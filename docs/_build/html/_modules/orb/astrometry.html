<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>orb.astrometry &#8212; orb  documentation</title>
    
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for orb.astrometry</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># *-* coding: utf-8 *-*</span>
<span class="c1"># author : Thomas Martin (thomas.martin.1@ulaval.ca)</span>
<span class="c1"># File: astrometry.py</span>

<span class="c1">## Copyright (c) 2010-2016 Thomas Martin &lt;thomas.martin.1@ulaval.ca&gt;</span>
<span class="c1">## </span>
<span class="c1">## This file is part of ORB</span>
<span class="c1">##</span>
<span class="c1">## ORB is free software: you can redistribute it and/or modify it</span>
<span class="c1">## under the terms of the GNU General Public License as published by</span>
<span class="c1">## the Free Software Foundation, either version 3 of the License, or</span>
<span class="c1">## (at your option) any later version.</span>
<span class="c1">##</span>
<span class="c1">## ORB is distributed in the hope that it will be useful, but WITHOUT</span>
<span class="c1">## ANY WARRANTY; without even the implied warranty of MERCHANTABILITY</span>
<span class="c1">## or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public</span>
<span class="c1">## License for more details.</span>
<span class="c1">##</span>
<span class="c1">## You should have received a copy of the GNU General Public License</span>
<span class="c1">## along with ORB.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">The Astrometry module is aimed to manage all astrometry processes:</span>
<span class="sd">Fitting star position and photometry for alignement and cubes merging.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;Thomas Martin&quot;</span>
<span class="n">__licence__</span> <span class="o">=</span> <span class="s2">&quot;Thomas Martin (thomas.martin.1@ulaval.ca)&quot;</span>                      
<span class="n">__docformat__</span> <span class="o">=</span> <span class="s1">&#39;reStructuredText&#39;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">optimize</span><span class="p">,</span> <span class="n">interpolate</span><span class="p">,</span> <span class="n">signal</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">interpolate</span>
<span class="kn">import</span> <span class="nn">astropy.wcs</span> <span class="k">as</span> <span class="nn">pywcs</span>
<span class="kn">import</span> <span class="nn">bottleneck</span> <span class="k">as</span> <span class="nn">bn</span>

<span class="kn">import</span> <span class="nn">core</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">__version__</span>
<span class="kn">from</span> <span class="nn">core</span> <span class="k">import</span> <span class="n">Tools</span><span class="p">,</span> <span class="n">Cube</span><span class="p">,</span> <span class="n">ProgressBar</span>
<span class="kn">import</span> <span class="nn">utils.astrometry</span>
<span class="kn">import</span> <span class="nn">utils.image</span>
<span class="kn">import</span> <span class="nn">utils.stats</span>
<span class="kn">import</span> <span class="nn">utils.vector</span>
<span class="kn">import</span> <span class="nn">utils.web</span>
<span class="kn">import</span> <span class="nn">cutils</span>
<span class="kn">import</span> <span class="nn">utils.misc</span>

<span class="c1">##################################################</span>
<span class="c1">#### CLASS StarsParams ###########################</span>
<span class="c1">##################################################</span>

<div class="viewcode-block" id="StarsParams"><a class="viewcode-back" href="../../orb.html#orb.astrometry.StarsParams">[docs]</a><span class="k">class</span> <span class="nc">StarsParams</span><span class="p">(</span><span class="n">Tools</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;StarsParams manage the parameters of each star in each frame of</span>
<span class="sd">    a cube.</span>

<span class="sd">    It can be accessed as a simple 3D array of shape (star_number,</span>
<span class="sd">    frame_nb, parameter).</span>

<span class="sd">    Additional methods provide an easy access to the data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># the whole data</span>
    <span class="n">star_nb</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Number of stars</span>
    <span class="n">frame_nb</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Number of frame</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Tuple containing the keys of the parameters</span>
    

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">star_nb</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">frame_nb</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;StarsParams init</span>

<span class="sd">        :param star_nb: (Optional) Number of stars (default 1)</span>
<span class="sd">        </span>
<span class="sd">        :param frame_nb: (Optional) Number of frames (default 1)</span>

<span class="sd">        :param kwargs: Kwargs are :meth:`core.Tools` properties.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Tools</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
              
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">star_nb</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">star_nb</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">star_nb</span> <span class="o">=</span> <span class="n">star_nb</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s2">&quot;Star number must be &gt; 0&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s2">&quot;Type Error: Star number must be an integer&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">frame_nb</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">frame_nb</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">frame_nb</span> <span class="o">=</span> <span class="n">frame_nb</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s2">&quot;Frame number must be &gt; 0&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s2">&quot;Type Error: Frame number must be an integer&quot;</span><span class="p">)</span>
                
        <span class="bp">self</span><span class="o">.</span><span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_data</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_msg_class_hdr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_msg_class_hdr</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Implement the evaluation of self[key] = item&quot;&quot;&quot;</span>

        <span class="c1"># Update keys</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">ikey</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">ikey</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ikey</span><span class="p">)</span>
                    
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">key</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">StarsParams</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">ikey</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">keys</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ikey</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ikey</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s2">&quot;IndexError: invalid index. Use index of 1, 2 or 3 dimensions to access StarsParams data&quot;</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame_nb</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">StarsParams</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span>
                <span class="k">elif</span> <span class="n">item</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s2">&quot;item to set is neither a StarsParams instance or a dict&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">star_nb</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">StarsParams</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span>
                <span class="k">elif</span> <span class="n">item</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s2">&quot;item to set is neither a StarsParams instance or a dict&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s2">&quot;IndexError&quot;</span><span class="p">)</span>
            
        <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>  <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">StarsParams</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">item</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">data</span>
                <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s2">&quot;Number of elements is not the same&quot;</span><span class="p">)</span> 
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span>
            <span class="k">elif</span> <span class="n">item</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s2">&quot;item to set is neither a StarsParams instance or a dict&quot;</span><span class="p">)</span>
                
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">data_key</span> <span class="o">=</span> <span class="n">key</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">param</span> <span class="o">=</span> <span class="n">key</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">data_key</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">data_key</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sliced_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">data_key</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sliced_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="k">for</span> <span class="n">jk</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sliced_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                        <span class="k">if</span> <span class="n">sliced_data</span><span class="p">[</span><span class="n">ik</span><span class="p">,</span><span class="n">jk</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">sliced_data</span><span class="p">[</span><span class="n">ik</span><span class="p">,</span><span class="n">jk</span><span class="p">][</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">sliced_data</span><span class="p">[</span><span class="n">ik</span><span class="p">,</span><span class="n">jk</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                            <span class="n">sliced_data</span><span class="p">[</span><span class="n">ik</span><span class="p">,</span><span class="n">jk</span><span class="p">][</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">data_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">sliced_data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s2">&quot;KeyError </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Implement the evaluation of self[key]&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s2">&quot;IndexError: invalid index. Use index of 1, 2 or 3 dimensions to access StarsParams data&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>  <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">data_key</span> <span class="o">=</span> <span class="n">key</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">param</span> <span class="o">=</span> <span class="n">key</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">data_key</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">data_key</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">data_key</span><span class="p">]))[</span><span class="mi">0</span><span class="p">][</span><span class="n">param</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sliced_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">data_key</span><span class="p">])</span>
                <span class="n">ret_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">sliced_data</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sliced_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="k">for</span> <span class="n">jk</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sliced_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                        <span class="k">if</span> <span class="n">sliced_data</span><span class="p">[</span><span class="n">ik</span><span class="p">,</span><span class="n">jk</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">sliced_data</span><span class="p">[</span><span class="n">ik</span><span class="p">,</span><span class="n">jk</span><span class="p">]:</span>
                                <span class="n">ret_data</span><span class="p">[</span><span class="n">ik</span><span class="p">,</span><span class="n">jk</span><span class="p">]</span> <span class="o">=</span> <span class="n">sliced_data</span><span class="p">[</span><span class="n">ik</span><span class="p">,</span><span class="n">jk</span><span class="p">][</span><span class="n">param</span><span class="p">]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">ret_data</span><span class="p">[</span><span class="n">ik</span><span class="p">,</span><span class="n">jk</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">ret_data</span><span class="p">[</span><span class="n">ik</span><span class="p">,</span><span class="n">jk</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ret_data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s2">&quot;KeyError </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a printable version of StarsParams data&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

<div class="viewcode-block" id="StarsParams.convert"><a class="viewcode-back" href="../../orb.html#orb.astrometry.StarsParams.convert">[docs]</a>    <span class="k">def</span> <span class="nf">convert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert StarsParams data to a new StarsParams instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># No conversion to do</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">StarsParams</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">data</span>
            
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">star_nb</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">frame_nb</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">new_params</span> <span class="o">=</span> <span class="n">StarsParams</span><span class="p">(</span><span class="n">star_nb</span><span class="p">,</span> <span class="n">frame_nb</span><span class="p">,</span>
                                     <span class="n">silent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_silent</span><span class="p">,</span>
                                     <span class="n">config_file_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config_file_name</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">star_nb</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">jk</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">frame_nb</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">ik</span><span class="p">,</span><span class="n">jk</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
                        <span class="n">new_params</span><span class="p">[</span><span class="n">ik</span><span class="p">,</span><span class="n">jk</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">ik</span><span class="p">,</span><span class="n">jk</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="n">data</span><span class="p">[</span><span class="n">ik</span><span class="p">,</span><span class="n">jk</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">new_params</span><span class="p">[</span><span class="n">ik</span><span class="p">,</span><span class="n">jk</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s2">&quot;Error occuring in data conversion. Data may be corrupted.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">new_params</span></div>
        
<div class="viewcode-block" id="StarsParams.reset_data"><a class="viewcode-back" href="../../orb.html#orb.astrometry.StarsParams.reset_data">[docs]</a>    <span class="k">def</span> <span class="nf">reset_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reset StarsParams data to an empty array&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">star_nb</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame_nb</span><span class="p">),</span>
                             <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="nb">dict</span><span class="p">())</span></div>

<div class="viewcode-block" id="StarsParams.save_stars_params"><a class="viewcode-back" href="../../orb.html#orb.astrometry.StarsParams.save_stars_params">[docs]</a>    <span class="k">def</span> <span class="nf">save_stars_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params_file_path</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save stars parameters in one file</span>

<span class="sd">        :param params_file_path: Path to the parameters file</span>

<span class="sd">        :param group: (Optional) Group path into the HDF5 file. If</span>
<span class="sd">          None the group will be &#39;/&#39; (default None).</span>

<span class="sd">        .. warning:: if no group is given, the whole file will be</span>
<span class="sd">          deleted if it already exists because new parameters will be</span>
<span class="sd">          written in the root group.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">start_t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print_msg</span><span class="p">(</span><span class="s2">&quot;Saving stars parameters in </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">params_file_path</span><span class="p">))</span>
        
        <span class="c1"># data restruct (much faster to save)</span>
        <span class="n">data_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">star_nb</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame_nb</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">)))</span>
        
        <span class="k">for</span> <span class="n">istar</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star_nb</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame_nb</span><span class="p">):</span>
                <span class="n">_d</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">istar</span><span class="p">,</span> <span class="n">index</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">ikey</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">)):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">data_r</span><span class="p">[</span><span class="n">istar</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">ikey</span><span class="p">]</span> <span class="o">=</span> <span class="n">_d</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">[</span><span class="n">ikey</span><span class="p">]]</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">data_r</span><span class="p">[</span><span class="n">istar</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">ikey</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="k">if</span> <span class="n">group</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">params_file_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">params_file_path</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_hdf5</span><span class="p">(</span><span class="n">params_file_path</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">group</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">f</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>
                <span class="n">grp</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">grp</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;/&#39;</span><span class="p">]</span>
            
            <span class="n">grp</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;star_nb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star_nb</span>
            <span class="n">grp</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;frame_nb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame_nb</span>
            <span class="n">grp</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span>
                    
            <span class="k">for</span> <span class="n">ikey</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">)):</span>
                <span class="n">grp</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">[</span><span class="n">ikey</span><span class="p">]]</span> <span class="o">=</span> <span class="n">data_r</span><span class="p">[:,:,</span><span class="n">ikey</span><span class="p">]</span>
               
        <span class="bp">self</span><span class="o">.</span><span class="n">_print_msg</span><span class="p">(</span><span class="s2">&quot;Stars parameters saved in </span><span class="si">{:.2f}</span><span class="s2"> s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_t</span><span class="p">))</span></div>

<div class="viewcode-block" id="StarsParams.load_stars_params"><a class="viewcode-back" href="../../orb.html#orb.astrometry.StarsParams.load_stars_params">[docs]</a>    <span class="k">def</span> <span class="nf">load_stars_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params_file_path</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">silent</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load a file containing stars parameters.</span>

<span class="sd">        :param fit_results_path: Path to the file parameters</span>

<span class="sd">        :param silent: (Optional) If True, no message is printed</span>
<span class="sd">          (default False).</span>

<span class="sd">        :param group: (Optional) Group path into the HDF5 file. If</span>
<span class="sd">          None the group will be &#39;/&#39; (default None).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_msg</span><span class="p">(</span><span class="s1">&#39;Loading stars parameters&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">start_t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_hdf5</span><span class="p">(</span><span class="n">params_file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        
            <span class="n">star_nb</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">frame_nb</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">group</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">grp</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">grp</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;/&#39;</span><span class="p">]</span>
            
            <span class="c1"># get header params to construct params array</span>
            <span class="k">if</span> <span class="s1">&#39;star_nb&#39;</span> <span class="ow">in</span> <span class="n">grp</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
                <span class="n">star_nb</span> <span class="o">=</span> <span class="n">grp</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;star_nb&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;params&#39;</span> <span class="ow">in</span> <span class="n">grp</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
                <span class="n">keys</span> <span class="o">=</span> <span class="n">grp</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;frame_nb&#39;</span> <span class="ow">in</span> <span class="n">grp</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
                <span class="n">frame_nb</span> <span class="o">=</span> <span class="n">grp</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;frame_nb&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">star_nb</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">keys</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">frame_nb</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s1">&#39;Bad star parameters file&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">star_nb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">star_nb</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star_nb</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_print_warning</span><span class="p">(</span><span class="s1">&#39;The number of stars in the loaded stars parameters and in the star list are not the same ! The star list will be erased&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">star_list</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">star_nb</span> <span class="o">=</span> <span class="n">star_nb</span>

            <span class="k">if</span> <span class="n">frame_nb</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame_nb</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print_warning</span><span class="p">(</span><span class="s1">&#39;The number of frames in the loaded stars parameters and in the cube are not the same ! The loaded data will be removed&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">frame_nb</span> <span class="o">=</span> <span class="n">frame_nb</span>

            <span class="c1"># reset data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reset_data</span><span class="p">()</span>

            <span class="c1"># load data (much faster if data is &#39;preloaded&#39;)</span>
            <span class="n">dat</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">ikey</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
                <span class="n">dat</span><span class="p">[</span><span class="n">ikey</span><span class="p">]</span> <span class="o">=</span> <span class="n">grp</span><span class="p">[</span><span class="n">ikey</span><span class="p">][:]</span>
                
            <span class="c1"># fill data</span>
            <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame_nb</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">istar</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star_nb</span><span class="p">):</span>
                    <span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">ikey</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
                        <span class="n">params</span><span class="p">[</span><span class="n">ikey</span><span class="p">]</span> <span class="o">=</span> <span class="n">dat</span><span class="p">[</span><span class="n">ikey</span><span class="p">][</span><span class="n">istar</span><span class="p">,</span> <span class="n">index</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">istar</span><span class="p">,</span> <span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print_msg</span><span class="p">(</span><span class="s1">&#39;Stars parameters loaded in </span><span class="si">{:.2f}</span><span class="s1"> s&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_t</span><span class="p">))</span></div>
            

<div class="viewcode-block" id="StarsParams.get_star_list"><a class="viewcode-back" href="../../orb.html#orb.astrometry.StarsParams.get_star_list">[docs]</a>    <span class="k">def</span> <span class="nf">get_star_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">all_params</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return an array of the positions of the stars in one frame</span>

<span class="sd">        :param index: (Optional) The index of the frame to use to</span>
<span class="sd">          create the list of stars (default 0)</span>

<span class="sd">        :param all_params: (Optional) If True, all params are</span>
<span class="sd">          returned. Bad params are returned as NaN values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">star_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">istar</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star_nb</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">istar</span><span class="p">,</span> <span class="n">index</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;x&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="n">istar</span><span class="p">,</span> <span class="n">index</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;y&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="n">istar</span><span class="p">,</span> <span class="n">index</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">istar</span><span class="p">,</span><span class="n">index</span><span class="p">,</span><span class="s1">&#39;x&#39;</span><span class="p">])</span>
                        <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">istar</span><span class="p">,</span><span class="n">index</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">])):</span>
                        <span class="n">star_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="bp">self</span><span class="p">[</span><span class="n">istar</span><span class="p">,</span><span class="n">index</span><span class="p">,</span><span class="s1">&#39;x&#39;</span><span class="p">],</span>
                                          <span class="bp">self</span><span class="p">[</span><span class="n">istar</span><span class="p">,</span><span class="n">index</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">]])</span>
                    <span class="k">elif</span> <span class="n">all_params</span><span class="p">:</span>
                        <span class="n">star_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">all_params</span><span class="p">:</span>
                    <span class="n">star_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">all_params</span><span class="p">:</span>
                    <span class="n">star_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">])</span>
            
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">star_list</span><span class="p">)</span></div></div>






<span class="c1">##################################################</span>
<span class="c1">#### CLASS Astrometry ############################</span>
<span class="c1">##################################################</span>

<div class="viewcode-block" id="Astrometry"><a class="viewcode-back" href="../../orb.html#orb.astrometry.Astrometry">[docs]</a><span class="k">class</span> <span class="nc">Astrometry</span><span class="p">(</span><span class="n">Tools</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Manage all astrometrical processes that can be made on a single</span>
<span class="sd">    frame of a whole cube.</span>

<span class="sd">    This class can detect stars in the given data and return fit</span>
<span class="sd">    parameters. Fit parameters are returned as a</span>
<span class="sd">    :py:class:`~astrometry.StarsParams` object used to store and access</span>
<span class="sd">    fit parameters.</span>

<span class="sd">    Possible fitting profiles are at least Gaussian and Moffat. Other</span>
<span class="sd">    profiles can be created by expanding :py:class:`~astrometry.PSF`</span>
<span class="sd">    class.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">DETECT_INDEX</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">BIG_DATA</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># If True some processes are parallelized</span>
    <span class="n">default_beta</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Default value of the beta parameter of the</span>
                        <span class="c1"># Moffat profile</span>

    <span class="n">data</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># data on which the astrometry is done</span>
    
    <span class="n">master_frame</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Master frame created from a combination of</span>
                        <span class="c1"># the frames of the cube</span>
    
    <span class="n">fwhm_arc</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Initial guess of the FWHM in arcsec</span>
    <span class="n">fwhm_pix</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Initial guess of the FWHM in pixels</span>
    
    <span class="n">fov</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Field of view of the cube in arcminutes (given along</span>
               <span class="c1"># x axis)</span>

    <span class="n">scale</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Scale of the frame in arcsec/pixel</span>
    
    <span class="n">box_size_coeff</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Coefficient used to define the size of the</span>
                          <span class="c1"># box from FWHM</span>
    <span class="n">box_size</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Size of the fitting box in pixel</span>

    <span class="n">profiles</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;moffat&#39;</span><span class="p">,</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">]</span>
    <span class="n">profile_name</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Name of the profile</span>
    <span class="n">profile</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># A PSF class (e.g. Moffat or Gaussian)</span>

    <span class="n">star_list</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># List of stars</span>
    <span class="n">star_nb</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Number of stars in the star list</span>
    <span class="n">frame_nb</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Number of frames in the data cube</span>
    <span class="n">_silent</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># If True only warnings and error message will be</span>
                    <span class="c1"># printed</span>
    <span class="n">deep_frame</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># computed deep frame</span>

    <span class="n">target_x</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># X position of a target</span>
    <span class="n">target_y</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Y position of a target</span>
    <span class="n">target_ra</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># RA of a target in degrees</span>
    <span class="n">target_dec</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># DEC of a target in degrees</span>
    <span class="n">wcs_rotation</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Rotation angle of the field relatively to the North.</span>
    <span class="n">wcs</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># When data is registered this pywcs.WCS instance gives</span>
               <span class="c1"># the corrected WCS.</span>
    
    <span class="n">detect_stack</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;Number of frames stacked together to create one median frame</span>
<span class="sd">    used for star detection&quot;&quot;&quot;</span>

    <span class="n">fit_results</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;Array containing all the resulting parameters (as dictionaries)</span>
<span class="sd">    of the fit of each star in each frame&quot;&quot;&quot;</span>

    <span class="n">fit_tol</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;Tolerance on the fit parameters&quot;&quot;&quot;</span>

    <span class="n">reduced_chi_square_limit</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;Coefficient on the reduced chi square for bad quality fits</span>
<span class="sd">    rejection&quot;&quot;&quot;</span>

    <span class="n">_check_mask</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;If True use masked frame to reject stars containing masked</span>
<span class="sd">    pixels&quot;&quot;&quot;</span>

    <span class="n">readout_noise</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;Readout noise in ADU/pixel (can be computed from bias frames:</span>
<span class="sd">    std(master_bias_frame))&quot;&quot;&quot;</span>
    
    <span class="n">dark_current_level</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;Dark current level in ADU/pixel (can be computed from dark frames:</span>
<span class="sd">    median(master_dark_frame))&quot;&quot;&quot;</span>

    

    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">fwhm_arc</span><span class="p">,</span> <span class="n">fov</span><span class="p">,</span> <span class="n">profile_name</span><span class="o">=</span><span class="s1">&#39;gaussian&#39;</span><span class="p">,</span>
                 <span class="n">detect_stack</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">fit_tol</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">,</span> <span class="n">moffat_beta</span><span class="o">=</span><span class="mf">2.1</span><span class="p">,</span>
                 <span class="n">star_list_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">box_size_coeff</span><span class="o">=</span><span class="mf">7.</span><span class="p">,</span>
                 <span class="n">check_mask</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">reduced_chi_square_limit</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
                 <span class="n">readout_noise</span><span class="o">=</span><span class="mf">10.</span><span class="p">,</span> <span class="n">dark_current_level</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
                 <span class="n">target_radec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">target_xy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wcs_rotation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">sip</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Init astrometry class.</span>

<span class="sd">        :param data: Can be an 2D or 3D Numpy array or an instance of</span>
<span class="sd">          core.Cube class. Note that the frames must not be too</span>
<span class="sd">          disaligned (a few pixels in both directions).</span>

<span class="sd">        :param fwhm_arc: rough FWHM of the stars in arcsec</span>
<span class="sd">        </span>
<span class="sd">        :param fov: Field of view of the frame in arcminutes (given</span>
<span class="sd">          along x axis)</span>

<span class="sd">        :param profile_name: (Optional) Name of the PSF profile to use</span>
<span class="sd">          for fitting. Can be &#39;moffat&#39; or &#39;gaussian&#39; (default</span>
<span class="sd">          &#39;gaussian&#39;).</span>

<span class="sd">        :param detect_stack: (Optional) Number of frames to stack</span>
<span class="sd">          before detecting stars (default 5).</span>

<span class="sd">        :param fit_tol: (Optional) Tolerance on the paramaters fit</span>
<span class="sd">          (the lower the better but the longer too) (default 1e-2).</span>

<span class="sd">        :param moffat_beta: (Optional) Default value of the beta</span>
<span class="sd">          parameter for the moffat profile (default 3.5).</span>

<span class="sd">        :param star_list_path: (Optional) Path to a file containing a</span>
<span class="sd">          list of star positions (default None).</span>

<span class="sd">        :param box_size_coeff: (Optional) Coefficient giving the size</span>
<span class="sd">          of the box created around each star before a fit is</span>
<span class="sd">          done. BOX_SIZE = box_size_coeff * STAR_FWHM. (default 10.).</span>
<span class="sd">          Note that this coeff is divided by 3 if the moffat profile</span>
<span class="sd">          is used (helps to avoid bad fit).</span>
<span class="sd">        </span>
<span class="sd">        :param check_mask: (Optional) If True and if the data frames</span>
<span class="sd">          are masked, masked pixels in a star are considered as bad so</span>
<span class="sd">          that no fit is done over it (returned fit parameters for the</span>
<span class="sd">          star are None). This is valid only if data is an instance of</span>
<span class="sd">          core.Cube() (default True).</span>

<span class="sd">        :param reduced_chi_square_limit: (Optional) Coefficient on the</span>
<span class="sd">          reduced chi square for bad quality fits rejection (default</span>
<span class="sd">          1.5)</span>

<span class="sd">        :param readout_noise: (Optional) Readout noise in ADU/pixel</span>
<span class="sd">          (can be computed from bias frames: std(master_bias_frame))</span>
<span class="sd">          (default 10.)</span>
<span class="sd">    </span>
<span class="sd">        :param dark_current_level: (Optional) Dark current level in</span>
<span class="sd">          ADU/pixel (can be computed from dark frames:</span>
<span class="sd">          median(master_dark_frame)) (default 0.)</span>

<span class="sd">        :param target_radec: (Optional) [RA, DEC] in degrees of a</span>
<span class="sd">          target near the center of the field. If the options</span>
<span class="sd">          target_xy (for the same target) and wcs rotation are also</span>
<span class="sd">          given , star detection will use a catalogue to get star</span>
<span class="sd">          positions in the field and WCS registration of an image or a</span>
<span class="sd">          cube is possible (default None).</span>

<span class="sd">        :param target_xy: (Optional) [X, Y] of a target near the</span>
<span class="sd">          center of the field. If the options target_radec (for the</span>
<span class="sd">          same target) and wcs rotation are also given , star</span>
<span class="sd">          detection will use a catalogue to get star positions in the</span>
<span class="sd">          field and WCS registration of an image or a cube is possible</span>
<span class="sd">          (default None).</span>

<span class="sd">        :param wcs_rotation: (Optional) Initial rotation angle of the</span>
<span class="sd">          field relatively to the North direction. Useful if the</span>
<span class="sd">          options target_radec and target_xy are also given. In this</span>
<span class="sd">          case, WCS registration and catalogued star detection are</span>
<span class="sd">          possible (default None).</span>

<span class="sd">        :param sip: (Optional) An astropy.wcs.WCS instance containing</span>
<span class="sd">          the SIP parameters of the distortion map (default None).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Tools</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
       
        <span class="bp">self</span><span class="o">.</span><span class="n">BIG_DATA</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_config_parameter</span><span class="p">(</span><span class="s2">&quot;BIG_DATA&quot;</span><span class="p">)))</span>
        
        <span class="c1"># check mask or not</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_mask</span> <span class="o">=</span> <span class="n">check_mask</span>
        
        <span class="c1"># load data and init parameters</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">Cube</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dimx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dimx</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dimy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dimy</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dimz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dimz</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_mask</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dimx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dimy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dimz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dimz</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s2">&quot;Data array must have 2 or 3 dimensions&quot;</span><span class="p">)</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s2">&quot;Cube must be an instance of Cube class or a Numpy array&quot;</span><span class="p">)</span>


        <span class="k">if</span> <span class="n">profile_name</span> <span class="o">==</span> <span class="s1">&#39;moffat&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">box_size_coeff</span> <span class="o">=</span> <span class="n">box_size_coeff</span> <span class="o">/</span> <span class="mf">3.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">box_size_coeff</span> <span class="o">=</span> <span class="n">box_size_coeff</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_nb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimz</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">fwhm_arc</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">fwhm_arc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">detect_stack</span> <span class="o">=</span> <span class="n">detect_stack</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_beta</span> <span class="o">=</span> <span class="n">moffat_beta</span>

        <span class="c1"># load star list</span>
        <span class="k">if</span> <span class="n">star_list_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_star_list</span><span class="p">(</span><span class="n">star_list_path</span><span class="p">)</span>
        
        <span class="c1"># set scale and all dependant parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fov</span> <span class="o">=</span> <span class="n">fov</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_scale</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fov</span><span class="p">)</span> <span class="o">*</span> <span class="mf">60.</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimx</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fit_tol</span><span class="o">=</span><span class="n">fit_tol</span>
    
        <span class="c1"># define profile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_profile_name</span><span class="p">(</span><span class="n">profile_name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reduced_chi_square_limit</span> <span class="o">=</span> <span class="n">reduced_chi_square_limit</span>

        <span class="c1"># get noise values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">readout_noise</span> <span class="o">=</span> <span class="n">readout_noise</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dark_current_level</span> <span class="o">=</span> <span class="n">dark_current_level</span>


        <span class="c1"># get RADEC and XY position of a target</span>
        <span class="k">if</span> <span class="n">target_radec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">target_ra</span> <span class="o">=</span> <span class="n">target_radec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">target_dec</span> <span class="o">=</span> <span class="n">target_radec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">target_ra</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">target_dec</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">target_xy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">target_x</span> <span class="o">=</span> <span class="n">target_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">target_y</span> <span class="o">=</span> <span class="n">target_xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">target_x</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">target_y</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wcs_rotation</span> <span class="o">=</span> <span class="n">wcs_rotation</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sip</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">sip</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sip</span><span class="p">,</span> <span class="n">pywcs</span><span class="o">.</span><span class="n">WCS</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sip</span> <span class="o">=</span> <span class="n">sip</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s1">&#39;sip must be an astropy.wcs.WCS instance&#39;</span><span class="p">)</span>
                
    
    <span class="k">def</span> <span class="nf">_get_star_list_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the default path to the star list file.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_path_hdr</span> <span class="o">+</span> <span class="s2">&quot;star_list&quot;</span>

    <span class="k">def</span> <span class="nf">_get_fit_results_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the default path to the file containing all fit</span>
<span class="sd">        results.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_path_hdr</span> <span class="o">+</span> <span class="s2">&quot;fit_results.hdf5&quot;</span>

    <span class="k">def</span> <span class="nf">_get_combined_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">use_deep_frame</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">realign</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a combined frame to work on.</span>

<span class="sd">        :param use_deep_frame: (Optional) If True returned frame is a</span>
<span class="sd">          deep frame instead of a combination of the first frames only</span>
<span class="sd">          (default False)</span>

<span class="sd">        :param realign: (Optional) Realign frames with a</span>
<span class="sd">          cross-correlation algorithm (default False). Much better if</span>
<span class="sd">          used on a small number of frames.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">deep_frame</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deep_frame</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimz</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">_cube</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[:,:,:]</span>

        <span class="c1"># realignment of the frames if necessary</span>
        <span class="k">if</span> <span class="n">realign</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimz</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">_cube</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">astrometry</span><span class="o">.</span><span class="n">realign_images</span><span class="p">(</span><span class="n">_cube</span><span class="p">)</span>
                
        <span class="c1"># If we have 3D data we work on a combined image of the first</span>
        <span class="c1"># frames</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimz</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">use_deep_frame</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">_cube</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">deep_frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get_median_image</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">deep_frame</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">_cube</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">deep_frame</span>
            
            
            <span class="n">stack_nb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_stack</span>
            <span class="k">if</span> <span class="n">stack_nb</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">DETECT_INDEX</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame_nb</span><span class="p">:</span>
                <span class="n">stack_nb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame_nb</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">DETECT_INDEX</span>

            <span class="k">if</span> <span class="n">_cube</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">dat</span> <span class="o">=</span> <span class="n">_cube</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span>
                <span class="p">:,:,</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DETECT_INDEX</span><span class="p">):</span>
                <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DETECT_INDEX</span><span class="o">+</span><span class="n">stack_nb</span><span class="p">)]</span>
                
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">BIG_DATA</span><span class="p">:</span>
                <span class="n">im</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">create_master_frame</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">im</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">pp_create_master_frame</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
                
        <span class="c1"># else we just return the only frame we have</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">im</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

<div class="viewcode-block" id="Astrometry.reset_profile_name"><a class="viewcode-back" href="../../orb.html#orb.astrometry.Astrometry.reset_profile_name">[docs]</a>    <span class="k">def</span> <span class="nf">reset_profile_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">profile_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reset the name of the profile used.</span>

<span class="sd">        :param profile_name: Name of the PSF profile to use for</span>
<span class="sd">          fitting. Can be &#39;moffat&#39; or &#39;gaussian&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">profile_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">profiles</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">profile_name</span> <span class="o">=</span> <span class="n">profile_name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">profile</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">astrometry</span><span class="o">.</span><span class="n">get_profile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">profile_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span>
                <span class="s2">&quot;Bad profile name (</span><span class="si">%s</span><span class="s2">) please choose it in: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span>
                    <span class="n">profile_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">profiles</span><span class="p">)))</span></div>
        
<div class="viewcode-block" id="Astrometry.reset_star_list"><a class="viewcode-back" href="../../orb.html#orb.astrometry.Astrometry.reset_star_list">[docs]</a>    <span class="k">def</span> <span class="nf">reset_star_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">star_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reset the list of stars</span>
<span class="sd">        </span>
<span class="sd">        :param star_list: An array of shape (star_nb, 2) giving the</span>
<span class="sd">          positions in x and y of the stars.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">star_list</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">star_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">star_list</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">star_list</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">star_list</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s1">&#39;Incorrect star list shape. The star list must be an array of shape (star_nb, 2)&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s1">&#39;Incorrect star list shape. The star list must be an array of shape (star_nb, 2)&#39;</span><span class="p">)</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">star_list</span> <span class="o">=</span> <span class="n">star_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">star_nb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star_list</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># create an empty StarsParams array</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit_results</span> <span class="o">=</span> <span class="n">StarsParams</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star_nb</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame_nb</span><span class="p">,</span>
                                       <span class="n">silent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_silent</span><span class="p">,</span>
                                       <span class="n">config_file_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config_file_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">star_list</span></div>
    
<div class="viewcode-block" id="Astrometry.reset_scale"><a class="viewcode-back" href="../../orb.html#orb.astrometry.Astrometry.reset_scale">[docs]</a>    <span class="k">def</span> <span class="nf">reset_scale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scale</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reset scale attribute.</span>
<span class="sd">        </span>
<span class="sd">        :param scale: Frame scale in arcsec/pixel</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">scale</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_fwhm_arc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fwhm_arc</span><span class="p">)</span></div>

<div class="viewcode-block" id="Astrometry.reset_fwhm_arc"><a class="viewcode-back" href="../../orb.html#orb.astrometry.Astrometry.reset_fwhm_arc">[docs]</a>    <span class="k">def</span> <span class="nf">reset_fwhm_arc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fwhm_arc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reset FWHM of stars in arcsec</span>

<span class="sd">        :param fwhm_arc: FWHM of stars in arcsec</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fwhm_arc</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">fwhm_arc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_fwhm_pix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arc2pix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fwhm_arc</span><span class="p">))</span></div>

<div class="viewcode-block" id="Astrometry.reset_fwhm_pix"><a class="viewcode-back" href="../../orb.html#orb.astrometry.Astrometry.reset_fwhm_pix">[docs]</a>    <span class="k">def</span> <span class="nf">reset_fwhm_pix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fwhm_pix</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reset FWHM of stars in pixels</span>

<span class="sd">        :param fwhm_arc: FWHM of stars in pixels</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fwhm_pix</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">fwhm_pix</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_box_size</span><span class="p">()</span></div>

<div class="viewcode-block" id="Astrometry.reset_box_size"><a class="viewcode-back" href="../../orb.html#orb.astrometry.Astrometry.reset_box_size">[docs]</a>    <span class="k">def</span> <span class="nf">reset_box_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reset box size attribute. Useful if FWHM or scale has been</span>
<span class="sd">        modified after class init.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">box_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">box_size_coeff</span> <span class="o">*</span>  <span class="bp">self</span><span class="o">.</span><span class="n">fwhm_pix</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">box_size</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span><span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">box_size</span><span class="o">%</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># make it odd</span></div>
    
<div class="viewcode-block" id="Astrometry.arc2pix"><a class="viewcode-back" href="../../orb.html#orb.astrometry.Astrometry.arc2pix">[docs]</a>    <span class="k">def</span> <span class="nf">arc2pix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert pixels to arcseconds</span>

<span class="sd">        :param x: a value or a vector in pixel</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s2">&quot;Scale not defined&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Astrometry.pix2arc"><a class="viewcode-back" href="../../orb.html#orb.astrometry.Astrometry.pix2arc">[docs]</a>    <span class="k">def</span> <span class="nf">pix2arc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert arcseconds to pixels</span>

<span class="sd">        :param x: a value or a vector in arcsec</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s2">&quot;Scale not defined&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Astrometry.fwhm"><a class="viewcode-back" href="../../orb.html#orb.astrometry.Astrometry.fwhm">[docs]</a>    <span class="k">def</span> <span class="nf">fwhm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return fwhm from width</span>

<span class="sd">        :param x: width</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">)))</span></div>

<div class="viewcode-block" id="Astrometry.width"><a class="viewcode-back" href="../../orb.html#orb.astrometry.Astrometry.width">[docs]</a>    <span class="k">def</span> <span class="nf">width</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return width from fwhm</span>

<span class="sd">        :param x: fwhm.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">)))</span></div>


<div class="viewcode-block" id="Astrometry.set_deep_frame"><a class="viewcode-back" href="../../orb.html#orb.astrometry.Astrometry.set_deep_frame">[docs]</a>    <span class="k">def</span> <span class="nf">set_deep_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">deep_frame_path</span><span class="p">):</span>
        <span class="n">deep_frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_fits</span><span class="p">(</span><span class="n">deep_frame_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">deep_frame</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimy</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deep_frame</span> <span class="o">=</span> <span class="n">deep_frame</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s1">&#39;Deep frame must have the same shape&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Astrometry.load_fit_results"><a class="viewcode-back" href="../../orb.html#orb.astrometry.Astrometry.load_fit_results">[docs]</a>    <span class="k">def</span> <span class="nf">load_fit_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fit_results_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load a file containing the fit results&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">fit_results_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fit_results_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_fit_results_path</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit_results</span><span class="o">.</span><span class="n">load_stars_params</span><span class="p">(</span><span class="n">fit_results_path</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="Astrometry.load_star_list"><a class="viewcode-back" href="../../orb.html#orb.astrometry.Astrometry.load_star_list">[docs]</a>    <span class="k">def</span> <span class="nf">load_star_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">star_list_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load a list of stars coordinates</span>

<span class="sd">        :param star_list_path: The path to the star list file.</span>

<span class="sd">        .. seealso:: :py:meth:`astrometry.load_star_list`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">star_list</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">astrometry</span><span class="o">.</span><span class="n">load_star_list</span><span class="p">(</span>
            <span class="n">star_list_path</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_silent</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_star_list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">star_list</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">))</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">star_list</span></div>

<div class="viewcode-block" id="Astrometry.fit_stars_in_frame"><a class="viewcode-back" href="../../orb.html#orb.astrometry.Astrometry.fit_stars_in_frame">[docs]</a>    <span class="k">def</span> <span class="nf">fit_stars_in_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit stars in one frame.</span>

<span class="sd">        This function is basically a wrapper around</span>
<span class="sd">        :meth:`utils.astrometry.fit_stars_in_frame`.</span>

<span class="sd">        .. note:: 2 fitting modes are possible::</span>
<span class="sd">        </span>
<span class="sd">            * Individual fit mode [multi_fit=False]</span>
<span class="sd">            * Multi fit mode [multi_fit=True]</span>

<span class="sd">            see :meth:`utils.astrometry.fit_stars_in_frame` for more</span>
<span class="sd">            information.</span>

<span class="sd">        :param index: Index of the frame to fit. If index is a frame,</span>
<span class="sd">          this frame is used instead.</span>

<span class="sd">        :param save: (Optional) If True save the fit results in a file</span>
<span class="sd">          (default True).</span>
<span class="sd">          </span>
<span class="sd">        :param kwargs: Same optional arguments as for</span>
<span class="sd">          :meth:`utils.astrometry.fit_stars_in_frame`.</span>

<span class="sd">        .. warning:: Some optional arguments are taken directly from the</span>
<span class="sd">          values computed at the init of the Class. The following</span>
<span class="sd">          optional arguments thus cannot be passed::</span>
<span class="sd">          </span>
<span class="sd">            * profile_name</span>
<span class="sd">            * scale</span>
<span class="sd">            * fwhm_pix</span>
<span class="sd">            * beta</span>
<span class="sd">            * fit_tol</span>
<span class="sd">            * readout_noise</span>
<span class="sd">            * dark_current_level</span>
<span class="sd">          </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span>
            <span class="s2">&quot;Some data must be loaded first&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">star_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span>
            <span class="s2">&quot;A star list must be loaded or created first&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">index</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimy</span><span class="p">):</span>
                <span class="n">frame</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s1">&#39;Image shape </span><span class="si">{}</span><span class="s1"> must have the same size as the cube size (</span><span class="si">{}</span><span class="s1">,</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">index</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimy</span><span class="p">))</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimz</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[:,:,</span><span class="n">index</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_mask</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">_mask_exists</span><span class="p">:</span>
                        <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get_data_frame</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="n">frame</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
                        <span class="n">frame</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">mask</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">frame</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
                

        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;profile_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile_name</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;scale&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;fwhm_pix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fwhm_pix</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_beta</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;fit_tol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_tol</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;readout_noise&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readout_noise</span><span class="p">,</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;dark_current_level&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dark_current_level</span>

        <span class="n">fit_results</span> <span class="o">=</span> <span class="n">StarsParams</span><span class="p">(</span><span class="n">star_nb</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star_list</span><span class="p">),</span> <span class="n">frame_nb</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># fit</span>
        <span class="n">_fit_results</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">astrometry</span><span class="o">.</span><span class="n">fit_stars_in_frame</span><span class="p">(</span>
            <span class="n">frame</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">star_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">box_size</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        

        <span class="c1"># convert results to a StarParams instance</span>
        <span class="k">for</span> <span class="n">istar</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star_list</span><span class="p">)):</span>
            <span class="n">fit_results</span><span class="p">[</span><span class="n">istar</span><span class="p">]</span> <span class="o">=</span> <span class="n">_fit_results</span><span class="p">[</span><span class="n">istar</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimz</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fit_results</span><span class="p">[:,</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit_results</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fit_results</span> <span class="o">=</span> <span class="n">fit_results</span>
        
        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fit_results</span><span class="o">.</span><span class="n">save_stars_params</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_fit_results_path</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">fit_results</span></div>
            


<div class="viewcode-block" id="Astrometry.fit_stars_in_cube"><a class="viewcode-back" href="../../orb.html#orb.astrometry.Astrometry.fit_stars_in_cube">[docs]</a>    <span class="k">def</span> <span class="nf">fit_stars_in_cube</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">correct_alignment</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">add_cube</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hpfilter</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">fix_height</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fix_beta</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                          <span class="n">fix_fwhm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">fwhm_min</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">local_background</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                          <span class="n">no_aperture_photometry</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">fix_aperture_size</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">precise_guess</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">aper_coeff</span><span class="o">=</span><span class="mf">3.</span><span class="p">,</span> <span class="n">blur</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                          <span class="n">no_fit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">estimate_local_noise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">multi_fit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">enable_zoom</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">enable_rotation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">saturation</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        
        <span class="sd">&quot;&quot;&quot;Fit stars in the cube.</span>

<span class="sd">        Frames must not be too disaligned. Disalignment can be</span>
<span class="sd">        corrected as the cube is fitted by setting correct_alignment</span>
<span class="sd">        option to True.</span>

<span class="sd">        .. note:: 2 fitting modes are possible::</span>
<span class="sd">        </span>
<span class="sd">            * Individual fit mode [multi_fit=False]</span>
<span class="sd">            * Multi fit mode [multi_fit=True]</span>

<span class="sd">            see :meth:`astrometry.utils.fit_stars_in_frame` for more</span>
<span class="sd">            information.</span>
<span class="sd">    </span>
<span class="sd">        :param correct_alignment: (Optional) If True, the initial star</span>
<span class="sd">          positions from the star list are corrected by their last</span>
<span class="sd">          recorded deviation. Useful when the cube is smoothly</span>
<span class="sd">          disaligned from one frame to the next.</span>

<span class="sd">        :param save: (Optional) If True save the fit results in a file</span>
<span class="sd">          (default True).</span>

<span class="sd">        :param add_cube: (Optional) A tuple [Cube instance,</span>
<span class="sd">          coeff]. This cube is added to the data before the fit so</span>
<span class="sd">          that the fitted data is self.data[] + coeff * Cube[].</span>

<span class="sd">        :param hpfilter: (Optional) If True, frames are HP filtered</span>
<span class="sd">          before fitting stars. Useful for alignment purpose if there</span>
<span class="sd">          are too much nebulosities in the frames. This option must</span>
<span class="sd">          not be used for photometry (default False).</span>
<span class="sd">    </span>
<span class="sd">        :param fix_height: (Optional) see</span>
<span class="sd">          :paramref:`utils.astrometry.fit_stars_in_frame.fix_height`</span>
<span class="sd">          (default True)</span>

<span class="sd">        :param fix_beta: (Optional) see</span>
<span class="sd">          :paramref:`utils.astrometry.fit_stars_in_frame.fix_beta` (default</span>
<span class="sd">          True).</span>

<span class="sd">        :param fix_fwhm: (Optional) see</span>
<span class="sd">          :paramref:`utils.astrometry.fit_stars_in_frame.fix_fwhm`</span>
<span class="sd">          (default False)</span>

<span class="sd">        :param fwhm_min: (Optional) see</span>
<span class="sd">          :paramref:`utils.astrometry.fit_stars_in_frame.fix_min` (default</span>
<span class="sd">          0.5)</span>

<span class="sd">        :param local_background: (Optional) see</span>
<span class="sd">          :paramref:`utils.astrometry.fit_stars_in_frame.local_background`</span>
<span class="sd">          (default True).</span>

<span class="sd">        :param no_aperture_photometry: (Optional) see</span>
<span class="sd">          :paramref:`utils.astrometry.fit_stars_in_frame.no_aperture_photometry`</span>
<span class="sd">          (default False).</span>

<span class="sd">        :param fix_aperture_size: (Optional) see</span>
<span class="sd">          :paramref:`utils.astrometry.fit_stars_in_frame.fix_aperture_size`</span>
<span class="sd">          (default False).</span>

<span class="sd">        :param precise_guess: (Optional) see</span>
<span class="sd">          :paramref:`utils.astrometry.fit_stars_in_frame.precise_guess`</span>
<span class="sd">          (default False).</span>

<span class="sd">        :param aper_coeff: (Optional) see</span>
<span class="sd">          :paramref:`utils.astrometry.fit_stars_in_frame.aper_coeff`</span>
<span class="sd">          (default 3).</span>

<span class="sd">        :param blur: (Optional) see</span>
<span class="sd">          :paramref:`utils.astrometry.fit_stars_in_frame.blur` (default</span>
<span class="sd">          False).</span>

<span class="sd">        :param no_fit: (Optional) see</span>
<span class="sd">          :paramref:`utils.astrometry.fit_stars_in_frame.no_fit` (default</span>
<span class="sd">          False).</span>

<span class="sd">        :param estimate_local_noise: (Optional) see</span>
<span class="sd">          :paramref:`utils.astrometry.fit_stars_in_frame.estimate_local_noise`</span>
<span class="sd">          (default True).</span>

<span class="sd">        :param multi_fit: (Optional) see</span>
<span class="sd">          :paramref:`utils.astrometry.fit_stars_in_frame.multi_fit` (default</span>
<span class="sd">          False).</span>

<span class="sd">        :param enable_zoom: (Optional) see</span>
<span class="sd">          :paramref:`utils.astrometry.fit_stars_in_frame.enable_zoom`</span>
<span class="sd">          (default False).</span>

<span class="sd">        :param enable_rotation: (Optional) see</span>
<span class="sd">          :paramref:`utils.astrometry.fit_stars_in_frame.enable_rotation`</span>
<span class="sd">          (default False).</span>
<span class="sd">  </span>
<span class="sd">        :param saturation: (Optional) see</span>
<span class="sd">          :paramref:`utils.astrometry.fit_stars_in_frame.saturation`</span>
<span class="sd">          (default None).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">get_index_mean_dev</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
            <span class="n">dx</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">robust_mean</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sigmacut</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fit_results</span><span class="p">[:,</span><span class="n">index</span><span class="p">,</span><span class="s1">&#39;dx&#39;</span><span class="p">]))</span>
            <span class="n">dy</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">robust_mean</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sigmacut</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fit_results</span><span class="p">[:,</span><span class="n">index</span><span class="p">,</span><span class="s1">&#39;dy&#39;</span><span class="p">]))</span>
            <span class="k">return</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span>


        <span class="n">FOLLOW_NB</span> <span class="o">=</span> <span class="mi">5</span> <span class="c1"># Number of deviation value to get to follow the</span>
                      <span class="c1"># stars</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_print_msg</span><span class="p">(</span><span class="s2">&quot;Fitting stars in cube&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span>
            <span class="s2">&quot;Some data must be loaded first&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">star_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span>
            <span class="s2">&quot;A star list must be loaded or created first&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimz</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span>
            <span class="s2">&quot;Data must have 3 dimensions. Use fit_stars_in_frame method instead&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fix_aperture_size</span><span class="p">:</span>
            <span class="n">fix_aperture_fwhm_pix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fwhm_pix</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fix_aperture_fwhm_pix</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">add_cube</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">add_cube</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">added_cube</span> <span class="o">=</span> <span class="n">add_cube</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">added_cube_scale</span> <span class="o">=</span> <span class="n">add_cube</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">added_cube</span><span class="p">,</span> <span class="n">Cube</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s1">&#39;Added cube must be a Cube instance. Check add_cube option&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">added_cube_scale</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s1">&#39;Bad added cube scale. Check add_cube option.&#39;</span><span class="p">)</span>
                
        <span class="bp">self</span><span class="o">.</span><span class="n">fit_results</span> <span class="o">=</span> <span class="n">StarsParams</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star_nb</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame_nb</span><span class="p">,</span>
                                       <span class="n">silent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_silent</span><span class="p">,</span>
                                       <span class="n">config_file_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config_file_name</span><span class="p">)</span>

        <span class="c1"># Init of the multiprocessing server</span>
        <span class="n">job_server</span><span class="p">,</span> <span class="n">ncpus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_pp_server</span><span class="p">()</span>

        <span class="n">frames</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">dimx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimy</span><span class="p">,</span> <span class="n">ncpus</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        
        <span class="n">progress</span> <span class="o">=</span> <span class="n">ProgressBar</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame_nb</span><span class="p">),</span> <span class="n">silent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_silent</span><span class="p">)</span>
        <span class="n">x_corr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">y_corr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame_nb</span><span class="p">,</span> <span class="n">ncpus</span><span class="p">):</span>
            <span class="c1"># no more jobs than frames to compute</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ik</span> <span class="o">+</span> <span class="n">ncpus</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame_nb</span><span class="p">):</span>
                <span class="n">ncpus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame_nb</span> <span class="o">-</span> <span class="n">ik</span>
    
            <span class="k">if</span> <span class="n">correct_alignment</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ik</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">old_x_corr</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">x_corr</span><span class="p">)</span>
                    <span class="n">old_y_corr</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">y_corr</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">ik</span> <span class="o">&gt;</span> <span class="n">FOLLOW_NB</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="c1"># try to get the mean deviation over the</span>
                        <span class="c1"># last fitted frames</span>
                        <span class="n">x_mean_dev</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_index_mean_dev</span><span class="p">(</span><span class="n">ik</span><span class="o">-</span><span class="n">ifol</span><span class="o">-</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                                      <span class="k">for</span> <span class="n">ifol</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">FOLLOW_NB</span><span class="p">)]</span>
                        <span class="n">y_mean_dev</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_index_mean_dev</span><span class="p">(</span><span class="n">ik</span><span class="o">-</span><span class="n">ifol</span><span class="o">-</span><span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                                      <span class="k">for</span> <span class="n">ifol</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">FOLLOW_NB</span><span class="p">)]</span>
                        <span class="n">x_corr</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">robust_median</span><span class="p">(</span><span class="n">x_mean_dev</span><span class="p">)</span>
                        <span class="n">y_corr</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">robust_median</span><span class="p">(</span><span class="n">y_mean_dev</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">x_corr</span><span class="p">,</span> <span class="n">y_corr</span> <span class="o">=</span> <span class="n">get_index_mean_dev</span><span class="p">(</span><span class="n">ik</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">x_corr</span><span class="p">):</span>
                        <span class="n">x_corr</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">old_x_corr</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y_corr</span><span class="p">):</span>
                        <span class="n">y_corr</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">old_y_corr</span><span class="p">)</span>
                    
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">x_corr</span> <span class="o">=</span> <span class="mf">0.</span>
                    <span class="n">y_corr</span> <span class="o">=</span> <span class="mf">0.</span>

                <span class="n">star_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star_list</span><span class="p">)</span>
                <span class="n">star_list</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">x_corr</span>
                <span class="n">star_list</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">y_corr</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">star_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star_list</span>

            <span class="c1"># follow FWHM variations</span>
            <span class="k">if</span> <span class="n">ik</span> <span class="o">&gt;</span> <span class="n">FOLLOW_NB</span> <span class="o">-</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">no_fit</span><span class="p">:</span>
                <span class="n">fwhm_mean</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">robust_median</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">utils</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">robust_mean</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sigmacut</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">fit_results</span><span class="p">[:,</span><span class="n">ik</span><span class="o">-</span><span class="n">ifol</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;fwhm_pix&#39;</span><span class="p">]))</span>
                     <span class="k">for</span> <span class="n">ifol</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">FOLLOW_NB</span><span class="p">)])</span>
                
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">fwhm_mean</span><span class="p">):</span>
                    <span class="n">fwhm_mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fwhm_pix</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fwhm_mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fwhm_pix</span>
          

            <span class="k">for</span> <span class="n">ijob</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncpus</span><span class="p">):</span>
                <span class="n">frame</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[:,:,</span><span class="n">ik</span><span class="o">+</span><span class="n">ijob</span><span class="p">])</span>
                
                <span class="c1"># add cube</span>
                <span class="k">if</span> <span class="n">add_cube</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">frame</span> <span class="o">+=</span> <span class="n">added_cube</span><span class="p">[:,:,</span><span class="n">ik</span><span class="o">+</span><span class="n">ijob</span><span class="p">]</span> <span class="o">*</span> <span class="n">added_cube_scale</span>
        
                <span class="c1"># check mask</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_mask</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">_mask_exists</span><span class="p">:</span>
                        <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get_data_frame</span><span class="p">(</span><span class="n">ik</span><span class="o">+</span><span class="n">ijob</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="n">frame</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
                        <span class="n">frame</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">mask</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="k">if</span> <span class="n">hpfilter</span><span class="p">:</span>
                    <span class="n">frame</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">high_pass_diff_image_filter</span><span class="p">(</span>
                        <span class="n">frame</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                    
                <span class="n">frames</span><span class="p">[:,:,</span><span class="n">ijob</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

            <span class="c1"># get stars photometry for each frame</span>
            <span class="n">jobs</span> <span class="o">=</span> <span class="p">[(</span><span class="n">ijob</span><span class="p">,</span> <span class="n">job_server</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
                <span class="n">utils</span><span class="o">.</span><span class="n">astrometry</span><span class="o">.</span><span class="n">fit_stars_in_frame</span><span class="p">,</span>
                <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">frames</span><span class="p">[:,:,</span><span class="n">ijob</span><span class="p">],</span> <span class="n">star_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">box_size</span><span class="p">,</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">profile_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span> <span class="n">fwhm_mean</span><span class="p">,</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">default_beta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_tol</span><span class="p">,</span> <span class="n">fwhm_min</span><span class="p">,</span>
                      <span class="n">fix_height</span><span class="p">,</span> <span class="n">fix_aperture_fwhm_pix</span><span class="p">,</span> <span class="n">fix_beta</span><span class="p">,</span> <span class="n">fix_fwhm</span><span class="p">,</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">readout_noise</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dark_current_level</span><span class="p">,</span>
                      <span class="n">local_background</span><span class="p">,</span> <span class="n">no_aperture_photometry</span><span class="p">,</span>
                      <span class="n">precise_guess</span><span class="p">,</span>
                      <span class="n">aper_coeff</span><span class="p">,</span> <span class="n">blur</span><span class="p">,</span> <span class="n">no_fit</span><span class="p">,</span> <span class="n">estimate_local_noise</span><span class="p">,</span>
                      <span class="n">multi_fit</span><span class="p">,</span> <span class="n">enable_zoom</span><span class="p">,</span> <span class="n">enable_rotation</span><span class="p">,</span> <span class="n">saturation</span><span class="p">),</span>
                <span class="n">modules</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;import orb.utils.stats&quot;</span><span class="p">,</span>
                         <span class="s2">&quot;import orb.utils.image&quot;</span><span class="p">,</span>
                         <span class="s2">&quot;import numpy as np&quot;</span><span class="p">,</span>
                         <span class="s2">&quot;import math&quot;</span><span class="p">,</span>
                         <span class="s2">&quot;import orb.cutils&quot;</span><span class="p">,</span>
                         <span class="s2">&quot;import bottleneck as bn&quot;</span><span class="p">,</span>
                         <span class="s2">&quot;import warnings&quot;</span><span class="p">,</span>
                         <span class="s2">&quot;from orb.utils.astrometry import *&quot;</span><span class="p">)))</span>
                    <span class="k">for</span> <span class="n">ijob</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncpus</span><span class="p">)]</span>

            <span class="k">for</span> <span class="n">ijob</span><span class="p">,</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">job</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">istar</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">star_list</span><span class="p">)):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">fit_results</span><span class="p">[</span><span class="n">istar</span><span class="p">,</span> <span class="n">ik</span><span class="o">+</span><span class="n">ijob</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="n">istar</span><span class="p">]</span>
                
            <span class="n">progress</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ik</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="s2">&quot;frame : &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ik</span><span class="p">))</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">_close_pp_server</span><span class="p">(</span><span class="n">job_server</span><span class="p">)</span>
        
        <span class="n">progress</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fit_results</span><span class="o">.</span><span class="n">save_stars_params</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_fit_results_path</span><span class="p">())</span>

        <span class="c1"># print reduced chi square</span>
        <span class="n">mean_red_chi_square</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">robust_mean</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sigmacut</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fit_results</span><span class="p">[:,</span> <span class="s1">&#39;reduced-chi-square&#39;</span><span class="p">]))</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_print_msg</span><span class="p">(</span><span class="s2">&quot;Mean reduced chi-square: </span><span class="si">%f</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">mean_red_chi_square</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_results</span></div>



<div class="viewcode-block" id="Astrometry.detect_stars_from_catalogue"><a class="viewcode-back" href="../../orb.html#orb.astrometry.Astrometry.detect_stars_from_catalogue">[docs]</a>    <span class="k">def</span> <span class="nf">detect_stars_from_catalogue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_star_number</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">no_save</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                    <span class="n">saturation_threshold</span><span class="o">=</span><span class="mi">35000</span><span class="p">,</span> <span class="n">realign</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Detect star positions in data from a catalogue.</span>

<span class="sd">        :param index: Minimum index of the images used for star detection.</span>
<span class="sd">        </span>
<span class="sd">        :param min_star_number: Minimum number of stars to</span>
<span class="sd">          detect. Must be greater or equal to 4 (minimum star number</span>
<span class="sd">          for any alignment process).</span>

<span class="sd">        :param no_save: if True do not save the list of detected stars</span>
<span class="sd">          in a file, only return a list (default False).</span>

<span class="sd">        :param saturation_threshold: Number of counts above which the</span>
<span class="sd">          star can be considered as saturated. Very low by default</span>
<span class="sd">          because at the ZPD the intensity of a star can be twice the</span>
<span class="sd">          intensity far from it (default 35000).</span>

<span class="sd">        :param realign: (Optional) Realign frames with a</span>
<span class="sd">          cross-correlation algorithm (default False). Much better if</span>
<span class="sd">          used on a small number of frames.</span>


<span class="sd">        :return: (star_list_path, mean_fwhm_arc) : (a path to a list</span>
<span class="sd">          of the dected stars, the mean FWHM of the stars in arcsec)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">LIMIT_RADIUS_RATIO</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="c1"># radius ratio around the center of</span>
                                 <span class="c1"># the frame where the stars are kept</span>
  
        <span class="bp">self</span><span class="o">.</span><span class="n">_print_msg</span><span class="p">(</span><span class="s2">&quot;Detecting stars from catalogue&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># during registration a star list compted from the catalogue</span>
        <span class="c1"># is created.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">()</span>

        <span class="n">deep_frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_combined_frame</span><span class="p">(</span><span class="n">realign</span><span class="o">=</span><span class="n">realign</span><span class="p">)</span>
        <span class="n">fit_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_stars_in_frame</span><span class="p">(</span><span class="n">deep_frame</span><span class="p">,</span> <span class="n">multi_fit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                             <span class="n">local_background</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                             <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        
        <span class="n">fitted_star_list</span> <span class="o">=</span> <span class="p">[[</span><span class="n">istar</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">istar</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span>
                             <span class="n">istar</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">],</span> <span class="n">istar</span><span class="p">[</span><span class="s1">&#39;snr&#39;</span><span class="p">]]</span>
                            <span class="k">for</span> <span class="n">istar</span> <span class="ow">in</span> <span class="n">fit_params</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">istar</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                                <span class="ow">and</span> <span class="n">istar</span><span class="p">[</span><span class="s1">&#39;amplitude&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">saturation_threshold</span><span class="p">)]</span>
        <span class="n">snr_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fitted_star_list</span><span class="p">)[:,</span><span class="mi">3</span><span class="p">]</span>

        <span class="c1"># remove stars in the corners of the frame</span>
        <span class="n">rcx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimx</span> <span class="o">/</span> <span class="mf">2.</span>
        <span class="n">rcy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimy</span> <span class="o">/</span> <span class="mf">2.</span>
        <span class="n">fitted_star_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">istar</span> <span class="k">for</span> <span class="n">istar</span> <span class="ow">in</span> <span class="n">fitted_star_list</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">istar</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">rcx</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span> <span class="o">+</span> <span class="p">(</span><span class="n">istar</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">rcy</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span>
                <span class="o">&lt;</span> <span class="n">LIMIT_RADIUS_RATIO</span> <span class="o">*</span> <span class="nb">min</span><span class="p">(</span><span class="n">rcx</span><span class="p">,</span> <span class="n">rcy</span><span class="p">))]</span>

        <span class="c1"># keep the brightest stars only</span>
        <span class="n">fitted_star_list</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">star</span><span class="p">:</span> <span class="n">star</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="n">star_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fitted_star_list</span><span class="p">)[:</span><span class="n">min_star_number</span><span class="p">,:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">snr_list</span> <span class="o">=</span> <span class="n">snr_list</span><span class="p">[:</span><span class="n">min_star_number</span><span class="p">]</span>
        
        <span class="c1"># write down detected stars</span>
        <span class="n">mean_fwhm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fwhm_arc</span>
        <span class="n">star_list_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_star_list_path</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">istar</span> <span class="ow">in</span> <span class="n">star_list</span><span class="p">:</span>
            <span class="n">star_list_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">istar</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">istar</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Print some comments and check number of detected stars    </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print_msg</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> stars detected&quot;</span> <span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">star_list</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print_msg</span><span class="p">(</span><span class="s2">&quot;Detected stars FWHM : </span><span class="si">%f</span><span class="s2"> pixels, </span><span class="si">%f</span><span class="s2"> arc-seconds&quot;</span><span class="o">%</span><span class="p">(</span>
            <span class="n">mean_fwhm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pix2arc</span><span class="p">(</span><span class="n">mean_fwhm</span><span class="p">)))</span>
        <span class="n">snr_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">snr_list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print_msg</span><span class="p">(</span><span class="s2">&quot;SNR Min: </span><span class="si">%.1e</span><span class="s2">, Max:</span><span class="si">%.1e</span><span class="s2">, Median:</span><span class="si">%.1e</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">snr_list</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">snr_list</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">snr_list</span><span class="p">)))</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">star_list</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_star_number</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_warning</span><span class="p">(</span>
                <span class="s2">&quot;Not enough detected stars in the image : </span><span class="si">%d</span><span class="s2">/</span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">star_list</span><span class="p">),</span> <span class="n">min_star_number</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">star_list</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span>
                <span class="s2">&quot;Not enough detected stars: </span><span class="si">%d</span><span class="s2"> &lt; 4&quot;</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">star_list</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reset_star_list</span><span class="p">(</span><span class="n">star_list</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_star_list_path</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pix2arc</span><span class="p">(</span><span class="n">mean_fwhm</span><span class="p">)</span></div>


<div class="viewcode-block" id="Astrometry.detect_all_sources"><a class="viewcode-back" href="../../orb.html#orb.astrometry.Astrometry.detect_all_sources">[docs]</a>    <span class="k">def</span> <span class="nf">detect_all_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">use_deep_frame</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">realign</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Detect all point sources in the cube regardless of there FWHM.</span>

<span class="sd">        Galaxies, HII regions, filamentary knots and stars might be</span>
<span class="sd">        detected.</span>

<span class="sd">        :param use_deep_frame: (Optional) If True a deep frame of the</span>
<span class="sd">          cube is used instead of combinig only the first frames</span>
<span class="sd">          (default False).</span>

<span class="sd">        :param realign: (Optional) Realign frames with a</span>
<span class="sd">          cross-correlation algorithm (default False). Much better if</span>
<span class="sd">          used on a small number of frames.   </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">SOURCE_SIZE</span> <span class="o">=</span> <span class="mi">2</span>

        <span class="k">def</span> <span class="nf">aggregate</span><span class="p">(</span><span class="n">init_source_list</span><span class="p">,</span> <span class="n">source_size</span><span class="p">):</span>
            
            <span class="n">px</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">init_source_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">py</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">init_source_list</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            
            <span class="n">sources</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">px</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">source</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                <span class="n">source</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">px</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">py</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="n">px</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">py</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                
                <span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">while</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">px</span><span class="p">):</span>
                    <span class="k">if</span> <span class="p">((</span><span class="nb">abs</span><span class="p">(</span><span class="n">px</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">source</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">source_size</span><span class="p">)</span>
                        <span class="ow">and</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">py</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="n">source</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">source_size</span><span class="p">)):</span>
                        <span class="n">source</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">px</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">py</span><span class="p">[</span><span class="n">ii</span><span class="p">]))</span>
                        <span class="n">px</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">ii</span><span class="p">),</span> <span class="n">py</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ii</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">source</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">source_size</span><span class="p">:</span>
                    <span class="n">xmean</span> <span class="o">=</span> <span class="mf">0.</span>
                    <span class="n">ymean</span> <span class="o">=</span> <span class="mf">0.</span>
                    <span class="k">for</span> <span class="n">ipoint</span> <span class="ow">in</span> <span class="n">source</span><span class="p">:</span>
                        <span class="n">xmean</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ipoint</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">ymean</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ipoint</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">xmean</span> <span class="o">/=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">source</span><span class="p">))</span>
                    <span class="n">ymean</span> <span class="o">/=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">source</span><span class="p">))</span>

                    <span class="n">sources</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">xmean</span><span class="p">,</span> <span class="n">ymean</span><span class="p">))</span>
                    
            <span class="k">return</span> <span class="n">sources</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_print_msg</span><span class="p">(</span><span class="s2">&quot;Detecting all point sources in the cube&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">im</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_combined_frame</span><span class="p">(</span><span class="n">use_deep_frame</span><span class="o">=</span><span class="n">use_deep_frame</span><span class="p">,</span>
                                      <span class="n">realign</span><span class="o">=</span><span class="n">realign</span><span class="p">)</span>
        
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print_msg</span><span class="p">(</span><span class="s2">&quot;Filtering master image&quot;</span><span class="p">)</span>
        <span class="n">hp_im</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">high_pass_diff_image_filter</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print_msg</span><span class="p">(</span><span class="s2">&quot;Master image filtered in </span><span class="si">{}</span><span class="s2"> s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">))</span>


        <span class="c1"># image is binned to help detection</span>
        <span class="n">binning</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fwhm_pix</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>        
        <span class="n">hp_im</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">nanbin_image</span><span class="p">(</span><span class="n">hp_im</span><span class="p">,</span> <span class="n">binning</span><span class="p">)</span>

        <span class="c1"># detect all pixels above the sky theshold</span>
        <span class="n">detected_pixels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span>
            <span class="n">hp_im</span> <span class="o">&gt;</span> <span class="mf">4.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sigmacut</span><span class="p">(</span>
                <span class="n">hp_im</span><span class="p">)))</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_print_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> detected pixels&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">detected_pixels</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
        
        <span class="c1"># pixels aggregation in sources</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print_msg</span><span class="p">(</span><span class="s1">&#39;aggregating detected pixels&#39;</span><span class="p">)</span>
        <span class="n">sources</span> <span class="o">=</span> <span class="n">aggregate</span><span class="p">(</span><span class="n">detected_pixels</span><span class="p">,</span> <span class="n">SOURCE_SIZE</span><span class="p">)</span>
            
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_print_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> sources detected&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sources</span><span class="p">)))</span>
        
        <span class="n">star_list_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_star_list_path</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">isource</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">:</span>
            <span class="n">star_list_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">isource</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">binning</span><span class="p">,</span> <span class="n">isource</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">binning</span><span class="p">))</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_star_list</span><span class="p">(</span><span class="n">sources</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_star_list_path</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">fwhm_arc</span></div>
       

<div class="viewcode-block" id="Astrometry.detect_stars"><a class="viewcode-back" href="../../orb.html#orb.astrometry.Astrometry.detect_stars">[docs]</a>    <span class="k">def</span> <span class="nf">detect_stars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_star_number</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">no_save</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                     <span class="n">saturation_threshold</span><span class="o">=</span><span class="mi">35000</span><span class="p">,</span> <span class="n">try_catalogue</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                     <span class="n">use_deep_frame</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">r_max_coeff</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span>
                     <span class="n">filter_image</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">realign</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Detect star positions in data.</span>

<span class="sd">        :param index: Minimum index of the images used for star detection.</span>
<span class="sd">        </span>
<span class="sd">        :param min_star_number: Minimum number of stars to</span>
<span class="sd">          detect. Must be greater or equal to 4 (minimum star number</span>
<span class="sd">          for any alignment process).</span>

<span class="sd">        :param no_save: (Optional) If True do not save the list of</span>
<span class="sd">          detected stars in a file, only return a list (default</span>
<span class="sd">          False).</span>

<span class="sd">        :param saturation_threshold: (Optional) Number of counts above</span>
<span class="sd">          which the star can be considered as saturated. Very low by</span>
<span class="sd">          default because at the ZPD the intensity of a star can be</span>
<span class="sd">          twice the intensity far from it (default 35000).</span>

<span class="sd">        :param try_catalogue: (Optional) If True, try to use a star</span>
<span class="sd">          catalogue (e.g. USNO-B1) to detect stars if target_ra,</span>
<span class="sd">          target_dec, target_x, target_y and wcs_rotation parameters</span>
<span class="sd">          have been given (see</span>
<span class="sd">          :py:meth:`astrometry.Astrometry.query_vizier`, default</span>
<span class="sd">          False).</span>

<span class="sd">        :param use_deep_frame: (Optional) If True a deep frame of the</span>
<span class="sd">          cube is used instead of combining only the first frames</span>
<span class="sd">          (default False).</span>

<span class="sd">        :param r_max_coeff: (Optional) Coefficient that sets the limit</span>
<span class="sd">          radius of the stars (default 0.6).</span>

<span class="sd">        :param filter_image: (Optional) If True, image is filtered</span>
<span class="sd">          before detection to remove nebulosities (default True).</span>

<span class="sd">        :param realign: (Optional) Realign frames with a</span>
<span class="sd">          cross-correlation algorithm (default False). Much better if</span>
<span class="sd">          used on a small number of frames.</span>

<span class="sd">        :return: (star_list_path, mean_fwhm_arc) : (a path to a list</span>
<span class="sd">          of the dected stars, the mean FWHM of the stars in arcsec)</span>

<span class="sd">        .. note:: Star detection walks through 2 steps:</span>
<span class="sd">        </span>
<span class="sd">           1. Preselection of 4 times the minimum number of stars to</span>
<span class="sd">              detect using a variable threshold with a filter for hot</span>
<span class="sd">              pixels and stars near the border of the image.</span>

<span class="sd">           2. Stars are fitted to test if they are &#39;real&#39; stars. The</span>
<span class="sd">              most luminous stars (that do not saturate) are</span>
<span class="sd">              eventually taken.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">define_box</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">box_size</span><span class="p">,</span><span class="n">ima</span><span class="p">):</span>
            <span class="n">minx</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">box_size</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">minx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">minx</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">maxx</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">box_size</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">maxx</span> <span class="o">&gt;</span> <span class="n">ima</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">maxx</span> <span class="o">=</span> <span class="n">ima</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">miny</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">box_size</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">miny</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">miny</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">maxy</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">box_size</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">maxy</span> <span class="o">&gt;</span> <span class="n">ima</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">:</span> <span class="n">maxy</span> <span class="o">=</span> <span class="n">ima</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">ima</span><span class="p">[</span><span class="n">minx</span><span class="p">:</span><span class="n">maxx</span><span class="p">,</span> <span class="n">miny</span><span class="p">:</span><span class="n">maxy</span><span class="p">],</span> <span class="p">[</span><span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">test_fit</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">mins</span><span class="p">,</span> <span class="n">profile_name</span><span class="p">,</span> <span class="n">fwhm_pix</span><span class="p">,</span>
                     <span class="n">default_beta</span><span class="p">,</span> <span class="n">fit_tol</span><span class="p">,</span> <span class="n">min_fwhm_coeff</span><span class="p">,</span>
                     <span class="n">saturation_threshold</span><span class="p">,</span> <span class="n">profile</span><span class="p">):</span>

            <span class="n">height</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">box</span><span class="p">)</span>

            <span class="n">params</span> <span class="o">=</span> <span class="n">fit_star</span><span class="p">(</span>
                <span class="n">box</span><span class="p">,</span> <span class="n">profile_name</span><span class="o">=</span><span class="n">profile_name</span><span class="p">,</span>
                <span class="n">fwhm_pix</span><span class="o">=</span><span class="n">fwhm_pix</span><span class="p">,</span>
                <span class="n">height</span><span class="o">=</span><span class="n">height</span><span class="p">,</span>
                <span class="n">beta</span><span class="o">=</span><span class="n">default_beta</span><span class="p">,</span> <span class="n">fix_height</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">fit_tol</span><span class="o">=</span><span class="n">fit_tol</span><span class="p">,</span>
                <span class="n">fix_beta</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">fwhm_min</span><span class="o">=</span><span class="n">min_fwhm_coeff</span> <span class="o">*</span> <span class="n">fwhm_pix</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">params</span> <span class="o">!=</span> <span class="p">[]:</span>
                <span class="c1"># eliminate possible saturated star</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;amplitude&#39;</span><span class="p">]</span>
                    <span class="o">&lt;</span> <span class="n">saturation_threshold</span><span class="p">):</span>
                    <span class="c1"># keep only a star far enough from another star or</span>
                    <span class="c1"># another bright point</span>
                    
                    <span class="c1"># 1 - remove fitted star from box</span>
                    <span class="n">box</span> <span class="o">-=</span> <span class="n">profile</span><span class="p">(</span><span class="n">params</span><span class="p">)</span><span class="o">.</span><span class="n">array2d</span><span class="p">(</span><span class="n">box</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                   <span class="n">box</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    
                    <span class="c1"># 2 - check pixels around</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">box</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;amplitude&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">3.</span><span class="p">:</span>
                        <span class="k">return</span> <span class="p">[]</span>
                  
                    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">mins</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">mins</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">[]</span>

            <span class="k">return</span> <span class="n">params</span>
           
        <span class="n">THRESHOLD_COEFF</span> <span class="o">=</span> <span class="mf">0.1</span>
        <span class="sd">&quot;&quot;&quot;Starting threshold coefficient&quot;&quot;&quot;</span>
        
        <span class="n">PRE_DETECT_COEFF</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_tuning_parameter</span><span class="p">(</span><span class="s1">&#39;PRE_DETECT_COEFF&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
        <span class="sd">&quot;&quot;&quot;Ratio of the number of pre-detected stars over the minimum</span>
<span class="sd">        number of stars&quot;&quot;&quot;</span>
        
        <span class="n">MIN_FWHM_COEFF</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="sd">&quot;&quot;&quot;Coefficient used to determine the minimum FWHM given the</span>
<span class="sd">        Rough stars FWHM. &quot;&quot;&quot;</span>

        
        <span class="c1"># TRY catalogue</span>
        <span class="k">if</span> <span class="n">try_catalogue</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_ra</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_dec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs_rotation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_stars_from_catalogue</span><span class="p">(</span>
                    <span class="n">min_star_number</span><span class="o">=</span><span class="n">min_star_number</span><span class="p">,</span> <span class="n">no_save</span><span class="o">=</span><span class="n">no_save</span><span class="p">,</span>
                    <span class="n">saturation_threshold</span><span class="o">=</span><span class="n">saturation_threshold</span><span class="p">)</span>
         

        <span class="bp">self</span><span class="o">.</span><span class="n">_print_msg</span><span class="p">(</span><span class="s2">&quot;Detecting stars&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">im</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_combined_frame</span><span class="p">(</span><span class="n">use_deep_frame</span><span class="o">=</span><span class="n">use_deep_frame</span><span class="p">,</span>
                                      <span class="n">realign</span><span class="o">=</span><span class="n">realign</span><span class="p">)</span>

        <span class="c1"># high pass filtering of the image to remove nebulosities</span>
        <span class="k">if</span> <span class="n">filter_image</span><span class="p">:</span>
            <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_msg</span><span class="p">(</span><span class="s2">&quot;Filtering master image&quot;</span><span class="p">)</span>
            <span class="n">hp_im</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">high_pass_diff_image_filter</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_msg</span><span class="p">(</span><span class="s2">&quot;Master image filtered in </span><span class="si">{}</span><span class="s2"> s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hp_im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>

        <span class="c1"># preselection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print_msg</span><span class="p">(</span><span class="s2">&quot;Stars preselection&quot;</span><span class="p">)</span>
        <span class="n">mean_hp_im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">hp_im</span><span class="p">)</span>
        <span class="n">std_hp_im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">hp_im</span><span class="p">)</span>
        <span class="n">max_im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
        <span class="c1"># +1 is just here to make sure we enter the loop</span>
        <span class="n">star_number</span> <span class="o">=</span> <span class="n">PRE_DETECT_COEFF</span> <span class="o">*</span> <span class="n">min_star_number</span> <span class="o">+</span> <span class="mi">1</span> 
        
        <span class="n">old_star_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span><span class="p">(</span><span class="n">star_number</span> <span class="o">&gt;</span> <span class="n">PRE_DETECT_COEFF</span> <span class="o">*</span> <span class="n">min_star_number</span><span class="p">):</span>
            <span class="n">pre_star_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span>
                <span class="p">(</span><span class="n">hp_im</span> <span class="o">&gt;</span> <span class="n">mean_hp_im</span> <span class="o">+</span> <span class="n">THRESHOLD_COEFF</span> <span class="o">*</span> <span class="n">std_hp_im</span><span class="p">)</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">im</span> <span class="o">&lt;</span> <span class="n">saturation_threshold</span><span class="p">)))</span>
            <span class="n">star_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">istar</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pre_star_list</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">ix</span> <span class="o">=</span> <span class="n">pre_star_list</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">istar</span><span class="p">]</span>
                <span class="n">iy</span> <span class="o">=</span> <span class="n">pre_star_list</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">istar</span><span class="p">]</span>
                <span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">mins</span><span class="p">)</span>  <span class="o">=</span> <span class="n">define_box</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span><span class="n">iy</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">box_size</span><span class="p">,</span><span class="n">im</span><span class="p">)</span>
                <span class="n">ilevel</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">]</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ilevel</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">box</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="n">ilevel</span> <span class="o">&lt;=</span> <span class="n">max_im</span><span class="p">):</span>
                    <span class="c1"># filter stars too far from the center</span>
                    <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimx</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimy</span><span class="o">/</span><span class="mf">2.</span>
                    <span class="n">r_max</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">cx</span><span class="o">**</span><span class="mf">2.</span> <span class="o">+</span> <span class="n">cy</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span> <span class="o">*</span> <span class="n">r_max_coeff</span>
                    <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">ix</span> <span class="o">-</span> <span class="n">cx</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span> <span class="o">+</span> <span class="p">(</span><span class="n">iy</span> <span class="o">-</span> <span class="n">cy</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">r_max</span><span class="p">:</span>
                        <span class="n">star_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">])</span>
                    
            <span class="n">star_number</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">star_list</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">star_number</span> <span class="o">&gt;</span> <span class="n">PRE_DETECT_COEFF</span> <span class="o">*</span> <span class="n">min_star_number</span><span class="p">:</span>
                <span class="n">old_star_list</span> <span class="o">=</span> <span class="n">star_list</span>
            <span class="n">THRESHOLD_COEFF</span> <span class="o">+=</span> <span class="mf">0.1</span>
        <span class="k">if</span> <span class="n">old_star_list</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="n">star_list</span> <span class="o">=</span> <span class="n">old_star_list</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="k">if</span> <span class="n">star_number</span> <span class="o">&lt;</span> <span class="n">min_star_number</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print_warning</span><span class="p">(</span>
                    <span class="s2">&quot;Not enough detected stars in the image : </span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">star_number</span><span class="p">)</span>
        
        <span class="c1">### FIT POSSIBLE STARS ############</span>
                
        <span class="c1"># first fit test to eliminate &quot;bad&quot; stars</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_print_msg</span><span class="p">(</span><span class="s2">&quot;Bad stars rejection based on fitting&quot;</span><span class="p">)</span>
        
        <span class="n">params_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        
        <span class="n">job_server</span><span class="p">,</span> <span class="n">ncpus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_pp_server</span><span class="p">()</span>
        
        <span class="n">progress</span> <span class="o">=</span> <span class="n">ProgressBar</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">star_list</span><span class="p">),</span> <span class="n">silent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_silent</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">istar</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">star_list</span><span class="p">),</span> <span class="n">ncpus</span><span class="p">):</span>
            
            <span class="k">if</span> <span class="n">istar</span> <span class="o">+</span> <span class="n">ncpus</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">star_list</span><span class="p">):</span>
                <span class="n">ncpus</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">star_list</span><span class="p">)</span> <span class="o">-</span> <span class="n">istar</span>

            <span class="n">jobs</span> <span class="o">=</span> <span class="p">[(</span><span class="n">ijob</span><span class="p">,</span> <span class="n">job_server</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
                <span class="n">test_fit</span><span class="p">,</span> 
                <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">define_box</span><span class="p">(</span><span class="n">star_list</span><span class="p">[</span><span class="n">istar</span><span class="o">+</span><span class="n">ijob</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                 <span class="n">star_list</span><span class="p">[</span><span class="n">istar</span><span class="o">+</span><span class="n">ijob</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">box_size</span><span class="p">,</span> <span class="n">im</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
                      <span class="n">define_box</span><span class="p">(</span><span class="n">star_list</span><span class="p">[</span><span class="n">istar</span><span class="o">+</span><span class="n">ijob</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                 <span class="n">star_list</span><span class="p">[</span><span class="n">istar</span><span class="o">+</span><span class="n">ijob</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">box_size</span><span class="p">,</span> <span class="n">im</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">profile_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fwhm_pix</span><span class="p">,</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">default_beta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_tol</span><span class="p">,</span> <span class="n">MIN_FWHM_COEFF</span><span class="p">,</span>
                      <span class="n">saturation_threshold</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile</span><span class="p">),</span>
                <span class="n">modules</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;import numpy as np&quot;</span><span class="p">,</span>
                         <span class="s2">&quot;from orb.utils.astrometry import fit_star&quot;</span><span class="p">)))</span>
                    <span class="k">for</span> <span class="n">ijob</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncpus</span><span class="p">)]</span>

            <span class="k">for</span> <span class="n">ijob</span><span class="p">,</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">:</span>
                <span class="n">params</span> <span class="o">=</span> <span class="n">job</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">params</span> <span class="o">!=</span> <span class="p">[]:</span>
                    <span class="n">params_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
            <span class="n">progress</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="n">istar</span><span class="p">,</span>
                <span class="n">info</span><span class="o">=</span><span class="s2">&quot;Fitting star </span><span class="si">%d</span><span class="s2">/</span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">istar</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">star_list</span><span class="p">)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_close_pp_server</span><span class="p">(</span><span class="n">job_server</span><span class="p">)</span>
        <span class="n">progress</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>

        <span class="c1">### FIT CHECK ##############</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print_msg</span><span class="p">(</span><span class="s2">&quot;Fit check&quot;</span><span class="p">)</span>
        
        <span class="n">fitted_star_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">fwhm_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">snr_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">params</span> <span class="ow">in</span> <span class="n">params_list</span><span class="p">:</span>
            <span class="n">fitted_star_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span>
                                     <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span> 
                                     <span class="n">params</span><span class="p">[</span><span class="s1">&#39;amplitude&#39;</span><span class="p">]))</span>
            <span class="n">fwhm_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;fwhm_pix&#39;</span><span class="p">]))</span>
            <span class="n">snr_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;snr&#39;</span><span class="p">]))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fwhm_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s2">&quot;All detected stars have been rejected !&quot;</span><span class="p">)</span>

        <span class="c1"># check FWHM value to ensure that it is a star and reject too</span>
        <span class="c1"># large or too narrow structures (e.g. galaxies and hot pixels)</span>
        <span class="n">median_fwhm</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">robust_median</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sigmacut</span><span class="p">(</span>
            <span class="n">fwhm_list</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">3.</span><span class="p">))</span>
        <span class="n">std_fwhm</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">robust_std</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sigmacut</span><span class="p">(</span>
            <span class="n">fwhm_list</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">3.</span><span class="p">))</span>
      
        <span class="n">istar</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">istar</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">fwhm_list</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">fwhm_list</span><span class="p">[</span><span class="n">istar</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">median_fwhm</span> <span class="o">+</span> <span class="mf">3.</span> <span class="o">*</span> <span class="n">std_fwhm</span><span class="p">)</span>
                <span class="ow">or</span> <span class="p">(</span><span class="n">fwhm_list</span><span class="p">[</span><span class="n">istar</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">median_fwhm</span> <span class="o">-</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">std_fwhm</span><span class="p">)</span>
                <span class="ow">or</span> <span class="n">fwhm_list</span><span class="p">[</span><span class="n">istar</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1.</span><span class="p">):</span>
                <span class="n">fitted_star_list</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">istar</span><span class="p">)</span>
                <span class="n">fwhm_list</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">istar</span><span class="p">)</span>
                <span class="n">snr_list</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">istar</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">istar</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># keep the brightest stars only</span>
        <span class="n">fitted_star_list</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">star</span><span class="p">:</span> <span class="n">star</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">star_list</span> <span class="o">=</span> <span class="n">fitted_star_list</span><span class="p">[:</span><span class="n">min_star_number</span><span class="p">]</span>

        <span class="c1"># write down detected stars</span>
        <span class="n">mean_fwhm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fwhm_list</span><span class="p">))</span>
        <span class="n">star_list_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_star_list_path</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">istar</span> <span class="ow">in</span> <span class="n">star_list</span><span class="p">:</span>
            <span class="n">star_list_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">istar</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">istar</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Print some comments and check number of detected stars    </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print_msg</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> stars detected&quot;</span> <span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">star_list</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print_msg</span><span class="p">(</span><span class="s2">&quot;Detected stars FWHM : </span><span class="si">%f</span><span class="s2"> pixels, </span><span class="si">%f</span><span class="s2"> arc-seconds&quot;</span><span class="o">%</span><span class="p">(</span>
            <span class="n">mean_fwhm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pix2arc</span><span class="p">(</span><span class="n">mean_fwhm</span><span class="p">)))</span>
        <span class="n">snr_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">snr_list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print_msg</span><span class="p">(</span><span class="s2">&quot;SNR Min: </span><span class="si">%.1e</span><span class="s2">, Max:</span><span class="si">%.1e</span><span class="s2">, Median:</span><span class="si">%.1e</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">snr_list</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">snr_list</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">snr_list</span><span class="p">)))</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">star_list</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_star_number</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_warning</span><span class="p">(</span>
                <span class="s2">&quot;Not enough detected stars in the image : </span><span class="si">%d</span><span class="s2">/</span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">star_list</span><span class="p">),</span> <span class="n">min_star_number</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">star_list</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span>
                <span class="s2">&quot;Not enough detected stars: </span><span class="si">%d</span><span class="s2"> &lt; 4&quot;</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">star_list</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reset_star_list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">star_list</span><span class="p">)[:,:</span><span class="mi">2</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_fwhm_pix</span><span class="p">(</span><span class="n">mean_fwhm</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_star_list_path</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pix2arc</span><span class="p">(</span><span class="n">mean_fwhm</span><span class="p">)</span></div>


<div class="viewcode-block" id="Astrometry.get_alignment_vectors"><a class="viewcode-back" href="../../orb.html#orb.astrometry.Astrometry.get_alignment_vectors">[docs]</a>    <span class="k">def</span> <span class="nf">get_alignment_vectors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fit_cube</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">min_coeff</span><span class="o">=</span><span class="mf">0.2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return alignement vectors</span>

<span class="sd">        :param fit_cube: (Optional) If True, the cube is fitted before</span>
<span class="sd">          using the fit results to create the alignement vectors. Else</span>
<span class="sd">          the vectors are created using the fit results already in</span>
<span class="sd">          memory (default False).</span>

<span class="sd">        :param min_coeff: The minimum proportion of stars correctly</span>
<span class="sd">            fitted to assume a good enough calculated disalignment</span>
<span class="sd">            (default 0.2).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Filter frames before alignment</span>
        <span class="n">HPFILTER</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_tuning_parameter</span><span class="p">(</span><span class="s1">&#39;HPFILTER&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span>
            <span class="s2">&quot;Some data must be loaded first&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">star_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span>
            <span class="s2">&quot;A star list must be loaded or created first&quot;</span><span class="p">)</span>
    
        <span class="k">if</span> <span class="n">fit_cube</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fit_stars_in_cube</span><span class="p">(</span><span class="n">correct_alignment</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">no_aperture_photometry</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">hpfilter</span><span class="o">=</span><span class="n">HPFILTER</span><span class="p">,</span> <span class="n">multi_fit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">fix_height</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
      
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">star_nb</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s2">&quot;Not enough stars to align properly : </span><span class="si">%d</span><span class="s2"> (must be &gt;= 3)&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">star_nb</span><span class="p">)</span>
            
        <span class="n">fit_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_results</span><span class="p">[:,:,</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
        <span class="n">fit_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_results</span><span class="p">[:,:,</span><span class="s1">&#39;y&#39;</span><span class="p">]</span>
        <span class="n">rcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_results</span><span class="p">[:,:,</span><span class="s1">&#39;reduced-chi-square&#39;</span><span class="p">]</span>
        <span class="n">fit_x_err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_results</span><span class="p">[:,:,</span><span class="s1">&#39;x_err&#39;</span><span class="p">]</span>
        <span class="n">fit_y_err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_results</span><span class="p">[:,:,</span><span class="s1">&#39;y_err&#39;</span><span class="p">]</span>
    
        <span class="n">start_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">fit_x</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]))</span>
        <span class="n">start_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">fit_y</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]))</span>

        <span class="c1"># Check if enough stars have been fitted in the first frame</span>
        <span class="n">good_nb</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">start_x</span><span class="p">))[</span><span class="mi">0</span><span class="p">])</span>
        
        <span class="k">if</span> <span class="n">good_nb</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="ow">or</span> <span class="n">good_nb</span> <span class="o">&lt;</span> <span class="n">min_coeff</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">star_nb</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s2">&quot;Not enough detected stars (</span><span class="si">%d</span><span class="s2">) in the first frame&quot;</span><span class="o">%</span><span class="n">good_nb</span><span class="p">)</span>

        <span class="c1">## Create alignment vectors from fitted positions</span>
        <span class="n">alignment_vector_x</span> <span class="o">=</span> <span class="p">((</span><span class="n">fit_x</span><span class="o">.</span><span class="n">T</span> <span class="o">-</span> <span class="n">start_x</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)[</span><span class="mi">0</span><span class="p">,:]</span>
        <span class="n">alignment_vector_y</span> <span class="o">=</span> <span class="p">((</span><span class="n">fit_y</span><span class="o">.</span><span class="n">T</span> <span class="o">-</span> <span class="n">start_y</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)[</span><span class="mi">0</span><span class="p">,:]</span>
        <span class="n">alignment_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">fit_x_err</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">**</span><span class="mf">2.</span> <span class="o">+</span> <span class="n">fit_y_err</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span>

        <span class="c1"># correct alignment vectors for NaN values</span>
        <span class="n">alignment_vector_x</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">vector</span><span class="o">.</span><span class="n">correct_vector</span><span class="p">(</span>
            <span class="n">alignment_vector_x</span><span class="p">,</span> <span class="n">polyfit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">alignment_vector_y</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">vector</span><span class="o">.</span><span class="n">correct_vector</span><span class="p">(</span>
            <span class="n">alignment_vector_y</span><span class="p">,</span> <span class="n">polyfit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

        <span class="c1"># print some info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print_msg</span><span class="p">(</span>
            <span class="s1">&#39;Alignment vectors median error: </span><span class="si">%f</span><span class="s1"> pixel&#39;</span><span class="o">%</span><span class="n">utils</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">robust_median</span><span class="p">(</span><span class="n">alignment_error</span><span class="p">))</span>
                
        <span class="k">return</span> <span class="n">alignment_vector_x</span><span class="p">,</span> <span class="n">alignment_vector_y</span><span class="p">,</span> <span class="n">alignment_error</span></div>

<div class="viewcode-block" id="Astrometry.query_vizier"><a class="viewcode-back" href="../../orb.html#orb.astrometry.Astrometry.query_vizier">[docs]</a>    <span class="k">def</span> <span class="nf">query_vizier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">catalog</span><span class="o">=</span><span class="s1">&#39;gaia&#39;</span><span class="p">,</span> <span class="n">max_stars</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of star coordinates around an object in a</span>
<span class="sd">        given radius based on a query to VizieR Services</span>
<span class="sd">        (http://vizier.u-strasbg.fr/viz-bin/VizieR)    </span>

<span class="sd">        :param catalog: (Optional) Catalog to ask on the VizieR</span>
<span class="sd">          database (see notes) (default &#39;gaia&#39;)</span>

<span class="sd">        :param max_stars: (Optional) Maximum number of row to retrieve</span>
<span class="sd">          (default 100)</span>

<span class="sd">        .. seealso:: :py:meth:`orb.utils.web.query_vizier`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fov</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_ra</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_dec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s1">&#39;No catalogue query can be done. Please make sure to give target_radec and target_xy parameter at class init&#39;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">utils</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">query_vizier</span><span class="p">(</span>
            <span class="n">radius</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_ra</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_dec</span><span class="p">,</span>
            <span class="n">catalog</span><span class="o">=</span><span class="n">catalog</span><span class="p">,</span> <span class="n">max_stars</span><span class="o">=</span><span class="n">max_stars</span><span class="p">)</span></div>


<div class="viewcode-block" id="Astrometry.register"><a class="viewcode-back" href="../../orb.html#orb.astrometry.Astrometry.register">[docs]</a>    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_stars_detect</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
                 <span class="n">full_deep_frame</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">return_fit_params</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">rscale_coeff</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span>
                 <span class="n">compute_precision</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">compute_distortion</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">realign</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_error_maps</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">return_error_spl</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register data and return a corrected pywcs.WCS</span>
<span class="sd">        object.</span>

<span class="sd">        Optionally (if return_error_maps set to True or</span>
<span class="sd">        return_error_spl set to True) 2 distortion maps used to refine</span>
<span class="sd">        a calculated SIP distortion model are returned.</span>
<span class="sd">        </span>
<span class="sd">        Precise RA/DEC positions of the stars in the field are</span>
<span class="sd">        recorded from a catalog of the VIZIER server.</span>

<span class="sd">        Using the real position of the same stars in the frame, WCS</span>
<span class="sd">        transformation parameters are optimized va a SIP model.</span>
<span class="sd">        </span>
<span class="sd">        :param max_stars_detect: (Optional) Number of detected stars</span>
<span class="sd">          in the frame for the initial wcs parameters (default 60).</span>
<span class="sd">          </span>
<span class="sd">        :param full_deep_frame: (Optional) If True all the frames of</span>
<span class="sd">          the cube are used to create a deep frame. Use it only when</span>
<span class="sd">          the frames in the cube are aligned. In the other case only</span>
<span class="sd">          the first frames are combined together (default False).</span>

<span class="sd">        :param return_fit_params: (Optional) If True return final fit</span>
<span class="sd">          parameters instead of wcs (default False).</span>

<span class="sd">        :param rscale_coeff: (Optional) Coefficient on the maximum</span>
<span class="sd">          radius of the fitted stars to compute scale. When rscale_coeff</span>
<span class="sd">          = 1, rmax is half the longer side of the image (default 1).</span>

<span class="sd">        :param compute_distortion: (Optional) If True, optical</span>
<span class="sd">          distortion (SIP) are computed. Note that a frame with a lot</span>
<span class="sd">          of stars is better for this purpose (default False).</span>

<span class="sd">        :param compute_precision: (Optional) If True, astrometrical</span>
<span class="sd">          precision is computed (default True).</span>

<span class="sd">        :param realign: (Optional) Realign frames with a</span>
<span class="sd">          cross-correlation algorithm (default False). Much better if</span>
<span class="sd">          used on a small number of frames.</span>

<span class="sd">        :param return_error_maps: (Optional) If True, error maps</span>
<span class="sd">          (200x200 pixels) on the registration are returned (default</span>
<span class="sd">          False).</span>

<span class="sd">        :param return_error_spl: (Optional) If True, error maps on the</span>
<span class="sd">          registration are returned as</span>
<span class="sd">          scipy.interpolate.RectBivariateSpline instances (default</span>
<span class="sd">          False).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">get_transformation_error</span><span class="p">(</span><span class="n">guess</span><span class="p">,</span> <span class="n">deg_list</span><span class="p">,</span> <span class="n">fit_list</span><span class="p">,</span>
                                     <span class="n">target_ra</span><span class="p">,</span> <span class="n">target_dec</span><span class="p">):</span>
            <span class="n">_wcs</span> <span class="o">=</span> <span class="n">pywcs</span><span class="o">.</span><span class="n">WCS</span><span class="p">(</span><span class="n">naxis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">_wcs</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">crpix</span> <span class="o">=</span> <span class="p">[</span><span class="n">guess</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">guess</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
            <span class="n">_wcs</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">cdelt</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">guess</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">guess</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span>
            <span class="n">_wcs</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">crval</span> <span class="o">=</span> <span class="p">[</span><span class="n">target_ra</span><span class="p">,</span> <span class="n">target_dec</span><span class="p">]</span>
            <span class="n">_wcs</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">ctype</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;RA---TAN&quot;</span><span class="p">,</span> <span class="s2">&quot;DEC--TAN&quot;</span><span class="p">]</span>
            <span class="n">_wcs</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">crota</span> <span class="o">=</span> <span class="p">[</span><span class="n">guess</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">guess</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            
            <span class="n">trans_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">istar</span> <span class="ow">in</span> <span class="n">deg_list</span><span class="p">:</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="n">_wcs</span><span class="o">.</span><span class="n">wcs_world2pix</span><span class="p">(</span><span class="n">istar</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">istar</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">trans_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

            <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">trans_list</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fit_list</span><span class="p">),</span>
                              <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">result</span><span class="p">))]</span>

        <span class="k">def</span> <span class="nf">radius_filter</span><span class="p">(</span><span class="n">star_list</span><span class="p">,</span> <span class="n">rmax</span><span class="p">,</span> <span class="n">borders</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="n">star_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">star_list</span><span class="p">)</span>
            <span class="n">star_list</span> <span class="o">=</span> <span class="p">[[</span><span class="n">star_list</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">star_list</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]]</span>
                         <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">star_list</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
            <span class="n">final_star_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">istar</span> <span class="ow">in</span> <span class="n">star_list</span><span class="p">:</span>
                <span class="n">posx</span> <span class="o">=</span> <span class="n">istar</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">;</span> <span class="n">posy</span> <span class="o">=</span> <span class="n">istar</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">posx</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimx</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span>
                              <span class="o">+</span> <span class="p">(</span><span class="n">posy</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimy</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">r</span> <span class="o">&lt;=</span> <span class="n">rmax</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">borders</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">final_star_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">posx</span><span class="p">,</span> <span class="n">posy</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">posx</span> <span class="o">&gt;</span> <span class="n">borders</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">posx</span> <span class="o">&lt;</span> <span class="n">borders</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                            <span class="ow">and</span> <span class="n">posy</span> <span class="o">&gt;</span> <span class="n">borders</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">and</span> <span class="n">posy</span> <span class="o">&lt;</span> <span class="n">borders</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
                            <span class="n">final_star_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">posx</span><span class="p">,</span> <span class="n">posy</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">final_star_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">final_star_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">final_star_list</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">world2pix</span><span class="p">(</span><span class="n">wcs</span><span class="p">,</span> <span class="n">star_list</span><span class="p">):</span>
            <span class="n">star_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">star_list</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">wcs</span><span class="o">.</span><span class="n">all_world2pix</span><span class="p">(</span>
                <span class="n">star_list</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">star_list</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>

        
        <span class="k">def</span> <span class="nf">get_filtered_params</span><span class="p">(</span><span class="n">fit_params</span><span class="p">,</span> <span class="n">snr_min</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                <span class="n">dist_min</span><span class="o">=</span><span class="mf">1e9</span><span class="p">,</span>
                                <span class="n">param</span><span class="o">=</span><span class="s1">&#39;star_list&#39;</span><span class="p">,</span>
                                <span class="n">return_index</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

            <span class="k">if</span> <span class="n">param</span> <span class="o">==</span> <span class="s1">&#39;star_list&#39;</span><span class="p">:</span>
                <span class="n">param_list</span> <span class="o">=</span> <span class="n">fit_params</span><span class="o">.</span><span class="n">get_star_list</span><span class="p">(</span><span class="n">all_params</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">param_list</span> <span class="o">=</span> <span class="n">fit_params</span><span class="p">[:,</span><span class="n">param</span><span class="p">]</span>
            <span class="n">snr</span> <span class="o">=</span> <span class="n">fit_params</span><span class="p">[:,</span><span class="s1">&#39;snr&#39;</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="n">snr_min</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">snr_min</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">robust_median</span><span class="p">(</span><span class="n">snr</span><span class="p">),</span> <span class="mf">3.</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">return_index</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">param_list</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                
            <span class="n">param_list_f</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">istar</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">param_list</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">snr</span><span class="p">[</span><span class="n">istar</span><span class="p">]):</span>
                    <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">fit_params</span><span class="p">[</span><span class="n">istar</span><span class="p">,</span><span class="s1">&#39;dx&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
                                   <span class="o">+</span> <span class="n">fit_params</span><span class="p">[</span><span class="n">istar</span><span class="p">,</span><span class="s1">&#39;dy&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">snr</span><span class="p">[</span><span class="n">istar</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">snr_min</span> <span class="ow">and</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="n">dist_min</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">param</span> <span class="o">==</span> <span class="s1">&#39;star_list&#39;</span><span class="p">:</span>
                            <span class="n">param_list_f</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param_list</span><span class="p">[</span><span class="n">istar</span><span class="p">,:])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">param_list_f</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param_list</span><span class="p">[</span><span class="n">istar</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">return_index</span><span class="p">:</span>
                            <span class="n">index</span><span class="p">[</span><span class="n">istar</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">return_index</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">param_list_f</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">param_list_f</span><span class="p">),</span> <span class="n">index</span>
        
      
        <span class="n">MIN_STAR_NB</span> <span class="o">=</span> <span class="mi">4</span> <span class="c1"># Minimum number of stars to get a correct WCS</span>

        <span class="n">XYRANGE_STEP_NB</span> <span class="o">=</span> <span class="mi">20</span> <span class="c1"># Define the number of steps for the</span>
                             <span class="c1"># brute force guess</span>
        <span class="n">XY_HIST_BINS</span> <span class="o">=</span> <span class="mi">200</span> <span class="c1"># Define the number of steps for the</span>
                           <span class="c1"># histogram registration</span>
                           
        <span class="c1"># warning: too much steps is not good. a good value is 40</span>
        <span class="c1"># steps for 12 degrees (i.e. 20 steps for 6 degrees etc.).</span>
        <span class="n">ANGLE_STEPS</span> <span class="o">=</span> <span class="mi">40</span> 
        <span class="n">ANGLE_RANGE</span> <span class="o">=</span> <span class="mi">12</span>
        <span class="n">ZOOM_RANGE_COEFF</span> <span class="o">=</span> <span class="mf">0.015</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_ra</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_dec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs_rotation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s2">&quot;Not enough parameters to register data. Please set target_xy, target_radec and wcs_rotation parameters at Astrometry init&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">return_error_maps</span> <span class="ow">and</span> <span class="n">return_error_spl</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s1">&#39;return_error_maps and return_error_spl cannot be both set to True, choose one of them&#39;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_print_msg</span><span class="p">(</span><span class="s1">&#39;Computing WCS&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_print_msg</span><span class="p">(</span><span class="s2">&quot;Initial scale: </span><span class="si">{}</span><span class="s2"> arcsec/pixel&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print_msg</span><span class="p">(</span><span class="s2">&quot;Initial rotation: </span><span class="si">{}</span><span class="s2"> degrees&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wcs_rotation</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print_msg</span><span class="p">(</span><span class="s2">&quot;Initial target position in the image (X,Y): </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">target_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_y</span><span class="p">))</span>

        <span class="c1"># get deep frame</span>
        <span class="n">deep_frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_combined_frame</span><span class="p">(</span>
            <span class="n">use_deep_frame</span><span class="o">=</span><span class="n">full_deep_frame</span><span class="p">,</span> <span class="n">realign</span><span class="o">=</span><span class="n">realign</span><span class="p">)</span>
        <span class="c1">## utils.io.write_fits(&#39;deep_frame.fits&#39;, deep_frame, overwrite=True)</span>

        <span class="n">deltax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">/</span> <span class="mf">3600.</span> <span class="c1"># arcdeg per pixel</span>
        <span class="n">deltay</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">deltax</span><span class="p">)</span>

        <span class="c1"># get FWHM</span>
        <span class="n">star_list_fit_init_path</span><span class="p">,</span> <span class="n">fwhm_arc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_stars</span><span class="p">(</span>
            <span class="n">min_star_number</span><span class="o">=</span><span class="n">max_stars_detect</span><span class="p">,</span>
            <span class="n">use_deep_frame</span><span class="o">=</span><span class="n">full_deep_frame</span><span class="p">)</span>
        <span class="n">star_list_fit_init</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_star_list</span><span class="p">(</span><span class="n">star_list_fit_init_path</span><span class="p">)</span>
        <span class="c1">## star_list_fit_init = self.load_star_list(</span>
        <span class="c1">##     &#39;./temp/data.Astrometry.star_list)&#39;</span>
        <span class="c1">## fwhm_arc= 1.</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">box_size_coeff</span> <span class="o">=</span> <span class="mf">5.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_fwhm_arc</span><span class="p">(</span><span class="n">fwhm_arc</span><span class="p">)</span>

        <span class="c1"># clean deep frame by keeping only the pixels around the</span>
        <span class="c1"># detected stars to avoid strong saturated stars.</span>
        <span class="n">deep_frame_corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">deep_frame</span><span class="p">)</span>
        <span class="n">deep_frame_corr</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">istar</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">star_list_fit_init</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">get_box_coords</span><span class="p">(</span>
                <span class="n">star_list_fit_init</span><span class="p">[</span><span class="n">istar</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="n">star_list_fit_init</span><span class="p">[</span><span class="n">istar</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fwhm_pix</span><span class="o">*</span><span class="mi">7</span><span class="p">,</span>
                <span class="mi">0</span><span class="p">,</span> <span class="n">deep_frame</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="mi">0</span><span class="p">,</span> <span class="n">deep_frame</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">deep_frame_corr</span><span class="p">[</span><span class="n">x_min</span><span class="p">:</span><span class="n">x_max</span><span class="p">,</span>
                            <span class="n">y_min</span><span class="p">:</span><span class="n">y_max</span><span class="p">]</span> <span class="o">=</span> <span class="n">deep_frame</span><span class="p">[</span><span class="n">x_min</span><span class="p">:</span><span class="n">x_max</span><span class="p">,</span>
                                                      <span class="n">y_min</span><span class="p">:</span><span class="n">y_max</span><span class="p">]</span>
        
        <span class="c1"># Query to get reference star positions in degrees</span>
        <span class="n">star_list_query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_vizier</span><span class="p">(</span><span class="n">max_stars</span><span class="o">=</span><span class="mi">100</span> <span class="o">*</span> <span class="n">max_stars_detect</span><span class="p">)</span>
        <span class="c1">## self.write_fits(&#39;star_list_query.fits&#39;, star_list_query, overwrite=True)</span>
        <span class="c1">## star_list_query = self.read_fits(&#39;star_list_query.fits&#39;)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">star_list_query</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">MIN_STAR_NB</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s2">&quot;Not enough stars found in the field (</span><span class="si">%d</span><span class="s2"> &lt; </span><span class="si">%d</span><span class="s2">)&quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">star_list_query</span><span class="p">),</span> <span class="n">MIN_STAR_NB</span><span class="p">))</span>
            
        <span class="c1"># reference star position list in degrees</span>
        <span class="n">star_list_deg</span> <span class="o">=</span> <span class="n">star_list_query</span><span class="p">[:</span><span class="n">max_stars_detect</span><span class="o">*</span><span class="mi">20</span><span class="p">]</span>

        <span class="c1">## Define a basic WCS        </span>
        <span class="n">wcs</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">astrometry</span><span class="o">.</span><span class="n">create_wcs</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">target_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_y</span><span class="p">,</span>
            <span class="n">deltax</span><span class="p">,</span> <span class="n">deltay</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_ra</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_dec</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wcs_rotation</span><span class="p">,</span> <span class="n">sip</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sip</span><span class="p">)</span>
        
        <span class="c1"># Compute initial star positions from initial transformation</span>
        <span class="c1"># parameters</span>
        <span class="n">rmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimy</span><span class="p">)</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">star_list_pix</span> <span class="o">=</span> <span class="n">radius_filter</span><span class="p">(</span>
            <span class="n">world2pix</span><span class="p">(</span><span class="n">wcs</span><span class="p">,</span> <span class="n">star_list_deg</span><span class="p">),</span> <span class="n">rmax</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_star_list</span><span class="p">(</span><span class="n">star_list_pix</span><span class="p">)</span>

        <span class="c1">## Plot star lists #####</span>
        <span class="c1">## import pylab as pl</span>
        <span class="c1">## pl.imshow(</span>
        <span class="c1">##     deep_frame.T,</span>
        <span class="c1">##     vmin=cutils.part_value(deep_frame.flatten(), 0.02),</span>
        <span class="c1">##     vmax=cutils.part_value(deep_frame.flatten(), 0.995),</span>
        <span class="c1">##     cmap=pl.gray())</span>
        <span class="c1">## pl.scatter(star_list_fit_init[:,0], star_list_fit_init[:,1])</span>
        <span class="c1">## pl.scatter(star_list_pix[:,0], star_list_pix[:,1], c=&#39;red&#39;)</span>
        <span class="c1">## pl.show()</span>
        <span class="c1">## quit()</span>

        <span class="c1"># fast histogram determination of the inital parameters</span>
        <span class="n">max_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">iangle</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">ANGLE_RANGE</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">ANGLE_RANGE</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">ANGLE_STEPS</span><span class="p">):</span>
            <span class="n">iwcs</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">astrometry</span><span class="o">.</span><span class="n">create_wcs</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">target_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_y</span><span class="p">,</span>
                <span class="n">deltax</span><span class="p">,</span> <span class="n">deltay</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_ra</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_dec</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wcs_rotation</span> <span class="o">+</span> <span class="n">iangle</span><span class="p">,</span> <span class="n">sip</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sip</span><span class="p">)</span>
            <span class="n">istar_list_pix</span> <span class="o">=</span> <span class="n">radius_filter</span><span class="p">(</span>
                <span class="n">world2pix</span><span class="p">(</span><span class="n">iwcs</span><span class="p">,</span> <span class="n">star_list_deg</span><span class="p">),</span> <span class="n">rmax</span><span class="p">)</span>

            <span class="n">max_corr</span><span class="p">,</span> <span class="n">max_dx</span><span class="p">,</span> <span class="n">max_dy</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">astrometry</span><span class="o">.</span><span class="n">histogram_registration</span><span class="p">(</span>
                <span class="n">star_list_fit_init</span><span class="p">,</span> <span class="n">istar_list_pix</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dimx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimy</span><span class="p">,</span> <span class="n">XY_HIST_BINS</span><span class="p">)</span>
            
            <span class="n">max_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">max_corr</span><span class="p">,</span> <span class="n">iangle</span><span class="p">,</span> <span class="n">max_dx</span><span class="p">,</span> <span class="n">max_dy</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_msg</span><span class="p">(</span><span class="s1">&#39;histogram check: correlation level </span><span class="si">{}</span><span class="s1">, angle </span><span class="si">{}</span><span class="s1">, dx </span><span class="si">{}</span><span class="s1">, dy </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">max_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">max_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">max_list</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">imax</span><span class="p">:</span> <span class="n">imax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_x</span> <span class="o">+=</span> <span class="n">max_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_y</span> <span class="o">+=</span> <span class="n">max_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wcs_rotation</span> <span class="o">=</span> <span class="n">max_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># update wcs</span>
        <span class="n">wcs</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">astrometry</span><span class="o">.</span><span class="n">create_wcs</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">target_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_y</span><span class="p">,</span>
            <span class="n">deltax</span><span class="p">,</span> <span class="n">deltay</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_ra</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_dec</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wcs_rotation</span><span class="p">,</span> <span class="n">sip</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sip</span><span class="p">)</span>

        <span class="n">star_list_pix</span> <span class="o">=</span> <span class="n">radius_filter</span><span class="p">(</span>
            <span class="n">world2pix</span><span class="p">(</span><span class="n">wcs</span><span class="p">,</span> <span class="n">star_list_deg</span><span class="p">),</span> <span class="n">rmax</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_star_list</span><span class="p">(</span><span class="n">star_list_pix</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_print_msg</span><span class="p">(</span>
            <span class="s2">&quot;Histogram guess of the parameters:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="o">+</span> <span class="s2">&quot;&gt; Rotation angle [in degree]: </span><span class="si">{:.3f}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wcs_rotation</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;&gt; Target position [in pixel]: (</span><span class="si">{:.3f}</span><span class="s2">, </span><span class="si">{:.3f}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">target_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_y</span><span class="p">))</span>

        <span class="c1">## brute force guess ####</span>
        <span class="n">x_range_len</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimy</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">XY_HIST_BINS</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span>
        <span class="n">y_range_len</span> <span class="o">=</span> <span class="n">x_range_len</span>
        <span class="n">r_range_len</span> <span class="o">=</span> <span class="n">ANGLE_RANGE</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">ANGLE_STEPS</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span>
        <span class="n">x_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">x_range_len</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">x_range_len</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                              <span class="n">XYRANGE_STEP_NB</span><span class="p">)</span>
        <span class="n">y_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">y_range_len</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">y_range_len</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                              <span class="n">XYRANGE_STEP_NB</span><span class="p">)</span>
        <span class="n">r_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">r_range_len</span><span class="p">,</span> <span class="n">r_range_len</span><span class="p">,</span>
                              <span class="n">ANGLE_STEPS</span><span class="p">)</span>

        <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dr</span><span class="p">,</span> <span class="n">guess_matrix</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">astrometry</span><span class="o">.</span><span class="n">brute_force_guess</span><span class="p">(</span>
            <span class="n">deep_frame_corr</span><span class="p">,</span>
            <span class="n">star_list_deg</span><span class="p">,</span> <span class="n">x_range</span><span class="p">,</span> <span class="n">y_range</span><span class="p">,</span> <span class="n">r_range</span><span class="p">,</span>
            <span class="kc">None</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fwhm_pix</span> <span class="o">*</span> <span class="mf">3.</span><span class="p">,</span> <span class="n">init_wcs</span><span class="o">=</span><span class="n">wcs</span><span class="p">)</span>
            
        <span class="c1"># refined brute force guess</span>
        <span class="n">x_range_len</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">x_range</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fwhm_pix</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span> <span class="c1"># 3 FWHM min</span>
        <span class="n">y_range_len</span> <span class="o">=</span> <span class="n">x_range_len</span>
        <span class="n">finer_angle_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">r_range</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">4.</span>
        <span class="n">finer_xy_step</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">XYRANGE_STEP_NB</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span>
                            <span class="nb">int</span><span class="p">(</span><span class="n">x_range_len</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># avoid xystep &lt; 1 pixel</span>

        
        <span class="n">x_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">dx</span><span class="o">-</span><span class="n">x_range_len</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">dx</span><span class="o">+</span><span class="n">x_range_len</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                              <span class="n">finer_xy_step</span><span class="p">)</span>
        <span class="n">y_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">dy</span><span class="o">-</span><span class="n">y_range_len</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">dy</span><span class="o">+</span><span class="n">y_range_len</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                              <span class="n">finer_xy_step</span><span class="p">)</span>
        <span class="n">r_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">dr</span><span class="o">-</span><span class="n">finer_angle_range</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">dr</span><span class="o">+</span><span class="n">finer_angle_range</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span>
                              <span class="n">ANGLE_STEPS</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>

        <span class="n">zoom_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">ZOOM_RANGE_COEFF</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span>
                                 <span class="mf">1.</span><span class="o">+</span><span class="n">ZOOM_RANGE_COEFF</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
        <span class="n">zoom_guesses</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">izoom</span> <span class="ow">in</span> <span class="n">zoom_range</span><span class="p">:</span>
            <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dr</span><span class="p">,</span> <span class="n">guess_matrix</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">astrometry</span><span class="o">.</span><span class="n">brute_force_guess</span><span class="p">(</span>
                <span class="n">deep_frame</span><span class="p">,</span>
                <span class="n">star_list_deg</span><span class="p">,</span> <span class="n">x_range</span><span class="p">,</span> <span class="n">y_range</span><span class="p">,</span> <span class="n">r_range</span><span class="p">,</span>
                <span class="kc">None</span><span class="p">,</span> <span class="n">izoom</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fwhm_pix</span> <span class="o">*</span> <span class="mf">3.</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">init_wcs</span><span class="o">=</span><span class="n">wcs</span><span class="p">,</span> <span class="n">raise_border_error</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="n">zoom_guesses</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">izoom</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dr</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">guess_matrix</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_msg</span><span class="p">(</span><span class="s1">&#39;Checking with zoom </span><span class="si">{}</span><span class="s1">: dx=</span><span class="si">{}</span><span class="s1">, dy=</span><span class="si">{}</span><span class="s1">, dr=</span><span class="si">{}</span><span class="s1">, score=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">zoom_guesses</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>

        <span class="c1"># sort brute force guesses to get the best one</span>
        <span class="n">best_guess</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">zoom_guesses</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">zoomp</span><span class="p">:</span> <span class="n">zoomp</span><span class="p">[</span><span class="mi">4</span><span class="p">])[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">wcs_rotation</span> <span class="o">-=</span> <span class="n">best_guess</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_x</span> <span class="o">-=</span> <span class="n">best_guess</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_y</span> <span class="o">-=</span> <span class="n">best_guess</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    
        <span class="n">deltax</span> <span class="o">*=</span> <span class="n">best_guess</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">deltay</span> <span class="o">*=</span> <span class="n">best_guess</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_print_msg</span><span class="p">(</span>
            <span class="s2">&quot;Brute force guess of the parameters:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="o">+</span> <span class="s2">&quot;&gt; Rotation angle [in degree]: </span><span class="si">{:.3f}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wcs_rotation</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;&gt; Target position [in pixel]: (</span><span class="si">{:.3f}</span><span class="s2">, </span><span class="si">{:.3f}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">target_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_y</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;&gt; Scale X (arcsec/pixel): </span><span class="si">{:.5f}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">deltax</span> <span class="o">*</span> <span class="mf">3600.</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;&gt; Scale Y (arcsec/pixel): </span><span class="si">{:.5f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">deltay</span> <span class="o">*</span> <span class="mf">3600.</span><span class="p">))</span>

        <span class="c1"># update wcs</span>
        <span class="n">wcs</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">astrometry</span><span class="o">.</span><span class="n">create_wcs</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">target_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_y</span><span class="p">,</span>
            <span class="n">deltax</span><span class="p">,</span> <span class="n">deltay</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_ra</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_dec</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wcs_rotation</span><span class="p">,</span> <span class="n">sip</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sip</span><span class="p">)</span>
        
        <span class="c1">############################</span>
        <span class="c1">### plot stars positions ###</span>
        <span class="c1">############################</span>
        <span class="c1">## import pylab as pl</span>
        <span class="c1">## im = pl.imshow(deep_frame.T,</span>
        <span class="c1">##                vmin=np.nanmedian(deep_frame),</span>
        <span class="c1">##                vmax=np.nanmedian(deep_frame)+50)</span>
        <span class="c1">## im.set_cmap(&#39;gray&#39;)</span>
        <span class="c1">## star_list_pix = radius_filter(</span>
        <span class="c1">##     world2pix(wcs, star_list_deg), rmax)</span>
        <span class="c1">## self.reset_star_list(star_list_pix)</span>
        <span class="c1">## pl.scatter(star_list_pix[:,0], star_list_pix[:,1],</span>
        <span class="c1">##            edgecolor=&#39;blue&#39;, linewidth=2., alpha=1.,</span>
        <span class="c1">##            facecolor=(0,0,0,0))</span>
        <span class="c1">## pl.show()</span>
                    

        <span class="c1">## COMPUTE SIP</span>
        <span class="k">if</span> <span class="n">compute_distortion</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_msg</span><span class="p">(</span><span class="s1">&#39;Computing SIP coefficients&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sip</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print_warning</span><span class="p">(</span><span class="s1">&#39;As no prior SIP has been given, this initial SIP is computed over the field inner circle. To cover the whole field the result of this registration must be passed at the definition of the class&#39;</span><span class="p">)</span>
                <span class="n">r_coeff</span> <span class="o">=</span> <span class="mf">0.5</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">r_coeff</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                
            <span class="c1"># compute optical distortion with a greater list of stars</span>
            <span class="n">rmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimy</span><span class="p">)</span> <span class="o">*</span> <span class="n">r_coeff</span>

            <span class="n">star_list_pix</span> <span class="o">=</span> <span class="n">radius_filter</span><span class="p">(</span>
                <span class="n">world2pix</span><span class="p">(</span><span class="n">wcs</span><span class="p">,</span> <span class="n">star_list_query</span><span class="p">),</span> <span class="n">rmax</span><span class="p">,</span>
                <span class="n">borders</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimy</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reset_star_list</span><span class="p">(</span><span class="n">star_list_pix</span><span class="p">)</span>
            
            <span class="n">fit_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_stars_in_frame</span><span class="p">(</span>
                <span class="n">deep_frame</span><span class="p">,</span> <span class="n">local_background</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">multi_fit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fix_fwhm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">no_aperture_photometry</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            
            <span class="c1">## SNR and DIST filter</span>
            <span class="n">star_list_fit</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">get_filtered_params</span><span class="p">(</span>
                <span class="n">fit_params</span><span class="p">,</span> <span class="n">param</span><span class="o">=</span><span class="s1">&#39;star_list&#39;</span><span class="p">,</span> <span class="n">dist_min</span><span class="o">=</span><span class="mf">15.</span><span class="p">,</span>
                <span class="n">return_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
            <span class="n">star_list_pix</span> <span class="o">=</span> <span class="n">star_list_pix</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">index</span><span class="p">)]</span>
            
            <span class="c1">############################</span>
            <span class="c1">### plot stars positions ###</span>
            <span class="c1">############################</span>
            <span class="c1">## import pylab as pl</span>
            <span class="c1">## pl.imshow(self.data.T, vmin=30, vmax=279, cmap=&#39;gray&#39;,</span>
            <span class="c1">##           interpolation=&#39;None&#39;)</span>
            <span class="c1">## pl.scatter(star_list_fit[:,0], star_list_fit[:,1],</span>
            <span class="c1">##            edgecolor=&#39;blue&#39;, linewidth=2., alpha=1.,</span>
            <span class="c1">##            facecolor=(0,0,0,0))</span>

            <span class="c1">## pl.scatter(star_list_pix[:,0], star_list_pix[:,1],</span>
            <span class="c1">##            edgecolor=&#39;red&#39;, linewidth=2., alpha=1.,</span>
            <span class="c1">##            facecolor=(0,0,0,0))</span>
            <span class="c1">## pl.show()</span>
            
            <span class="n">wcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_sip</span><span class="p">(</span><span class="n">star_list_pix</span><span class="p">,</span>
                               <span class="n">star_list_fit</span><span class="p">,</span>
                               <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">init_sip</span><span class="o">=</span><span class="n">wcs</span><span class="p">,</span>
                               <span class="n">err</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sip_order</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

            <span class="c1">## star_list_pix = wcs.all_world2pix(star_list_query[:,:2], 0)</span>
            <span class="c1">## pl.scatter(star_list_pix[:,0], star_list_pix[:,1],</span>
            <span class="c1">##            edgecolor=&#39;green&#39;, linewidth=2., alpha=1.,</span>
            <span class="c1">##            facecolor=(0,0,0,0))</span>
            
        <span class="c1"># computing distortion maps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print_msg</span><span class="p">(</span><span class="s1">&#39;Computing distortion maps&#39;</span><span class="p">)</span>
        <span class="n">r_coeff</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">rmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimy</span><span class="p">)</span> <span class="o">*</span> <span class="n">r_coeff</span>

        <span class="n">star_list_pix</span> <span class="o">=</span> <span class="n">radius_filter</span><span class="p">(</span>
            <span class="n">world2pix</span><span class="p">(</span><span class="n">wcs</span><span class="p">,</span> <span class="n">star_list_query</span><span class="p">),</span> <span class="n">rmax</span><span class="p">,</span> <span class="n">borders</span><span class="o">=</span><span class="p">[</span>
                <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimy</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_star_list</span><span class="p">(</span><span class="n">star_list_pix</span><span class="p">)</span>

        <span class="c1"># fit based on SIP corrected parameters</span>
        <span class="n">fit_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_stars_in_frame</span><span class="p">(</span>
            <span class="n">deep_frame</span><span class="p">,</span> <span class="n">local_background</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">multi_fit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fix_fwhm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">no_aperture_photometry</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">_x</span> <span class="o">=</span> <span class="n">fit_params</span><span class="p">[:,</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
        <span class="n">_y</span> <span class="o">=</span> <span class="n">fit_params</span><span class="p">[:,</span><span class="s1">&#39;y&#39;</span><span class="p">]</span>
        <span class="n">_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">_x</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimx</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span>
                     <span class="o">+</span> <span class="p">(</span><span class="n">_y</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimy</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span>

        <span class="n">_dx</span> <span class="o">=</span> <span class="n">fit_params</span><span class="p">[:,</span> <span class="s1">&#39;dx&#39;</span><span class="p">]</span>
        <span class="n">_dy</span> <span class="o">=</span> <span class="n">fit_params</span><span class="p">[:,</span> <span class="s1">&#39;dy&#39;</span><span class="p">]</span>

        <span class="c1"># filtering badly fitted stars (jumping stars)</span>
        <span class="c1">## _x[np.nonzero(np.abs(_dx) &gt; 5.)] = np.nan</span>
        <span class="c1">## _x[np.nonzero(np.abs(_dy) &gt; 5.)] = np.nan</span>
        <span class="n">_x</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">_r</span> <span class="o">&gt;</span> <span class="n">rmax</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># avoids duplicate of the same star (singular matrix error</span>
        <span class="c1"># with RBF)</span>
        <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">_x</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">_x</span> <span class="o">==</span> <span class="n">_x</span><span class="p">[</span><span class="n">ix</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                 <span class="n">_x</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="n">nonans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">_x</span><span class="p">))</span>
        <span class="n">_w</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">fit_params</span><span class="p">[:,</span> <span class="s1">&#39;x_err&#39;</span><span class="p">][</span><span class="n">nonans</span><span class="p">]</span>
        <span class="n">_x</span> <span class="o">=</span> <span class="n">fit_params</span><span class="p">[:,</span> <span class="s1">&#39;x&#39;</span><span class="p">][</span><span class="n">nonans</span><span class="p">]</span>
        <span class="n">_y</span> <span class="o">=</span> <span class="n">fit_params</span><span class="p">[:,</span> <span class="s1">&#39;y&#39;</span><span class="p">][</span><span class="n">nonans</span><span class="p">]</span>
        <span class="n">_dx</span> <span class="o">=</span> <span class="n">fit_params</span><span class="p">[:,</span> <span class="s1">&#39;dx&#39;</span><span class="p">][</span><span class="n">nonans</span><span class="p">]</span>
        <span class="n">_dy</span> <span class="o">=</span> <span class="n">fit_params</span><span class="p">[:,</span> <span class="s1">&#39;dy&#39;</span><span class="p">][</span><span class="n">nonans</span><span class="p">]</span>

        <span class="n">dxrbf</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">Rbf</span><span class="p">(</span><span class="n">_x</span><span class="p">,</span> <span class="n">_y</span><span class="p">,</span> <span class="n">_dx</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">function</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">)</span>
        <span class="n">dyrbf</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">Rbf</span><span class="p">(</span><span class="n">_x</span><span class="p">,</span> <span class="n">_y</span><span class="p">,</span> <span class="n">_dy</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">function</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">)</span>

        <span class="c1"># RBF models are converted to pixel maps and fitted with</span>
        <span class="c1"># Zernike polynomials</span>
        <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">dimx</span><span class="p">:</span><span class="mi">200</span><span class="n">j</span><span class="p">,:</span><span class="bp">self</span><span class="o">.</span><span class="n">dimy</span><span class="p">:</span><span class="mi">200</span><span class="n">j</span><span class="p">]</span>
        <span class="n">dxmap</span> <span class="o">=</span> <span class="n">dxrbf</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>
        <span class="n">dymap</span> <span class="o">=</span> <span class="n">dyrbf</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>

        <span class="n">dxmap_fit</span><span class="p">,</span> <span class="n">dxmap_res</span><span class="p">,</span> <span class="n">fit_error</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">fit_map_zernike</span><span class="p">(</span>
            <span class="n">dxmap</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">dxmap</span><span class="p">),</span> <span class="mi">20</span><span class="p">)</span>
        <span class="n">dymap_fit</span><span class="p">,</span> <span class="n">dymap_res</span><span class="p">,</span> <span class="n">fit_error</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">fit_map_zernike</span><span class="p">(</span>
            <span class="n">dymap</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">dymap</span><span class="p">),</span> <span class="mi">20</span><span class="p">)</span>

        <span class="c1"># error maps are converted to a RectBivariateSpline instance</span>
        <span class="n">dxspl</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">RectBivariateSpline</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimx</span><span class="p">,</span> <span class="n">dxmap</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimy</span><span class="p">,</span> <span class="n">dxmap</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
            <span class="n">dxmap_fit</span><span class="p">,</span> <span class="n">kx</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">ky</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        
        <span class="n">dyspl</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">RectBivariateSpline</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimx</span><span class="p">,</span> <span class="n">dymap</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimy</span><span class="p">,</span> <span class="n">dymap</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
            <span class="n">dymap_fit</span><span class="p">,</span> <span class="n">kx</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">ky</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

        <span class="c1">## import pylab as pl</span>
        <span class="c1">## pl.figure(1)</span>
        <span class="c1">## pl.imshow(dxmap.T, interpolation=&#39;none&#39;)</span>
        <span class="c1">## pl.colorbar()</span>
        <span class="c1">## pl.scatter(_x/10., _y/10.,</span>
        <span class="c1">##            edgecolor=&#39;red&#39;, linewidth=2., alpha=1.,</span>
        <span class="c1">##            facecolor=(0,0,0,0))</span>
        <span class="c1">## pl.figure(2)</span>
        <span class="c1">## pl.imshow(dymap.T, interpolation=&#39;none&#39;)</span>
        <span class="c1">## pl.colorbar()            </span>
        <span class="c1">## pl.scatter(_x/10., _y/10.,</span>
        <span class="c1">##            edgecolor=&#39;red&#39;, linewidth=2., alpha=1.,</span>
        <span class="c1">##            facecolor=(0,0,0,0))</span>
        <span class="c1">## pl.show()</span>

            
        <span class="c1">## COMPUTE PRECISION</span>
        <span class="k">if</span> <span class="n">compute_precision</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_msg</span><span class="p">(</span><span class="s1">&#39;Computing astrometrical precision&#39;</span><span class="p">)</span>

            <span class="n">rmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimy</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span>

            <span class="c1"># compute astrometrical precision with a greater list of stars</span>
            <span class="n">star_list_pix</span> <span class="o">=</span> <span class="n">radius_filter</span><span class="p">(</span>
                <span class="n">world2pix</span><span class="p">(</span><span class="n">wcs</span><span class="p">,</span> <span class="n">star_list_query</span><span class="p">),</span> <span class="n">rmax</span><span class="p">,</span> <span class="n">borders</span><span class="o">=</span><span class="p">[</span>
                    <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimy</span><span class="p">])</span>

            <span class="c1">## for checking purpose: ############################</span>
            <span class="c1">## # refine position with calculated dxmap and dymap</span>
            <span class="c1">## if dxspl is not None:</span>
            <span class="c1">##     star_list_pix_old = np.copy(star_list_pix)</span>
            <span class="c1">##     star_list_pix[:,0] += dxspl.ev(star_list_pix_old[:,0],</span>
            <span class="c1">##                                    star_list_pix_old[:,1])</span>
            <span class="c1">##     star_list_pix[:,1] += dyspl.ev(star_list_pix_old[:,0],</span>
            <span class="c1">##                                    star_list_pix_old[:,1])</span>
                
            <span class="bp">self</span><span class="o">.</span><span class="n">reset_star_list</span><span class="p">(</span><span class="n">star_list_pix</span><span class="p">)</span>

            <span class="n">fit_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_stars_in_frame</span><span class="p">(</span>
                <span class="n">deep_frame</span><span class="p">,</span> <span class="n">local_background</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">multi_fit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fix_fwhm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">no_aperture_photometry</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            
            <span class="c1">############################</span>
            <span class="c1">### plot stars positions ###</span>
            <span class="c1">############################</span>
            <span class="c1">## import pylab as pl</span>
            <span class="c1">## pl.imshow(self.data.T, vmin=30, vmax=279, cmap=&#39;gray&#39;,</span>
            <span class="c1">##           interpolation=&#39;None&#39;)</span>
            <span class="c1">## star_list_fit, index = get_filtered_params(</span>
            <span class="c1">##     fit_params, param=&#39;star_list&#39;, dist_min=15.,</span>
            <span class="c1">##     return_index=True)</span>
            <span class="c1">## star_list_pix = star_list_pix[np.nonzero(index)]</span>
            <span class="c1">## pl.scatter(star_list_fit[:,0], star_list_fit[:,1],</span>
            <span class="c1">##            edgecolor=&#39;blue&#39;, linewidth=2., alpha=1.,</span>
            <span class="c1">##            facecolor=(0,0,0,0))</span>
            <span class="c1">## pl.scatter(star_list_pix[:,0], star_list_pix[:,1],</span>
            <span class="c1">##            edgecolor=&#39;red&#39;, linewidth=2., alpha=1.,</span>
            <span class="c1">##            facecolor=(0,0,0,0))</span>
            <span class="c1">## pl.scatter(star_list_pix_old[:,0], star_list_pix_old[:,1],</span>
            <span class="c1">##            edgecolor=&#39;green&#39;, linewidth=2., alpha=1.,</span>
            <span class="c1">##            facecolor=(0,0,0,0))</span>
            <span class="c1">## pl.show()</span>

            <span class="c1"># results must be filtered for &#39;jumping&#39; stars</span>
            <span class="c1"># when fitted independantly the most brilliant stars in</span>
            <span class="c1"># the fit box gets fitted instead of the star at the</span>
            <span class="c1"># center of it. </span>
            <span class="n">dx</span> <span class="o">=</span> <span class="n">get_filtered_params</span><span class="p">(</span>
                <span class="n">fit_params</span><span class="p">,</span> <span class="n">param</span><span class="o">=</span><span class="s1">&#39;dx&#39;</span><span class="p">,</span>
                <span class="n">dist_min</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fwhm_pix</span><span class="o">*</span><span class="mf">2.</span><span class="p">)</span>
            <span class="n">dy</span> <span class="o">=</span> <span class="n">get_filtered_params</span><span class="p">(</span>
                <span class="n">fit_params</span><span class="p">,</span> <span class="n">param</span><span class="o">=</span><span class="s1">&#39;dy&#39;</span><span class="p">,</span>
                <span class="n">dist_min</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fwhm_pix</span><span class="o">*</span><span class="mf">2.</span><span class="p">)</span>
            <span class="n">x_err</span> <span class="o">=</span> <span class="n">get_filtered_params</span><span class="p">(</span>
                <span class="n">fit_params</span><span class="p">,</span> <span class="n">param</span><span class="o">=</span><span class="s1">&#39;x_err&#39;</span><span class="p">,</span>
                <span class="n">dist_min</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fwhm_pix</span><span class="o">*</span><span class="mf">2.</span><span class="p">)</span>
            <span class="n">y_err</span> <span class="o">=</span> <span class="n">get_filtered_params</span><span class="p">(</span>
                <span class="n">fit_params</span><span class="p">,</span> <span class="n">param</span><span class="o">=</span><span class="s1">&#39;y_err&#39;</span><span class="p">,</span>
                <span class="n">dist_min</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fwhm_pix</span><span class="o">*</span><span class="mf">2.</span><span class="p">)</span>

            <span class="n">precision</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dx</span><span class="o">**</span><span class="mf">2.</span> <span class="o">+</span> <span class="n">dy</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span>
            <span class="n">precision_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dx</span><span class="p">))</span><span class="o">**</span><span class="mf">2.</span>
                                     <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dy</span><span class="p">))</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span>
            <span class="n">precision_mean_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
                <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="mi">84</span><span class="p">)</span> <span class="o">-</span> <span class="n">precision_mean</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span>
                 <span class="o">+</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="n">dy</span><span class="p">,</span> <span class="mi">84</span><span class="p">)</span> <span class="o">-</span> <span class="n">precision_mean</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_print_msg</span><span class="p">(</span>
                <span class="s2">&quot;Astrometrical precision [in arcsec]: </span><span class="si">{:.3f}</span><span class="s2"> [+/-</span><span class="si">{:.3f}</span><span class="s2">] computed over </span><span class="si">{}</span><span class="s2"> stars&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">precision_mean</span> <span class="o">*</span> <span class="n">deltax</span> <span class="o">*</span> <span class="mf">3600.</span><span class="p">,</span>
                    <span class="n">precision_mean_err</span> <span class="o">*</span> <span class="n">deltax</span> <span class="o">*</span> <span class="mf">3600.</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">dx</span><span class="p">)))</span>

            <span class="c1">### PLOT ERROR ON STAR POSITIONS ###</span>
            <span class="c1">## import pylab as pl</span>
            <span class="c1">## pl.errorbar(dx * deltax * 3600.,</span>
            <span class="c1">##             dy * deltay * 3600.,</span>
            <span class="c1">##             xerr= x_err * deltax * 3600.,</span>
            <span class="c1">##             yerr= y_err * deltay * 3600.,</span>
            <span class="c1">##             linestyle=&#39;None&#39;)</span>
            <span class="c1">## circ = pl.Circle([0.,0.], radius=fwhm_arc/2.,</span>
            <span class="c1">##                  fill=False, color=&#39;g&#39;, linewidth=2.)</span>
            <span class="c1">## pl.gca().add_patch(circ)</span>
            <span class="c1">## pl.axes().set_aspect(&#39;equal&#39;)</span>
            <span class="c1">## pl.grid()</span>
            <span class="c1">## pl.xlim([-fwhm_arc/2.,fwhm_arc/2.])</span>
            <span class="c1">## pl.ylim([-fwhm_arc/2.,fwhm_arc/2.])</span>
            <span class="c1">## pl.show()</span>
       
        <span class="bp">self</span><span class="o">.</span><span class="n">_print_msg</span><span class="p">(</span>
            <span class="s2">&quot;Optimization parameters:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="o">+</span> <span class="s2">&quot;&gt; Rotation angle [in degree]: </span><span class="si">{:.3f}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wcs_rotation</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;&gt; Target position [in pixel]: (</span><span class="si">{:.3f}</span><span class="s2">, </span><span class="si">{:.3f}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">target_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_y</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;&gt; Scale X (arcsec/pixel): </span><span class="si">{:.5f}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">deltax</span> <span class="o">*</span> <span class="mf">3600.</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;&gt; Scale Y (arcsec/pixel): </span><span class="si">{:.5f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">deltay</span> <span class="o">*</span> <span class="mf">3600.</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reset_scale</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">deltax</span><span class="p">,</span> <span class="n">deltay</span><span class="p">))</span> <span class="o">*</span> <span class="mf">3600.</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_print_msg</span><span class="p">(</span><span class="s1">&#39;Corrected WCS computed&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">return_fit_params</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">return_error_maps</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">wcs</span><span class="p">,</span> <span class="n">dxmap_fit</span><span class="p">,</span> <span class="n">dymap_fit</span>
            <span class="k">elif</span> <span class="n">return_error_spl</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">wcs</span><span class="p">,</span> <span class="n">dxspl</span><span class="p">,</span> <span class="n">dyspl</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">wcs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">fit_params</span></div>


<div class="viewcode-block" id="Astrometry.fit_sip"><a class="viewcode-back" href="../../orb.html#orb.astrometry.Astrometry.fit_sip">[docs]</a>    <span class="k">def</span> <span class="nf">fit_sip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">star_list1</span><span class="p">,</span> <span class="n">star_list2</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">init_sip</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">err</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sip_order</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">crpix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">crval</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;FIT the distortion correction polynomial to match two lists</span>
<span class="sd">        of stars (the list of stars 2 is distorded to match the list</span>
<span class="sd">        of stars 1).</span>

<span class="sd">        :param star_list1: list of stars 1</span>
<span class="sd">        </span>
<span class="sd">        :param star_list2: list of stars 2</span>
<span class="sd">        </span>
<span class="sd">        :param params: (Optional) Transformation parameter to go from</span>
<span class="sd">          the list of stars 1 to the list of stars 2. Must be a tuple</span>
<span class="sd">          [dx, dy, dr, da, db, rcx, rcy, zoom_factor] (default None).</span>

<span class="sd">        :param init_sip: (Optional) Initial SIP (an astropy.wcs.WCS object,</span>
<span class="sd">          default None)</span>

<span class="sd">        :param err: (Optional) error on the star positions of the star</span>
<span class="sd">          list 2 (default None).</span>
<span class="sd">          </span>
<span class="sd">        :param sip_order: (Optional) SIP order (default 3).</span>

<span class="sd">        :param crpix: (Optional) If an initial wcs is not given (init_sip</span>
<span class="sd">          set to None) this header value must be given.</span>

<span class="sd">        :param crval: (Optional) If an initial wcs is not given (init_sip</span>
<span class="sd">          set to None) this header value must be given.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">utils</span><span class="o">.</span><span class="n">astrometry</span><span class="o">.</span><span class="n">fit_sip</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dimx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span> <span class="n">star_list1</span><span class="p">,</span> <span class="n">star_list2</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">init_sip</span><span class="o">=</span><span class="n">init_sip</span><span class="p">,</span> <span class="n">err</span><span class="o">=</span><span class="n">err</span><span class="p">,</span> <span class="n">sip_order</span><span class="o">=</span><span class="n">sip_order</span><span class="p">,</span>
            <span class="n">crpix</span><span class="o">=</span><span class="n">crpix</span><span class="p">,</span> <span class="n">crval</span><span class="o">=</span><span class="n">crval</span><span class="p">)</span></div></div>



<span class="c1">##################################################</span>
<span class="c1">#### CLASS Aligner ###############################</span>
<span class="c1">##################################################</span>
            
<div class="viewcode-block" id="Aligner"><a class="viewcode-back" href="../../orb.html#orb.astrometry.Aligner">[docs]</a><span class="k">class</span> <span class="nc">Aligner</span><span class="p">(</span><span class="n">Tools</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class is aimed to align two images of the same field of</span>
<span class="sd">    stars and correct for optical distortions.</span>

<span class="sd">    Primarily designed to align the cube of the camera 2 onto the cube</span>
<span class="sd">    of the camera 1 it can be used to align any other kind of images</span>
<span class="sd">    containing stars.</span>
<span class="sd">    &quot;&quot;&quot;</span>
 
    <span class="n">saturation_threshold</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># saturation threshold</span>

    <span class="n">image1</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># 1st image</span>
    <span class="n">image2</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># 2nd image</span>
    <span class="n">bin1</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># binning of the 1st image</span>
    <span class="n">bin2</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># binning of the 2nd image</span>
    <span class="n">pix_size1</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># pixel size of the 1st image im um</span>
    <span class="n">pix_size2</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># pixel size of the 2nd image in um</span>
    

    <span class="n">sip1</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># pywcs.WCS() instance of the 1st image</span>
    <span class="n">sip2</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># pywcs.WCS() instance of the 2nd image</span>
    
    <span class="n">astro1</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Astrometry instance of the 1st image</span>
    <span class="n">astro2</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Astrometry instance of the 2nd image</span>

    <span class="n">search_size_coeff</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Define the range of pixels around the</span>
                             <span class="c1"># initial shift values where the correct</span>
                             <span class="c1"># shift parameters have to be found</span>
                             <span class="c1"># (default 0.01).</span>
          
    <span class="c1"># transformation parameters</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">dy</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">dr</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">da</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">db</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">zoom_factor</span> <span class="o">=</span> <span class="kc">None</span>
            
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image1</span><span class="p">,</span> <span class="n">image2</span><span class="p">,</span> <span class="n">fwhm_arc</span><span class="p">,</span> <span class="n">fov1</span><span class="p">,</span> <span class="n">fov2</span><span class="p">,</span>
                 <span class="n">bin1</span><span class="p">,</span> <span class="n">bin2</span><span class="p">,</span> <span class="n">pix_size1</span><span class="p">,</span> <span class="n">pix_size2</span><span class="p">,</span>
                 <span class="n">init_angle</span><span class="p">,</span> <span class="n">init_dx</span><span class="p">,</span> <span class="n">init_dy</span><span class="p">,</span>
                 <span class="n">sip1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sip2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">saturation_threshold</span><span class="o">=</span><span class="mi">60000</span><span class="p">,</span>
                 <span class="n">project_header</span><span class="o">=</span><span class="nb">list</span><span class="p">(),</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Aligner init   </span>

<span class="sd">        :param image1: Image 1.</span>

<span class="sd">        :param image2: Image 2.</span>

<span class="sd">        :param fwhm_arc: rough FWHM of the stars in arcseconds.</span>

<span class="sd">        :param fov1: Field of view of the image 1.</span>

<span class="sd">        :param fov2: Field of view of the image 2.</span>
<span class="sd">        </span>
<span class="sd">        :param bin1: Binning of the image 1.</span>
<span class="sd">        </span>
<span class="sd">        :param bin2: Binning of the image 2.</span>

<span class="sd">        :param init_angle: Initial guess on the angle between the two</span>
<span class="sd">          images.</span>

<span class="sd">        :param init_dx: Initial guess of the translation along the X</span>
<span class="sd">          axis (in binned pixels).</span>

<span class="sd">        :param init_dy: Initial guess of the translation along the Y</span>
<span class="sd">          axis (in binned pixels).</span>

<span class="sd">        :param sip1: (Optional) A pywcs.WCS() instance containing the</span>
<span class="sd">          SIP parameters of the image 1 (default None).</span>

<span class="sd">        :param sip2: (Optional) A pywcs.WCS() instance containing the</span>
<span class="sd">          SIP parameters of the image 2 (default None).</span>

<span class="sd">        :param saturation_threshold: (Optional) Saturation threshold</span>
<span class="sd">          of the detectors in the intensity unit of the images</span>
<span class="sd">          (default 60000, for images in counts).    </span>

<span class="sd">        :param project_header: (Optional) header section to be added</span>
<span class="sd">          to each output files based on merged data (an empty list by</span>
<span class="sd">          default).</span>

<span class="sd">        :param overwrite: (Optional) If True existing FITS files will</span>
<span class="sd">          be overwritten (default False).</span>

<span class="sd">        :param kwargs: Kwargs are :meth:`core.Tools` properties.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Tools</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">overwrite</span> <span class="o">=</span> <span class="n">overwrite</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_project_header</span> <span class="o">=</span> <span class="n">project_header</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">range_coeff</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_tuning_parameter</span><span class="p">(</span>
            <span class="s1">&#39;RANGE_COEFF&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_config_parameter</span><span class="p">(</span>
            <span class="s1">&#39;ALIGNER_RANGE_COEFF&#39;</span><span class="p">))))</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">saturation_threshold</span> <span class="o">=</span> <span class="n">saturation_threshold</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">image1</span> <span class="o">=</span> <span class="n">image1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image2</span> <span class="o">=</span> <span class="n">image2</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bin1</span> <span class="o">=</span> <span class="n">bin1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bin2</span> <span class="o">=</span> <span class="n">bin2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pix_size1</span> <span class="o">=</span> <span class="n">pix_size1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pix_size2</span> <span class="o">=</span> <span class="n">pix_size2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rc</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">image2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">image2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sip1</span> <span class="o">=</span> <span class="n">sip1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sip2</span> <span class="o">=</span> <span class="n">sip2</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">zoom_factor</span> <span class="o">=</span> <span class="p">((</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pix_size2</span><span class="p">)</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bin2</span><span class="p">))</span> <span class="o">/</span> 
                            <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pix_size1</span><span class="p">)</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bin1</span><span class="p">)))</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">astro1</span> <span class="o">=</span> <span class="n">Astrometry</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image1</span><span class="p">,</span> <span class="n">fwhm_arc</span><span class="p">,</span> <span class="n">fov1</span><span class="p">,</span>
                                 <span class="n">profile_name</span><span class="o">=</span><span class="s1">&#39;gaussian&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">astro2</span> <span class="o">=</span> <span class="n">Astrometry</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image2</span><span class="p">,</span> <span class="n">fwhm_arc</span><span class="p">,</span> <span class="n">fov2</span><span class="p">,</span>
                                 <span class="n">profile_name</span><span class="o">=</span><span class="s1">&#39;gaussian&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dx</span> <span class="o">=</span> <span class="n">init_dx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dy</span> <span class="o">=</span> <span class="n">init_dy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dr</span> <span class="o">=</span> <span class="n">init_angle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">da</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="mf">0.</span>


    <span class="k">def</span> <span class="nf">_get_guess_matrix_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return path to the guess matrix&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_path_hdr</span> <span class="o">+</span> <span class="s2">&quot;guess_matrix.fits&quot;</span>

    <span class="k">def</span> <span class="nf">_get_guess_matrix_header</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return path to the guess matrix&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_basic_header</span><span class="p">(</span><span class="s1">&#39;Alignment guess matrix&#39;</span><span class="p">)</span> <span class="o">+</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_project_header</span><span class="p">)</span>
    
<div class="viewcode-block" id="Aligner.print_alignment_coeffs"><a class="viewcode-back" href="../../orb.html#orb.astrometry.Aligner.print_alignment_coeffs">[docs]</a>    <span class="k">def</span> <span class="nf">print_alignment_coeffs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print the alignement coefficients.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print_msg</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&gt; dx : &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
                        <span class="s2">&quot;&gt; dy : &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dy</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
                        <span class="s2">&quot;&gt; dr : &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dr</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
                        <span class="s2">&quot;&gt; da : &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">da</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
                        <span class="s2">&quot;&gt; db : &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">))</span></div>
    
<div class="viewcode-block" id="Aligner.compute_alignment_parameters"><a class="viewcode-back" href="../../orb.html#orb.astrometry.Aligner.compute_alignment_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">compute_alignment_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">correct_distortion</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                     <span class="n">star_list_path1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fwhm_arc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                     <span class="n">brute_force</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the alignment coefficients that match the stars of the</span>
<span class="sd">        frame 2 to the stars of the frame 1.</span>

<span class="sd">        :param correct_distortion: (Optional) If True, a SIP is computed to</span>
<span class="sd">          match stars from frame 2 onto the stars from frame 1. But it</span>
<span class="sd">          needs a lot of stars to run correctly (default False).</span>

<span class="sd">        :param star_list_path1: (Optional) Path to a list of stars in</span>
<span class="sd">          the image 1. If given the fwhm_arc must also be set (default None).</span>

<span class="sd">        :param fwhm_arc: (Optional) mean FWHM of the stars in</span>
<span class="sd">          arcseconds. Must be given if star_list_path1 is not None</span>
<span class="sd">          (default None).</span>

<span class="sd">        :param brute_force: (Optional) If True the first step is a</span>
<span class="sd">          brute force guess. This is very useful if the initial</span>
<span class="sd">          parameters are not well known (default True).</span>

<span class="sd">        .. note:: The alignement coefficients are:</span>
<span class="sd">        </span>
<span class="sd">          * dx : shift along x axis in pixels</span>
<span class="sd">          </span>
<span class="sd">          * dy : shift along y axis in pixels</span>
<span class="sd">          </span>
<span class="sd">          * dr : rotation angle between images (the center of rotation</span>
<span class="sd">            is the center of the images of the camera 1) in degrees</span>
<span class="sd">            </span>
<span class="sd">          * da : tip angle between cameras (along x axis) in degrees</span>
<span class="sd">          </span>
<span class="sd">          * db : tilt angle between cameras (along y axis) in degrees</span>

<span class="sd">        .. note:: The process tries to find the stars detected in the camera A in the frame of the camera B. It goes through 2 steps:</span>

<span class="sd">           1. Rough alignment (brute force style) only looking over</span>
<span class="sd">              dx, dy. dr is kept to its initial value (init_angle), da</span>
<span class="sd">              and db are set to 0.</span>

<span class="sd">           2. Fine alignment pass.</span>

<span class="sd">        .. warning:: This alignment process do not work if the initial</span>
<span class="sd">          parameters are too far from the real value. The angle must</span>
<span class="sd">          be known within a few degrees. The shift must be known</span>
<span class="sd">          within 4 % of the frame size (The latter can be changed</span>
<span class="sd">          using the SIZE_COEFF constant)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">match_star_lists</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">slin</span><span class="p">,</span> <span class="n">slout</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">zf</span><span class="p">,</span> <span class="n">sip1</span><span class="p">,</span> <span class="n">sip2</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;return the transformation parameters given two list of</span>
<span class="sd">            star positions.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">def</span> <span class="nf">diff</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">slin</span><span class="p">,</span> <span class="n">slout</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">zf</span><span class="p">,</span> <span class="n">sip1</span><span class="p">,</span> <span class="n">sip2</span><span class="p">):</span>
                <span class="n">slin_t</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">astrometry</span><span class="o">.</span><span class="n">transform_star_position_A_to_B</span><span class="p">(</span>
                    <span class="n">slin</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">zf</span><span class="p">,</span>
                    <span class="n">sip_A</span><span class="o">=</span><span class="n">sip1</span><span class="p">,</span> <span class="n">sip_B</span><span class="o">=</span><span class="n">sip2</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">slin_t</span> <span class="o">-</span> <span class="n">slout</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">result</span><span class="p">))]</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">fit</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">leastsq</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span>
                                       <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">slin</span><span class="p">,</span> <span class="n">slout</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">zf</span><span class="p">,</span> <span class="n">sip1</span><span class="p">,</span> <span class="n">sip2</span><span class="p">),</span>
                                       <span class="n">full_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">xtol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;No matching parameters found: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            
            <span class="k">if</span> <span class="n">fit</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">fit</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="s1">&#39;fvec&#39;</span><span class="p">]</span><span class="o">**</span><span class="mf">2.</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">match</span> <span class="o">&gt;</span> <span class="mf">1e-3</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Star lists not perfectly matched (residual </span><span class="si">{}</span><span class="s1"> &gt; 1e-3)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">match</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">fit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;No matching parameters found&#39;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">brute_force_alignment</span><span class="p">(</span><span class="n">xystep_size</span><span class="p">,</span> <span class="n">angle_range</span><span class="p">,</span> <span class="n">angle_steps</span><span class="p">,</span> <span class="n">range_coeff</span><span class="p">):</span>
            <span class="c1"># define the ranges in x and y for the rough optimization</span>
            <span class="n">x_range_len</span> <span class="o">=</span> <span class="n">range_coeff</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">astro2</span><span class="o">.</span><span class="n">dimx</span><span class="p">)</span>
            <span class="n">y_range_len</span> <span class="o">=</span> <span class="n">range_coeff</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">astro2</span><span class="o">.</span><span class="n">dimy</span><span class="p">)</span>

            <span class="n">x_hrange</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">xystep_size</span><span class="p">,</span> <span class="n">x_range_len</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">xystep_size</span><span class="p">)</span>
            <span class="n">x_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="o">-</span><span class="n">x_hrange</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">x_hrange</span><span class="p">))</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dx</span>
            
            <span class="n">y_hrange</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">xystep_size</span><span class="p">,</span> <span class="n">y_range_len</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">xystep_size</span><span class="p">)</span>
            <span class="n">y_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="o">-</span><span class="n">y_hrange</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">y_hrange</span><span class="p">))</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dy</span>
            
          
            <span class="n">r_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">angle_range</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span>
                                  <span class="n">angle_range</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span>
                                  <span class="n">angle_steps</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dr</span>

            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dr</span><span class="p">,</span> <span class="n">guess_matrix</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">utils</span><span class="o">.</span><span class="n">astrometry</span><span class="o">.</span><span class="n">brute_force_guess</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">image2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">astro1</span><span class="o">.</span><span class="n">star_list</span><span class="p">,</span>
                    <span class="n">x_range</span><span class="p">,</span> <span class="n">y_range</span><span class="p">,</span> <span class="n">r_range</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">rc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zoom_factor</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">astro2</span><span class="o">.</span><span class="n">fwhm_pix</span> <span class="o">*</span> <span class="mf">3.</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">da</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="mf">0.</span>

            <span class="c1"># Save guess matrix</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_fits</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_guess_matrix_path</span><span class="p">(),</span>
                            <span class="n">guess_matrix</span><span class="p">,</span>
                            <span class="n">fits_header</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_guess_matrix_header</span><span class="p">(),</span>
                            <span class="n">overwrite</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">overwrite</span><span class="p">)</span>

        
            
        <span class="n">ERROR_RATIO</span> <span class="o">=</span> <span class="mf">0.2</span> <span class="c1"># Minimum ratio of fitted stars once the</span>
                          <span class="c1"># optimization pass has been done. If</span>
                          <span class="c1"># the ratio of fitted stars is less than</span>
                          <span class="c1"># this ratio an error is raised.</span>

        <span class="n">WARNING_RATIO</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="c1"># If there&#39;s less than this ratio of</span>
                            <span class="c1"># fitted stars after the </span>
                            <span class="c1"># optimization pass a warning is printed.</span>

        <span class="n">WARNING_DIST</span> <span class="o">=</span> <span class="o">.</span><span class="mi">3</span> <span class="c1"># Max optimized distance in arcsec before a</span>
                          <span class="c1"># warning is raised</span>
                          
        <span class="n">ERROR_DIST</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span> <span class="n">WARNING_DIST</span> <span class="c1"># Max optimized distance in</span>
                                      <span class="c1"># arcsec before an error is</span>
                                      <span class="c1"># raised</span>
        
        <span class="n">MIN_STAR_NB</span> <span class="o">=</span> <span class="mi">30</span> <span class="c1"># Target number of star to detect to find the</span>
                         <span class="c1"># transformation parameters</span>

        <span class="n">XYSTEP_SIZE</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="c1"># Pixel step size of the search range</span>

        <span class="n">ANGLE_STEPS</span> <span class="o">=</span> <span class="mi">10</span> <span class="c1"># Angle steps for brute force guess</span>
        <span class="n">ANGLE_RANGE</span> <span class="o">=</span> <span class="mf">1.</span> <span class="c1"># Angle range for brute force guess</span>
        
        <span class="c1"># Skip fit checking</span>
        <span class="n">SKIP_CHECK</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_tuning_parameter</span><span class="p">(</span><span class="s1">&#39;SKIP_CHECK&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span>

        <span class="k">if</span> <span class="n">star_list_path1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">star_list_path1</span><span class="p">,</span> <span class="n">fwhm_arc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">astro1</span><span class="o">.</span><span class="n">detect_stars</span><span class="p">(</span>
                <span class="n">min_star_number</span><span class="o">=</span><span class="n">MIN_STAR_NB</span><span class="p">,</span>
                <span class="n">saturation_threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">saturation_threshold</span><span class="p">,</span>
                <span class="n">no_save</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">fwhm_arc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">astro1</span><span class="o">.</span><span class="n">load_star_list</span><span class="p">(</span><span class="n">star_list_path1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s1">&#39;If the path to a list of stars is given (star_list_path1) the fwhm in arcsec(fwhm_arc) must also be given.&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">astro2</span><span class="o">.</span><span class="n">reset_fwhm_arc</span><span class="p">(</span><span class="n">fwhm_arc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">astro1</span><span class="o">.</span><span class="n">reset_fwhm_arc</span><span class="p">(</span><span class="n">fwhm_arc</span><span class="p">)</span>


        <span class="c1">##########################################</span>
        <span class="c1">### BRUTE FORCE GUESS (only dx and dy) ###</span>
        <span class="c1">##########################################</span>
        <span class="k">if</span> <span class="n">brute_force</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_msg</span><span class="p">(</span><span class="s2">&quot;Brute force guess on large field&quot;</span><span class="p">)</span>
            <span class="n">brute_force_alignment</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">XYSTEP_SIZE</span><span class="p">,</span> <span class="n">ANGLE_RANGE</span><span class="p">,</span> <span class="n">ANGLE_STEPS</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">range_coeff</span><span class="o">*</span><span class="mi">10</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_msg</span><span class="p">(</span><span class="s2">&quot;Brute force guess:&quot;</span><span class="p">)</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">print_alignment_coeffs</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_print_msg</span><span class="p">(</span><span class="s2">&quot;Finer brute force guess&quot;</span><span class="p">)</span>
            <span class="n">brute_force_alignment</span><span class="p">(</span><span class="n">XYSTEP_SIZE</span><span class="p">,</span> <span class="n">ANGLE_RANGE</span><span class="p">,</span> <span class="n">ANGLE_STEPS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">range_coeff</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_msg</span><span class="p">(</span><span class="s2">&quot;Brute force guess:&quot;</span><span class="p">)</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">print_alignment_coeffs</span><span class="p">()</span>


        <span class="n">guess</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">da</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">]</span>
        
        <span class="c1">##########################</span>
        <span class="c1">## FINE ALIGNMENT STEP ###</span>
        <span class="c1">##########################</span>
        
        <span class="c1"># create sip corrected and transformed list</span>
        <span class="n">star_list2</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">astrometry</span><span class="o">.</span><span class="n">transform_star_position_A_to_B</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">astro1</span><span class="o">.</span><span class="n">star_list</span><span class="p">),</span> <span class="n">guess</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zoom_factor</span><span class="p">,</span>
            <span class="n">sip_A</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sip1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">astro2</span><span class="o">.</span><span class="n">reset_star_list</span><span class="p">(</span><span class="n">star_list2</span><span class="p">)</span>

        <span class="n">fit_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">astro2</span><span class="o">.</span><span class="n">fit_stars_in_frame</span><span class="p">(</span>
            <span class="mi">0</span><span class="p">,</span> <span class="n">no_aperture_photometry</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">multi_fit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">enable_zoom</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">enable_rotation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fix_fwhm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">sip</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sip2</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        
        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">da</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">]</span> <span class="o">=</span> <span class="n">match_star_lists</span><span class="p">(</span>
            <span class="n">guess</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">astro1</span><span class="o">.</span><span class="n">star_list</span><span class="p">),</span> <span class="n">fit_results</span><span class="o">.</span><span class="n">get_star_list</span><span class="p">(</span>
                <span class="n">all_params</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zoom_factor</span><span class="p">,</span> <span class="n">sip1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sip1</span><span class="p">,</span> <span class="n">sip2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sip2</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_print_msg</span><span class="p">(</span><span class="s2">&quot;Fine alignment parameters:&quot;</span><span class="p">)</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">print_alignment_coeffs</span><span class="p">()</span>
                

        <span class="c1">#####################################</span>
        <span class="c1">### COMPUTE DISTORTION CORRECTION ###</span>
        <span class="c1">#####################################</span>

        <span class="k">if</span> <span class="n">correct_distortion</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_msg</span><span class="p">(</span><span class="s1">&#39;Computing distortion correction polynomial (SIP)&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Must be checked. using transformation parameters with sip may not be implemented properly.&#39;</span><span class="p">)</span>
            <span class="c1"># try to detect a maximum number of stars in frame 1</span>
            <span class="n">star_list1_path1</span><span class="p">,</span> <span class="n">fwhm_arc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">astro1</span><span class="o">.</span><span class="n">detect_stars</span><span class="p">(</span>
                <span class="n">min_star_number</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span>
                <span class="n">saturation_threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">saturation_threshold</span><span class="p">,</span>
                <span class="n">no_save</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">r_max_coeff</span><span class="o">=</span><span class="mf">2.</span><span class="p">)</span>

            <span class="c1">############################</span>
            <span class="c1">### plot stars positions ###</span>
            <span class="c1">############################</span>
            <span class="c1">## import pylab as pl</span>
            <span class="c1">## im = pl.imshow(self.image1.T, vmin=0, vmax=1000)</span>
            <span class="c1">## im.set_cmap(&#39;gray&#39;)</span>
            <span class="c1">## pl.scatter(self.astro1.star_list[:,0], self.astro1.star_list[:,1],</span>
            <span class="c1">##            edgecolor=&#39;red&#39;, linewidth=2., alpha=1.,</span>
            <span class="c1">##            facecolor=(0,0,0,0))</span>
            <span class="c1">## pl.show()</span>

            <span class="n">star_list2</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">astrometry</span><span class="o">.</span><span class="n">transform_star_position_A_to_B</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">astro1</span><span class="o">.</span><span class="n">star_list</span><span class="p">),</span>
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">da</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zoom_factor</span><span class="p">,</span>
                <span class="n">sip_A</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sip1</span><span class="p">,</span> <span class="n">sip_B</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sip2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">astro2</span><span class="o">.</span><span class="n">reset_star_list</span><span class="p">(</span><span class="n">star_list2</span><span class="p">)</span>

            <span class="c1"># fit stars</span>
            <span class="n">fit_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">astro2</span><span class="o">.</span><span class="n">fit_stars_in_frame</span><span class="p">(</span>
                <span class="mi">0</span><span class="p">,</span> <span class="n">no_aperture_photometry</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">multi_fit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">enable_zoom</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">enable_rotation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                <span class="n">fix_fwhm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sip</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">err</span> <span class="o">=</span> <span class="n">fit_results</span><span class="p">[:,</span><span class="s1">&#39;x_err&#39;</span><span class="p">]</span>


            <span class="c1">## FIT SIP </span>
            <span class="c1">## SIP 1 and SIP 2 are replaced by only one SIP that matches the</span>
            <span class="c1">## stars of the frame 2 onto the stars of the frame 1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sip1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">astro1</span><span class="o">.</span><span class="n">fit_sip</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">astro1</span><span class="o">.</span><span class="n">star_list</span><span class="p">),</span>
                <span class="n">fit_results</span><span class="o">.</span><span class="n">get_star_list</span><span class="p">(</span><span class="n">all_params</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">da</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">rc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">rc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">zoom_factor</span><span class="p">],</span>
                <span class="n">init_sip</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">err</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">crpix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sip1</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">crpix</span><span class="p">,</span>
                <span class="n">crval</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sip1</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">crval</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sip2</span> <span class="o">=</span> <span class="kc">None</span>


        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># fit stars</span>
            <span class="n">fit_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">astro2</span><span class="o">.</span><span class="n">fit_stars_in_frame</span><span class="p">(</span>
                <span class="mi">0</span><span class="p">,</span> <span class="n">no_aperture_photometry</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">multi_fit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">enable_zoom</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">enable_rotation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                <span class="n">fix_fwhm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sip</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="n">fitted_star_nb</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span>
                <span class="n">fit_results</span><span class="o">.</span><span class="n">get_star_list</span><span class="p">(</span><span class="n">all_params</span><span class="o">=</span><span class="kc">True</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">])))</span>
            
            <span class="k">if</span> <span class="p">(</span><span class="n">fitted_star_nb</span> <span class="o">&lt;</span> <span class="n">ERROR_RATIO</span> <span class="o">*</span> <span class="n">MIN_STAR_NB</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s2">&quot;Not enough fitted stars in both cubes (</span><span class="si">%d%%</span><span class="s2">). Alignment parameters might be wrong.&quot;</span><span class="o">%</span><span class="nb">int</span><span class="p">(</span><span class="n">fitted_star_nb</span> <span class="o">/</span> <span class="n">MIN_STAR_NB</span> <span class="o">*</span> <span class="mf">100.</span><span class="p">))</span>
                
            <span class="k">if</span> <span class="p">(</span><span class="n">fitted_star_nb</span> <span class="o">&lt;</span> <span class="n">WARNING_RATIO</span> <span class="o">*</span> <span class="n">MIN_STAR_NB</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print_warning</span><span class="p">(</span><span class="s2">&quot;Poor ratio of fitted stars in both cubes (</span><span class="si">%d%%</span><span class="s2">). Check alignment parameters.&quot;</span><span class="o">%</span><span class="nb">int</span><span class="p">(</span><span class="n">fitted_star_nb</span> <span class="o">/</span> <span class="n">MIN_STAR_NB</span> <span class="o">*</span> <span class="mf">100.</span><span class="p">))</span>

            
            <span class="n">err</span> <span class="o">=</span> <span class="n">fit_results</span><span class="p">[:,</span><span class="s1">&#39;x_err&#39;</span><span class="p">]</span>
            
        <span class="n">star_list2</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">astrometry</span><span class="o">.</span><span class="n">transform_star_position_A_to_B</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">astro1</span><span class="o">.</span><span class="n">star_list</span><span class="p">),</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">da</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zoom_factor</span><span class="p">,</span>
            <span class="n">sip_A</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sip1</span><span class="p">,</span> <span class="n">sip_B</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sip2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">astro2</span><span class="o">.</span><span class="n">reset_star_list</span><span class="p">(</span><span class="n">star_list2</span><span class="p">)</span>

        <span class="n">fwhm_arc2</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">robust_mean</span><span class="p">(</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sigmacut</span><span class="p">(</span><span class="n">fit_results</span><span class="p">[:,</span> <span class="s1">&#39;fwhm_arc&#39;</span><span class="p">]))</span>
        
        <span class="n">dx_fit</span> <span class="o">=</span> <span class="p">(</span><span class="n">star_list2</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
                  <span class="o">-</span> <span class="n">fit_results</span><span class="o">.</span><span class="n">get_star_list</span><span class="p">(</span><span class="n">all_params</span><span class="o">=</span><span class="kc">True</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">dy_fit</span> <span class="o">=</span> <span class="p">(</span><span class="n">star_list2</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
                  <span class="o">-</span> <span class="n">fit_results</span><span class="o">.</span><span class="n">get_star_list</span><span class="p">(</span><span class="n">all_params</span><span class="o">=</span><span class="kc">True</span><span class="p">)[:,</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">dr_fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dx_fit</span><span class="o">**</span><span class="mf">2.</span> <span class="o">+</span> <span class="n">dy_fit</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span>
        <span class="n">final_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sigmacut</span><span class="p">(</span><span class="n">dr_fit</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">SKIP_CHECK</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">final_err</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">astro1</span><span class="o">.</span><span class="n">arc2pix</span><span class="p">(</span><span class="n">WARNING_DIST</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print_msg</span><span class="p">(</span><span class="s1">&#39;Mean difference on star positions: </span><span class="si">{}</span><span class="s1"> pixels = </span><span class="si">{}</span><span class="s1"> arcsec&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">final_err</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">astro1</span><span class="o">.</span><span class="n">pix2arc</span><span class="p">(</span><span class="n">final_err</span><span class="p">)))</span>
            <span class="k">elif</span> <span class="n">final_err</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">astro1</span><span class="o">.</span><span class="n">arc2pix</span><span class="p">(</span><span class="n">ERROR_DIST</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print_warning</span><span class="p">(</span><span class="s1">&#39;Mean difference on star positions is bad: </span><span class="si">{}</span><span class="s1"> pixels = </span><span class="si">{}</span><span class="s1"> arcsec&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">final_err</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">astro1</span><span class="o">.</span><span class="n">pix2arc</span><span class="p">(</span><span class="n">final_err</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s1">&#39;Mean difference on star positions is too bad: </span><span class="si">{}</span><span class="s1"> pixels = </span><span class="si">{}</span><span class="s1"> arcsec&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">final_err</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">astro1</span><span class="o">.</span><span class="n">pix2arc</span><span class="p">(</span><span class="n">final_err</span><span class="p">)))</span>
        

        <span class="c1">### PLOT ERROR ON STAR POSITIONS ###</span>
        <span class="c1">## import pylab as pl</span>
        <span class="c1">## scale = self.astro1.scale</span>
        <span class="c1">## pl.errorbar(dx_fit*scale, dy_fit*scale, xerr=err*scale,</span>
        <span class="c1">##             yerr=err*scale, linestyle=&#39;None&#39;)</span>
        <span class="c1">## circ = pl.Circle([0.,0.], radius=fwhm_arc/2.,</span>
        <span class="c1">##                  fill=False, color=&#39;g&#39;, linewidth=2.)</span>
        <span class="c1">## pl.gca().add_patch(circ)</span>
        <span class="c1">## pl.axes().set_aspect(&#39;equal&#39;)</span>
        <span class="c1">## pl.grid()</span>
        <span class="c1">## pl.xlim([-fwhm_arc/2.,fwhm_arc/2.])</span>
        <span class="c1">## pl.ylim([-fwhm_arc/2.,fwhm_arc/2.])</span>
        <span class="c1">## pl.show()</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;coeffs&#39;</span><span class="p">:[</span><span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">da</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">],</span>
                <span class="s1">&#39;rc&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">rc</span><span class="p">,</span>
                <span class="s1">&#39;zoom_factor&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zoom_factor</span><span class="p">,</span>
                <span class="s1">&#39;sip1&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sip1</span><span class="p">,</span>
                <span class="s1">&#39;sip2&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sip2</span><span class="p">,</span>
                <span class="s1">&#39;star_list1&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">astro1</span><span class="o">.</span><span class="n">star_list</span><span class="p">,</span>
                <span class="s1">&#39;star_list2&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">astro2</span><span class="o">.</span><span class="n">star_list</span><span class="p">,</span>
                <span class="s1">&#39;fwhm_arc1&#39;</span><span class="p">:</span> <span class="n">fwhm_arc</span><span class="p">,</span>
                <span class="s1">&#39;fwhm_arc2&#39;</span><span class="p">:</span> <span class="n">fwhm_arc2</span><span class="p">}</span></div></div>


</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, Author.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.5.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.8</a>
      
    </div>

    

    
  </body>
</html>
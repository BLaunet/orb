<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>orb.utils.astrometry &#8212; orb  documentation</title>
    
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for orb.utils.astrometry</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/python</span>
<span class="c1"># *-* coding: utf-8 *-*</span>
<span class="c1"># Author: Thomas Martin &lt;thomas.martin.1@ulaval.ca&gt;</span>
<span class="c1"># File: astrometry.py</span>

<span class="c1">## Copyright (c) 2010-2016 Thomas Martin &lt;thomas.martin.1@ulaval.ca&gt;</span>
<span class="c1">## </span>
<span class="c1">## This file is part of ORB</span>
<span class="c1">##</span>
<span class="c1">## ORB is free software: you can redistribute it and/or modify it</span>
<span class="c1">## under the terms of the GNU General Public License as published by</span>
<span class="c1">## the Free Software Foundation, either version 3 of the License, or</span>
<span class="c1">## (at your option) any later version.</span>
<span class="c1">##</span>
<span class="c1">## ORB is distributed in the hope that it will be useful, but WITHOUT</span>
<span class="c1">## ANY WARRANTY; without even the implied warranty of MERCHANTABILITY</span>
<span class="c1">## or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public</span>
<span class="c1">## License for more details.</span>
<span class="c1">##</span>
<span class="c1">## You should have received a copy of the GNU General Public License</span>
<span class="c1">## along with ORB.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">optimize</span><span class="p">,</span> <span class="n">interpolate</span><span class="p">,</span> <span class="n">signal</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">bottleneck</span> <span class="k">as</span> <span class="nn">bn</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">astropy.wcs</span> <span class="k">as</span> <span class="nn">pywcs</span>

<span class="kn">import</span> <span class="nn">orb.cutils</span>
<span class="kn">import</span> <span class="nn">orb.utils.stats</span>
<span class="kn">import</span> <span class="nn">orb.utils.image</span>
<span class="kn">import</span> <span class="nn">orb.utils.vector</span>
<span class="kn">import</span> <span class="nn">orb.utils.parallel</span>
<span class="kn">import</span> <span class="nn">orb.utils.misc</span>

<span class="kn">import</span> <span class="nn">copy</span>


<span class="c1">##################################################</span>
<span class="c1">#### CLASS PSF ###################################</span>
<span class="c1">##################################################</span>


<div class="viewcode-block" id="PSF"><a class="viewcode-back" href="../../../orb.utils.html#orb.utils.astrometry.PSF">[docs]</a><span class="k">class</span> <span class="nc">PSF</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;General class of inheritance for point spread functions (PSFs)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">params</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">))</span>

<div class="viewcode-block" id="PSF.array2d"><a class="viewcode-back" href="../../../orb.utils.html#orb.utils.astrometry.PSF.array2d">[docs]</a>    <span class="k">def</span> <span class="nf">array2d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a 2D profile given the size of the returned</span>
<span class="sd">        array.</span>
<span class="sd">        </span>
<span class="sd">        :param nx: Length of the returned array along x axis</span>
<span class="sd">        :param ny: Length of the returned array along y axis</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">varray2d</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">nx</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">ny</span><span class="p">))</span></div>
    
<div class="viewcode-block" id="PSF.varray2d"><a class="viewcode-back" href="../../../orb.utils.html#orb.utils.astrometry.PSF.varray2d">[docs]</a>    <span class="k">def</span> <span class="nf">varray2d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a vectorized 2D profile given the size of the returned</span>
<span class="sd">        array.</span>
<span class="sd">        </span>
<span class="sd">        :param nx: Length of the returned array along x axis</span>
<span class="sd">        :param ny: Length of the returned array along y axis</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfunction</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psf2d</span><span class="p">),</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">nx</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">ny</span><span class="p">)))</span></div></div>

    

<span class="c1">##################################################</span>
<span class="c1">#### CLASS Moffat ################################</span>
<span class="c1">##################################################</span>


<div class="viewcode-block" id="Moffat"><a class="viewcode-back" href="../../../orb.utils.html#orb.utils.astrometry.Moffat">[docs]</a><span class="k">class</span> <span class="nc">Moffat</span><span class="p">(</span><span class="n">PSF</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class implementing the Moffat profile.</span>

<span class="sd">    This profile is useful to fit stars on CCD arrays.</span>

<span class="sd">    .. note:: The Moffat profile has been first proposed by Moffat</span>
<span class="sd">      (1969) A&amp;A. The exact form of the equation used has been derived</span>
<span class="sd">      from Trujillo et al. (2001) MNRAS, 977. The PSF:</span>

<span class="sd">      :math:`f(x,y) = H + A \\times [1+(\\frac{r}{\\alpha})^2]^{-\\beta}`</span>

<span class="sd">      with,</span>
<span class="sd">      :math:`\\alpha = \\frac{\\text{FWHM}}{2\\sqrt{2^{1/\\beta} - 1}}`</span>

<span class="sd">      and,</span>
<span class="sd">      :math:`r = (x - dx)^2 + (y - dy)^2`</span>
<span class="sd">    </span>
<span class="sd">      The total flux F under the 2D profile is thus:</span>
<span class="sd">      :math:`F = A \\times \\frac{\\pi \\alpha^2}{\\beta - 1}`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">input_params</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="s1">&#39;height&#39;</span><span class="p">,</span> <span class="s1">&#39;amplitude&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;fwhm&#39;</span><span class="p">,</span> <span class="s1">&#39;beta&#39;</span><span class="p">])</span>
    <span class="sd">&quot;&quot;&quot;Keys of the input parameters&quot;&quot;&quot;</span>
    
    <span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="sd">&quot;&quot;&quot;dictionary containing the parameters of the profile&quot;&quot;&quot;</span>
    
    <span class="n">alpha</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Alpha: coefficient defined from beta and FWHM</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Init Moffat profile parameters</span>

<span class="sd">        :param params: Input parameters of the Moffat profile. Input</span>
<span class="sd">          parameters can be given as a dictionary providing {&#39;height&#39;,</span>
<span class="sd">          &#39;amplitude&#39;, &#39;x&#39;, &#39;y&#39;, &#39;fwhm&#39;, &#39;beta&#39;} or an array of 6</span>
<span class="sd">          elements stored in this order: [&#39;height&#39;, &#39;amplitude&#39;, &#39;x&#39;,</span>
<span class="sd">          &#39;y&#39;, &#39;fwhm&#39;, &#39;beta&#39;]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">MAX_BETA</span> <span class="o">=</span> <span class="mf">30.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">iterkeys</span><span class="p">()])</span>
                <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_params</span><span class="p">)</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_params</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;amplitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;amplitude&#39;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;fwhm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;fwhm&#39;</span><span class="p">]))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Input dictionary is not valid. You must provide a dictionary containing all those keys : </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_params</span><span class="p">))</span>

        <span class="k">elif</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_params</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;amplitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;fwhm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid input parameters&#39;</span><span class="p">)</span>


        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">MAX_BETA</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MAX_BETA</span>

        <span class="c1"># Computation of alpha</span>
        <span class="c1"># Beta must not be negative or too near 0</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">.</span><span class="mi">1</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;fwhm&#39;</span><span class="p">]</span>
                          <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span><span class="o">**</span><span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="mf">1.</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="p">()</span>

        <span class="c1"># 1-D PSF function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psf</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;amplitude&#39;</span><span class="p">]</span>
            <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="p">(</span><span class="n">r</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">]))</span>
        
        <span class="c1"># 2-D PSF function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psf2d</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">psf</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">])</span><span class="o">**</span><span class="mf">2.</span>
                             <span class="o">+</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])</span><span class="o">**</span><span class="mf">2.</span><span class="p">)))</span>
        

<div class="viewcode-block" id="Moffat.flux"><a class="viewcode-back" href="../../../orb.utils.html#orb.utils.astrometry.Moffat.flux">[docs]</a>    <span class="k">def</span> <span class="nf">flux</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the total flux under the 2D profile.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">1.</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;amplitude&#39;</span><span class="p">]</span>
                    <span class="o">*</span> <span class="p">((</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span>
                       <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span></div>

<div class="viewcode-block" id="Moffat.flux_error"><a class="viewcode-back" href="../../../orb.utils.html#orb.utils.astrometry.Moffat.flux_error">[docs]</a>    <span class="k">def</span> <span class="nf">flux_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amplitude_err</span><span class="p">,</span> <span class="n">width_err</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return flux error.</span>
<span class="sd">        </span>
<span class="sd">        :param amplitude_err: estimation of the amplitude error</span>
<span class="sd">        </span>
<span class="sd">        :param width_err: estimation of the width error</span>

<span class="sd">        .. warning:: Not implemented yet!</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span></div>

<div class="viewcode-block" id="Moffat.array2d"><a class="viewcode-back" href="../../../orb.utils.html#orb.utils.astrometry.Moffat.array2d">[docs]</a>    <span class="k">def</span> <span class="nf">array2d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a 2D profile given the size of the returned</span>
<span class="sd">        array.</span>
<span class="sd">        </span>
<span class="sd">        :param nx: Length of the returned array along x axis</span>
<span class="sd">        :param ny: Length of the returned array along y axis</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">orb</span><span class="o">.</span><span class="n">cutils</span><span class="o">.</span><span class="n">moffat_array2d</span><span class="p">(</span>
            <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;amplitude&#39;</span><span class="p">]),</span>
            <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]),</span>
            <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;fwhm&#39;</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">nx</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">ny</span><span class="p">)))</span></div></div>
    
<span class="c1">##################################################</span>
<span class="c1">#### CLASS Gaussian ##############################</span>
<span class="c1">##################################################</span>


<div class="viewcode-block" id="Gaussian"><a class="viewcode-back" href="../../../orb.utils.html#orb.utils.astrometry.Gaussian">[docs]</a><span class="k">class</span> <span class="nc">Gaussian</span><span class="p">(</span><span class="n">PSF</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class implementing the gaussian profile</span>

<span class="sd">    .. note:: The Gaussian profile used here is:</span>
<span class="sd">      :math:`f(x,y) = H + A \\times \exp(\\frac{-r^2}{2 W^2})`</span>

<span class="sd">      and,</span>
<span class="sd">      :math:`r = (x - dx)^2 + (y - dy)^2`</span>
<span class="sd">      </span>
<span class="sd">      The total flux F under the 2D profile is:</span>
<span class="sd">      :math:`F = 2 \\pi A W^2`</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>


    <span class="n">input_params</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="s1">&#39;height&#39;</span><span class="p">,</span> <span class="s1">&#39;amplitude&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;fwhm&#39;</span><span class="p">])</span>
    <span class="sd">&quot;&quot;&quot;Keys of the input parameters&quot;&quot;&quot;</span>
    
    <span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="sd">&quot;&quot;&quot;dictionary containing the parameters of the profile&quot;&quot;&quot;</span>
    
    <span class="n">width</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Width = FWHM / abs(2.*sqrt(2. * log(2.)))</span>


    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Init Gaussian profile parameters</span>

<span class="sd">        :param params: Input parameters of the Gaussian profile. Input</span>
<span class="sd">          parameters can be given as a dictionary providing {&#39;height&#39;,</span>
<span class="sd">          &#39;amplitude&#39;, &#39;x&#39;, &#39;y&#39;, &#39;fwhm&#39;} or an array of 5</span>
<span class="sd">          elements stored in this order: [&#39;height&#39;, &#39;amplitude&#39;, &#39;x&#39;,</span>
<span class="sd">          &#39;y&#39;, &#39;fwhm&#39;]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">iterkeys</span><span class="p">()])</span>
                <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_params</span><span class="p">)</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_params</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;amplitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;amplitude&#39;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;fwhm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;fwhm&#39;</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Input dictionary is not valid. You must provide a dictionary containing all those keys : </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_params</span><span class="p">))</span>

        <span class="k">elif</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_params</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;amplitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;fwhm&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="nb">abs</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid input parameters&#39;</span><span class="p">)</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;fwhm&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="p">()</span>


        <span class="c1"># 1-D PSF function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psf</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;amplitude&#39;</span><span class="p">]</span>
            <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="o">**</span><span class="mf">2.</span><span class="p">)))</span>
        
        <span class="c1"># 2-D PSF function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psf2d</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">psf</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">])</span><span class="o">**</span><span class="mf">2.</span>
                               <span class="o">+</span><span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])</span><span class="o">**</span><span class="mf">2.</span><span class="p">)))</span>
        

<div class="viewcode-block" id="Gaussian.flux"><a class="viewcode-back" href="../../../orb.utils.html#orb.utils.astrometry.Gaussian.flux">[docs]</a>    <span class="k">def</span> <span class="nf">flux</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the total flux under the 2D profile.</span>
<span class="sd">        </span>
<span class="sd">        The total flux F under a 2D profile is :</span>
<span class="sd">        :math:`F = 2 \\pi A W^2`</span>
<span class="sd">        </span>
<span class="sd">        .. note:: Under a 1d profile the flux is :math:`F = \\sqrt{2\\pi}A W`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="mf">2.</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;amplitude&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span></div>

<div class="viewcode-block" id="Gaussian.flux_error"><a class="viewcode-back" href="../../../orb.utils.html#orb.utils.astrometry.Gaussian.flux_error">[docs]</a>    <span class="k">def</span> <span class="nf">flux_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amplitude_err</span><span class="p">,</span> <span class="n">width_err</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return flux error.</span>
<span class="sd">        </span>
<span class="sd">        :param amplitude_err: estimation of the amplitude error</span>
<span class="sd">        </span>
<span class="sd">        :param width_err: estimation of the width error</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="p">()</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
            <span class="p">(</span><span class="n">amplitude_err</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;amplitude&#39;</span><span class="p">])</span><span class="o">**</span><span class="mf">2.</span>
            <span class="o">+</span> <span class="mf">2.</span> <span class="o">*</span> <span class="p">(</span><span class="n">width_err</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="Gaussian.array2d"><a class="viewcode-back" href="../../../orb.utils.html#orb.utils.astrometry.Gaussian.array2d">[docs]</a>    <span class="k">def</span> <span class="nf">array2d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a 2D profile given the size of the returned</span>
<span class="sd">        array.</span>
<span class="sd">        </span>
<span class="sd">        :param nx: Length of the returned array along x axis</span>
<span class="sd">        :param ny: Length of the returned array along y axis</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">orb</span><span class="o">.</span><span class="n">cutils</span><span class="o">.</span><span class="n">gaussian_array2d</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]),</span>
                                                <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;amplitude&#39;</span><span class="p">]),</span>
                                                <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]),</span>
                                                <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]),</span>
                                                <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;fwhm&#39;</span><span class="p">]),</span>
                                                <span class="nb">int</span><span class="p">(</span><span class="n">nx</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">ny</span><span class="p">)))</span></div></div>

<div class="viewcode-block" id="mag"><a class="viewcode-back" href="../../../orb.utils.html#orb.utils.astrometry.mag">[docs]</a><span class="k">def</span> <span class="nf">mag</span><span class="p">(</span><span class="n">flux</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the instrumental magnitude of a given flux (magnitude 0</span>
<span class="sd">      is set to 1 e-)</span>

<span class="sd">    :param flux: Flux in e-</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">flux</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">flux</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span></div>

<div class="viewcode-block" id="guess"><a class="viewcode-back" href="../../../orb.utils.html#orb.utils.astrometry.guess">[docs]</a><span class="k">def</span> <span class="nf">guess</span><span class="p">(</span><span class="n">star_box</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">precise_pos</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return an estimation of the star parameters.</span>

<span class="sd">    :param star_box: Sub-part of an image surrounding a star. The</span>
<span class="sd">      center of the star must be placed near the center of the</span>
<span class="sd">      box. The dimensions of the box must be greater than 3 times</span>
<span class="sd">      the FWHM of the star.</span>

<span class="sd">    :param pos: (Optional) Position guess as a tuple (x,y). Used to</span>
<span class="sd">      estimate amplitude (default None).</span>

<span class="sd">    :param height: (Optional) Guess of the background level. Used to</span>
<span class="sd">      estimate amplitude (default None).</span>

<span class="sd">    :param precise_pos: (Optional) If True, position is estimated from</span>
<span class="sd">      the marginal distribution of the PSF. Return a far better</span>
<span class="sd">      estimation if and only if the star is well centered in the box,</span>
<span class="sd">      i.e. if and only if the position of the star is already</span>
<span class="sd">      known. This can lead to errors when trying to find the star in</span>
<span class="sd">      the box, in this case precise_pos must be set to False (default</span>
<span class="sd">      False).</span>

<span class="sd">    :return: [height,amplitude,x,y,width]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">pos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">x_guess</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">y_guess</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Estimation of the position from the marginal distribution of the psf</span>
        <span class="c1"># [e.g. Howell 2006]</span>
        <span class="k">if</span> <span class="n">precise_pos</span><span class="p">:</span>
            <span class="n">box_dimx</span> <span class="o">=</span> <span class="n">star_box</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">box_dimy</span> <span class="o">=</span> <span class="n">star_box</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">Ii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">star_box</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">Jj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">star_box</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">I</span> <span class="o">=</span> <span class="n">Ii</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">Ii</span><span class="p">)</span>
            <span class="n">nzi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">I</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">J</span> <span class="o">=</span> <span class="n">Jj</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">Jj</span><span class="p">)</span>
            <span class="n">nzj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">J</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">x_guess</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">I</span><span class="p">[</span><span class="n">nzi</span><span class="p">])</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">box_dimx</span><span class="p">)[</span><span class="n">nzi</span><span class="p">])</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">I</span><span class="p">[</span><span class="n">nzi</span><span class="p">])</span>
            <span class="n">y_guess</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">J</span><span class="p">[</span><span class="n">nzj</span><span class="p">])</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">box_dimy</span><span class="p">)[</span><span class="n">nzj</span><span class="p">])</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">J</span><span class="p">[</span><span class="n">nzj</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">x_guess</span><span class="p">):</span>
                <span class="n">x_guess</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">star_box</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y_guess</span><span class="p">):</span>
                <span class="n">y_guess</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">star_box</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x_guess</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">star_box</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">y_guess</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">star_box</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
            
    <span class="k">if</span> <span class="n">height</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">h_guess</span> <span class="o">=</span> <span class="n">height</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">h_guess</span> <span class="o">=</span> <span class="n">sky_background_level</span><span class="p">(</span><span class="n">star_box</span><span class="p">)</span>
        
    <span class="n">a_guess</span> <span class="o">=</span> <span class="n">star_box</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x_guess</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">y_guess</span><span class="p">)]</span> <span class="o">-</span> <span class="n">h_guess</span>
    <span class="n">fwhm_guess</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">star_box</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span> <span class="o">*</span> <span class="mf">0.2</span>
    
    <span class="k">return</span> <span class="p">[</span><span class="n">h_guess</span><span class="p">,</span><span class="n">a_guess</span><span class="p">,</span><span class="n">x_guess</span><span class="p">,</span><span class="n">y_guess</span><span class="p">,</span><span class="n">fwhm_guess</span><span class="p">]</span></div>


<div class="viewcode-block" id="fit_star"><a class="viewcode-back" href="../../../orb.utils.html#orb.utils.astrometry.fit_star">[docs]</a><span class="k">def</span> <span class="nf">fit_star</span><span class="p">(</span><span class="n">star_box</span><span class="p">,</span> <span class="n">profile_name</span><span class="o">=</span><span class="s1">&#39;gaussian&#39;</span><span class="p">,</span> <span class="n">fwhm_pix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">amp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mf">3.5</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">fix_height</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fix_amp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fix_beta</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
             <span class="n">fix_fwhm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fix_pos</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
             <span class="n">fit_tol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fwhm_min</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
             <span class="n">check_reject</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ron</span><span class="o">=</span><span class="mf">10.</span><span class="p">,</span> <span class="n">dcl</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
             <span class="n">estimate_local_noise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">precise_guess</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
             <span class="n">saturation</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Fit a single star</span>

<span class="sd">    :param star_box: The box where the star has to be fitted.</span>

<span class="sd">    :param profile_name: (Optional) Name of the PSF profile to use to</span>
<span class="sd">      fit stars. May be &#39;gaussian&#39; or &#39;moffat&#39; (default &#39;gaussian&#39;).</span>

<span class="sd">    :param amp: (Optional) Amplitude guess, replace the value of the</span>
<span class="sd">      automatic estimation (default None).</span>

<span class="sd">    :param fwhm_pix: (Optional) Estimate of the FWHM in pixels. If</span>
<span class="sd">      None given FWHM is estimated to half the box size (default</span>
<span class="sd">      None).</span>
<span class="sd">      </span>
<span class="sd">    :param beta: (Optional) Beta parameter of the moffat psf. Used</span>
<span class="sd">      only if the fitted profile is a Moffat psf (default 3.5).</span>

<span class="sd">    :param height: (Optional) Height guess, replace the value of the</span>
<span class="sd">      automatic estimation (default None).</span>

<span class="sd">    :param pos: (Optional) Position guess as a tuple (x,y), replace</span>
<span class="sd">      the value of the automatic estimation (default None).</span>

<span class="sd">    :param fix_amp: (Optional) Fix amplitude parameter to its</span>
<span class="sd">      estimation (default False)</span>

<span class="sd">    :param fix_height: (Optional) Fix height parameter to its</span>
<span class="sd">      estimation (default False)</span>

<span class="sd">    :param fix_beta: (Optional) Fix beta to the given value (default</span>
<span class="sd">      True).</span>

<span class="sd">    :param fix_fwhm: (Optional) Fix FWHM to its estimation (default</span>
<span class="sd">      False).</span>
<span class="sd">      </span>
<span class="sd">    :param fix_pos: (Optional) Fix position parameters (x,y) at their</span>
<span class="sd">      estimated value (default False).</span>

<span class="sd">    :param fit_tol: (Optional) Tolerance on the paramaters fit (the</span>
<span class="sd">      lower the better but the longer too) (default 1e-2).</span>

<span class="sd">    :param check: (Optional) If True, check fit results for oddities</span>
<span class="sd">      (default True).</span>

<span class="sd">    :param fwhm_min: (Optional) Minimum valid FWHM [in pixel] of the</span>
<span class="sd">      fitted star (default 0.5)</span>

<span class="sd">    :param check_reject: (Optional) [Debug] If True, print the reason</span>
<span class="sd">      why a fit is rejected (default False).</span>

<span class="sd">    :param ron: (Optional) Readout noise in ADU/pixel (default</span>
<span class="sd">      10.). estimate_local_noise must be set to False for this noise</span>
<span class="sd">      to be taken into account.</span>

<span class="sd">    :param dcl: (Optional) Dark current level in ADU/pixel (default</span>
<span class="sd">      0.). estimate_local_noise must be set to False for this noise to</span>
<span class="sd">      be taken into account.</span>

<span class="sd">    :param estimate_local_noise: (Optional) If True, the level of</span>
<span class="sd">      noise is computed from the background pixels around the</span>
<span class="sd">      stars. ron and dcl are thus not used (default True).</span>

<span class="sd">    :param precise_guess: (Optional) If True, the fit guess will be</span>
<span class="sd">      more precise but this can lead to errors if the stars positions</span>
<span class="sd">      are not already well known (default False).</span>

<span class="sd">    :param saturation: (Optional) If not None, all pixels above the</span>
<span class="sd">      saturation level are removed from the fit (default None).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">get_background_noise</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">fwhm</span><span class="p">,</span> <span class="n">posx</span><span class="p">,</span> <span class="n">posy</span><span class="p">):</span>
        <span class="n">FWHM_SKY_COEFF</span> <span class="o">=</span> <span class="mf">1.5</span>
        <span class="n">SUB_DIV</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="c1"># background noise is computed from the std of &#39;sky&#39;</span>
        <span class="c1"># pixels around the object. The poisson noise is removed</span>
        <span class="c1"># because it is added when the real sigma is calculated.</span>
        <span class="k">if</span> <span class="n">fwhm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># if FWHM is known sky pixels are considered to be at more</span>
            <span class="c1"># than 3 sigma of the guessed star position</span>
            <span class="n">S_sky</span> <span class="o">=</span> <span class="n">orb</span><span class="o">.</span><span class="n">cutils</span><span class="o">.</span><span class="n">surface_value</span><span class="p">(</span>
                <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">posx</span><span class="p">,</span> <span class="n">posy</span><span class="p">,</span> <span class="n">FWHM_SKY_COEFF</span> <span class="o">*</span> <span class="n">fwhm</span><span class="p">,</span>
                <span class="nb">max</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">SUB_DIV</span><span class="p">)</span>
            <span class="n">sky_pixels</span> <span class="o">=</span> <span class="n">data</span> <span class="o">*</span> <span class="n">S_sky</span>
            <span class="n">sky_pixels</span> <span class="o">=</span> <span class="n">sky_pixels</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">sky_pixels</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># else a sigma cut is made over the pixels to remove too</span>
            <span class="c1"># high values</span>
            <span class="n">sky_pixels</span> <span class="o">=</span> <span class="n">orb</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sigmacut</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">4.</span><span class="p">)</span>

        <span class="n">mean_sky</span> <span class="o">=</span> <span class="n">orb</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">robust_mean</span><span class="p">(</span><span class="n">orb</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sigmacut</span><span class="p">(</span>
            <span class="n">sky_pixels</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">4.</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">mean_sky</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">mean_sky</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">background_noise</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">orb</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">robust_std</span><span class="p">(</span><span class="n">sky_pixels</span><span class="p">)</span>
            <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_sky</span><span class="p">))</span>
   
        <span class="k">return</span> <span class="n">background_noise</span>
        
    <span class="k">def</span> <span class="nf">sigma</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ron</span><span class="p">,</span> <span class="n">dcl</span><span class="p">):</span>
        <span class="c1"># guessing sigma as sqrt(photon noise + readout noise^2 + dark</span>
        <span class="c1"># current level)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">ron</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span> <span class="o">+</span> <span class="n">dcl</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">diff</span><span class="p">(</span><span class="n">free_p</span><span class="p">,</span> <span class="n">free_i</span><span class="p">,</span> <span class="n">fixed_p</span><span class="p">,</span> <span class="n">profile</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="n">saturation</span><span class="p">):</span>
        <span class="n">data_dimx</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">data_dimy</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">fixed_p</span>
        <span class="n">params</span><span class="p">[</span><span class="n">free_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">free_p</span>
        <span class="n">prof</span> <span class="o">=</span> <span class="n">profile</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">array2d</span><span class="p">(</span><span class="n">data_dimx</span><span class="p">,</span> <span class="n">data_dimy</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">-</span> <span class="n">model</span><span class="p">)</span> <span class="o">/</span> <span class="n">sig</span>
        <span class="k">if</span> <span class="n">saturation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">data</span> <span class="o">&gt;=</span> <span class="n">saturation</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">result</span><span class="p">))]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">result</span><span class="p">))]</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>


    <span class="n">star_box</span> <span class="o">=</span> <span class="n">star_box</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">star_box</span><span class="p">)):</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">star_box</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="c1"># correct star_box level if the background level is &lt; 0</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">star_box</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">level_correction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">star_box</span><span class="p">)</span>
        <span class="n">star_box</span> <span class="o">-=</span> <span class="n">level_correction</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">level_correction</span> <span class="o">=</span> <span class="mf">0.</span>

    <span class="c1"># Get parameters guess</span>
    <span class="n">guess_params</span> <span class="o">=</span> <span class="n">guess</span><span class="p">(</span><span class="n">star_box</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">height</span><span class="p">,</span>
                         <span class="n">precise_pos</span><span class="o">=</span><span class="n">precise_guess</span><span class="p">)</span>

    <span class="c1"># Guessed params are replaced by given values (if not None)</span>
    <span class="k">if</span> <span class="n">height</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">guess_params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">height</span>
    <span class="k">if</span> <span class="n">amp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">guess_params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">amp</span>
    <span class="k">if</span> <span class="n">fwhm_pix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">guess_params</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">fwhm_pix</span>
    <span class="k">if</span> <span class="n">pos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">guess_params</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">guess_params</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Bad position guess : must be a tuple (x,y)&#39;</span><span class="p">)</span>

    <span class="c1"># local estimate of the noise</span>
    <span class="k">if</span> <span class="n">estimate_local_noise</span><span class="p">:</span>
        <span class="n">ron</span> <span class="o">=</span> <span class="n">get_background_noise</span><span class="p">(</span><span class="n">star_box</span><span class="p">,</span> <span class="n">fwhm_pix</span><span class="p">,</span>
                                   <span class="n">guess_params</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">guess_params</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">dcl</span> <span class="o">=</span> <span class="mf">0.</span>
        
    <span class="n">profile</span> <span class="o">=</span> <span class="n">get_profile</span><span class="p">(</span><span class="n">profile_name</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">profile_name</span> <span class="o">==</span> <span class="s1">&#39;moffat&#39;</span><span class="p">:</span>
        <span class="n">guess_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">guess_params</span><span class="p">,</span> <span class="p">[</span><span class="n">beta</span><span class="p">]))</span>
        
    <span class="n">guess_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">guess_params</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="n">fixed_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">guess_params</span><span class="p">)</span>
    <span class="n">masked_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">guess_params</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fix_height</span><span class="p">:</span>
        <span class="n">masked_params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">fix_amp</span><span class="p">:</span>
        <span class="n">masked_params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">fix_pos</span><span class="p">:</span>
        <span class="n">masked_params</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">masked_params</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">fix_fwhm</span><span class="p">:</span>
        <span class="n">masked_params</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">fix_beta</span> <span class="ow">and</span> <span class="n">profile_name</span> <span class="o">==</span> <span class="s1">&#39;moffat&#39;</span><span class="p">:</span>
        <span class="n">masked_params</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    

    <span class="n">free_params</span> <span class="o">=</span> <span class="n">guess_params</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">masked_params</span><span class="p">)]</span>
    <span class="n">free_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">guess_params</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">masked_params</span><span class="p">)]</span>
    <span class="n">fixed_params</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">masked_params</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">fit_params</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">leastsq</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="n">free_params</span><span class="p">,</span>
                                      <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">free_index</span><span class="p">,</span> <span class="n">fixed_params</span><span class="p">,</span>
                                            <span class="n">profile</span><span class="p">,</span> <span class="n">star_box</span><span class="p">,</span> <span class="n">sigma</span><span class="p">(</span>
                                                <span class="n">star_box</span><span class="p">,</span> <span class="n">ron</span><span class="p">,</span> <span class="n">dcl</span><span class="p">),</span>
                                            <span class="n">saturation</span><span class="p">),</span>
                                      <span class="n">maxfev</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">full_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                      <span class="n">xtol</span><span class="o">=</span><span class="n">fit_tol</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;fit_star leastsq exception: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">[]</span>
    
    <span class="k">if</span> <span class="n">fit_params</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">fixed_params</span><span class="p">[</span><span class="n">free_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit_params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">cov_x</span> <span class="o">=</span> <span class="n">fit_params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">fit_params</span> <span class="o">=</span> <span class="n">profile</span><span class="p">(</span><span class="n">fixed_params</span><span class="p">)</span><span class="o">.</span><span class="n">params</span>
        <span class="n">fit_params</span><span class="p">[</span><span class="s1">&#39;fwhm_pix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit_params</span><span class="p">[</span><span class="s1">&#39;fwhm&#39;</span><span class="p">]</span>
        
        <span class="c1"># Check fit params for oddities</span>
        <span class="k">if</span> <span class="n">check</span><span class="p">:</span>
            <span class="n">box_size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">star_box</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">fix_fwhm</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">fit_params</span><span class="p">[</span><span class="s1">&#39;fwhm_pix&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">fwhm_min</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">check_reject</span><span class="p">:</span> <span class="nb">print</span> <span class="s1">&#39;FWHM &lt; fwhm_min&#39;</span>
                    <span class="k">return</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">fit_params</span><span class="p">[</span><span class="s1">&#39;fwhm_pix&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">box_size</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">check_reject</span><span class="p">:</span> <span class="nb">print</span> <span class="s1">&#39;FWHM &gt; box_size&#39;</span>
                    <span class="k">return</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">fix_pos</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">fit_params</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">guess_params</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">box_size</span><span class="o">/</span><span class="mf">2.</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">check_reject</span><span class="p">:</span> <span class="nb">print</span> <span class="s1">&#39;DX &gt; box_size / 2&#39;</span>
                    <span class="k">return</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">fit_params</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">guess_params</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">box_size</span><span class="o">/</span><span class="mf">2.</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">check_reject</span><span class="p">:</span> <span class="nb">print</span> <span class="s1">&#39;DY &gt; box_size / 2&#39;</span>
                    <span class="k">return</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">fix_amp</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">fit_params</span><span class="p">[</span><span class="s1">&#39;amplitude&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">check_reject</span><span class="p">:</span> <span class="nb">print</span> <span class="s1">&#39;AMP &lt; 0&#39;</span>
                    <span class="k">return</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">fix_amp</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">fix_height</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">((</span><span class="n">fit_params</span><span class="p">[</span><span class="s1">&#39;amplitude&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">fit_params</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span>
                     <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">star_box</span><span class="p">))</span>
                    <span class="o">&lt;</span> <span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">star_box</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">star_box</span><span class="p">))</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">check_reject</span><span class="p">:</span> <span class="nb">print</span> <span class="s1">&#39;AMP + HEI &lt; 0.5 * max&#39;</span>
                    <span class="k">return</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="p">((</span><span class="n">fit_params</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">fit_params</span><span class="p">[</span><span class="s1">&#39;amplitude&#39;</span><span class="p">]</span>
                     <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">star_box</span><span class="p">))</span>
                    <span class="o">&lt;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">star_box</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">star_box</span><span class="p">))):</span>
                    <span class="k">if</span> <span class="n">check_reject</span><span class="p">:</span> <span class="nb">print</span> <span class="s1">&#39;AMP + HEI &lt; median&#39;</span>
                    <span class="k">return</span> <span class="p">[]</span>
        
        <span class="c1"># reduced chi-square</span>
        <span class="n">fit_params</span><span class="p">[</span><span class="s1">&#39;chi-square&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
            <span class="n">diff</span><span class="p">([],[],</span> <span class="n">fixed_params</span><span class="p">,</span> <span class="n">profile</span><span class="p">,</span> <span class="n">star_box</span><span class="p">,</span>
                 <span class="n">sigma</span><span class="p">(</span><span class="n">star_box</span><span class="p">,</span> <span class="n">ron</span><span class="p">,</span> <span class="n">dcl</span><span class="p">),</span> <span class="n">saturation</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span>
            
        <span class="n">fit_params</span><span class="p">[</span><span class="s1">&#39;reduced-chi-square&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">fit_params</span><span class="p">[</span><span class="s1">&#39;chi-square&#39;</span><span class="p">]</span>
            <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">star_box</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">free_params</span><span class="p">)))</span>

        <span class="c1"># restore level correction:</span>
        <span class="n">fit_params</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">level_correction</span>
        <span class="n">fit_params</span><span class="p">[</span><span class="s1">&#39;amplitude&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">level_correction</span>

        <span class="c1"># SNR estimation (from Mighell, MNRAS 361,3 (2005))</span>
        <span class="n">S</span> <span class="o">=</span> <span class="n">fit_params</span><span class="p">[</span><span class="s1">&#39;fwhm_pix&#39;</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">4</span><span class="p">)))</span>
        <span class="n">Beta</span> <span class="o">=</span> <span class="mf">4.</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">S</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">star_box</span><span class="p">)</span>
        <span class="n">flux</span> <span class="o">=</span> <span class="n">fit_params</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">]</span>
        <span class="n">background_noise</span> <span class="o">=</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">fit_params</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">])</span>
                                      <span class="o">+</span> <span class="p">(</span><span class="n">ron</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span> <span class="o">+</span> <span class="n">dcl</span><span class="p">))</span>
        <span class="n">SNR</span> <span class="o">=</span> <span class="p">(</span><span class="n">flux</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
            <span class="n">flux</span> <span class="o">+</span> <span class="n">Beta</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Beta</span><span class="o">/</span><span class="n">N</span><span class="p">))</span><span class="o">**</span><span class="mf">2.</span>
            <span class="o">*</span> <span class="p">(</span><span class="n">background_noise</span><span class="o">**</span><span class="mf">2.</span><span class="p">)))</span>
        <span class="n">fit_params</span><span class="p">[</span><span class="s1">&#39;snr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNR</span>
        
        <span class="c1"># error estimation</span>
        <span class="n">fit_params</span><span class="p">[</span><span class="s1">&#39;height_err&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">fit_params</span><span class="p">[</span><span class="s1">&#39;amplitude_err&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">fit_params</span><span class="p">[</span><span class="s1">&#39;x_err&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">fit_params</span><span class="p">[</span><span class="s1">&#39;y_err&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">fit_params</span><span class="p">[</span><span class="s1">&#39;fwhm_err&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">if</span> <span class="n">profile_name</span> <span class="o">==</span> <span class="s1">&#39;moffat&#39;</span><span class="p">:</span>
            <span class="n">fit_params</span><span class="p">[</span><span class="s1">&#39;beta_err&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">fit_params</span><span class="p">[</span><span class="s1">&#39;flux_err&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>

        <span class="k">if</span> <span class="n">cov_x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cov_x</span> <span class="o">*=</span> <span class="n">fit_params</span><span class="p">[</span><span class="s1">&#39;reduced-chi-square&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">ip</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">free_index</span><span class="p">)):</span>
                <span class="n">err</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">cov_x</span><span class="p">[</span><span class="n">ip</span><span class="p">,</span><span class="n">ip</span><span class="p">]))</span>
                <span class="k">if</span> <span class="n">free_index</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">fit_params</span><span class="p">[</span><span class="s1">&#39;height_err&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">err</span>
                <span class="k">elif</span> <span class="n">free_index</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">fit_params</span><span class="p">[</span><span class="s1">&#39;amplitude_err&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">err</span>
                <span class="k">elif</span> <span class="n">free_index</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">fit_params</span><span class="p">[</span><span class="s1">&#39;x_err&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">err</span>
                <span class="k">elif</span> <span class="n">free_index</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">fit_params</span><span class="p">[</span><span class="s1">&#39;y_err&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">err</span>
                <span class="k">elif</span> <span class="n">free_index</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                    <span class="n">fit_params</span><span class="p">[</span><span class="s1">&#39;fwhm_err&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">err</span>
                <span class="k">elif</span> <span class="n">free_index</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span> <span class="o">==</span> <span class="mi">5</span> <span class="ow">and</span> <span class="n">profile_name</span> <span class="o">==</span> <span class="s1">&#39;moffat&#39;</span><span class="p">:</span>
                    <span class="n">fit_params</span><span class="p">[</span><span class="s1">&#39;beta_err&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">err</span>
            <span class="n">fit_params</span><span class="p">[</span><span class="s1">&#39;flux_err&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">profile</span><span class="p">(</span><span class="n">fixed_params</span><span class="p">)</span><span class="o">.</span><span class="n">flux_error</span><span class="p">(</span>
                <span class="n">fit_params</span><span class="p">[</span><span class="s1">&#39;amplitude_err&#39;</span><span class="p">],</span>
                <span class="n">fit_params</span><span class="p">[</span><span class="s1">&#39;fwhm_err&#39;</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">4</span><span class="p">))))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        
        <span class="k">return</span> <span class="n">fit_params</span>
        
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="aperture_photometry"><a class="viewcode-back" href="../../../orb.utils.html#orb.utils.astrometry.aperture_photometry">[docs]</a><span class="k">def</span> <span class="nf">aperture_photometry</span><span class="p">(</span><span class="n">star_box</span><span class="p">,</span> <span class="n">fwhm_guess</span><span class="p">,</span> <span class="n">background_guess</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">background_guess_err</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
                        <span class="n">aper_coeff</span><span class="o">=</span><span class="mf">3.</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">x_guess</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">y_guess</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_surfaces</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">aperture_surface</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">annulus_surface</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the aperture photometry of a star centered in a star box.</span>

<span class="sd">    :param star_box: Star box</span>

<span class="sd">    :param fwhm_guess: Guessed FWHM. Used to get the aperture radius.</span>

<span class="sd">    :param background_guess: (Optional) If not None, this guess is</span>
<span class="sd">      used instead of the background determination in an annulus</span>
<span class="sd">      around the star (default None).</span>

<span class="sd">    :param background_guess_err: (Optional) Error on the background</span>
<span class="sd">      guess. Used to compute the aperture photometry error (default 0.).</span>

<span class="sd">    :param aper_coeff: (Optional) Aperture coefficient. The aperture</span>
<span class="sd">      radius is Rap = aper_coeff * FWHM. Better when between 1.5 to</span>
<span class="sd">      reduce the variation of the collected photons with varying FWHM</span>
<span class="sd">      and 3. to account for the flux in the wings (default 3., better</span>
<span class="sd">      for Moffat stars with a high SNR).</span>

<span class="sd">    :param warn: (Optional) If True, print a warning when the background cannot</span>
<span class="sd">      be well estimated (default True).</span>

<span class="sd">    :param x_guess: (Optional) position of the star along x axis. If</span>
<span class="sd">      None, star is assumed to lie at the very center of the frame</span>
<span class="sd">      (default None).</span>

<span class="sd">    :param y_guess: (Optional) position of the star along y axis. If</span>
<span class="sd">      None, star is assumed to lie at the very center of the frame</span>
<span class="sd">      (default None).</span>

<span class="sd">    :param return_surfaces: (Optional) If True returns also the</span>
<span class="sd">      aperture_surface and annulus_surface computed. Useful if</span>
<span class="sd">      multiple stars with the same FWHM must be done (default False).</span>

<span class="sd">    :param aperture_surface: (Optional) Pre-computed</span>
<span class="sd">      aperture_surface. Accelerate the process for multiple stars with</span>
<span class="sd">      the same FWHM but must be used with caution. aper_coeff is of no</span>
<span class="sd">      use if aperture_surface if given (default None). See</span>
<span class="sd">      :py:meth:`orb.utils.astrometry.multi_aperture_photometry`.</span>

<span class="sd">    :param annulus_surface: (Optional) Pre-computed</span>
<span class="sd">      annulus_surface. Accelerate the process for multiple stars with</span>
<span class="sd">      the same FWHM but must be used with caution. aper_coeff is of no</span>
<span class="sd">      use if annulus_surface if given (default None). See</span>
<span class="sd">      :py:meth:`orb.utils.astrometry.multi_aperture_photometry`.</span>

<span class="sd">    :return: A Tuple (flux, flux_error, aperture surface,</span>
<span class="sd">      bad_estimation_flag). If the estimation is bad,</span>
<span class="sd">      bad_estimation_flat is set to 1, else it is set to 0.</span>
<span class="sd">    </span>
<span class="sd">    .. note:: Best aperture for maximum S/N: 1. FWHM (Howell 1989,</span>
<span class="sd">      Howell 1992). But that works only when the PSF is well sampled</span>
<span class="sd">      which is not always the case so a higher aperture coefficient</span>
<span class="sd">      may be better. More over, to get exact photometry the result</span>
<span class="sd">      must be corrected by aperture growth curve for the &#39;missing</span>
<span class="sd">      light&#39;. A coefficient of 1.27 FWHM corresponds to 3 sigma and</span>
<span class="sd">      collects more than 99% of the light if the star is a pure</span>
<span class="sd">      Gaussian. A coefficient of 3 for Moffat stars reduces the</span>
<span class="sd">      variations of the proportion of collected photons when the FWHM</span>
<span class="sd">      is changing and seems to be the best.</span>

<span class="sd">    .. note:: Best radius for sky background annulus is determined</span>
<span class="sd">      from this rule of thumb: The number of pixels to estimate the</span>
<span class="sd">      background must be al least 3 times the number of pixel in the</span>
<span class="sd">      aperture (Merline &amp; Howell 1995). Choosing the aperture radius</span>
<span class="sd">      coefficient(Cap) as Rap = Cap * FWHM and the inner radius</span>
<span class="sd">      coefficient (Cin) as Rin = Cin * FWHM, gives the outer radius</span>
<span class="sd">      coefficient (Cout): Cout = sqrt(3*Cap^2 + Cin^2)</span>

<span class="sd">    .. warning:: The star MUST be at the center (+/- 1 pixel) of the</span>
<span class="sd">      star box.</span>

<span class="sd">    .. seealso:: :py:meth:`orb.utils.astrometry.multi_aperture_photometry`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">MIN_APER_SIZE</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="c1"># Minimum warning flux coefficient in the</span>
                        <span class="c1"># aperture</span>
    
    <span class="n">C_AP</span> <span class="o">=</span> <span class="n">aper_coeff</span> <span class="c1"># Aperture coefficient</span>
    
    <span class="n">C_IN</span> <span class="o">=</span> <span class="n">C_AP</span> <span class="o">+</span> <span class="mf">1.</span> <span class="c1"># Inner radius coefficient of the bckg annulus</span>
    
    <span class="n">MIN_BACK_COEFF</span> <span class="o">=</span> <span class="mf">5.</span> <span class="c1"># Minimum percentage of the pixels in the</span>
                        <span class="c1"># annulus to estimate the background</span>
                        
    <span class="n">SUR_VAL_COEFF</span> <span class="o">=</span> <span class="mi">10</span> <span class="c1"># Number of pixel division to estimate the</span>
                       <span class="c1"># surface value</span>

    <span class="c1"># Outer radius coefficient of the annulus</span>
    <span class="n">C_OUT</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">MIN_BACK_COEFF</span><span class="o">*</span><span class="n">C_AP</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span> <span class="o">+</span> <span class="n">C_IN</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span>
    
    <span class="n">bad</span> <span class="o">=</span> <span class="mi">0</span>        
    <span class="n">box_dimx</span> <span class="o">=</span> <span class="n">star_box</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">box_dimy</span> <span class="o">=</span> <span class="n">star_box</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">x_guess</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">x_guess</span> <span class="o">=</span> <span class="n">box_dimx</span> <span class="o">/</span> <span class="mf">2.</span> <span class="o">-</span> <span class="mf">0.5</span>
    <span class="k">if</span> <span class="n">y_guess</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">y_guess</span> <span class="o">=</span> <span class="n">box_dimy</span> <span class="o">/</span> <span class="mf">2.</span> <span class="o">-</span> <span class="mf">0.5</span>
                                     
    <span class="c1"># Aperture radius</span>
    <span class="n">aper_rmax</span> <span class="o">=</span> <span class="n">C_AP</span> <span class="o">*</span> <span class="n">fwhm_guess</span>

    <span class="c1"># Get approximate pixels surface value of the pixels for the aperture</span>
    <span class="k">if</span> <span class="n">aperture_surface</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">aperture_surface</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="n">box_dimx</span><span class="p">,</span> <span class="n">box_dimy</span><span class="p">):</span>
        <span class="n">aperture_surface</span> <span class="o">=</span> <span class="n">orb</span><span class="o">.</span><span class="n">cutils</span><span class="o">.</span><span class="n">surface_value</span><span class="p">(</span>
            <span class="n">box_dimx</span><span class="p">,</span> <span class="n">box_dimy</span><span class="p">,</span>
            <span class="n">x_guess</span><span class="p">,</span> <span class="n">y_guess</span><span class="p">,</span>
            <span class="mf">0.</span><span class="p">,</span> <span class="n">aper_rmax</span><span class="p">,</span> <span class="n">SUR_VAL_COEFF</span><span class="p">)</span>
    <span class="c1"># saved for clean output if return_surfaces is True</span>
    <span class="n">base_aperture_surface</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">aperture_surface</span><span class="p">)</span> 
    
    <span class="n">aperture_surface</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">star_box</span><span class="p">))]</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">aperture</span> <span class="o">=</span> <span class="n">star_box</span> <span class="o">*</span> <span class="n">aperture_surface</span>
    <span class="n">total_aperture</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">aperture</span><span class="p">)</span>
    
    <span class="c1"># compute number of nans</span>
    <span class="n">aperture</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">aperture_surface</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">aperture_nan_nb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">aperture</span><span class="p">))</span>
    
    
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">aperture_surface</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">MIN_APER_SIZE</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">warn</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Not enough pixels in the aperture&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    
    <span class="c1"># Estimation of the background</span>
    <span class="k">if</span> <span class="n">background_guess</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ann_rmin</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">C_IN</span> <span class="o">*</span> <span class="n">fwhm_guess</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span>

        <span class="c1"># C_OUT definition just does not work well at small radii, so the</span>
        <span class="c1"># outer radius has to be enlarged until we have a good ratio of</span>
        <span class="c1"># background counts</span>
        <span class="n">ann_rmax</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">C_OUT</span> <span class="o">*</span> <span class="n">fwhm_guess</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">not_enough</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">while</span> <span class="n">not_enough</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">annulus_surface</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">annulus_surface</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="n">box_dimx</span><span class="p">,</span> <span class="n">box_dimy</span><span class="p">):</span>
                <span class="n">annulus_surface</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">orb</span><span class="o">.</span><span class="n">cutils</span><span class="o">.</span><span class="n">surface_value</span><span class="p">(</span>
                    <span class="n">box_dimx</span><span class="p">,</span> <span class="n">box_dimy</span><span class="p">,</span>
                    <span class="n">x_guess</span><span class="p">,</span> <span class="n">y_guess</span><span class="p">,</span>
                    <span class="n">ann_rmin</span><span class="p">,</span> <span class="n">ann_rmax</span><span class="p">,</span>
                    <span class="n">SUR_VAL_COEFF</span><span class="p">))</span>
            <span class="c1"># saved for clean output if return_surfaces is True</span>
            <span class="n">base_annulus_surface</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">annulus_surface</span><span class="p">)</span>
            
            <span class="n">annulus_surface</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">annulus_surface</span> <span class="o">&lt;</span> <span class="mf">1.</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.</span> <span class="c1"># no partial pixels are used</span>
       
            <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">annulus_surface</span><span class="p">)</span> <span class="o">&gt;</span>
                <span class="nb">float</span><span class="p">(</span><span class="n">MIN_BACK_COEFF</span><span class="p">)</span> <span class="o">*</span>  <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">aperture_surface</span><span class="p">)):</span>
                <span class="n">not_enough</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">elif</span> <span class="n">ann_rmax</span> <span class="o">&gt;=</span> <span class="nb">min</span><span class="p">(</span><span class="n">box_dimx</span><span class="p">,</span> <span class="n">box_dimy</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">:</span>
                <span class="n">not_enough</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ann_rmax</span> <span class="o">+=</span> <span class="mf">0.5</span>
                <span class="n">annulus_surface</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># background in counts / pixel</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">annulus_surface</span><span class="p">)</span> <span class="o">&gt;</span>
            <span class="nb">float</span><span class="p">(</span><span class="n">MIN_BACK_COEFF</span><span class="p">)</span> <span class="o">*</span>  <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">aperture_surface</span><span class="p">)):</span>
            <span class="n">background_pixels</span> <span class="o">=</span> <span class="n">star_box</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">annulus_surface</span><span class="p">)]</span>
            <span class="c1"># background level is computed from the mode of the sky</span>
            <span class="c1"># pixels distribution</span>
            <span class="n">background</span><span class="p">,</span> <span class="n">background_err</span> <span class="o">=</span> <span class="n">sky_background_level</span><span class="p">(</span>
                <span class="n">background_pixels</span><span class="p">,</span> <span class="n">return_error</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="n">background_pixels</span> <span class="o">=</span> <span class="n">orb</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sigmacut</span><span class="p">(</span><span class="n">star_box</span><span class="p">)</span>
            <span class="n">background</span> <span class="o">=</span> <span class="n">orb</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">robust_mean</span><span class="p">(</span><span class="n">background_pixels</span><span class="p">)</span>
            <span class="n">background_err</span> <span class="o">=</span> <span class="p">(</span><span class="n">orb</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">robust_std</span><span class="p">(</span><span class="n">background_pixels</span><span class="p">)</span>
                              <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">background_pixels</span><span class="p">)))</span>
            
            <span class="k">if</span> <span class="n">warn</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Estimation of the background might be bad&#39;</span><span class="p">)</span>
                <span class="n">bad</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">background</span> <span class="o">=</span> <span class="n">background_guess</span>
        <span class="n">background_err</span> <span class="o">=</span> <span class="n">background_guess_err</span>

    <span class="n">aperture_flux</span> <span class="o">=</span> <span class="n">total_aperture</span> <span class="o">-</span> <span class="p">(</span><span class="n">background</span> <span class="o">*</span>  <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">aperture_surface</span><span class="p">))</span>
    <span class="n">aperture_flux_error</span> <span class="o">=</span> <span class="n">background_err</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">aperture_surface</span><span class="p">)</span>

    <span class="n">returns</span> <span class="o">=</span> <span class="p">(</span><span class="n">aperture_flux</span><span class="p">,</span> <span class="n">aperture_flux_error</span><span class="p">,</span>
               <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">aperture_surface</span><span class="p">),</span> <span class="n">bad</span><span class="p">,</span>
               <span class="n">background</span><span class="p">,</span> <span class="n">background_err</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">return_surfaces</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">returns</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">returns</span><span class="p">,</span> <span class="n">base_aperture_surface</span><span class="p">,</span> <span class="n">base_annulus_surface</span></div>

<div class="viewcode-block" id="detect_fwhm_in_frame"><a class="viewcode-back" href="../../../orb.utils.html#orb.utils.astrometry.detect_fwhm_in_frame">[docs]</a><span class="k">def</span> <span class="nf">detect_fwhm_in_frame</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">star_list</span><span class="p">,</span> <span class="n">fwhm_guess_pix</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Detect stars FWHM in a frame.</span>

<span class="sd">    .. warning:: star positions must be known precisely</span>

<span class="sd">    :param frame: Frame</span>

<span class="sd">    :param star_list: List of the positions of the stars used to</span>
<span class="sd">      detect FWHM.</span>

<span class="sd">    :param fwhm_guess_pix: Initial guess on the FWHM of the stars.</span>

<span class="sd">    :return: (FWHM, FWHM_ERR) in pixels</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">FIT_BOXSZ_COEFF</span> <span class="o">=</span> <span class="mi">8</span>

    <span class="c1"># note that the fwhm guess is divided by two because it is better</span>
    <span class="c1"># to have a starting guess smaller than the real fwhm value</span>
    <span class="n">fit_params</span> <span class="o">=</span> <span class="n">orb</span><span class="o">.</span><span class="n">cutils</span><span class="o">.</span><span class="n">multi_fit_stars</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">star_list</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span>
        <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">fwhm_guess_pix</span><span class="o">*</span><span class="n">FIT_BOXSZ_COEFF</span><span class="p">)),</span>
        <span class="n">height_guess</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">frame</span><span class="p">),</span>
        <span class="n">fwhm_guess</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">fwhm_guess_pix</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span>
        <span class="n">cov_height</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">cov_pos</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">cov_fwhm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">fix_height</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">fix_pos</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">fix_fwhm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">enable_zoom</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">enable_rotation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">estimate_local_noise</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">fit_params</span> <span class="o">!=</span> <span class="p">[]:</span>
        <span class="k">return</span> <span class="n">fit_params</span><span class="p">[</span><span class="s1">&#39;stars-params&#39;</span><span class="p">][:,</span><span class="mi">4</span><span class="p">],</span> <span class="n">fit_params</span><span class="p">[</span><span class="s1">&#39;stars-params-err&#39;</span><span class="p">][:,</span><span class="mi">4</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;FWHM could not be measured, check star positions&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="multi_aperture_photometry"><a class="viewcode-back" href="../../../orb.utils.html#orb.utils.astrometry.multi_aperture_photometry">[docs]</a><span class="k">def</span> <span class="nf">multi_aperture_photometry</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">pos_list</span><span class="p">,</span> <span class="n">fwhm_guess_pix</span><span class="p">,</span>
                              <span class="n">aper_coeff</span><span class="o">=</span><span class="mf">3.</span><span class="p">,</span> <span class="n">detect_fwhm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                              <span class="n">silent</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Aperture photometry of multiple sources in a frame.</span>

<span class="sd">    :param frame: Frame</span>

<span class="sd">    :param pos_list: List of the positions of the sources</span>

<span class="sd">    :param fwhm_guess_pix: Initial guess on the FWHM of the sources.</span>

<span class="sd">    :param aper_coeff: (Optional) Aperture coefficient used for</span>
<span class="sd">      photometry (default 3.).</span>

<span class="sd">    :param detect_fwhm: (Optional) If True FWHM is automatically</span>
<span class="sd">      computed from a fit on the sources. Sources must be stars or</span>
<span class="sd">      bright point sources. If most of the sources are stars this</span>
<span class="sd">      might work well enough (default False).</span>

<span class="sd">    :param silent: (Optional) Silent function if True (default False).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">PHOT_BOXSZ_COEFF</span> <span class="o">=</span> <span class="mi">17</span>
    <span class="n">pos_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pos_list</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">detect_fwhm</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">detect_fwhm_in_frame</span><span class="p">(</span>
            <span class="n">frame</span><span class="p">,</span> <span class="n">pos_list</span><span class="p">,</span> <span class="n">fwhm_guess_pix</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fwhm_guess_pix</span><span class="p">,</span> <span class="n">fwhm_err</span> <span class="o">=</span> <span class="n">res</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fwhm_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s1">&#39;Detected FWHM: </span><span class="si">{}</span><span class="s1"> [+/- </span><span class="si">{}</span><span class="s1">] pixels&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">fwhm_guess_pix</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">fwhm_err</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fwhm_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">pos_list</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">fwhm_err</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">fwhm_guess_pix</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">temp_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">pos_list</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">temp_arr</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">fwhm_guess_pix</span><span class="p">)</span>
        <span class="n">fwhm_guess_pix</span> <span class="o">=</span> <span class="n">temp_arr</span>

    <span class="n">results</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">pos_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pos_list</span><span class="p">)</span>
    <span class="n">aper_surf</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">annu_surf</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">istar</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pos_list</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">ix</span><span class="p">,</span> <span class="n">iy</span> <span class="o">=</span> <span class="n">pos_list</span><span class="p">[</span><span class="n">istar</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">=</span> <span class="n">orb</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">get_box_coords</span><span class="p">(</span>
            <span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">fwhm_guess_pix</span><span class="p">)</span><span class="o">*</span><span class="n">PHOT_BOXSZ_COEFF</span><span class="p">),</span>
            <span class="mi">0</span><span class="p">,</span> <span class="n">frame</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="mi">0</span><span class="p">,</span> <span class="n">frame</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">star_box</span> <span class="o">=</span> <span class="n">frame</span><span class="p">[</span><span class="n">x_min</span><span class="p">:</span><span class="n">x_max</span><span class="p">,</span> <span class="n">y_min</span><span class="p">:</span><span class="n">y_max</span><span class="p">]</span>
        <span class="n">photom_result</span><span class="p">,</span> <span class="n">aper_surf</span><span class="p">,</span> <span class="n">annu_surf</span> <span class="o">=</span> <span class="n">aperture_photometry</span><span class="p">(</span>
            <span class="n">star_box</span><span class="p">,</span> <span class="n">fwhm_guess_pix</span><span class="p">[</span><span class="n">istar</span><span class="p">],</span> <span class="n">aper_coeff</span><span class="o">=</span><span class="n">aper_coeff</span><span class="p">,</span>
            <span class="n">return_surfaces</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">aperture_surface</span><span class="o">=</span><span class="n">aper_surf</span><span class="p">,</span>
            <span class="n">annulus_surface</span><span class="o">=</span><span class="n">annu_surf</span><span class="p">)</span>
        
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;aperture_flux&#39;</span><span class="p">:</span><span class="n">photom_result</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="s1">&#39;aperture_flux_err&#39;</span><span class="p">:</span><span class="n">photom_result</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                        <span class="s1">&#39;aperture_surface&#39;</span><span class="p">:</span><span class="n">photom_result</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                        <span class="s1">&#39;aperture_flux_bad&#39;</span><span class="p">:</span><span class="n">photom_result</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
                        <span class="s1">&#39;aperture_background&#39;</span><span class="p">:</span><span class="n">photom_result</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
                        <span class="s1">&#39;aperture_background_err&#39;</span><span class="p">:</span><span class="n">photom_result</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
                        <span class="s1">&#39;fwhm_pix&#39;</span><span class="p">:</span><span class="n">fwhm_guess_pix</span><span class="p">[</span><span class="n">istar</span><span class="p">],</span>
                        <span class="s1">&#39;fwhm_pix_err&#39;</span><span class="p">:</span><span class="n">fwhm_err</span><span class="p">[</span><span class="n">istar</span><span class="p">]})</span>
    <span class="k">return</span> <span class="n">results</span></div>

<div class="viewcode-block" id="load_star_list"><a class="viewcode-back" href="../../../orb.utils.html#orb.utils.astrometry.load_star_list">[docs]</a><span class="k">def</span> <span class="nf">load_star_list</span><span class="p">(</span><span class="n">star_list_path</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Load a list of stars coordinates</span>

<span class="sd">    :param star_list_path: The path to the star list file.</span>

<span class="sd">    :param silent: (Optional) If True no message is printed (default</span>
<span class="sd">      False).</span>

<span class="sd">    .. note:: A list of stars is a list of star coordinates (x and</span>
<span class="sd">       y). Each set of coordinates is separated by a line</span>
<span class="sd">       break. There must not be any blank line or comments.</span>

<span class="sd">       For example::</span>

<span class="sd">           221.994164678 62.8374036151</span>
<span class="sd">           135.052291354 274.848787038</span>
<span class="sd">           186.478298303 11.8162949818</span>
<span class="sd">           362.642981933 323.083868198</span>
<span class="sd">           193.546595814 321.017948051</span>

<span class="sd">    The star list can be created using DS9</span>
<span class="sd">    (http://hea-www.harvard.edu/RD/ds9/site/Home.html) on the</span>
<span class="sd">    first image of the sequence :</span>

<span class="sd">          1. Select more than 3 stars with the circular tool (the</span>
<span class="sd">             more you select, the better will be the alignment)</span>
<span class="sd">          2. Save the regions you have created with the options:</span>

<span class="sd">             * Format = &#39;XY&#39;</span>
<span class="sd">             * Coordinate system = &#39;Image&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">star_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">star_list_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">star_list_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">star_coords</span> <span class="ow">in</span> <span class="n">star_list_file</span><span class="p">:</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">star_coords</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">star_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

    <span class="n">star_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">star_list</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;Star list of &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">star_list</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot; stars loaded&quot;</span>
    <span class="k">return</span> <span class="n">star_list</span></div>

<div class="viewcode-block" id="radial_profile"><a class="viewcode-back" href="../../../orb.utils.html#orb.utils.astrometry.radial_profile">[docs]</a><span class="k">def</span> <span class="nf">radial_profile</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">xc</span><span class="p">,</span> <span class="n">yc</span><span class="p">,</span> <span class="n">rmax</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the average radial profile on a region of a 2D array.</span>

<span class="sd">    :param a: A 2D array</span>
<span class="sd">    </span>
<span class="sd">    :param xc: Center of the profile along x axis</span>
<span class="sd">    </span>
<span class="sd">    :param yc: Center of the profile along y axis</span>
<span class="sd">    </span>
<span class="sd">    :param rmax: Radius of the profile</span>

<span class="sd">    :return: (R axis, V axis). A tuple of 2 vectors giving the radius</span>
<span class="sd">      axis and the corresponding values axis.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">xmin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">xc</span><span class="o">-</span><span class="n">rmax</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">xmin</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">xmin</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">xmax</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">xc</span><span class="o">+</span><span class="n">rmax</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">xmax</span> <span class="o">&gt;</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">xmax</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ymin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">yc</span><span class="o">-</span><span class="n">rmax</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">ymin</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">ymin</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">ymax</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">yc</span><span class="o">+</span><span class="n">rmax</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">ymax</span> <span class="o">&gt;</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># collecting pixels values and their respective radius</span>
    <span class="n">r_list</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">ij</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">):</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">ii</span><span class="o">-</span><span class="n">xc</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">ij</span><span class="o">-</span><span class="n">yc</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="n">ij</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">r_list</span><span class="p">:</span>
                <span class="n">r_list</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">([</span><span class="n">v</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">r_list</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">v</span><span class="p">])</span>
            
    <span class="c1"># reducing the list by averaging the values for each different radius</span>
    <span class="n">reduced_r_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">ir</span> <span class="ow">in</span> <span class="n">r_list</span><span class="p">:</span>
        <span class="n">reduced_r_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">ir</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">r_list</span><span class="p">[</span><span class="n">ir</span><span class="p">]),</span> <span class="nb">len</span><span class="p">(</span><span class="n">r_list</span><span class="p">[</span><span class="n">ir</span><span class="p">])))</span>

    <span class="n">reduced_r_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">reduced_r_list</span><span class="p">,</span>
                              <span class="n">dtype</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;n&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">)])</span>
    <span class="n">reduced_r_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reduced_r_list</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">r_axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">reduced_r_list</span><span class="p">[</span><span class="n">ik</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                       <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">reduced_r_list</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
    <span class="n">v_axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">reduced_r_list</span><span class="p">[</span><span class="n">ik</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                       <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">reduced_r_list</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">r_axis</span><span class="p">,</span> <span class="n">v_axis</span><span class="p">)</span></div>


<div class="viewcode-block" id="sky_background_level"><a class="viewcode-back" href="../../../orb.utils.html#orb.utils.astrometry.sky_background_level">[docs]</a><span class="k">def</span> <span class="nf">sky_background_level</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">smooth_coeff</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">return_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
                         <span class="n">return_error</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the level of the sky background based on the maximum of</span>
<span class="sd">    the histogram of the pixels distribution in the image.</span>

<span class="sd">    :param im: Image.</span>

<span class="sd">    :param smooth_coeff: (Optional) the smoothing degree, i.e. the</span>
<span class="sd">      number of smoothing points is defined by smooth_coeff *</span>
<span class="sd">      size(histogram) (default 0.05). If smooth_coeff &lt;= 0. no</span>
<span class="sd">      smoothing is applied.</span>

<span class="sd">    :param return_mode: (Optional) If True the returned value is the</span>
<span class="sd">      mode (an entire value for a distribution of integers). If False,</span>
<span class="sd">      return the mean of a sigmacut realized around the mode (a</span>
<span class="sd">      fractional value, generally more precise).</span>

<span class="sd">    :param bins: (Optional) Number of bins for the histogram (default</span>
<span class="sd">      20).</span>

<span class="sd">    :param return_error: (Optional) If True, the error on the</span>
<span class="sd">      estimation is returned (default False).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sig_im</span> <span class="o">=</span> <span class="n">orb</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sigmacut</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">2.5</span><span class="p">)</span>
    <span class="n">hist</span><span class="p">,</span> <span class="n">bin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">sig_im</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">hist</span><span class="p">)</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s1">&#39;Bad sky histogram: returning median of the distribution&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">smooth_coeff</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
        <span class="n">hist</span> <span class="o">=</span> <span class="n">orb</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">vector</span><span class="o">.</span><span class="n">smooth</span><span class="p">(</span>
            <span class="n">hist</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">smooth_coeff</span> <span class="o">*</span> <span class="n">bins</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
            <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;gaussian_conv&#39;</span><span class="p">)</span>
    <span class="n">index_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">hist</span><span class="p">)</span>
    <span class="n">mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">bin_edges</span><span class="p">[</span><span class="n">index_max</span><span class="p">]</span> <span class="o">+</span> <span class="n">bin_edges</span><span class="p">[</span><span class="n">index_max</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.</span>
    <span class="n">im_cut</span> <span class="o">=</span> <span class="n">orb</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sigmacut</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span> <span class="n">central_value</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">return_error</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">orb</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">robust_mean</span><span class="p">(</span><span class="n">im_cut</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">orb</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">robust_mean</span><span class="p">(</span><span class="n">im_cut</span><span class="p">),</span> <span class="p">(</span><span class="n">orb</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">robust_std</span><span class="p">(</span><span class="n">im_cut</span><span class="p">)</span>
                                                 <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">im_cut</span><span class="p">)))</span></div>

<div class="viewcode-block" id="compute_radec_pm"><a class="viewcode-back" href="../../../orb.utils.html#orb.utils.astrometry.compute_radec_pm">[docs]</a><span class="k">def</span> <span class="nf">compute_radec_pm</span><span class="p">(</span><span class="n">ra_deg</span><span class="p">,</span> <span class="n">dec_deg</span><span class="p">,</span> <span class="n">pm_ra_mas</span><span class="p">,</span> <span class="n">pm_dec_mas</span><span class="p">,</span> <span class="n">yr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute RA/DEC in degrees with proper motion values.</span>

<span class="sd">    :param ra_deg: RA in degrees</span>

<span class="sd">    :param dec_deg: DEC in degrees</span>

<span class="sd">    :param pm_ra_mas: Proper motion along RA axis in mas/yr</span>

<span class="sd">    :param pm_dec_mas: Proper motion along DEC axis in mas/yr</span>

<span class="sd">    :param yr: Number of years</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ra</span> <span class="o">=</span> <span class="n">ra_deg</span> <span class="o">+</span> <span class="p">(</span><span class="n">pm_ra_mas</span> <span class="o">*</span> <span class="n">yr</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-3</span> <span class="o">/</span> <span class="mf">3600.</span>
    <span class="n">dec</span> <span class="o">=</span> <span class="n">dec_deg</span> <span class="o">+</span> <span class="p">(</span><span class="n">pm_dec_mas</span> <span class="o">*</span> <span class="n">yr</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-3</span> <span class="o">/</span> <span class="mf">3600.</span>
    <span class="k">if</span> <span class="n">ra</span> <span class="o">&gt;</span> <span class="mf">360.</span> <span class="p">:</span> <span class="n">ra</span> <span class="o">-=</span> <span class="mf">360.</span>
    <span class="k">if</span> <span class="n">ra</span> <span class="o">&lt;</span> <span class="mf">0.</span> <span class="p">:</span> <span class="n">ra</span> <span class="o">+=</span> <span class="mf">360.</span>
    <span class="k">if</span> <span class="n">dec</span> <span class="o">&gt;</span> <span class="mf">90.</span><span class="p">:</span> <span class="n">dec</span> <span class="o">=</span> <span class="mf">90.</span> <span class="o">-</span> <span class="n">dec</span>
    <span class="k">if</span> <span class="n">dec</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">:</span> <span class="n">dec</span> <span class="o">=</span> <span class="o">-</span><span class="n">dec</span>
    <span class="k">return</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span></div>

<div class="viewcode-block" id="ra2deg"><a class="viewcode-back" href="../../../orb.utils.html#orb.utils.astrometry.ra2deg">[docs]</a><span class="k">def</span> <span class="nf">ra2deg</span><span class="p">(</span><span class="n">ra</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert RA in sexagesimal format to degrees.</span>

<span class="sd">    :param ra: RA in sexagesimal format</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ra</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ra</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,)):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">ra</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">ra</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">60.</span> <span class="o">+</span> <span class="n">ra</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mf">3600.</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">360.</span><span class="o">/</span><span class="mf">24.</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="dec2deg"><a class="viewcode-back" href="../../../orb.utils.html#orb.utils.astrometry.dec2deg">[docs]</a><span class="k">def</span> <span class="nf">dec2deg</span><span class="p">(</span><span class="n">dec</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert DEC in sexagesimal format to degrees.</span>

<span class="sd">    :param dec: DEC in sexagesimal format</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dec</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">dec</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,)):</span>
        <span class="k">if</span> <span class="n">dec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">dec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">60.</span> <span class="o">+</span> <span class="n">dec</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mf">3600.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">dec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">60.</span> <span class="o">-</span> <span class="n">dec</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mf">3600.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>   </div>

<div class="viewcode-block" id="deg2ra"><a class="viewcode-back" href="../../../orb.utils.html#orb.utils.astrometry.deg2ra">[docs]</a><span class="k">def</span> <span class="nf">deg2ra</span><span class="p">(</span><span class="n">deg</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert RA in degrees to sexagesimal.</span>

<span class="sd">    :param deg: RA in degrees</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">deg</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">deg</span><span class="p">)</span>
    <span class="n">ra</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">deg</span> <span class="o">=</span> <span class="n">deg</span><span class="o">*</span><span class="mf">24.</span><span class="o">/</span><span class="mf">360.</span>
    <span class="n">ra</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">deg</span><span class="p">)</span>
    <span class="n">deg</span> <span class="o">=</span> <span class="n">deg</span> <span class="o">-</span> <span class="n">ra</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">deg</span> <span class="o">*=</span> <span class="mf">60.</span>
    <span class="n">ra</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">deg</span><span class="p">)</span>
    <span class="n">deg</span> <span class="o">=</span> <span class="n">deg</span> <span class="o">-</span> <span class="n">ra</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">deg</span> <span class="o">*=</span> <span class="mf">60.</span>
    <span class="n">ra</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">deg</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">string</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ra</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2">:</span><span class="si">%d</span><span class="s2">:</span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ra</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ra</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ra</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span></div>

<div class="viewcode-block" id="deg2dec"><a class="viewcode-back" href="../../../orb.utils.html#orb.utils.astrometry.deg2dec">[docs]</a><span class="k">def</span> <span class="nf">deg2dec</span><span class="p">(</span><span class="n">deg</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert DEC in degrees to sexagesimal.</span>

<span class="sd">    :param deg: DEC in degrees</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">deg</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">deg</span><span class="p">)</span>
    <span class="n">dec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">dec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">deg</span><span class="p">)</span>
    <span class="n">deg</span> <span class="o">=</span> <span class="n">deg</span> <span class="o">-</span> <span class="n">dec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">deg</span> <span class="o">*=</span> <span class="mf">60.</span>
    <span class="n">dec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">deg</span><span class="p">)</span>
    <span class="n">deg</span> <span class="o">=</span> <span class="n">deg</span> <span class="o">-</span> <span class="n">dec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">deg</span> <span class="o">*=</span> <span class="mf">60.</span>
    <span class="n">dec</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">deg</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dec</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span> <span class="o">==</span> <span class="mf">60.0</span><span class="p">):</span>
        <span class="n">dec</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">dec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">dec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">60</span><span class="p">:</span>
        <span class="n">dec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">dec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">dec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">dec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">dec</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">dec</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">string</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">dec</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;+</span><span class="si">%d</span><span class="s2">:</span><span class="si">%d</span><span class="s2">:</span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dec</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dec</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span></div>

<div class="viewcode-block" id="transform_star_position_A_to_B"><a class="viewcode-back" href="../../../orb.utils.html#orb.utils.astrometry.transform_star_position_A_to_B">[docs]</a><span class="k">def</span> <span class="nf">transform_star_position_A_to_B</span><span class="p">(</span><span class="n">star_list_A</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">zoom_factor</span><span class="p">,</span>
                                   <span class="n">sip_A</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sip_B</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Transform star positions in camera A to the positions in camera</span>
<span class="sd">    B given the transformation parameters.</span>

<span class="sd">    Optionally SIP distorsion parameters can be given.</span>

<span class="sd">    The transformation steps are::</span>
<span class="sd">    </span>
<span class="sd">      dist_pix_camA -&gt; perf_pix_camA -&gt; geometric transformation_A2B</span>
<span class="sd">      -&gt; perf_pix_camB -&gt; dist_pix_camB</span>

<span class="sd">    :param star_list_A: List of star coordinates in the cube A.</span>
<span class="sd">    </span>
<span class="sd">    :param params: Transformation parameters [dx, dy, dr, da, db].</span>
<span class="sd">    </span>
<span class="sd">    :param rc: Rotation center coordinates.</span>
<span class="sd">    </span>
<span class="sd">    :param zoom_factor: Zooming factor between the two cameras. Can be</span>
<span class="sd">      a couple (zx, zy).</span>
<span class="sd">    </span>
<span class="sd">    :param sip_A: (Optional) pywcs.WCS instance containing SIP</span>
<span class="sd">      parameters of the frame A (default None).</span>
<span class="sd">      </span>
<span class="sd">    :param sip_B: (Optional) pywcs.WCS instance containing SIP</span>
<span class="sd">      parameters of the frame B (default None).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">zoom_factor</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">zx</span> <span class="o">=</span> <span class="n">zoom_factor</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">zy</span> <span class="o">=</span> <span class="n">zoom_factor</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">zx</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">zoom_factor</span><span class="p">)</span>
        <span class="n">zy</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">zoom_factor</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">star_list_A</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">star_list_A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">star_list_A</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">star_list_A</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="nb">float</span><span class="p">):</span>
        <span class="n">star_list_A</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

    <span class="n">star_list_B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">star_list_A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="c1"># dist_pix_camA -&gt; perf_pix_camA</span>
    <span class="k">if</span> <span class="n">sip_A</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1">#star_list_A = sip_pix2im(star_list_A, sip_A)</span>
        <span class="c1">## star_list_A = sip_A.sip.pix2foc(star_list_A) + sip_A.wcs.crpix</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;must be checked&#39;</span><span class="p">)</span>
        
        
    <span class="c1"># geometric transformation_A2B</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">istar</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">star_list_A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">star_list_B</span><span class="p">[</span><span class="n">istar</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">orb</span><span class="o">.</span><span class="n">cutils</span><span class="o">.</span><span class="n">transform_A_to_B</span><span class="p">(</span>
                <span class="n">star_list_A</span><span class="p">[</span><span class="n">istar</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">star_list_A</span><span class="p">[</span><span class="n">istar</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
                <span class="n">rc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">zx</span><span class="p">,</span> <span class="n">zy</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">star_list_B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">star_list_A</span><span class="p">)</span>
        
    <span class="c1"># perf_pix_camB -&gt; dist_pix_camB</span>
    <span class="k">if</span> <span class="n">sip_B</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1">## star_list_B = sip_im2pix(star_list_B, sip_B)</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;must be checked&#39;</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">star_list_B</span></div>


<div class="viewcode-block" id="get_profile"><a class="viewcode-back" href="../../../orb.utils.html#orb.utils.astrometry.get_profile">[docs]</a><span class="k">def</span> <span class="nf">get_profile</span><span class="p">(</span><span class="n">profile_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the PSF profile class corresponding to the given profile name.</span>

<span class="sd">    :param profile name: The name of the PSF profile. Must be &#39;moffat&#39;</span>
<span class="sd">      or &#39;gaussian&#39;.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">profile_name</span> <span class="o">==</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Gaussian</span>
    <span class="k">elif</span> <span class="n">profile_name</span> <span class="o">==</span> <span class="s1">&#39;moffat&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Moffat</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Bad profile name (</span><span class="si">%s</span><span class="s2">) ! Profile name must be &#39;gaussian&#39; or &#39;moffat&#39;&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">profile_name</span><span class="p">))</span></div>


<div class="viewcode-block" id="fit_stars_in_frame"><a class="viewcode-back" href="../../../orb.utils.html#orb.utils.astrometry.fit_stars_in_frame">[docs]</a><span class="k">def</span> <span class="nf">fit_stars_in_frame</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">star_list</span><span class="p">,</span> <span class="n">box_size</span><span class="p">,</span>
                       <span class="n">profile_name</span><span class="o">=</span><span class="s1">&#39;gaussian&#39;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">fwhm_pix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mf">3.5</span><span class="p">,</span> <span class="n">fit_tol</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">,</span>
                       <span class="n">fwhm_min</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">fix_height</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">fix_aperture_fwhm_pix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fix_beta</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                       <span class="n">fix_fwhm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">readout_noise</span><span class="o">=</span><span class="mf">10.</span><span class="p">,</span>
                       <span class="n">dark_current_level</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">local_background</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                       <span class="n">no_aperture_photometry</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="n">precise_guess</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">aper_coeff</span><span class="o">=</span><span class="mf">3.</span><span class="p">,</span> <span class="n">blur</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="n">no_fit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">estimate_local_noise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                       <span class="n">multi_fit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">enable_zoom</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="n">enable_rotation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">saturation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">fix_pos</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nozero</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                       <span class="n">sip</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">background_value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="c1">## WARNING : DO NOT CHANGE THE ORDER OF THE ARGUMENTS OR TAKE CARE</span>
    <span class="c1">## OF THE CALL IN astrometry.Astrometry.fit_stars_in_cube()</span>
  
    <span class="sd">&quot;&quot;&quot;Fit stars in a frame.</span>

<span class="sd">    .. note:: 2 fitting modes are possible:</span>
<span class="sd">    </span>
<span class="sd">      * Individual fit mode [multi_fit=False]: Stars are all fit</span>
<span class="sd">        independantly.</span>
<span class="sd">      </span>
<span class="sd">      * Multi fit mode [multi_fit=True]: Stars are fitted all together</span>
<span class="sd">        considering that the position pattern is well known, the same</span>
<span class="sd">        shift in x and y will be applied. Optionally the pattern can be</span>
<span class="sd">        rotated and zoomed. The FWHM is also considered to be the</span>
<span class="sd">        same. This option is far more robust and precise for alignment</span>
<span class="sd">        purpose.</span>

<span class="sd">    :param frame: The frame containing the stars to fit.</span>

<span class="sd">    :param star_list: A list of star positions as an array of shape</span>
<span class="sd">      (star_nb, 2)</span>

<span class="sd">    :param box_size: The size of the box created around a star to fit</span>
<span class="sd">      its parameter.</span>

<span class="sd">    :param profile_name: (Optional) Name of the PSF profile to use to</span>
<span class="sd">      fit stars. May be &#39;gaussian&#39; or &#39;moffat&#39; (default &#39;gaussian&#39;).</span>

<span class="sd">    :param fwhm_pix: (Optional) Estimate of the FWHM in pixels. If</span>
<span class="sd">      None given FWHM is estimated to half the box size (default</span>
<span class="sd">      None).</span>

<span class="sd">    :param scale: (Optional) Scale of the frame in arcsec/pixel. If</span>
<span class="sd">      given the fwhm in arcseconds is also computed (keyword:</span>
<span class="sd">      &#39;fwhm_arc&#39;) with the fit parameters (default None).</span>

<span class="sd">    :param beta: (Optional) Beta parameter of the moffat psf. Used</span>
<span class="sd">      only if the fitted profile is a Moffat psf (default 3.5).</span>

<span class="sd">    :param fix_height: (Optional) Fix height parameter to its</span>
<span class="sd">      estimation. If None, set by default to True in individual fit</span>
<span class="sd">      mode [multi_fit=False] and False in multi fit mode</span>
<span class="sd">      [multi_fit=True] (default None).</span>

<span class="sd">    :param fix_beta: (Optional) Fix beta to the given value (default</span>
<span class="sd">      True).</span>

<span class="sd">    :param fix_fwhm: (Optional) Fix FWHM to the given value or the</span>
<span class="sd">      estimated value (default False).</span>

<span class="sd">    :param fix_pos: (Optional) Fix x,y positions of the stars to the</span>
<span class="sd">      given value.</span>

<span class="sd">    :param fit_tol: (Optional) Tolerance on the paramaters fit (the</span>
<span class="sd">      lower the better but the longer too) (default 1e-2).</span>

<span class="sd">    :param nozero: (Optional) If True do not fit any star which box</span>
<span class="sd">      (the pixels around it) contains a zero. Valid only in individual</span>
<span class="sd">      fit mode [multi_fit=False] (default False).</span>

<span class="sd">    :param fwhm_min: (Optional) Minimum valid FWHM of the fitted star</span>
<span class="sd">      (default 0.5)</span>
<span class="sd">      </span>
<span class="sd">    :param silent: (Optional) If True no messages are printed (default</span>
<span class="sd">      True).</span>

<span class="sd">    :param local_background: (Optional) If True, height is estimated</span>
<span class="sd">      localy, i.e. around the star. If False, the sky background is</span>
<span class="sd">      determined in the whole frame. In individual fit mode</span>
<span class="sd">      [multi_fit=False] height will be the same for all the stars, and</span>
<span class="sd">      the fix_height option is thus automatically set to True. In</span>
<span class="sd">      multi fit mode [multi_fit=True] height is considered as a</span>
<span class="sd">      covarying parameter for all the stars but it won&#39;t be fixed</span>
<span class="sd">      (default True).</span>

<span class="sd">    :param fix_aperture_fwhm_pix: (Optional) If a positive float. FWHM</span>
<span class="sd">      used to scale aperture size is not computed from the mean FWHM</span>
<span class="sd">      in the frame but fixed to the given float (default None).</span>

<span class="sd">    :param no_aperture_photometry: (Optional) If True, aperture</span>
<span class="sd">      photometry will not be done after profile fitting (default</span>
<span class="sd">      False).</span>

<span class="sd">    :param precise_guess: (Optional) If True, the fit guess will be</span>
<span class="sd">      more precise but this can lead to errors if the stars positions</span>
<span class="sd">      are not already well known. Valid only in individual fit mode</span>
<span class="sd">      [multi_fit=False] (default False).</span>
<span class="sd">          </span>
<span class="sd">    :param readout_noise: (Optional) Readout noise in ADU/pixel (can</span>
<span class="sd">      be computed from bias frames: std(master_bias_frame)) (default</span>
<span class="sd">      10.)</span>
<span class="sd">    </span>
<span class="sd">    :param dark_current_level: (Optional) Dark current level in</span>
<span class="sd">      ADU/pixel (can be computed from dark frames:</span>
<span class="sd">      median(master_dark_frame)) (default 0.)</span>

<span class="sd">    :param aper_coeff: (Optional) Aperture coefficient. The aperture</span>
<span class="sd">      radius is Rap = aper_coeff * FWHM. Better when between 1.5 to</span>
<span class="sd">      reduce the variation of the collected photons with varying FWHM</span>
<span class="sd">      and 3. to account for the flux in the wings (default 3., better</span>
<span class="sd">      for star with a high SNR).</span>

<span class="sd">    :param blur: (Optional) If True, blur frame (low pass filtering)</span>
<span class="sd">      before fitting stars. It can be used to enhance the quality of</span>
<span class="sd">      the fitted flux of undersampled data. Note that the error on</span>
<span class="sd">      star position can be greater on blurred frame. This option must</span>
<span class="sd">      not be used for alignment purpose (default False).</span>

<span class="sd">    :param no_fit: (Optional) If True, no fit is done. Only the</span>
<span class="sd">      aperture photometry. Star positions in the star list must thus</span>
<span class="sd">      be precise (default False).</span>

<span class="sd">    :param multi_fit: (Optional) If True all stars are fitted at the</span>
<span class="sd">      same time. More robust for alignment purpose. The difference of</span>
<span class="sd">      position between the stars in the star list must be precisely</span>
<span class="sd">      known because the overall shift only is estimated (default</span>
<span class="sd">      False).</span>

<span class="sd">    :param enable_zoom: (Optional) If True, the stars position pattern</span>
<span class="sd">      can be zoomed to better adjust it to the real frame. Valid only</span>
<span class="sd">      in multi fit mode [multi_fit=True] (default False).</span>

<span class="sd">    :param enable_rotation: (Optional) If True, the stars position</span>
<span class="sd">      pattern can be rotated to better adjust it to the real frame</span>
<span class="sd">      Valid only in multi fit mode [multi_fit=True] (default False).</span>

<span class="sd">    :param estimate_local_noise: (Optional) If True, the level of</span>
<span class="sd">      noise is computed from the background pixels around the</span>
<span class="sd">      stars. readout_noise and dark_current_level are thus not used</span>
<span class="sd">      (default True).</span>

<span class="sd">    :param saturation: (Optional) If not None, all pixels above the</span>
<span class="sd">      saturation level are removed from the fit (default None).</span>

<span class="sd">    :param sip: (Optional) A pywcs.WCS instance containing SIP</span>
<span class="sd">      distorsion correction (default None).</span>

<span class="sd">    :param background_value: (Optional) If not None, this background</span>
<span class="sd">      value is used in the fit functions and will be fixed for fit and</span>
<span class="sd">      aperture photometry. Note also that in this case</span>
<span class="sd">      local_background is automatically set to False (default None).</span>
<span class="sd">    </span>
<span class="sd">    :return: Parameters of a 2D fit of the stars positions.</span>

<span class="sd">    .. seealso:: :py:meth:`astrometry.Astrometry.load_star_list` to load</span>
<span class="sd">      a predefined list of stars or</span>
<span class="sd">      :py:meth:`astrometry.Astrometry.detect_stars` to automatically</span>
<span class="sd">      create it.</span>

<span class="sd">    .. seealso:: :meth:`utils.astrometry.fit_star` and</span>
<span class="sd">      :meth:`orb.cutils.multi_fit_stars`</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">BOX_COEFF</span> <span class="o">=</span> <span class="mf">7.</span> <span class="c1"># Coefficient to redefine the box size if the</span>
                   <span class="c1"># fitted FWHM is too large</span>
    
    <span class="n">BIG_BOX_COEFF</span> <span class="o">=</span> <span class="mf">4.</span> <span class="c1"># Coefficient to apply to create a bigger box</span>
                       <span class="c1"># than the normal star box. This box is used for</span>
                       <span class="c1"># background determination and aperture</span>
                       <span class="c1"># photometry</span>
                       
    <span class="n">BLUR_FWHM</span> <span class="o">=</span> <span class="mf">3.5</span>   <span class="c1"># FWHM of the gaussian kernel used to blur frames</span>
    <span class="n">BLUR_DEG</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span>
        <span class="n">BLUR_FWHM</span> <span class="o">*</span> <span class="mf">2.</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">)))))</span>
    
    <span class="n">dimx</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">dimy</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">fitted_stars_params</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">fit_count</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">fit_results</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

    <span class="n">star_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">star_list</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">fix_height</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">multi_fit</span><span class="p">:</span> <span class="n">fix_height</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">fix_height</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">frame_median</span> <span class="o">=</span> <span class="n">bn</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">frame_median</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">:</span>
        <span class="n">frame</span> <span class="o">-=</span> <span class="n">frame_median</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;frame median is &lt; 0 (</span><span class="si">{}</span><span class="s1">), a value of </span><span class="si">{}</span><span class="s1"> has been subtracted to have a median at 0.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">frame_median</span><span class="p">,</span> <span class="n">frame_median</span><span class="p">))</span>
    
    <span class="c1">## Frame background determination if wanted</span>
    <span class="n">background</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">cov_height</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">background_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">local_background</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">background</span> <span class="o">=</span> <span class="n">background_value</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">local_background</span> <span class="ow">and</span> <span class="n">background_value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">precise_guess</span><span class="p">:</span>
            <span class="n">background</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">astrometry</span><span class="o">.</span><span class="n">sky_background_level</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">background</span> <span class="o">=</span> <span class="n">frame_median</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">multi_fit</span><span class="p">:</span>
            <span class="n">fix_height</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cov_height</span> <span class="o">=</span> <span class="kc">True</span>
    
    <span class="c1">## Blur frame to avoid undersampled data</span>
    <span class="k">if</span> <span class="n">blur</span><span class="p">:</span>
        <span class="n">fit_frame</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">low_pass_image_filter</span><span class="p">(</span>
            <span class="n">frame</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="n">BLUR_DEG</span><span class="p">))</span>
        <span class="n">fwhm_pix</span> <span class="o">=</span> <span class="n">BLUR_FWHM</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fit_frame</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

    <span class="c1">## Profile fitting</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">no_fit</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">multi_fit</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">saturation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">saturation</span> <span class="o">=</span> <span class="mi">0</span>
            
            <span class="n">fit_params</span> <span class="o">=</span> <span class="n">orb</span><span class="o">.</span><span class="n">cutils</span><span class="o">.</span><span class="n">multi_fit_stars</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fit_frame</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">star_list</span><span class="p">),</span> <span class="n">box_size</span><span class="p">,</span>
                <span class="n">height_guess</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">background</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">),</span>
                <span class="n">fwhm_guess</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">fwhm_pix</span><span class="p">),</span>
                <span class="n">cov_height</span><span class="o">=</span><span class="n">cov_height</span><span class="p">,</span>
                <span class="n">cov_pos</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">cov_fwhm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">fix_height</span><span class="o">=</span><span class="n">fix_height</span><span class="p">,</span>
                <span class="n">fix_pos</span><span class="o">=</span><span class="n">fix_pos</span><span class="p">,</span>
                <span class="n">fix_fwhm</span><span class="o">=</span><span class="n">fix_fwhm</span><span class="p">,</span>
                <span class="n">fit_tol</span><span class="o">=</span><span class="n">fit_tol</span><span class="p">,</span>
                <span class="n">ron</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">readout_noise</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">),</span>
                <span class="n">dcl</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dark_current_level</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">),</span>
                <span class="n">enable_zoom</span><span class="o">=</span><span class="n">enable_zoom</span><span class="p">,</span>
                <span class="n">enable_rotation</span><span class="o">=</span><span class="n">enable_rotation</span><span class="p">,</span>
                <span class="n">estimate_local_noise</span><span class="o">=</span><span class="n">estimate_local_noise</span><span class="p">,</span>
                <span class="n">saturation</span><span class="o">=</span><span class="n">saturation</span><span class="p">,</span> <span class="n">sip</span><span class="o">=</span><span class="n">sip</span><span class="p">)</span>
                
            <span class="c1"># save results as a StarsParams instance</span>
            <span class="k">for</span> <span class="n">istar</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">star_list</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">fit_params</span> <span class="o">!=</span> <span class="p">[]:</span>
                    <span class="n">star_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">fit_params</span><span class="p">[</span><span class="s1">&#39;stars-params&#39;</span><span class="p">][</span><span class="n">istar</span><span class="p">,</span> <span class="p">:]</span>
                    <span class="n">e</span> <span class="o">=</span> <span class="n">fit_params</span><span class="p">[</span><span class="s1">&#39;stars-params-err&#39;</span><span class="p">][</span><span class="n">istar</span><span class="p">,</span> <span class="p">:]</span>
                    
                    <span class="n">star_params</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">star_params</span><span class="p">[</span><span class="s1">&#39;height_err&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">star_params</span><span class="p">[</span><span class="s1">&#39;amplitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">star_params</span><span class="p">[</span><span class="s1">&#39;amplitude_err&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">star_params</span><span class="p">[</span><span class="s1">&#39;snr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">star_params</span><span class="p">[</span><span class="s1">&#39;amplitude&#39;</span><span class="p">]</span>
                                          <span class="o">/</span> <span class="n">star_params</span><span class="p">[</span><span class="s1">&#39;amplitude_err&#39;</span><span class="p">])</span>
                    <span class="n">star_params</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">star_params</span><span class="p">[</span><span class="s1">&#39;x_err&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">star_params</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                    <span class="n">star_params</span><span class="p">[</span><span class="s1">&#39;y_err&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                    <span class="n">star_params</span><span class="p">[</span><span class="s1">&#39;fwhm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                    <span class="n">star_params</span><span class="p">[</span><span class="s1">&#39;fwhm_pix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">star_params</span><span class="p">[</span><span class="s1">&#39;fwhm&#39;</span><span class="p">]</span>
                    <span class="n">star_params</span><span class="p">[</span><span class="s1">&#39;fwhm_err&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                    <span class="n">star_params</span><span class="p">[</span><span class="s1">&#39;chi-square&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit_params</span><span class="p">[</span><span class="s1">&#39;chi-square&#39;</span><span class="p">]</span>
                    <span class="n">star_params</span><span class="p">[</span><span class="s1">&#39;reduced-chi-square&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit_params</span><span class="p">[</span>
                        <span class="s1">&#39;reduced-chi-square&#39;</span><span class="p">]</span>
                    
                    <span class="n">star_params</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">get_profile</span><span class="p">(</span><span class="n">profile_name</span><span class="p">))(</span>
                        <span class="n">star_params</span><span class="p">)</span><span class="o">.</span><span class="n">flux</span><span class="p">()</span>
                    <span class="n">star_params</span><span class="p">[</span><span class="s1">&#39;flux_err&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">get_profile</span><span class="p">(</span><span class="n">profile_name</span><span class="p">))(</span>
                        <span class="n">star_params</span><span class="p">)</span><span class="o">.</span><span class="n">flux_error</span><span class="p">(</span>
                        <span class="n">star_params</span><span class="p">[</span><span class="s1">&#39;amplitude_err&#39;</span><span class="p">],</span>
                        <span class="n">star_params</span><span class="p">[</span><span class="s1">&#39;fwhm_err&#39;</span><span class="p">]</span>
                        <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">))))</span>
                    <span class="n">star_params</span><span class="p">[</span><span class="s1">&#39;dx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">star_params</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">star_list</span><span class="p">[</span><span class="n">istar</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">star_params</span><span class="p">[</span><span class="s1">&#39;dy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">star_params</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">star_list</span><span class="p">[</span><span class="n">istar</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">star_params</span><span class="p">[</span><span class="s1">&#39;cov_angle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit_params</span><span class="p">[</span><span class="s1">&#39;cov_angle&#39;</span><span class="p">]</span>
                    <span class="n">star_params</span><span class="p">[</span><span class="s1">&#39;cov_zx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit_params</span><span class="p">[</span><span class="s1">&#39;cov_zx&#39;</span><span class="p">]</span>
                    <span class="n">star_params</span><span class="p">[</span><span class="s1">&#39;cov_zy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit_params</span><span class="p">[</span><span class="s1">&#39;cov_zy&#39;</span><span class="p">]</span>
                    <span class="n">star_params</span><span class="p">[</span><span class="s1">&#39;cov_dx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit_params</span><span class="p">[</span><span class="s1">&#39;cov_dx&#39;</span><span class="p">]</span>
                    <span class="n">star_params</span><span class="p">[</span><span class="s1">&#39;cov_dy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit_params</span><span class="p">[</span><span class="s1">&#39;cov_dy&#39;</span><span class="p">]</span>
                    
                    <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">star_params</span><span class="p">[</span><span class="s1">&#39;fwhm_arc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="nb">float</span><span class="p">(</span><span class="n">star_params</span><span class="p">[</span><span class="s1">&#39;fwhm_pix&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="n">scale</span><span class="p">)</span>
                        <span class="n">star_params</span><span class="p">[</span><span class="s1">&#39;fwhm_arc_err&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="nb">float</span><span class="p">(</span><span class="n">star_params</span><span class="p">[</span><span class="s1">&#39;fwhm_err&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="n">scale</span><span class="p">)</span>
                    
                    <span class="n">fit_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">star_params</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fit_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">istar</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">star_list</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>        
                <span class="c1">## Create fit box</span>
                <span class="n">guess</span> <span class="o">=</span> <span class="n">star_list</span><span class="p">[</span><span class="n">istar</span><span class="p">,:]</span>
                <span class="k">if</span> <span class="n">guess</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="p">[</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">]</span> <span class="o">=</span> <span class="n">guess</span>
                <span class="k">elif</span> <span class="n">guess</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">:</span>
                    <span class="p">[</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">]</span> <span class="o">=</span> <span class="n">guess</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The star list must give 2 OR at least 4 parameters for each star [x, y, fwhm_x, fwhm_y]&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">x_test</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">x_test</span> <span class="o">&lt;</span> <span class="n">dimx</span>
                    <span class="ow">and</span> <span class="n">y_test</span> <span class="o">&gt;</span> <span class="mi">0</span>  <span class="ow">and</span> <span class="n">y_test</span> <span class="o">&lt;</span> <span class="n">dimy</span><span class="p">):</span>
                    <span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span>
                     <span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">)</span> <span class="o">=</span> <span class="n">orb</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">get_box_coords</span><span class="p">(</span>
                        <span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">box_size</span><span class="p">,</span>
                        <span class="mi">0</span><span class="p">,</span> <span class="n">dimx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dimy</span><span class="p">)</span>

                    <span class="n">star_box</span> <span class="o">=</span> <span class="n">fit_frame</span><span class="p">[</span><span class="n">x_min</span><span class="p">:</span><span class="n">x_max</span><span class="p">,</span> <span class="n">y_min</span><span class="p">:</span><span class="n">y_max</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                    <span class="n">star_box</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>

                <span class="c1">## Profile Fitting</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">star_box</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">float</span><span class="p">(</span><span class="n">box_size</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="p">(</span><span class="n">x_max</span> <span class="o">&lt;</span> <span class="n">dimx</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">x_min</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="p">(</span><span class="n">y_max</span> <span class="o">&lt;</span> <span class="n">dimy</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">y_min</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)):</span>

                    <span class="c1">## Local background determination for fitting</span>
                    <span class="k">if</span> <span class="n">local_background</span><span class="p">:</span>
                        <span class="n">background_box_size</span> <span class="o">=</span> <span class="n">BIG_BOX_COEFF</span> <span class="o">*</span> <span class="n">box_size</span>
                        <span class="p">(</span><span class="n">x_min_back</span><span class="p">,</span>
                         <span class="n">x_max_back</span><span class="p">,</span>
                         <span class="n">y_min_back</span><span class="p">,</span>
                         <span class="n">y_max_back</span><span class="p">)</span> <span class="o">=</span> <span class="n">orb</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">get_box_coords</span><span class="p">(</span>
                            <span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">background_box_size</span><span class="p">,</span>
                            <span class="mi">0</span><span class="p">,</span> <span class="n">dimx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dimy</span><span class="p">)</span>
                        <span class="n">background_box</span> <span class="o">=</span> <span class="n">fit_frame</span><span class="p">[</span><span class="n">x_min_back</span><span class="p">:</span><span class="n">x_max_back</span><span class="p">,</span>
                                                   <span class="n">y_min_back</span><span class="p">:</span><span class="n">y_max_back</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">precise_guess</span><span class="p">:</span>
                            <span class="n">background</span> <span class="o">=</span> <span class="n">sky_background_level</span><span class="p">(</span><span class="n">background_box</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">background</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">background_box</span><span class="p">)</span>


                    <span class="k">if</span> <span class="n">nozero</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">star_box</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">fit_params</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">fit_params</span> <span class="o">=</span> <span class="n">fit_star</span><span class="p">(</span>
                            <span class="n">star_box</span><span class="p">,</span> <span class="n">profile_name</span><span class="o">=</span><span class="n">profile_name</span><span class="p">,</span>
                            <span class="n">fwhm_pix</span><span class="o">=</span><span class="n">fwhm_pix</span><span class="p">,</span>
                            <span class="n">beta</span><span class="o">=</span><span class="n">beta</span><span class="p">,</span> <span class="n">fix_height</span><span class="o">=</span><span class="n">fix_height</span><span class="p">,</span>
                            <span class="n">fix_beta</span><span class="o">=</span><span class="n">fix_beta</span><span class="p">,</span>
                            <span class="n">fix_fwhm</span><span class="o">=</span><span class="n">fix_fwhm</span><span class="p">,</span>
                            <span class="n">fit_tol</span><span class="o">=</span><span class="n">fit_tol</span><span class="p">,</span>
                            <span class="n">fwhm_min</span><span class="o">=</span><span class="n">fwhm_min</span><span class="p">,</span>
                            <span class="n">height</span><span class="o">=</span><span class="n">background</span><span class="p">,</span>
                            <span class="n">ron</span><span class="o">=</span><span class="n">readout_noise</span><span class="p">,</span>
                            <span class="n">dcl</span><span class="o">=</span><span class="n">dark_current_level</span><span class="p">,</span>
                            <span class="n">precise_guess</span><span class="o">=</span><span class="n">precise_guess</span><span class="p">,</span>
                            <span class="n">estimate_local_noise</span><span class="o">=</span><span class="n">estimate_local_noise</span><span class="p">,</span>
                            <span class="n">saturation</span><span class="o">=</span><span class="n">saturation</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fit_params</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">fit_params</span> <span class="o">!=</span> <span class="p">[]):</span>
                    <span class="n">fit_count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="c1"># compute real position in the frame</span>
                    <span class="n">fit_params</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">x_min</span><span class="p">)</span>
                    <span class="n">fit_params</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">y_min</span><span class="p">)</span>

                    <span class="c1"># compute deviation from the position given in the</span>
                    <span class="c1"># star list (the center of the star box)</span>
                    <span class="n">fit_params</span><span class="p">[</span><span class="s1">&#39;dx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit_params</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_test</span>
                    <span class="n">fit_params</span><span class="p">[</span><span class="s1">&#39;dy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit_params</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">y_test</span>

                    <span class="c1"># compute FWHM in arcsec</span>
                    <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">fit_params</span><span class="p">[</span><span class="s1">&#39;fwhm_arc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">fit_params</span><span class="p">[</span><span class="s1">&#39;fwhm_pix&#39;</span><span class="p">])</span>
                                                  <span class="o">*</span> <span class="n">scale</span><span class="p">)</span>
                        <span class="n">fit_params</span><span class="p">[</span><span class="s1">&#39;fwhm_arc_err&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="nb">float</span><span class="p">(</span><span class="n">fit_params</span><span class="p">[</span><span class="s1">&#39;fwhm_err&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="n">scale</span><span class="p">)</span>

                    <span class="c1"># save results</span>
                    <span class="n">fit_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">fit_params</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fit_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span> <span class="c1"># if no_fit fit_results is filled with None</span>
        <span class="k">for</span> <span class="n">istar</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">star_list</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">fit_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        
    <span class="c1">## Compute aperture photometry</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">no_aperture_photometry</span><span class="p">:</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">no_fit</span><span class="p">:</span>
            <span class="c1"># get mean FWHM in the frame</span>
            <span class="k">if</span> <span class="n">fix_aperture_fwhm_pix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">fix_aperture_fwhm_pix</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
                    <span class="n">mean_fwhm</span> <span class="o">=</span> <span class="n">fix_aperture_fwhm_pix</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s1">&#39;Fixed FWHM for aperture photometry must be &gt; 0.&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">star_list</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">mean_fwhm</span> <span class="o">=</span> <span class="n">orb</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">robust_mean</span><span class="p">(</span>
                    <span class="n">orb</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sigmacut</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">ires</span><span class="p">[</span><span class="s1">&#39;fwhm_pix&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">ires</span> <span class="ow">in</span> <span class="n">fit_results</span> <span class="k">if</span> <span class="n">ires</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mean_fwhm</span> <span class="o">=</span> <span class="n">fit_results</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;fwhm_pix&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mean_fwhm</span> <span class="o">=</span> <span class="n">fwhm_pix</span>

        <span class="c1">## Local background determination for aperture</span>
        <span class="k">if</span> <span class="n">local_background</span><span class="p">:</span>
            <span class="n">background</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="c1"># get aperture given the mean FWHM</span>
        <span class="k">for</span> <span class="n">istar</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">star_list</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">fit_results</span><span class="p">[</span><span class="n">istar</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">no_fit</span><span class="p">):</span>
                <span class="n">new_box_size</span> <span class="o">=</span> <span class="n">BOX_COEFF</span> <span class="o">*</span> <span class="n">mean_fwhm</span>
                <span class="n">aperture_box_size</span> <span class="o">=</span> <span class="n">BIG_BOX_COEFF</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">box_size</span><span class="p">,</span> <span class="n">new_box_size</span><span class="p">)</span>
               
                <span class="k">if</span> <span class="ow">not</span> <span class="n">no_fit</span><span class="p">:</span>
                    <span class="n">ix</span> <span class="o">=</span> <span class="n">fit_results</span><span class="p">[</span><span class="n">istar</span><span class="p">][</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
                    <span class="n">iy</span> <span class="o">=</span> <span class="n">fit_results</span><span class="p">[</span><span class="n">istar</span><span class="p">][</span><span class="s1">&#39;y&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ix</span> <span class="o">=</span> <span class="n">star_list</span><span class="p">[</span><span class="n">istar</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">iy</span> <span class="o">=</span> <span class="n">star_list</span><span class="p">[</span><span class="n">istar</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">ix</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">ix</span> <span class="o">&lt;</span> <span class="n">dimx</span> <span class="ow">and</span> <span class="n">iy</span> <span class="o">&gt;</span> <span class="mi">0</span>  <span class="ow">and</span> <span class="n">iy</span> <span class="o">&lt;</span> <span class="n">dimy</span><span class="p">:</span>
                    <span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span>
                     <span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">)</span> <span class="o">=</span> <span class="n">orb</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">get_box_coords</span><span class="p">(</span>
                        <span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">aperture_box_size</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dimx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dimy</span><span class="p">)</span>
                    <span class="n">star_box</span> <span class="o">=</span> <span class="n">frame</span><span class="p">[</span><span class="n">x_min</span><span class="p">:</span><span class="n">x_max</span><span class="p">,</span> <span class="n">y_min</span><span class="p">:</span><span class="n">y_max</span><span class="p">]</span>
                    
                    <span class="n">photom_result</span> <span class="o">=</span> <span class="n">aperture_photometry</span><span class="p">(</span>
                        <span class="n">star_box</span><span class="p">,</span> <span class="n">mean_fwhm</span><span class="p">,</span> <span class="n">background_guess</span><span class="o">=</span><span class="n">background</span><span class="p">,</span>
                        <span class="n">aper_coeff</span><span class="o">=</span><span class="n">aper_coeff</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="n">no_fit</span><span class="p">:</span>
                        <span class="n">fit_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;aperture_flux&#39;</span><span class="p">:</span><span class="n">photom_result</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                      <span class="s1">&#39;aperture_flux_err&#39;</span><span class="p">:</span><span class="n">photom_result</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                      <span class="s1">&#39;aperture_surface&#39;</span><span class="p">:</span><span class="n">photom_result</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                                      <span class="s1">&#39;aperture_flux_bad&#39;</span><span class="p">:</span><span class="n">photom_result</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
                                      <span class="s1">&#39;aperture_background&#39;</span><span class="p">:</span><span class="n">photom_result</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
                                      <span class="s1">&#39;aperture_background_err&#39;</span><span class="p">:</span><span class="n">photom_result</span><span class="p">[</span><span class="mi">5</span><span class="p">]}</span>
                        
                        <span class="n">fit_results</span><span class="p">[</span><span class="n">istar</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit_params</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">fit_results</span><span class="p">[</span><span class="n">istar</span><span class="p">][</span><span class="s1">&#39;aperture_flux&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">photom_result</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">fit_results</span><span class="p">[</span><span class="n">istar</span><span class="p">][</span><span class="s1">&#39;aperture_flux_err&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">photom_result</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                        <span class="n">fit_results</span><span class="p">[</span><span class="n">istar</span><span class="p">][</span><span class="s1">&#39;aperture_surface&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">photom_result</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                        <span class="n">fit_results</span><span class="p">[</span><span class="n">istar</span><span class="p">][</span><span class="s1">&#39;aperture_flux_bad&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">photom_result</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                        <span class="n">fit_results</span><span class="p">[</span><span class="n">istar</span><span class="p">][</span><span class="s1">&#39;aperture_background&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">photom_result</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
                        <span class="n">fit_results</span><span class="p">[</span><span class="n">istar</span><span class="p">][</span><span class="s1">&#39;aperture_background_err&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">photom_result</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
                        
                    
        
    <span class="c1">## Print number of fitted stars</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2">/</span><span class="si">%d</span><span class="s2"> stars fitted&quot;</span> <span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fitted_stars_params</span><span class="p">),</span> <span class="n">star_list</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">fit_results</span></div>



<div class="viewcode-block" id="fit_sip"><a class="viewcode-back" href="../../../orb.utils.html#orb.utils.astrometry.fit_sip">[docs]</a><span class="k">def</span> <span class="nf">fit_sip</span><span class="p">(</span><span class="n">dimx</span><span class="p">,</span> <span class="n">dimy</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">star_list1</span><span class="p">,</span> <span class="n">star_list2</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">init_sip</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">err</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sip_order</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">crpix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">crval</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;FIT the distortion correction polynomial to match two lists</span>
<span class="sd">    of stars (the list of stars 2 is distorded to match the list</span>
<span class="sd">    of stars 1).</span>

<span class="sd">    :param dimx: X dimension of the image</span>

<span class="sd">    :param dimy: Y dimension of the image</span>

<span class="sd">    :param scale: Plate scale of the image in arcseconds</span>

<span class="sd">    :param star_list1: list of stars 1</span>

<span class="sd">    :param star_list2: list of stars 2</span>

<span class="sd">    :param params: (Optional) Transformation parameter to go from</span>
<span class="sd">      the list of stars 1 to the list of stars 2. Must be a tuple</span>
<span class="sd">      [dx, dy, dr, da, db, rcx, rcy, zoom_factor] (default None).</span>

<span class="sd">    :param init_sip: (Optional) Initial SIP (an astropy.wcs.WCS object,</span>
<span class="sd">      default None)</span>

<span class="sd">    :param err: (Optional) error on the star positions of the star</span>
<span class="sd">      list 2 (default None).</span>

<span class="sd">    :param sip_order: (Optional) SIP order (default 3).</span>

<span class="sd">    :param crpix: (Optional) If an initial wcs is not given (init_sip</span>
<span class="sd">      set to None) this header value must be given.</span>

<span class="sd">    :param crval: (Optional) If an initial wcs is not given (init_sip</span>
<span class="sd">      set to None) this header value must be given.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">p2sip</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">sip</span><span class="p">,</span> <span class="n">direct</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">direct</span><span class="p">:</span>
            <span class="n">sip</span><span class="o">.</span><span class="n">sip</span><span class="o">.</span><span class="n">a</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                <span class="n">p</span><span class="p">[:(</span><span class="n">sip</span><span class="o">.</span><span class="n">sip</span><span class="o">.</span><span class="n">a_order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">],</span>
                <span class="p">(</span><span class="n">sip</span><span class="o">.</span><span class="n">sip</span><span class="o">.</span><span class="n">a_order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sip</span><span class="o">.</span><span class="n">sip</span><span class="o">.</span><span class="n">a_order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="p">[(</span><span class="n">sip</span><span class="o">.</span><span class="n">sip</span><span class="o">.</span><span class="n">a_order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">:]</span>
            <span class="n">sip</span><span class="o">.</span><span class="n">sip</span><span class="o">.</span><span class="n">b</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                <span class="n">p</span><span class="p">[:(</span><span class="n">sip</span><span class="o">.</span><span class="n">sip</span><span class="o">.</span><span class="n">b_order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">],</span>
                <span class="p">(</span><span class="n">sip</span><span class="o">.</span><span class="n">sip</span><span class="o">.</span><span class="n">b_order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sip</span><span class="o">.</span><span class="n">sip</span><span class="o">.</span><span class="n">b_order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sip</span><span class="o">.</span><span class="n">sip</span><span class="o">.</span><span class="n">ap</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                <span class="n">p</span><span class="p">[:(</span><span class="n">sip</span><span class="o">.</span><span class="n">sip</span><span class="o">.</span><span class="n">a_order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">],</span>
                <span class="p">(</span><span class="n">sip</span><span class="o">.</span><span class="n">sip</span><span class="o">.</span><span class="n">a_order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sip</span><span class="o">.</span><span class="n">sip</span><span class="o">.</span><span class="n">a_order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="p">[(</span><span class="n">sip</span><span class="o">.</span><span class="n">sip</span><span class="o">.</span><span class="n">a_order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">:]</span>
            <span class="n">sip</span><span class="o">.</span><span class="n">sip</span><span class="o">.</span><span class="n">bp</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                <span class="n">p</span><span class="p">[:(</span><span class="n">sip</span><span class="o">.</span><span class="n">sip</span><span class="o">.</span><span class="n">b_order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">],</span>
                <span class="p">(</span><span class="n">sip</span><span class="o">.</span><span class="n">sip</span><span class="o">.</span><span class="n">b_order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sip</span><span class="o">.</span><span class="n">sip</span><span class="o">.</span><span class="n">b_order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">sip</span>

    <span class="k">def</span> <span class="nf">sip2p</span><span class="p">(</span><span class="n">sip</span><span class="p">,</span> <span class="n">direct</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">direct</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sip</span><span class="o">.</span><span class="n">sip</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
            <span class="n">p</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sip</span><span class="o">.</span><span class="n">sip</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sip</span><span class="o">.</span><span class="n">sip</span><span class="o">.</span><span class="n">ap</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
            <span class="n">p</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sip</span><span class="o">.</span><span class="n">sip</span><span class="o">.</span><span class="n">bp</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">p</span>

    <span class="k">def</span> <span class="nf">diff</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">star_list2</span><span class="p">,</span> <span class="n">star_list_deg1</span><span class="p">,</span> 
             <span class="n">params</span><span class="p">,</span> <span class="n">sip</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">direct</span><span class="p">):</span>
        <span class="n">sip</span> <span class="o">=</span> <span class="n">p2sip</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">sip</span><span class="p">,</span> <span class="n">direct</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">direct</span><span class="p">:</span>
                <span class="n">star_list_1t</span> <span class="o">=</span> <span class="n">sip</span><span class="o">.</span><span class="n">all_world2pix</span><span class="p">(</span><span class="n">star_list_deg1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            
                <span class="c1">## star_list_1t = transform_star_position_A_to_B(</span>
                <span class="c1">##     star_list1, params[:5],</span>
                <span class="c1">##     (params[5], params[6]),</span>
                <span class="c1">##     (params[7], params[8]),</span>
                <span class="c1">##     sip_A=None, sip_B=None)</span>

                <span class="n">dx</span> <span class="o">=</span> <span class="p">(</span><span class="n">star_list2</span> <span class="o">-</span> <span class="n">star_list_1t</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">dy</span> <span class="o">=</span> <span class="p">(</span><span class="n">star_list2</span> <span class="o">-</span> <span class="n">star_list_1t</span><span class="p">)[:,</span><span class="mi">1</span><span class="p">]</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">star_list_2t</span> <span class="o">=</span> <span class="n">sip</span><span class="o">.</span><span class="n">all_pix2world</span><span class="p">(</span><span class="n">star_list2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">star_list_2t</span> <span class="o">=</span> <span class="n">sip</span><span class="o">.</span><span class="n">all_world2pix</span><span class="p">(</span><span class="n">star_list_2t</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                            
                <span class="n">dx</span> <span class="o">=</span> <span class="p">(</span><span class="n">star_list_2t</span> <span class="o">-</span> <span class="n">star_list2</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">dy</span> <span class="o">=</span> <span class="p">(</span><span class="n">star_list_2t</span> <span class="o">-</span> <span class="n">star_list2</span><span class="p">)[:,</span><span class="mi">1</span><span class="p">]</span>

            <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">dx</span><span class="o">/</span><span class="n">err</span><span class="p">)</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">dy</span><span class="o">/</span><span class="n">err</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">result</span><span class="p">)):</span>
                <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">result</span><span class="o">**</span><span class="mf">2.</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="mf">1e9</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">warnings</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">return</span> <span class="mf">1e9</span>

    <span class="k">def</span> <span class="nf">add_sip</span><span class="p">(</span><span class="n">wcs</span><span class="p">):</span>
        <span class="n">wcs</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">ctype</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;RA---TAN-SIP&quot;</span><span class="p">,</span> <span class="s2">&quot;DEC--TAN-SIP&quot;</span><span class="p">]</span>
        <span class="n">wcs</span><span class="o">.</span><span class="n">sip</span> <span class="o">=</span> <span class="n">pywcs</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">Sip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">sip_order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sip_order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)),</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">sip_order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sip_order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)),</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">sip_order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sip_order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)),</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">sip_order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sip_order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)),</span>
                                <span class="n">wcs</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">crpix</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">wcs</span>



    <span class="k">if</span> <span class="n">params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Not implemented&#39;</span><span class="p">)</span>


    <span class="c1"># initialize WCS and SIP if not given</span>
    <span class="k">if</span> <span class="n">init_sip</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">crpix</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">crval</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;If an initial wcs is not given (init_sip set to None) CRPIX and CRVAL must be given.&#39;</span><span class="p">)</span>
        
        <span class="n">init_sip</span> <span class="o">=</span> <span class="n">create_wcs</span><span class="p">(</span><span class="n">crpix</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">crpix</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                              <span class="n">scale</span> <span class="o">/</span> <span class="mf">3600.</span><span class="p">,</span> <span class="n">scale</span> <span class="o">/</span> <span class="mf">3600.</span><span class="p">,</span>
                              <span class="n">crval</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">crval</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mf">0.</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> <span class="c1"># WCS copy to avoid modifing the original WCS</span>
        <span class="n">init_sipt</span> <span class="o">=</span> <span class="n">pywcs</span><span class="o">.</span><span class="n">WCS</span><span class="p">(</span><span class="n">init_sip</span><span class="o">.</span><span class="n">to_header</span><span class="p">(</span><span class="n">relax</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">init_sipt</span><span class="o">.</span><span class="n">sip</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">init_sip</span><span class="o">.</span><span class="n">sip</span><span class="p">)</span>
        <span class="n">init_sip</span> <span class="o">=</span> <span class="n">init_sipt</span>
        
    <span class="k">if</span> <span class="n">init_sip</span><span class="o">.</span><span class="n">sip</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">init_sip</span> <span class="o">=</span> <span class="n">add_sip</span><span class="p">(</span><span class="n">init_sip</span><span class="p">)</span>

    <span class="c1"># computation of a reference ra/dec list of stars from the</span>
    <span class="c1"># reference list of pixels (star_list1)</span>
    <span class="n">star_list_deg1</span> <span class="o">=</span> <span class="n">init_sip</span><span class="o">.</span><span class="n">all_pix2world</span><span class="p">(</span><span class="n">star_list1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">err</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">star_list1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">err</span><span class="p">)):</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">star_list1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="n">err</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

    <span class="n">guess</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sip2p</span><span class="p">(</span><span class="n">init_sip</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span>

    <span class="c1"># look for direct transformation parameters (A, B matrices)</span>
    <span class="n">fit</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">fmin</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="n">guess</span><span class="p">,</span>
                        <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">star_list2</span><span class="p">,</span> <span class="n">star_list_deg1</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span>
                              <span class="n">init_sip</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
                        <span class="n">full_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">xtol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">disp</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">fit</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s1">&#39;Optimized average radius for direct transformation (in pixel) </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fit</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">init_sip</span> <span class="o">=</span> <span class="n">p2sip</span><span class="p">(</span><span class="n">fit</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">init_sip</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;SIP direct transformation fit failed&#39;</span><span class="p">)</span>

    <span class="c1"># look for reverse transformation parameters (AP, BP matrices)</span>
    <span class="n">fit</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">fmin</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="o">-</span><span class="n">fit</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">star_list2</span><span class="p">,</span> <span class="n">star_list_deg1</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span>
                              <span class="n">init_sip</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
                        <span class="n">full_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">xtol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">disp</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">fit</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s1">&#39;Optimized average radius for reverse transformation (in pixel) </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fit</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">new_wcs</span> <span class="o">=</span> <span class="n">p2sip</span><span class="p">(</span><span class="n">fit</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">init_sip</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">new_wcs</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">cd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">new_wcs</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">get_cdelt</span><span class="p">()),</span>
                                <span class="n">new_wcs</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">get_pc</span><span class="p">())</span>
            
        <span class="k">return</span> <span class="n">new_wcs</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;SIP reverse transformation fit failed&#39;</span><span class="p">)</span></div>
    

<div class="viewcode-block" id="histogram_registration"><a class="viewcode-back" href="../../../orb.utils.html#orb.utils.astrometry.histogram_registration">[docs]</a><span class="k">def</span> <span class="nf">histogram_registration</span><span class="p">(</span><span class="n">star_list1</span><span class="p">,</span> <span class="n">star_list2</span><span class="p">,</span> <span class="n">dimx</span><span class="p">,</span> <span class="n">dimy</span><span class="p">,</span> <span class="n">xy_bins</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fast histogram registration of an image based on the comparison</span>
<span class="sd">    of two star lists: one created from the real star position in the</span>
<span class="sd">    image and the other from, e.g. a catalog.</span>

<span class="sd">    :param star_list1: first list of stars</span>

<span class="sd">    :param star_list2: second list of stars</span>

<span class="sd">    :param dimx: X dimension of the image in pixels</span>

<span class="sd">    :param dimy: Y dimension of the image inp ixels</span>

<span class="sd">    :param xy_bins: number of bins along X and Y</span>

<span class="sd">    .. warning:: This kind of registration is very sensitive to the</span>
<span class="sd">      angle between each list. It is better to use it on a range of</span>
<span class="sd">      angles (steps of 0.5 degree) to make sure the best correlation</span>
<span class="sd">      is found.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">hist_bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">dimx</span><span class="p">,</span> <span class="n">dimy</span><span class="p">),</span> <span class="n">xy_bins</span><span class="p">)</span>
    <span class="n">hist1</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogramdd</span><span class="p">(</span>
        <span class="n">star_list1</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="p">[</span><span class="n">hist_bins</span><span class="p">,</span><span class="n">hist_bins</span><span class="p">])</span>
    <span class="n">hist2</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogramdd</span><span class="p">(</span>
        <span class="n">star_list2</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="p">[</span><span class="n">hist_bins</span><span class="p">,</span><span class="n">hist_bins</span><span class="p">])</span>
    <span class="n">hist_corr</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">correlate2d</span><span class="p">(</span><span class="n">hist1</span><span class="p">,</span> <span class="n">hist2</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
    <span class="n">max_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanargmax</span><span class="p">(</span><span class="n">hist_corr</span><span class="p">),</span> <span class="n">hist1</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">max_corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">hist_corr</span><span class="p">)</span>
    <span class="n">max_dx</span> <span class="o">=</span> <span class="n">hist_bins</span><span class="p">[</span><span class="n">max_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">-</span> <span class="n">dimx</span> <span class="o">/</span> <span class="mf">2.</span>
    <span class="n">max_dy</span> <span class="o">=</span> <span class="n">hist_bins</span><span class="p">[</span><span class="n">max_index</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">-</span> <span class="n">dimx</span> <span class="o">/</span> <span class="mf">2.</span>

    <span class="k">return</span> <span class="n">max_corr</span><span class="p">,</span> <span class="n">max_dx</span><span class="p">,</span> <span class="n">max_dy</span>    </div>


<div class="viewcode-block" id="create_wcs"><a class="viewcode-back" href="../../../orb.utils.html#orb.utils.astrometry.create_wcs">[docs]</a><span class="k">def</span> <span class="nf">create_wcs</span><span class="p">(</span><span class="n">target_x</span><span class="p">,</span> <span class="n">target_y</span><span class="p">,</span> <span class="n">deltax</span><span class="p">,</span> <span class="n">deltay</span><span class="p">,</span> <span class="n">target_ra</span><span class="p">,</span>
               <span class="n">target_dec</span><span class="p">,</span> <span class="n">rotation</span><span class="p">,</span> <span class="n">sip</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a WCS with an optional SIP distortion model.</span>

<span class="sd">    :param wcs: Original WCS. If None, a 2 axis WCS is created instead.</span>

<span class="sd">    :param target_x: Target X position in pixels</span>

<span class="sd">    :param target_y: Target Y position in pixels</span>

<span class="sd">    :param deltax: Plate scale in arcdeg / pixel along X axis (don&#39;t forget to</span>
<span class="sd">      divide by 3600 if originally in arcsec by pixels)</span>

<span class="sd">    :param deltax: Plate scale in arcdeg / pixel along Y axis (don&#39;t forget to</span>
<span class="sd">      divide by 3600 if originally in arcsec by pixels)</span>

<span class="sd">    :param target_ra: Target RA</span>

<span class="sd">    :param target_dec: Target DEC</span>

<span class="sd">    :param rotation: Rotation angle</span>

<span class="sd">    :param sip: (Optional) astropy.WCS instance containing a valid SIP.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_wcs</span> <span class="o">=</span> <span class="n">pywcs</span><span class="o">.</span><span class="n">WCS</span><span class="p">(</span><span class="n">naxis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># a new WCS must be created. Never update</span>
                             <span class="c1"># an old WCS!</span>
        
    <span class="n">_wcs</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">crpix</span> <span class="o">=</span> <span class="p">[</span><span class="n">target_x</span><span class="p">,</span> <span class="n">target_y</span><span class="p">]</span>
    <span class="n">_wcs</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">cdelt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">deltax</span><span class="p">,</span> <span class="n">deltay</span><span class="p">])</span>
    <span class="n">_wcs</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">crval</span> <span class="o">=</span> <span class="p">[</span><span class="n">target_ra</span><span class="p">,</span> <span class="n">target_dec</span><span class="p">]</span>
    <span class="c1"># !! must stay here because get_pc does not work with RA---TAN-SIP type</span>
    <span class="n">_wcs</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">ctype</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;RA---TAN&quot;</span><span class="p">,</span> <span class="s2">&quot;DEC--TAN&quot;</span><span class="p">]</span> 
    <span class="n">_wcs</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">crota</span> <span class="o">=</span> <span class="p">[</span><span class="n">rotation</span><span class="p">,</span> <span class="n">rotation</span><span class="p">]</span>
    <span class="c1"># force wcs to CD definition (for SIP)</span>
    <span class="n">_wcs</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">cd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">_wcs</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">get_cdelt</span><span class="p">()),</span>
        <span class="n">_wcs</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">get_pc</span><span class="p">())</span>
    <span class="n">_wcs</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">ctype</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;RA---TAN-SIP&quot;</span><span class="p">,</span> <span class="s2">&quot;DEC--TAN-SIP&quot;</span><span class="p">]</span>
    <span class="n">_wcs</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">radesys</span> <span class="o">=</span> <span class="s1">&#39;FK5&#39;</span>
    <span class="n">_wcs</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">equinox</span> <span class="o">=</span> <span class="mf">2000.</span>
    <span class="k">del</span> <span class="n">_wcs</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">crota</span>
    <span class="k">if</span> <span class="n">sip</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_wcs</span><span class="o">.</span><span class="n">sip</span> <span class="o">=</span> <span class="n">sip</span><span class="o">.</span><span class="n">sip</span>
    <span class="k">return</span> <span class="n">_wcs</span></div>

<div class="viewcode-block" id="get_wcs_parameters"><a class="viewcode-back" href="../../../orb.utils.html#orb.utils.astrometry.get_wcs_parameters">[docs]</a><span class="k">def</span> <span class="nf">get_wcs_parameters</span><span class="p">(</span><span class="n">_wcs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return comprehensive parameters from a simple WCS as created</span>
<span class="sd">    with orb.utils.astrometry.create_wcs.</span>

<span class="sd">    :param wcs: An astropy.wcs.WCS instance created with</span>
<span class="sd">      orb.utils.astrometry.create_wcs.</span>

<span class="sd">    :return: target_x, target_y, deltax, deltay, target_ra,</span>
<span class="sd">      target_dec, rotation</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">target_x</span><span class="p">,</span> <span class="n">target_y</span> <span class="o">=</span> <span class="n">_wcs</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">crpix</span>
    <span class="n">target_ra</span><span class="p">,</span> <span class="n">target_dec</span> <span class="o">=</span> <span class="n">_wcs</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">crval</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">_wcs</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">cd</span><span class="p">)</span>
        <span class="n">rotation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="o">-</span><span class="n">cd</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="n">cd</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">deltax</span> <span class="o">=</span> <span class="o">-</span> <span class="n">cd</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">rotation</span><span class="p">))</span>
        <span class="n">deltay</span> <span class="o">=</span> <span class="o">-</span> <span class="n">cd</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">rotation</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> <span class="c1"># no cd is present</span>
        <span class="n">pc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">_wcs</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">get_pc</span><span class="p">())</span>
        <span class="n">rotation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">pc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">pc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">deltax</span><span class="p">,</span> <span class="n">deltay</span> <span class="o">=</span> <span class="n">_wcs</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">cdelt</span>
        <span class="n">deltax</span> <span class="o">=</span> <span class="o">-</span><span class="n">deltax</span>

    <span class="k">if</span> <span class="n">deltax</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;deltax and deltay must be equal and &gt; 0&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">rotation</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">90.</span> <span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;rotation angle must be &lt; 90. There must be an error.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">deltax</span><span class="p">,</span> <span class="n">deltay</span><span class="p">):</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;deltax must be equal to deltay&#39;</span><span class="p">)</span>
    <span class="n">deltay</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">deltax</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">target_x</span><span class="p">,</span> <span class="n">target_y</span><span class="p">,</span> <span class="n">deltax</span><span class="p">,</span> <span class="n">deltay</span><span class="p">,</span> <span class="n">target_ra</span><span class="p">,</span> <span class="n">target_dec</span><span class="p">,</span> <span class="n">rotation</span></div>

<div class="viewcode-block" id="brute_force_guess"><a class="viewcode-back" href="../../../orb.utils.html#orb.utils.astrometry.brute_force_guess">[docs]</a><span class="k">def</span> <span class="nf">brute_force_guess</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">star_list</span><span class="p">,</span> <span class="n">x_range</span><span class="p">,</span> <span class="n">y_range</span><span class="p">,</span> <span class="n">r_range</span><span class="p">,</span>
                      <span class="n">rc</span><span class="p">,</span> <span class="n">zoom_factor</span><span class="p">,</span> <span class="n">box_size</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">init_wcs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">raise_border_error</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Determine a precise alignment guess by brute force.</span>

<span class="sd">    :param star_list: List of star position. Must be given in pixels</span>
<span class="sd">      if no wcs is given (wcs set to None). If a wcs is given must be a</span>
<span class="sd">      list of ra/dec coordinates.</span>

<span class="sd">    :param x_range: range of x values to check</span>

<span class="sd">    :param y_range: range of y values to check</span>

<span class="sd">    :param r_range: range of angle values to check</span>

<span class="sd">    :param rc: rotation center (rc, ry). If a WCS is given the</span>
<span class="sd">      rotation center is obtaind from the wcs itself and must be set to</span>
<span class="sd">      None.</span>

<span class="sd">    :param zoom_factor: zoom_factor</span>

<span class="sd">    :param verbose: (Optional) If True, print some informations</span>
<span class="sd">      (default True).</span>

<span class="sd">    :param init_wcs: (Optional) WCS instance (can contain an SIP distortion</span>
<span class="sd">      model, default None).</span>

<span class="sd">    :param raise_border_error: (Optional) if True raise an exception</span>
<span class="sd">      if the returned guess is on the border of the brute force grid</span>
<span class="sd">      (defaut True).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">get_total_flux</span><span class="p">(</span><span class="n">guess_list</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">star_list</span><span class="p">,</span>
                       <span class="n">rc</span><span class="p">,</span> <span class="n">zoom_factor</span><span class="p">,</span> <span class="n">box_size</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">_wcs_str</span><span class="p">,</span> <span class="n">_wcsp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the sum of the flux around a transformed list of</span>
<span class="sd">        star positions for a list of parameters.        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_wcs</span> <span class="o">=</span> <span class="n">pywcs</span><span class="o">.</span><span class="n">WCS</span><span class="p">(</span><span class="n">_wcs_str</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">guess_list</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">4</span><span class="p">))</span>
        <span class="n">result</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">_wcsp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">_wcs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="p">(</span><span class="n">target_x</span><span class="p">,</span> <span class="n">target_y</span><span class="p">,</span> <span class="n">deltax</span><span class="p">,</span> <span class="n">deltay</span><span class="p">,</span>
             <span class="n">target_ra</span><span class="p">,</span> <span class="n">target_dec</span><span class="p">,</span> <span class="n">rotation</span><span class="p">)</span> <span class="o">=</span> <span class="n">_wcsp</span>
                
        <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">guess_list</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">guess</span> <span class="o">=</span> <span class="p">(</span><span class="n">guess_list</span><span class="p">[</span><span class="n">ik</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                     <span class="n">guess_list</span><span class="p">[</span><span class="n">ik</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                     <span class="n">guess_list</span><span class="p">[</span><span class="n">ik</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">_wcs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">iwcs</span> <span class="o">=</span> <span class="n">create_wcs</span><span class="p">(</span>
                    <span class="n">target_x</span> <span class="o">-</span> <span class="n">guess</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">target_y</span> <span class="o">-</span> <span class="n">guess</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">deltax</span> <span class="o">*</span> <span class="n">zoom_factor</span><span class="p">,</span>
                    <span class="n">deltay</span> <span class="o">*</span> <span class="n">zoom_factor</span><span class="p">,</span>
                    <span class="n">target_ra</span><span class="p">,</span> <span class="n">target_dec</span><span class="p">,</span>
                    <span class="n">rotation</span> <span class="o">-</span> <span class="n">guess</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">sip</span><span class="o">=</span><span class="n">_wcs</span><span class="p">)</span>
                <span class="n">star_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">star_list</span><span class="p">)</span>
                <span class="n">star_list_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">iwcs</span><span class="o">.</span><span class="n">all_world2pix</span><span class="p">(</span>
                    <span class="n">star_list</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">star_list</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
                <span class="n">star_list2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                <span class="c1"># removing stars not in the image</span>
                <span class="k">for</span> <span class="n">istar</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">star_list_t</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">star_list_t</span><span class="p">[</span><span class="n">istar</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.</span>
                        <span class="ow">and</span> <span class="n">star_list_t</span><span class="p">[</span><span class="n">istar</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="ow">and</span> <span class="n">star_list_t</span><span class="p">[</span><span class="n">istar</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.</span>
                        <span class="ow">and</span> <span class="n">star_list_t</span><span class="p">[</span><span class="n">istar</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                        <span class="n">star_list2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">star_list_t</span><span class="p">[</span><span class="n">istar</span><span class="p">,:])</span>
                <span class="n">star_list2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">star_list2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">star_list2</span> <span class="o">=</span> <span class="n">transform_star_position_A_to_B</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">star_list</span><span class="p">),</span> <span class="n">guess</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">zoom_factor</span><span class="p">)</span>

            <span class="n">total_flux</span> <span class="o">=</span> <span class="n">orb</span><span class="o">.</span><span class="n">cutils</span><span class="o">.</span><span class="n">brute_photometry</span><span class="p">(</span>
                <span class="n">image</span><span class="p">,</span> <span class="n">star_list2</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">box_size</span><span class="p">)</span>
            <span class="n">result</span><span class="p">[</span><span class="n">ik</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_flux</span>
            <span class="n">result</span><span class="p">[</span><span class="n">ik</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">guess_list</span><span class="p">[</span><span class="n">ik</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">result</span>
    
    <span class="k">if</span> <span class="n">init_wcs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">rc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;rc must be set to None if a wcs is given. rc automatically set to None.&#39;</span><span class="p">)</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">init_wcs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">rc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;rc automatically set.&#39;</span><span class="p">)</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s1">&#39;Brute force range:&#39;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_range</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s1">&#39;X = </span><span class="si">{:.2f}</span><span class="s1">:</span><span class="si">{:.2f}</span><span class="s1">:</span><span class="si">{:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">x_range</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x_range</span><span class="p">),</span> <span class="n">x_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_range</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s1">&#39;Y = </span><span class="si">{:.2f}</span><span class="s1">:</span><span class="si">{:.2f}</span><span class="s1">:</span><span class="si">{:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">y_range</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">y_range</span><span class="p">),</span> <span class="n">y_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">r_range</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s1">&#39;R = </span><span class="si">{:.2f}</span><span class="s1">:</span><span class="si">{:.2f}</span><span class="s1">:</span><span class="si">{:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">r_range</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">r_range</span><span class="p">),</span> <span class="n">r_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">r_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>


    <span class="n">guess_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">guess_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">x_range</span><span class="p">),</span>
                             <span class="nb">len</span><span class="p">(</span><span class="n">y_range</span><span class="p">),</span>
                             <span class="nb">len</span><span class="p">(</span><span class="n">r_range</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">guess_matrix_index_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

    <span class="n">box_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">box_size</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">box_size</span><span class="o">&amp;</span><span class="mi">1</span><span class="p">:</span> <span class="n">box_size</span> <span class="o">+=</span> <span class="mi">1</span> <span class="c1"># box_size must be odd</span>
    <span class="n">kernel</span> <span class="o">=</span> <span class="n">orb</span><span class="o">.</span><span class="n">cutils</span><span class="o">.</span><span class="n">gaussian_array2d</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="n">box_size</span> <span class="o">/</span><span class="mf">2.</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span>
                                         <span class="n">box_size</span> <span class="o">/</span><span class="mf">2.</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">box_size</span> <span class="o">/</span> <span class="mf">3.</span><span class="p">,</span>
                                         <span class="n">box_size</span><span class="p">,</span> <span class="n">box_size</span><span class="p">)</span>
    <span class="n">kernel</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">kernel</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x_range</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">idy</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y_range</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">idr</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">r_range</span><span class="p">)):</span>
                <span class="n">guess_matrix_index_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">idx</span><span class="p">,</span> <span class="n">idy</span><span class="p">,</span> <span class="n">idr</span><span class="p">))</span>
                <span class="n">guess_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x_range</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
                                            <span class="n">y_range</span><span class="p">[</span><span class="n">idy</span><span class="p">],</span>
                                            <span class="n">r_range</span><span class="p">[</span><span class="n">idr</span><span class="p">]]))</span>

    <span class="n">guess_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">guess_list</span><span class="p">)</span>
    <span class="c1"># Init of the multiprocessing server</span>
    <span class="n">job_server</span><span class="p">,</span> <span class="n">ncpus</span> <span class="o">=</span> <span class="n">orb</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">parallel</span><span class="o">.</span><span class="n">init_pp_server</span><span class="p">()</span>
    <span class="n">ncpus_max</span> <span class="o">=</span> <span class="n">ncpus</span>

    <span class="c1"># divide guess list in smaller lists for parallelization</span>
    <span class="n">pguess_cut_indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
        <span class="mi">0</span><span class="p">,</span> <span class="n">guess_list</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ncpus_max</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">pguess_lists</span> <span class="o">=</span> <span class="p">[</span><span class="n">guess_list</span><span class="p">[</span>
        <span class="n">pguess_cut_indexes</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="n">pguess_cut_indexes</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncpus_max</span><span class="p">)]</span>

    <span class="n">total_flux_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">guess_list</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">init_wcs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">wcs_params</span> <span class="o">=</span> <span class="n">get_wcs_parameters</span><span class="p">(</span><span class="n">init_wcs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">wcs_params</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">init_wcs_str</span> <span class="o">=</span> <span class="n">init_wcs</span><span class="o">.</span><span class="n">to_header_string</span><span class="p">(</span><span class="n">relax</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># parallel processing of each guess list part</span>
    <span class="n">jobs</span> <span class="o">=</span> <span class="p">[(</span><span class="n">ijob</span><span class="p">,</span> <span class="n">job_server</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
        <span class="n">get_total_flux</span><span class="p">,</span> 
        <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">pguess_lists</span><span class="p">[</span><span class="n">ijob</span><span class="p">],</span> <span class="n">image</span><span class="p">,</span>
              <span class="n">star_list</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">zoom_factor</span><span class="p">,</span>
              <span class="n">box_size</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">init_wcs_str</span><span class="p">,</span> <span class="n">wcs_params</span><span class="p">),</span>
        <span class="n">modules</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;import numpy as np&quot;</span><span class="p">,</span>
                 <span class="s2">&quot;import astropy.wcs as pywcs&quot;</span><span class="p">,</span>
                 <span class="s2">&quot;import orb.cutils&quot;</span><span class="p">,</span>
                 <span class="s2">&quot;import warnings&quot;</span><span class="p">,</span>
                 <span class="s2">&quot;from orb.utils.astrometry import *&quot;</span><span class="p">,</span>
                 <span class="s2">&quot;import astropy.io.fits as pyfits&quot;</span><span class="p">)))</span>
            <span class="k">for</span> <span class="n">ijob</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncpus</span><span class="p">)]</span>

    <span class="k">for</span> <span class="n">ijob</span><span class="p">,</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">:</span>
        <span class="n">total_flux_list</span><span class="p">[</span>
            <span class="n">pguess_cut_indexes</span><span class="p">[</span><span class="n">ijob</span><span class="p">]</span>
            <span class="p">:</span><span class="n">pguess_cut_indexes</span><span class="p">[</span><span class="n">ijob</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">job</span><span class="p">()</span>

    <span class="n">orb</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">parallel</span><span class="o">.</span><span class="n">close_pp_server</span><span class="p">(</span><span class="n">job_server</span><span class="p">)</span>

    <span class="c1"># rebuilding guess matrix</span>
    <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">guess_list</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">guess_matrix</span><span class="p">[</span>
            <span class="n">guess_matrix_index_list</span><span class="p">[</span><span class="n">ik</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">guess_matrix_index_list</span><span class="p">[</span><span class="n">ik</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">guess_matrix_index_list</span><span class="p">[</span><span class="n">ik</span><span class="p">][</span><span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">total_flux_list</span><span class="p">[</span><span class="n">ik</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

    <span class="c1"># avoid a negative guess matrix</span>
    <span class="n">guess_matrix</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">guess_matrix</span><span class="p">)</span>

    <span class="c1"># maximum value of the guess matrix is the best estimate</span>
    <span class="n">rough_dx</span><span class="p">,</span> <span class="n">rough_dy</span><span class="p">,</span> <span class="n">rough_dr</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">guess_matrix</span><span class="p">),</span> <span class="n">guess_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="n">index1d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel_multi_index</span><span class="p">((</span><span class="n">rough_dx</span><span class="p">,</span> <span class="n">rough_dy</span><span class="p">,</span> <span class="n">rough_dr</span><span class="p">),</span>
                                   <span class="n">guess_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="n">dx</span> <span class="o">=</span> <span class="n">total_flux_list</span><span class="p">[</span><span class="n">index1d</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">dy</span> <span class="o">=</span> <span class="n">total_flux_list</span><span class="p">[</span><span class="n">index1d</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">dr</span> <span class="o">=</span> <span class="n">total_flux_list</span><span class="p">[</span><span class="n">index1d</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s1">&#39;Brute force guess:</span><span class="se">\n</span><span class="s1">dx = </span><span class="si">{}</span><span class="se">\n</span><span class="s1">dy = </span><span class="si">{}</span><span class="s1"> </span><span class="se">\n</span><span class="s1">dr = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dr</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">raise_border_error</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">dx</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">x_range</span><span class="p">)</span>
            <span class="ow">or</span> <span class="n">dx</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x_range</span><span class="p">)</span>
            <span class="ow">or</span> <span class="n">dy</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">y_range</span><span class="p">)</span>
            <span class="ow">or</span> <span class="n">dy</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">y_range</span><span class="p">)</span>
            <span class="ow">or</span> <span class="n">dr</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">r_range</span><span class="p">)</span>
            <span class="ow">or</span> <span class="n">dr</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">r_range</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Brute force maximum found on grid border !&#39;</span><span class="p">)</span>
        

    <span class="k">return</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dr</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">guess_matrix</span><span class="p">)</span></div>



<div class="viewcode-block" id="world2pix"><a class="viewcode-back" href="../../../orb.utils.html#orb.utils.astrometry.world2pix">[docs]</a><span class="k">def</span> <span class="nf">world2pix</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="n">dimx</span><span class="p">,</span> <span class="n">dimy</span><span class="p">,</span> <span class="n">star_list_deg</span><span class="p">,</span> <span class="n">dxmap</span><span class="p">,</span> <span class="n">dymap</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert RA/DEC coordinates to pixel positions.</span>

<span class="sd">    :param hdr: pyfits.Header instance</span>

<span class="sd">    :param dimx: Image dimension along X</span>

<span class="sd">    :param dimy: Image dimension along Y</span>

<span class="sd">    :param star_list_deg: List of star coordinates in degrees</span>

<span class="sd">    :param dxmap: Distortion error map along X axis returned by</span>
<span class="sd">      orb.astrometry.Astrometry.register().</span>

<span class="sd">    :param dymap: Distortion error map along Y axis returned by</span>
<span class="sd">      orb.astrometry.Astrometry.register().</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dxspl</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">RectBivariateSpline</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dimx</span><span class="p">,</span> <span class="n">dxmap</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dimy</span><span class="p">,</span> <span class="n">dxmap</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
        <span class="n">dxmap</span><span class="p">,</span> <span class="n">kx</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">ky</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    
    <span class="n">dyspl</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">RectBivariateSpline</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dimx</span><span class="p">,</span> <span class="n">dymap</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dimy</span><span class="p">,</span> <span class="n">dymap</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
        <span class="n">dymap</span><span class="p">,</span> <span class="n">kx</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">ky</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

    <span class="n">wcs</span> <span class="o">=</span> <span class="n">pywcs</span><span class="o">.</span><span class="n">WCS</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="n">relax</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="n">star_list_pix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="n">wcs</span><span class="o">.</span><span class="n">all_world2pix</span><span class="p">(</span>
            <span class="n">star_list_deg</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">star_list_deg</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">detect_divergence</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>

    <span class="n">dx</span> <span class="o">=</span> <span class="n">dxspl</span><span class="o">.</span><span class="n">ev</span><span class="p">(</span><span class="n">star_list_pix</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span>
                  <span class="n">star_list_pix</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">dy</span> <span class="o">=</span> <span class="n">dyspl</span><span class="o">.</span><span class="n">ev</span><span class="p">(</span><span class="n">star_list_pix</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span>
                  <span class="n">star_list_pix</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">star_list_pix</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dx</span>
    <span class="n">star_list_pix</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dy</span>

    <span class="k">return</span> <span class="n">star_list_pix</span></div>

    
<div class="viewcode-block" id="pix2world"><a class="viewcode-back" href="../../../orb.utils.html#orb.utils.astrometry.pix2world">[docs]</a><span class="k">def</span> <span class="nf">pix2world</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="n">dimx</span><span class="p">,</span> <span class="n">dimy</span><span class="p">,</span> <span class="n">star_list_pix</span><span class="p">,</span> <span class="n">dxmap</span><span class="p">,</span> <span class="n">dymap</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert pixel positions to RA/DEC coordinates.</span>

<span class="sd">    :param hdr: pyfits.Header instance</span>

<span class="sd">    :param dimx: Image dimension along X</span>

<span class="sd">    :param dimy: Image dimension along Y</span>

<span class="sd">    :param star_list_pix: List of star coordinates in pixels</span>

<span class="sd">    :param dxmap: Distortion error map along X axis returned by</span>
<span class="sd">      orb.astrometry.Astrometry.register().</span>

<span class="sd">    :param dymap: Distortion error map along Y axis returned by</span>
<span class="sd">      orb.astrometry.Astrometry.register().</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dxspl</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">RectBivariateSpline</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dimx</span><span class="p">,</span> <span class="n">dxmap</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dimy</span><span class="p">,</span> <span class="n">dxmap</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
        <span class="n">dxmap</span><span class="p">,</span> <span class="n">kx</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">ky</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    
    <span class="n">dyspl</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">RectBivariateSpline</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dimx</span><span class="p">,</span> <span class="n">dymap</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dimy</span><span class="p">,</span> <span class="n">dymap</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
        <span class="n">dymap</span><span class="p">,</span> <span class="n">kx</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">ky</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

    <span class="n">wcs</span> <span class="o">=</span> <span class="n">pywcs</span><span class="o">.</span><span class="n">WCS</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="n">relax</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="n">dx</span> <span class="o">=</span> <span class="n">dxspl</span><span class="o">.</span><span class="n">ev</span><span class="p">(</span><span class="n">star_list_pix</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span>
                  <span class="n">star_list_pix</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">dy</span> <span class="o">=</span> <span class="n">dyspl</span><span class="o">.</span><span class="n">ev</span><span class="p">(</span><span class="n">star_list_pix</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span>
                  <span class="n">star_list_pix</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">star_list_pixt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">star_list_pix</span><span class="p">)</span>
    <span class="n">star_list_pixt</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="n">dx</span>
    <span class="n">star_list_pixt</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="n">dy</span>

    <span class="n">star_list_deg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="n">wcs</span><span class="o">.</span><span class="n">all_pix2world</span><span class="p">(</span>
            <span class="n">star_list_pixt</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">star_list_pixt</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>

    <span class="k">return</span> <span class="n">star_list_deg</span></div>


<div class="viewcode-block" id="realign_images"><a class="viewcode-back" href="../../../orb.utils.html#orb.utils.astrometry.realign_images">[docs]</a><span class="k">def</span> <span class="nf">realign_images</span><span class="p">(</span><span class="n">_cube</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Realign images of a small cube of images</span>

<span class="sd">    :param _cube: A 3 dimensional np.ndarray.</span>

<span class="sd">    .. warning:: This procedure is robust but very slow. Do not use it</span>
<span class="sd">      to realign a large number of images.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">im1</span> <span class="o">=</span> <span class="n">_cube</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">dimz</span> <span class="o">=</span> <span class="n">_cube</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">src1_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">im1</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="n">im1</span><span class="p">,</span> <span class="mf">99.9</span><span class="p">))</span>
    <span class="n">agg1_list</span> <span class="o">=</span> <span class="n">orb</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">aggregate_pixels</span><span class="p">(</span><span class="n">src1_list</span><span class="p">)</span>

    <span class="n">isrcx</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span> <span class="p">;</span> <span class="n">isrcy</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">isrc</span> <span class="ow">in</span> <span class="n">agg1_list</span><span class="p">:</span>
        <span class="n">isrc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">isrc</span><span class="p">)</span>
        <span class="n">isrcx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">isrc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">isrcy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">isrc</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">isrcx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">isrcx</span><span class="p">)</span>
    <span class="n">isrcy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">isrcy</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dimz</span><span class="p">):</span>
        <span class="c1"># detect sources</span>
        <span class="n">im2</span> <span class="o">=</span> <span class="n">_cube</span><span class="p">[:,:,</span><span class="n">ik</span><span class="p">]</span>
        <span class="n">src2_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">im2</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="n">im2</span><span class="p">,</span> <span class="mf">99.9</span><span class="p">))</span>
        <span class="n">agg2_list</span> <span class="o">=</span> <span class="n">orb</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">aggregate_pixels</span><span class="p">(</span><span class="n">src2_list</span><span class="p">)</span>
        <span class="n">isrcx2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span> <span class="p">;</span> <span class="n">isrcy2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">isrc2</span> <span class="ow">in</span> <span class="n">agg2_list</span><span class="p">:</span>
            <span class="n">isrc2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">isrc2</span><span class="p">)</span>
            <span class="n">isrcx2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">isrc2</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">isrcy2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">isrc2</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">isrcx2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">isrcx2</span><span class="p">)</span>
        <span class="n">isrcy2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">isrcy2</span><span class="p">)</span>

        <span class="n">neix</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">neiy</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">isrcx</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">isrcx2</span> <span class="o">-</span> <span class="n">isrcx</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
            <span class="n">idy</span> <span class="o">=</span> <span class="n">isrcy2</span> <span class="o">-</span> <span class="n">isrcy</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
            <span class="n">ir</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">idx</span><span class="o">**</span><span class="mf">2.</span> <span class="o">+</span> <span class="n">idy</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span>
            <span class="n">inei</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanargmin</span><span class="p">(</span><span class="n">ir</span><span class="p">)</span>
            <span class="n">neix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">[</span><span class="n">inei</span><span class="p">])</span>
            <span class="n">neiy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idy</span><span class="p">[</span><span class="n">inei</span><span class="p">])</span>

        <span class="n">dx</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">orb</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sigmacut</span><span class="p">(</span><span class="n">neix</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">2.</span><span class="p">))</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">orb</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sigmacut</span><span class="p">(</span><span class="n">neiy</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">2.</span><span class="p">))</span>

        <span class="nb">print</span> <span class="s1">&#39;dx: </span><span class="si">{}</span><span class="s1">, dy: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">)</span>
        <span class="n">_cube</span><span class="p">[:,:,</span><span class="n">ik</span><span class="p">]</span> <span class="o">=</span> <span class="n">orb</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">transform_frame</span><span class="p">(</span>
            <span class="n">im2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">im2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">im2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="p">(</span><span class="n">im2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">im2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">),</span> <span class="mf">1.</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_cube</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, Author.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.5.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.8</a>
      
    </div>

    

    
  </body>
</html>
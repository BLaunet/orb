<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>orb.core &#8212; orb  documentation</title>
    
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for orb.core</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/python</span>
<span class="c1"># *-* coding: utf-8 *-*</span>
<span class="c1"># Author: Thomas Martin &lt;thomas.martin.1@ulaval.ca&gt;</span>
<span class="c1"># File: core.py</span>

<span class="c1">## Copyright (c) 2010-2016 Thomas Martin &lt;thomas.martin.1@ulaval.ca&gt;</span>
<span class="c1">## </span>
<span class="c1">## This file is part of ORB</span>
<span class="c1">##</span>
<span class="c1">## ORB is free software: you can redistribute it and/or modify it</span>
<span class="c1">## under the terms of the GNU General Public License as published by</span>
<span class="c1">## the Free Software Foundation, either version 3 of the License, or</span>
<span class="c1">## (at your option) any later version.</span>
<span class="c1">##</span>
<span class="c1">## ORB is distributed in the hope that it will be useful, but WITHOUT</span>
<span class="c1">## ANY WARRANTY; without even the implied warranty of MERCHANTABILITY</span>
<span class="c1">## or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public</span>
<span class="c1">## License for more details.</span>
<span class="c1">##</span>
<span class="c1">## You should have received a copy of the GNU General Public License</span>
<span class="c1">## along with ORB.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">The Core module contains all the core classes of ORB.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;Thomas Martin&quot;</span>
<span class="n">__licence__</span> <span class="o">=</span> <span class="s2">&quot;Thomas Martin (thomas.martin.1@ulaval.ca)&quot;</span>                      
<span class="n">__docformat__</span> <span class="o">=</span> <span class="s1">&#39;reStructuredText&#39;</span>
<span class="kn">import</span> <span class="nn">version</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="n">version</span><span class="o">.</span><span class="n">__version__</span>

<span class="c1">## BASIC IMPORTS</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">datetime</span>

<span class="c1">## MODULES IMPORTS</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">bottleneck</span> <span class="k">as</span> <span class="nn">bn</span>
<span class="kn">import</span> <span class="nn">astropy.io.fits</span> <span class="k">as</span> <span class="nn">pyfits</span>
<span class="kn">import</span> <span class="nn">astropy.wcs</span> <span class="k">as</span> <span class="nn">pywcs</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">interpolate</span>
<span class="kn">import</span> <span class="nn">h5py</span>
<span class="kn">import</span> <span class="nn">dill</span>

<span class="c1">## ORB IMPORTS</span>
<span class="kn">import</span> <span class="nn">utils.spectrum</span><span class="o">,</span> <span class="nn">utils.parallel</span><span class="o">,</span> <span class="nn">utils.io</span><span class="o">,</span> <span class="nn">utils.filters</span>
<span class="kn">import</span> <span class="nn">utils.photometry</span>
<span class="kn">import</span> <span class="nn">constants</span>

<span class="c1">#################################################</span>
<span class="c1">#### CLASS TextColor ############################</span>
<span class="c1">#################################################</span>

<div class="viewcode-block" id="TextColor"><a class="viewcode-back" href="../../orb.html#orb.core.TextColor">[docs]</a><span class="k">class</span> <span class="nc">TextColor</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Define ANSI Escape sequences to display text with colors.</span>
<span class="sd">    </span>
<span class="sd">    .. warning:: Note that colored text doesn&#39;t work on Windows, use</span>
<span class="sd">       disable() function to disable coloured text.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">BLUE</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[1;94m&#39;</span>
    <span class="n">GREEN</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[1;92m&#39;</span>
    <span class="n">PURPLE</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[1;95m&#39;</span>
    <span class="n">WARNING</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[4;33m&#39;</span>
    <span class="n">ERROR</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[4;91m&#39;</span>
    <span class="n">END</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[0m&#39;</span>

<div class="viewcode-block" id="TextColor.disable"><a class="viewcode-back" href="../../orb.html#orb.core.TextColor.disable">[docs]</a>    <span class="k">def</span> <span class="nf">disable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Disable ANSI Escape sequences for windows portability</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BLUE</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">GREEN</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">PURPLE</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">WARNING</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ERROR</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">END</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span></div></div>


<span class="c1">#################################################</span>
<span class="c1">#### CLASS Tools ################################</span>
<span class="c1">#################################################</span>

<div class="viewcode-block" id="Tools"><a class="viewcode-back" href="../../orb.html#orb.core.Tools">[docs]</a><span class="k">class</span> <span class="nc">Tools</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parent class of all classes of orb.</span>

<span class="sd">    Manage configuration file, implement basic methods and manage the</span>
<span class="sd">    server for parallel processing.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">config_file_name</span> <span class="o">=</span> <span class="s1">&#39;config.orb&#39;</span> <span class="c1"># Name of the config file</span>
    <span class="n">ncpus</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># number of CPUs to use for parallel processing</span>
    
    <span class="n">_MASK_FRAME_TAIL</span> <span class="o">=</span> <span class="s1">&#39;_mask.fits&#39;</span> <span class="c1"># Tail of a mask frame</span>
    
    <span class="n">_msg_class_hdr</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="c1"># header of any message printed by this class</span>
                        <span class="c1"># or its inheritance (see _get_msg_class_hdr()</span>
                        <span class="c1"># function)</span>
                        
    <span class="n">_data_path_hdr</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="c1"># first part of the path of all the data files</span>
                        <span class="c1"># created during the reduction process.</span>
                        
    <span class="n">_data_prefix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="c1"># prefix used in the creation of _data_path_hdr</span>
                      <span class="c1"># (see _get_data_path_hdr() function)</span>

    <span class="n">_no_log</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># If True no logfile is created</span>

    <span class="n">_tuning_parameters</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span> <span class="c1"># Dictionay containing the full names of the</span>
                                <span class="c1"># parameter and their new value.</span>

    <span class="n">_silent</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># If True only error messages will be diplayed on screen</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_prefix</span><span class="o">=</span><span class="s2">&quot;./temp/data.&quot;</span><span class="p">,</span> <span class="n">no_log</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">tuning_parameters</span><span class="o">=</span><span class="nb">dict</span><span class="p">(),</span> <span class="n">ncpus</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">config_file_name</span><span class="o">=</span><span class="s1">&#39;config.orb&#39;</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize Tools class.</span>

<span class="sd">        :param data_prefix: (Optional) Prefix used to determine the</span>
<span class="sd">          header of the name of each created file (default</span>
<span class="sd">          &#39;temp_data&#39;)</span>

<span class="sd">        :param no_log: (Optional) If True (and if sys.stdout has been</span>
<span class="sd">          redirected to Logger) no log file is created (default</span>
<span class="sd">          False).</span>

<span class="sd">        :param ncpus: (Optional) Number of CPUs to use for parallel</span>
<span class="sd">          processing. set to None gives the maximum number available</span>
<span class="sd">          (default None).</span>

<span class="sd">        :param tuning_parameters: (Optional) Some parameters of the</span>
<span class="sd">          methods can be tuned externally using this dictionary. The</span>
<span class="sd">          dictionary must contains the full parameter name</span>
<span class="sd">          (class.method.parameter_name) and its value. For example :</span>
<span class="sd">          {&#39;InterferogramMerger.find_alignment.BOX_SIZE&#39;: 7}. Note</span>
<span class="sd">          that only some parameters can be tuned. This possibility is</span>
<span class="sd">          implemented into the method itself with the method</span>
<span class="sd">          :py:meth:`core.Tools._get_tuning_parameter`.</span>

<span class="sd">        :param config_file_name: (Optional) name of the config file to</span>
<span class="sd">          use. Must be located in orb/data/.</span>

<span class="sd">        :param silent: If True only error messages will be diplayed on</span>
<span class="sd">          screen (default False).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config_file_name</span> <span class="o">=</span> <span class="n">config_file_name</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;nt&#39;</span><span class="p">):</span>
            <span class="n">TextColor</span><span class="o">.</span><span class="n">disable</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_prefix</span> <span class="o">=</span> <span class="n">data_prefix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_msg_class_hdr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_msg_class_hdr</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_path_hdr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_data_path_hdr</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_no_log</span> <span class="o">=</span> <span class="n">no_log</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tuning_parameters</span> <span class="o">=</span> <span class="n">tuning_parameters</span>
        <span class="k">if</span> <span class="n">ncpus</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ncpus</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_config_parameter</span><span class="p">(</span><span class="s2">&quot;NCPUS&quot;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ncpus</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ncpus</span><span class="p">)</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">_silent</span> <span class="o">=</span> <span class="n">silent</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">showwarning</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_custom_warn</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_no_log</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">Logger</span><span class="p">):</span>
                <span class="n">Logger</span><span class="o">.</span><span class="n">nolog</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_get_msg_class_hdr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the header of the displayed messages.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;# &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span>
    
    <span class="k">def</span> <span class="nf">_get_data_path_hdr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the header of the created files.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_prefix</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span>

    <span class="k">def</span> <span class="nf">_get_orb_data_file_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the path to a file in ORB data folder: orb/data/file_name</span>

<span class="sd">        :param file_name: Name of the file in ORB data folder.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">_get_date_str</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return local date and hour as a short string </span>
<span class="sd">        for messages&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%y-%m-</span><span class="si">%d</span><span class="s2">|%H:%M:%S &quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">_get_config_file_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the full path to the configuration file given its name. </span>

<span class="sd">        The configuration file must exist and it must be located in</span>
<span class="sd">        orb/data/.</span>

<span class="sd">        :param config_file_name: Name of the configuration file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">config_file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_orb_data_file_path</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config_file_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">config_file_path</span><span class="p">):</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span>
                 <span class="s2">&quot;Configuration file </span><span class="si">%s</span><span class="s2"> does not exist !&quot;</span><span class="o">%</span><span class="n">config_file_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">config_file_path</span>

    <span class="k">def</span> <span class="nf">_get_filter_file_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filter_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the full path to the filter file given the name of</span>
<span class="sd">        the filter.</span>

<span class="sd">        The filter file name must be filter_FILTER_NAME and it must be</span>
<span class="sd">        located in orb/data/.</span>

<span class="sd">        :param filter_name: Name of the filter.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">filter_file_path</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">_get_orb_data_file_path</span><span class="p">(</span>
            <span class="s2">&quot;filter_&quot;</span> <span class="o">+</span> <span class="n">filter_name</span> <span class="o">+</span> <span class="s2">&quot;.orb&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filter_file_path</span><span class="p">):</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">_print_warning</span><span class="p">(</span>
                 <span class="s2">&quot;Filter file </span><span class="si">%s</span><span class="s2"> does not exist !&quot;</span><span class="o">%</span><span class="n">filter_file_path</span><span class="p">)</span>
             <span class="k">return</span> <span class="kc">None</span>
         
        <span class="k">return</span> <span class="n">filter_file_path</span>

    
    <span class="k">def</span> <span class="nf">_get_phase_file_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filter_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the full path to the phase file given the name of</span>
<span class="sd">        the filter.</span>

<span class="sd">        The file name must be &#39;phase_FILTER_NAME.orb&#39; and it must be</span>
<span class="sd">        located in orb/data/.</span>

<span class="sd">        :param filter_name: Name of the filter.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">phase_file_path</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">_get_orb_data_file_path</span><span class="p">(</span>
            <span class="s2">&quot;phase_&quot;</span> <span class="o">+</span> <span class="n">filter_name</span> <span class="o">+</span> <span class="s2">&quot;.orb&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">phase_file_path</span><span class="p">):</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">_print_warning</span><span class="p">(</span>
                 <span class="s2">&quot;Phase file </span><span class="si">%s</span><span class="s2"> does not exist !&quot;</span><span class="o">%</span><span class="n">phase_file_path</span><span class="p">)</span>
             <span class="k">return</span> <span class="kc">None</span>
         
        <span class="k">return</span> <span class="n">phase_file_path</span>

    <span class="k">def</span> <span class="nf">_get_sip_file_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">camera_number</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the full path to the FITS file containing the SIP</span>
<span class="sd">        header given the camera number.</span>
<span class="sd">    </span>

<span class="sd">        The file name must be &#39;sip.*.fits&#39; and it must be</span>
<span class="sd">        located in orb/data/.</span>

<span class="sd">        :param camera_number: Camera number (can be 1,2 or 0 for</span>
<span class="sd">          merged data)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">camera_number</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">cam_name</span> <span class="o">=</span> <span class="s1">&#39;merged&#39;</span>
        <span class="k">elif</span> <span class="n">camera_number</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="n">cam_name</span> <span class="o">=</span> <span class="s1">&#39;cam1&#39;</span>
        <span class="k">elif</span> <span class="n">camera_number</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> <span class="n">cam_name</span> <span class="o">=</span> <span class="s1">&#39;cam2&#39;</span>
        <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s1">&#39;Bad camera number, must be 0, 1 or 2&#39;</span><span class="p">)</span>
        
        <span class="n">sip_file_path</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">_get_orb_data_file_path</span><span class="p">(</span>
            <span class="s2">&quot;sip.&quot;</span> <span class="o">+</span> <span class="n">cam_name</span> <span class="o">+</span> <span class="s2">&quot;.fits&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">sip_file_path</span><span class="p">):</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">_print_warning</span><span class="p">(</span>
                 <span class="s2">&quot;SIP file </span><span class="si">%s</span><span class="s2"> does not exist !&quot;</span><span class="o">%</span><span class="n">sip_file_path</span><span class="p">)</span>
             <span class="k">return</span> <span class="kc">None</span>
         
        <span class="k">return</span> <span class="n">sip_file_path</span>


    <span class="k">def</span> <span class="nf">_get_optics_file_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filter_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the full path to the optics transmission file given</span>
<span class="sd">        the name of the filter.</span>

<span class="sd">        The filter file name must be filter_FILTER_NAME and it must be</span>
<span class="sd">        located in orb/data/.</span>

<span class="sd">        :param filter_name: Name of the filter.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">optics_file_path</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">_get_orb_data_file_path</span><span class="p">(</span>
            <span class="s2">&quot;optics_&quot;</span> <span class="o">+</span> <span class="n">filter_name</span> <span class="o">+</span> <span class="s2">&quot;.orb&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">optics_file_path</span><span class="p">):</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">_print_warning</span><span class="p">(</span>
                 <span class="s2">&quot;Optics file </span><span class="si">%s</span><span class="s2"> does not exist !&quot;</span><span class="o">%</span><span class="n">optics_file_path</span><span class="p">)</span>
             <span class="k">return</span> <span class="kc">None</span>
         
        <span class="k">return</span> <span class="n">optics_file_path</span>

    <span class="k">def</span> <span class="nf">_get_standard_table_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">standard_table_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the full path to the standard table giving name,</span>
<span class="sd">        location and type of the recorded standard spectra.</span>

<span class="sd">        :param standard_table_name: Name of the standard table file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">standard_table_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_orb_data_file_path</span><span class="p">(</span>
            <span class="n">standard_table_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">standard_table_path</span><span class="p">):</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span>
                 <span class="s2">&quot;Standard table </span><span class="si">%s</span><span class="s2"> does not exist !&quot;</span><span class="o">%</span><span class="n">standard_table_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">standard_table_path</span>


    <span class="k">def</span> <span class="nf">_get_standard_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">standard_table_name</span><span class="o">=</span><span class="s1">&#39;std_table.orb&#39;</span><span class="p">,</span>
                           <span class="n">group</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the list of standards recorded in the standard table</span>

<span class="sd">        :param standard_table_name: (Optional) Name of the standard</span>
<span class="sd">          table file (default std_table.orb).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;MASSEY&#39;</span><span class="p">,</span> <span class="s1">&#39;MISC&#39;</span><span class="p">,</span> <span class="s1">&#39;CALSPEC&#39;</span><span class="p">,</span> <span class="s1">&#39;OKE&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s1">&#39;Group must be in </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">groups</span><span class="p">))</span>
        <span class="n">std_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_standard_table_path</span><span class="p">(</span>
            <span class="n">standard_table_name</span><span class="o">=</span><span class="n">standard_table_name</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">std_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">iline</span> <span class="ow">in</span> <span class="n">std_table</span><span class="p">:</span>
            <span class="n">iline</span> <span class="o">=</span> <span class="n">iline</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">iline</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">group</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">std_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iline</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">iline</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">group</span><span class="p">:</span>
                    <span class="n">std_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iline</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    
        <span class="n">std_list</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">std_list</span>
    
    <span class="k">def</span> <span class="nf">_get_standard_file_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">standard_name</span><span class="p">,</span>
                                <span class="n">standard_table_name</span><span class="o">=</span><span class="s1">&#39;std_table.orb&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a standard spectrum file path.</span>
<span class="sd">        </span>
<span class="sd">        :param standard_name: Name of the standard star. Must be</span>
<span class="sd">          recorded in the standard table.</span>
<span class="sd">        </span>
<span class="sd">        :param standard_table_name: (Optional) Name of the standard</span>
<span class="sd">          table file (default std_table.orb).</span>

<span class="sd">        :return: A tuple [standard file path, standard type]. Standard type</span>
<span class="sd">          can be &#39;MASSEY&#39;, &#39;CALSPEC&#39;, &#39;MISC&#39; or &#39;OKE&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">std_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_standard_table_path</span><span class="p">(</span>
            <span class="n">standard_table_name</span><span class="o">=</span><span class="n">standard_table_name</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">iline</span> <span class="ow">in</span> <span class="n">std_table</span><span class="p">:</span>
            <span class="n">iline</span> <span class="o">=</span> <span class="n">iline</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">iline</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">iline</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">standard_name</span><span class="p">:</span>
                    <span class="n">file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_orb_data_file_path</span><span class="p">(</span><span class="n">iline</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
                        <span class="k">return</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">iline</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s1">&#39;Standard name unknown. Please see data/std_table.orb for the list of recorded standard spectra&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_standard_radec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">standard_name</span><span class="p">,</span>
                            <span class="n">standard_table_name</span><span class="o">=</span><span class="s1">&#39;std_table.orb&#39;</span><span class="p">,</span>
                            <span class="n">return_pm</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a standard spectrum file path.</span>
<span class="sd">        </span>
<span class="sd">        :param standard_name: Name of the standard star. Must be</span>
<span class="sd">          recorded in the standard table.</span>
<span class="sd">        </span>
<span class="sd">        :param standard_table_name: (Optional) Name of the standard</span>
<span class="sd">          table file (default std_table.orb).</span>

<span class="sd">        :param return_pm: (Optional) Returns also proper motion if</span>
<span class="sd">          recorded (in mas/yr), else returns 0.</span>

<span class="sd">        :return: A tuple [standard file path, standard type]. Standard type</span>
<span class="sd">          can be &#39;MASSEY&#39;, &#39;MISC&#39;, &#39;CALSPEC&#39; or &#39;OKE&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">std_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_standard_table_path</span><span class="p">(</span>
            <span class="n">standard_table_name</span><span class="o">=</span><span class="n">standard_table_name</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">iline</span> <span class="ow">in</span> <span class="n">std_table</span><span class="p">:</span>
            <span class="n">iline</span> <span class="o">=</span> <span class="n">iline</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">iline</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">iline</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">standard_name</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">iline</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="n">ra</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">iline</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                        <span class="n">dec</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">iline</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">iline</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
                            <span class="n">pm_ra</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">iline</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
                            <span class="n">pm_dec</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">iline</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">pm_ra</span> <span class="o">=</span> <span class="mf">0.</span>
                            <span class="n">pm_dec</span> <span class="o">=</span> <span class="mf">0.</span>
                        <span class="k">if</span> <span class="n">return_pm</span><span class="p">:</span>
                            <span class="k">return</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">pm_ra</span><span class="p">,</span> <span class="n">pm_dec</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">return</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s1">&#39;No RA DEC recorded for standard: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">standard_name</span><span class="p">))</span>
                    

        <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s1">&#39;Standard name unknown. Please see data/std_table.orb for the list of recorded standard spectra&#39;</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_get_atmospheric_extinction_file_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the path to the atmospheric extinction file&quot;&quot;&quot;</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_config_parameter</span><span class="p">(</span><span class="s1">&#39;ATM_EXTINCTION_FILE&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_orb_data_file_path</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_mirror_transmission_file_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the path to the telescope mirror transmission file&quot;&quot;&quot;</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_config_parameter</span><span class="p">(</span><span class="s1">&#39;MIR_TRANSMISSION_FILE&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_orb_data_file_path</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_quantum_efficiency_file_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">camera_number</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the path to the quantum efficiency file</span>

<span class="sd">        :param camera_number: Number of the camera, can be 1 or 2.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_config_parameter</span><span class="p">(</span>
            <span class="s1">&#39;CAM</span><span class="si">{}</span><span class="s1">_QE_FILE&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">camera_number</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_orb_data_file_path</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
    
  
    <span class="k">def</span> <span class="nf">_get_config_parameter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param_key</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a parameter written in a config file located in</span>
<span class="sd">          orb/data/</span>

<span class="sd">        :param param_key: Key of the parameter to be read</span>

<span class="sd">        :param optional: (Optional) If True, a parameter key which is</span>
<span class="sd">          not found only raise a warning and the method returns</span>
<span class="sd">          None. Else, an error is raised (Default False).</span>

<span class="sd">        .. Note:: A parameter key is a string in upper case</span>
<span class="sd">          (e.g. PIX_SIZE_CAM1) which starts a line and which must be</span>
<span class="sd">          followed in the configuration file by an empty space and the</span>
<span class="sd">          parameter (in one word - no empty space). The following</span>
<span class="sd">          words on the same line are not read. A line not starting by</span>
<span class="sd">          a parameter key is considered as a comment. Please refer to</span>
<span class="sd">          the configuration file in orb/data/ folder::</span>
<span class="sd">          </span>
<span class="sd">             ## ORB configuration file </span>
<span class="sd">             # Author: Thomas Martin &lt;thomas.martin.1@ulaval.ca&gt;</span>
<span class="sd">             </span>
<span class="sd">             ## Instrumental parameters</span>
<span class="sd">             PIX_SIZE_CAM1 20 # Size of one pixel of the camera 1 in um</span>
<span class="sd">             PIX_SIZE_CAM2 15 # Size of one pixel of the camera 2 in um  </span>
<span class="sd">        &quot;&quot;&quot;</span> 
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_config_file_path</span><span class="p">(),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">param_key</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">optional</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s2">&quot;Parameter key </span><span class="si">%s</span><span class="s2"> not found in file </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span>
                <span class="n">param_key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_file_name</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_warning</span><span class="p">(</span><span class="s2">&quot;Parameter key </span><span class="si">%s</span><span class="s2"> not found in file </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span>
                <span class="n">param_key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_file_name</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">None</span>


    <span class="k">def</span> <span class="nf">_print_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print an error message and raise an exception which will</span>
<span class="sd">        stop the execution of the program.</span>

<span class="sd">        Error messages are written in the log file.</span>
<span class="sd">        </span>
<span class="sd">        :param message: The message to be displayed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_date_str</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_msg_class_hdr</span> <span class="o">+</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span> <span class="o">+</span> <span class="s2">&quot; &gt; Error: &quot;</span> <span class="o">+</span> <span class="n">message</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">Logger</span><span class="p">):</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">error_msg</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">TextColor</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">TextColor</span><span class="o">.</span><span class="n">ERROR</span> <span class="o">+</span> <span class="n">error_msg</span> <span class="o">+</span> <span class="n">TextColor</span><span class="o">.</span><span class="n">END</span>
            
        <span class="k">raise</span> <span class="n">StandardError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_print_caller_traceback</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print the traceback of the calling function.&quot;&quot;&quot;</span>
        <span class="n">traceback</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span>
        <span class="n">traceback_msg</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">traceback</span><span class="p">))[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">traceback_msg</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;  File </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">traceback</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                              <span class="o">+</span> <span class="s1">&#39;, line </span><span class="si">%d</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">traceback</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
                              <span class="o">+</span> <span class="s1">&#39;, in </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">traceback</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span>
                              <span class="n">traceback</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">4</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            
        <span class="nb">print</span> <span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">traceback_msg</span>

    <span class="k">def</span> <span class="nf">_print_warning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">traceback</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print a warning message. No exception is raised.</span>
<span class="sd">        </span>
<span class="sd">        Warning  messages are written in the log file.</span>
<span class="sd">        </span>
<span class="sd">        :param message: The message to be displayed.</span>

<span class="sd">        :param traceback: (Optional) If True, print traceback (default</span>
<span class="sd">          False)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_silent</span><span class="p">:</span> <span class="k">return</span>
        <span class="k">if</span> <span class="n">traceback</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_caller_traceback</span><span class="p">()</span>
            
        <span class="n">warning_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_date_str</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_msg_class_hdr</span> <span class="o">+</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span> <span class="o">+</span> <span class="s2">&quot; &gt; Warning: &quot;</span> <span class="o">+</span> <span class="n">message</span>
        
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">Logger</span><span class="p">):</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">warning_msg</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">TextColor</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">TextColor</span><span class="o">.</span><span class="n">WARNING</span> <span class="o">+</span> <span class="n">warning_msg</span> <span class="o">+</span> <span class="n">TextColor</span><span class="o">.</span><span class="n">END</span>
        
    <span class="k">def</span> <span class="nf">_custom_warn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">lineno</span><span class="p">,</span>
                     <span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Redirect warnings thrown by external functions</span>
<span class="sd">        (e.g. :py:mod:`orb.utils`) to :py:meth:`orb._print_warning`.</span>

<span class="sd">        The parameters are the same parameters as the method</span>
<span class="sd">        warnings.showwarning (see the python module warnings).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print_warning</span><span class="p">(</span><span class="n">warnings</span><span class="o">.</span><span class="n">formatwarning</span><span class="p">(</span>
            <span class="n">message</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">lineno</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_print_msg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">no_hdr</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print a simple message.</span>
<span class="sd">        </span>
<span class="sd">        Simple messages are written in the log file.</span>

<span class="sd">        :param message: The message to be displayed.</span>
<span class="sd">        </span>
<span class="sd">        :param color: (Optional) If True, the message is diplayed in</span>
<span class="sd">          color. If &#39;alt&#39;, an alternative color is displayed.</span>

<span class="sd">        :param no_hdr: (Optional) If True, The message is displayed</span>
<span class="sd">          as it is, without any header.   </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_silent</span><span class="p">:</span> <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">no_hdr</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_date_str</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_msg_class_hdr</span> <span class="o">+</span> 
                       <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span> <span class="o">+</span> <span class="s2">&quot; &gt; &quot;</span> <span class="o">+</span> <span class="n">message</span><span class="p">)</span>
            
        <span class="n">text_col</span> <span class="o">=</span> <span class="n">TextColor</span><span class="o">.</span><span class="n">BLUE</span>
        <span class="k">if</span> <span class="n">color</span> <span class="o">==</span> <span class="s1">&#39;alt&#39;</span><span class="p">:</span>
            <span class="n">color</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">text_col</span> <span class="o">=</span> <span class="n">TextColor</span><span class="o">.</span><span class="n">PURPLE</span>
            
        <span class="k">if</span> <span class="n">color</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">Logger</span><span class="p">):</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">message</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">text_col</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span> <span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">text_col</span> <span class="o">+</span> <span class="n">message</span> <span class="o">+</span> <span class="n">TextColor</span><span class="o">.</span><span class="n">END</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span> <span class="n">message</span>
        
    <span class="k">def</span> <span class="nf">_print_traceback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">no_hdr</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print a traceback</span>

<span class="sd">        :param no_hdr: (Optional) If True, The message is displayed</span>
<span class="sd">          as it is, without any header.</span>

<span class="sd">        .. note:: This method returns a traceback only if an error has</span>
<span class="sd">          been raised.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">no_hdr</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_date_str</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_msg_class_hdr</span> <span class="o">+</span> 
                       <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span> <span class="o">+</span> <span class="s2">&quot; &gt; &quot;</span> <span class="o">+</span> <span class="n">message</span><span class="p">)</span>
            
        <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">message</span>
            
    <span class="k">def</span> <span class="nf">_update_fits_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fits_name</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">comment</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update one key of a FITS file. If the key doesn&#39;t exist</span>
<span class="sd">        create one.</span>
<span class="sd">        </span>
<span class="sd">        :param fits_name: Path to the file, can be either</span>
<span class="sd">          relative or absolut.</span>
<span class="sd">        </span>
<span class="sd">        :param key: Exact name of the key to be updated.</span>
<span class="sd">        </span>
<span class="sd">        :param value: New value of the key</span>

<span class="sd">        :param comment: Comment on this key</span>

<span class="sd">        .. note:: Please refer to</span>
<span class="sd">          http://www.stsci.edu/institute/software_hardware/pyfits/ for</span>
<span class="sd">          more information on PyFITS module. And</span>
<span class="sd">          http://fits.gsfc.nasa.gov/ for more information on FITS</span>
<span class="sd">          files.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fits_name</span> <span class="o">=</span> <span class="p">(</span><span class="n">fits_name</span><span class="o">.</span><span class="n">splitlines</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">hdulist</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fits_name</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;update&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span>
                <span class="s2">&quot;The file &#39;</span><span class="si">%s</span><span class="s2">&#39; could not be opened&quot;</span><span class="o">%</span><span class="n">fits_name</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">prihdr</span> <span class="o">=</span> <span class="n">hdulist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
        <span class="n">prihdr</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">comment</span><span class="p">)</span>
        <span class="n">hdulist</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">hdulist</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_get_basic_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_type</span><span class="p">,</span> <span class="n">config_file_name</span><span class="o">=</span><span class="s1">&#39;config.orb&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a basic header as a list of tuples (key, value,</span>
<span class="sd">        comment) that can be added to any FITS file created by</span>
<span class="sd">        :meth:`core.Tools.write_fits`.</span>
<span class="sd">        </span>
<span class="sd">        :param file_type: Description of the type of file created.</span>
<span class="sd">        </span>
<span class="sd">        :param config_file_name: (Optional) Name of the configuration</span>
<span class="sd">          file (config.orb by default).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;COMMENT&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
        <span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;COMMENT&#39;</span><span class="p">,</span><span class="s1">&#39;General&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
        <span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;COMMENT&#39;</span><span class="p">,</span><span class="s1">&#39;-------&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
        <span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;COMMENT&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
        <span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;FILETYPE&#39;</span><span class="p">,</span> <span class="n">file_type</span><span class="p">,</span> <span class="s1">&#39;Type of file&#39;</span><span class="p">))</span>
        <span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;OBSERVAT&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_config_parameter</span><span class="p">(</span>
                    <span class="s2">&quot;OBSERVATORY_NAME&quot;</span><span class="p">),</span> 
                    <span class="s1">&#39;Observatory name&#39;</span><span class="p">))</span>
        <span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;TELESCOP&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_config_parameter</span><span class="p">(</span>
                    <span class="s2">&quot;TELESCOPE_NAME&quot;</span><span class="p">),</span>
                    <span class="s1">&#39;Telescope name&#39;</span><span class="p">))</span>  
        <span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;INSTRUME&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_config_parameter</span><span class="p">(</span>
                    <span class="s2">&quot;INSTRUMENT_NAME&quot;</span><span class="p">),</span>
                    <span class="s1">&#39;Instrument name&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">hdr</span>
        
    <span class="k">def</span> <span class="nf">_get_basic_frame_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dimx</span><span class="p">,</span> <span class="n">dimy</span><span class="p">,</span>
                                <span class="n">config_file_name</span><span class="o">=</span><span class="s1">&#39;config.orb&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a specific part of a header that can be used for image</span>
<span class="sd">        files or frames. It creates a false WCS useful to get a rough</span>
<span class="sd">        idea of the angular separation between two objects in the</span>
<span class="sd">        image.</span>

<span class="sd">        The header is returned as a list of tuples (key, value,</span>
<span class="sd">        comment) that can be added to any FITS file created by</span>
<span class="sd">        :meth:`core.Tools.write_fits`. You can add this part to the</span>
<span class="sd">        basic header returned by :meth:`core.Tools._get_basic_header`</span>

<span class="sd">        :param dimx: dimension of the first axis of the frame</span>
<span class="sd">        :param dimy: dimension of the second axis of the frame</span>
<span class="sd">        :param config_file_name: (Optional) Name of the configuration</span>
<span class="sd">          file (config.orb by default).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">FIELD_OF_VIEW</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_config_parameter</span><span class="p">(</span>
            <span class="s2">&quot;FIELD_OF_VIEW_1&quot;</span><span class="p">))</span>
        <span class="n">x_delta</span> <span class="o">=</span> <span class="n">FIELD_OF_VIEW</span> <span class="o">/</span> <span class="n">dimx</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mf">60.</span><span class="p">)</span>
        <span class="n">y_delta</span> <span class="o">=</span> <span class="n">FIELD_OF_VIEW</span> <span class="o">/</span> <span class="n">dimy</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mf">60.</span><span class="p">)</span>
        <span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;COMMENT&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
        <span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;COMMENT&#39;</span><span class="p">,</span><span class="s1">&#39;Frame WCS&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
        <span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;COMMENT&#39;</span><span class="p">,</span><span class="s1">&#39;---------&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
        <span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;COMMENT&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
        <span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;CTYPE1&#39;</span><span class="p">,</span> <span class="s1">&#39;DEC--TAN&#39;</span><span class="p">,</span> <span class="s1">&#39;Gnomonic projection&#39;</span><span class="p">))</span>
        <span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;CRVAL1&#39;</span><span class="p">,</span> <span class="mf">0.000000</span><span class="p">,</span> <span class="s1">&#39;DEC at reference point&#39;</span><span class="p">))</span>
        <span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;CUNIT1&#39;</span><span class="p">,</span> <span class="s1">&#39;deg&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
        <span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;CRPIX1&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;Pixel coordinate of reference point&#39;</span><span class="p">))</span>
        <span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;CDELT1&#39;</span><span class="p">,</span> <span class="n">x_delta</span><span class="p">,</span> <span class="s1">&#39;Degrees per pixel&#39;</span><span class="p">))</span>
        <span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;CROTA1&#39;</span><span class="p">,</span> <span class="mf">0.000000</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
        <span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;CTYPE2&#39;</span><span class="p">,</span> <span class="s1">&#39;RA---TAN&#39;</span><span class="p">,</span> <span class="s1">&#39;Gnomonic projection&#39;</span><span class="p">))</span>
        <span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;CRVAL2&#39;</span><span class="p">,</span> <span class="mf">0.000000</span><span class="p">,</span> <span class="s1">&#39;RA at reference point&#39;</span><span class="p">))</span>
        <span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;CUNIT2&#39;</span><span class="p">,</span> <span class="s1">&#39;deg&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
        <span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;CRPIX2&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;Pixel coordinate of reference point&#39;</span><span class="p">))</span>
        <span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;CDELT2&#39;</span><span class="p">,</span> <span class="n">y_delta</span><span class="p">,</span> <span class="s1">&#39;Degrees per pixel&#39;</span><span class="p">))</span>
        <span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;CROTA2&#39;</span><span class="p">,</span> <span class="mf">0.000000</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">hdr</span>

    <span class="k">def</span> <span class="nf">_get_fft_params_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">apodization_function</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a specific part of the header containing the</span>
<span class="sd">        parameters of the FFT.</span>

<span class="sd">        :param apodization_function: Name of the apodization function.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;COMMENT&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
        <span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;COMMENT&#39;</span><span class="p">,</span><span class="s1">&#39;FFT Parameters&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
        <span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;COMMENT&#39;</span><span class="p">,</span><span class="s1">&#39;--------------&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
        <span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;COMMENT&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
        <span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;APODIZ&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">apodization_function</span><span class="p">),</span>
                    <span class="s1">&#39;Apodization function&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">hdr</span>

    <span class="k">def</span> <span class="nf">_get_basic_spectrum_frame_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame_index</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span>
                                         <span class="n">wavenumber</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a specific part of a header that can be used for</span>
<span class="sd">        independant frames of a spectral cube. It gives the wavelength</span>
<span class="sd">        position of the frame.</span>

<span class="sd">        The header is returned as a list of tuples (key, value,</span>
<span class="sd">        comment) that can be added to any FITS file created by</span>
<span class="sd">        :meth:`core.Tools.write_fits`. You can add this part to the</span>
<span class="sd">        basic header returned by :meth:`core.Tools._get_basic_header`</span>
<span class="sd">        and :meth:`core.Tools._get_frame_header`</span>
<span class="sd">        </span>
<span class="sd">        :param frame_index: Index of the frame.</span>
<span class="sd">        </span>
<span class="sd">        :param axis: Spectrum axis. The axis must have the same length</span>
<span class="sd">          as the number of frames in the cube. Must be an axis in</span>
<span class="sd">          wavenumber (cm1) or in wavelength (nm).</span>

<span class="sd">        :param wavenumber: (Optional) If True the axis is considered</span>
<span class="sd">          to be in wavenumber (cm1). If False it is considered to be</span>
<span class="sd">          in wavelength (nm) (default False).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">wavenumber</span><span class="p">:</span>
            <span class="n">wave_type</span> <span class="o">=</span> <span class="s1">&#39;wavelength&#39;</span>
            <span class="n">wave_unit</span> <span class="o">=</span> <span class="s1">&#39;nm&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wave_type</span> <span class="o">=</span> <span class="s1">&#39;wavenumber&#39;</span>
            <span class="n">wave_unit</span> <span class="o">=</span> <span class="s1">&#39;cm-1&#39;</span>

        <span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;COMMENT&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
        <span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;COMMENT&#39;</span><span class="p">,</span><span class="s1">&#39;Frame </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">wave_type</span><span class="p">),</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
        <span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;COMMENT&#39;</span><span class="p">,</span><span class="s1">&#39;----------------&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
        <span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;COMMENT&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
        <span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;FRAMENB&#39;</span><span class="p">,</span> <span class="n">frame_index</span><span class="p">,</span> <span class="s1">&#39;Frame number&#39;</span><span class="p">))</span>
        
        <span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;WAVEMIN&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="p">[</span><span class="n">frame_index</span><span class="p">],</span> 
                    <span class="s1">&#39;Minimum </span><span class="si">{}</span><span class="s1"> in the frame in </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">wave_type</span><span class="p">,</span>
                                                           <span class="n">wave_unit</span><span class="p">)))</span>
        <span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;WAVEMAX&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="p">[</span><span class="n">frame_index</span><span class="p">]</span> <span class="o">+</span> <span class="n">axis</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">axis</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
                    <span class="s1">&#39;Maximum </span><span class="si">{}</span><span class="s1"> in the frame in </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">wave_type</span><span class="p">,</span>
                                                           <span class="n">wave_unit</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">hdr</span>

    <span class="k">def</span> <span class="nf">_get_basic_spectrum_cube_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">wavenumber</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a specific part of a header that can be used for</span>
<span class="sd">        a spectral cube. It creates the wavelength axis of the cube.</span>

<span class="sd">        The header is returned as a list of tuples (key, value,</span>
<span class="sd">        comment) that can be added to any FITS file created by</span>
<span class="sd">        :meth:`core.Tools.write_fits`. You can add this part to the</span>
<span class="sd">        basic header returned by :meth:`core.Tools._get_basic_header`</span>
<span class="sd">        and :meth:`core.Tools._get_frame_header`</span>

<span class="sd">        :param axis: Spectrum axis. The axis must have the same length</span>
<span class="sd">          as the number of frames in the cube. Must be an axis in</span>
<span class="sd">          wavenumber (cm1) or in wavelength (nm)</span>
<span class="sd">          </span>
<span class="sd">        :param wavenumber: (Optional) If True the axis is considered</span>
<span class="sd">          to be in wavenumber (cm1). If False it is considered to be</span>
<span class="sd">          in wavelength (nm) (default False).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">wavenumber</span><span class="p">:</span>
            <span class="n">wave_type</span> <span class="o">=</span> <span class="s1">&#39;wavelength&#39;</span>
            <span class="n">wave_unit</span> <span class="o">=</span> <span class="s1">&#39;nm&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wave_type</span> <span class="o">=</span> <span class="s1">&#39;wavenumber&#39;</span>
            <span class="n">wave_unit</span> <span class="o">=</span> <span class="s1">&#39;cm-1&#39;</span>
        <span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;COMMENT&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
        <span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;COMMENT&#39;</span><span class="p">,</span><span class="s1">&#39;Spectrum axis&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
        <span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;COMMENT&#39;</span><span class="p">,</span><span class="s1">&#39;-------------&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
        <span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;COMMENT&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
        <span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;WAVTYPE&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">wave_type</span><span class="o">.</span><span class="n">upper</span><span class="p">()),</span>
                    <span class="s1">&#39;Spectral axis type: wavenumber or wavelength&#39;</span><span class="p">))</span>
        <span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;CTYPE3&#39;</span><span class="p">,</span> <span class="s1">&#39;WAVE&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> in </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">wave_type</span><span class="p">,</span>
                                                        <span class="n">wave_unit</span><span class="p">)))</span>
        <span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;CRVAL3&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;Minimum </span><span class="si">{}</span><span class="s1"> in </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">wave_type</span><span class="p">,</span>
                                                                    <span class="n">wave_unit</span><span class="p">)))</span>
        <span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;CUNIT3&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">wave_unit</span><span class="p">),</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
        <span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;CRPIX3&#39;</span><span class="p">,</span> <span class="mf">1.000000</span><span class="p">,</span> <span class="s1">&#39;Pixel coordinate of reference point&#39;</span><span class="p">))</span>
        <span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;CDELT3&#39;</span><span class="p">,</span> 
                    <span class="p">((</span><span class="n">axis</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">axis</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)),</span> 
                    <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> per pixel&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">wave_unit</span><span class="p">)))</span>
        <span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;CROTA3&#39;</span><span class="p">,</span> <span class="mf">0.000000</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">hdr</span>

    <span class="k">def</span> <span class="nf">_get_basic_spectrum_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">wavenumber</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a specific part of a header that can be used for</span>
<span class="sd">        a 1D spectrum. It creates the wavelength axis.</span>

<span class="sd">        The header is returned as a list of tuples (key, value,</span>
<span class="sd">        comment) that can be added to any FITS file created by</span>
<span class="sd">        :meth:`core.Tools.write_fits`. You can add this part to the</span>
<span class="sd">        basic header returned by :meth:`core.Tools._get_basic_header`</span>
<span class="sd">        and :meth:`core.Tools._get_frame_header`</span>

<span class="sd">        :param axis: Spectrum axis. The axis must have the same length</span>
<span class="sd">          as the spectrum length. Must be an axis in wavenumber (cm1)</span>
<span class="sd">          or in wavelength (nm)</span>
<span class="sd">          </span>
<span class="sd">        :param wavenumber: (Optional) If True the axis is considered</span>
<span class="sd">          to be in wavenumber (cm1). If False it is considered to be</span>
<span class="sd">          in wavelength (nm) (default False).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">wavenumber</span><span class="p">:</span>
            <span class="n">wave_type</span> <span class="o">=</span> <span class="s1">&#39;wavelength&#39;</span>
            <span class="n">wave_unit</span> <span class="o">=</span> <span class="s1">&#39;nm&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wave_type</span> <span class="o">=</span> <span class="s1">&#39;wavenumber&#39;</span>
            <span class="n">wave_unit</span> <span class="o">=</span> <span class="s1">&#39;cm-1&#39;</span>
        <span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;CTYPE1&#39;</span><span class="p">,</span> <span class="s1">&#39;WAVE&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> in </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">wave_type</span><span class="p">,</span> <span class="n">wave_unit</span><span class="p">)))</span>
        <span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;CRVAL1&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;Minimum </span><span class="si">{}</span><span class="s1"> in </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">wave_type</span><span class="p">,</span> <span class="n">wave_unit</span><span class="p">)))</span>
        <span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;CUNIT1&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">wave_unit</span><span class="p">),</span>
                    <span class="s1">&#39;Spectrum coordinate unit&#39;</span><span class="p">))</span>
        <span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;CRPIX1&#39;</span><span class="p">,</span> <span class="mf">1.000000</span><span class="p">,</span> <span class="s1">&#39;Pixel coordinate of reference point&#39;</span><span class="p">))</span>
        <span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;CD1_1&#39;</span><span class="p">,</span> 
                    <span class="p">((</span><span class="n">axis</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">axis</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)),</span> 
                    <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> per pixel&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">wave_unit</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">hdr</span>

    <span class="k">def</span> <span class="nf">_init_pp_server</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize a server for parallel processing.</span>

<span class="sd">        :param silent: (Optional) If silent no message is printed</span>
<span class="sd">          (Default False).</span>

<span class="sd">        .. note:: Please refer to http://www.parallelpython.com/ for</span>
<span class="sd">          sources and information on Parallel Python software</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">utils</span><span class="o">.</span><span class="n">parallel</span><span class="o">.</span><span class="n">init_pp_server</span><span class="p">(</span><span class="n">ncpus</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ncpus</span><span class="p">,</span>
                                             <span class="n">silent</span><span class="o">=</span><span class="n">silent</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_close_pp_server</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">js</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Destroy the parallel python job server to avoid too much</span>
<span class="sd">        opened files.</span>

<span class="sd">        :param js: job server.</span>
<span class="sd">        </span>
<span class="sd">        .. note:: Please refer to http://www.parallelpython.com/ for</span>
<span class="sd">            sources and information on Parallel Python software.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">utils</span><span class="o">.</span><span class="n">parallel</span><span class="o">.</span><span class="n">close_pp_server</span><span class="p">(</span><span class="n">js</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">_get_mask_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the path to the mask given the path to the original</span>
<span class="sd">        FITS file.</span>

<span class="sd">        :param path: Path of the origial FITS file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">path</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MASK_FRAME_TAIL</span>

    <span class="k">def</span> <span class="nf">_get_tuning_parameter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameter_name</span><span class="p">,</span> <span class="n">default_value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the value of the tuning parameter if it exists. In</span>
<span class="sd">        the other case return the default value.</span>

<span class="sd">        This method is used to help in setting some tuning parameters</span>
<span class="sd">        of some method externally.</span>

<span class="sd">        .. warning:: The value returned if not the default value will</span>
<span class="sd">          be a string.</span>
<span class="sd">        </span>
<span class="sd">        :param parameter_name: Name of the parameter</span>

<span class="sd">        :param default_value: Default value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">caller_name</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span>
                       <span class="o">+</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span><span class="p">)</span>
        <span class="n">full_parameter_name</span> <span class="o">=</span> <span class="n">caller_name</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">parameter_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print_msg</span><span class="p">(</span><span class="s1">&#39;looking for tuning parameter: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">full_parameter_name</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">full_parameter_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tuning_parameters</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_warning</span><span class="p">(</span>
                <span class="s1">&#39;Tuning parameter </span><span class="si">{}</span><span class="s1"> changed to </span><span class="si">{}</span><span class="s1"> (default </span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">full_parameter_name</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_tuning_parameters</span><span class="p">[</span><span class="n">full_parameter_name</span><span class="p">],</span>
                    <span class="n">default_value</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tuning_parameters</span><span class="p">[</span><span class="n">full_parameter_name</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">default_value</span>

    <span class="k">def</span> <span class="nf">_create_list_from_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dir_path</span><span class="p">,</span> <span class="n">list_file_path</span><span class="p">,</span>
                              <span class="n">image_mode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chip_index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                              <span class="n">prebinning</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a file containing the list of all FITS files at</span>
<span class="sd">        a specified directory and returns the path to the list </span>
<span class="sd">        file.</span>

<span class="sd">        :param dir_path: Directory containing the FITS files</span>
<span class="sd">        </span>
<span class="sd">        :param list_file_path: Path to the list file to be created. If None a</span>
<span class="sd">          list of the lines is returned.</span>

<span class="sd">        :param image_mode: (Optional) Image mode. If not None the given string</span>
<span class="sd">          will be written at the first line of the file along with the chip</span>
<span class="sd">          index.</span>

<span class="sd">        :param chip_index: (Optional) Index of the chip, must be an</span>
<span class="sd">          integer. Used in conjonction with image mode to write the first</span>
<span class="sd">          directive line of the file which indicates the image mode.</span>

<span class="sd">        :param prebinning: (Optional) If not None, must be an integer. Add</span>
<span class="sd">          another directive line for data prebinning (default None).</span>


<span class="sd">        :param check: (Optional) If True, files dimensions are checked. Else no</span>
<span class="sd">          check is done. this is faster but less safe (default True).</span>
<span class="sd">        </span>
<span class="sd">        :returns: Path to the created list file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">dir_path</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">:</span>
            <span class="n">dir_path</span> <span class="o">+=</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span>
        <span class="n">dir_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dir_path</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dir_path</span><span class="p">):</span>
            <span class="n">list_file_str</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

            <span class="c1"># print image mode directive line</span>
            <span class="k">if</span> <span class="n">image_mode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">list_file_str</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;# </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">image_mode</span><span class="p">,</span> <span class="n">chip_index</span><span class="p">))</span>

            <span class="c1"># print prebinning directive line</span>
            <span class="k">if</span> <span class="n">prebinning</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">list_file_str</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="s1">&#39;# prebinning </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">prebinning</span><span class="p">)))</span>
    
            <span class="n">file_list</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">dir_path</span><span class="p">)</span>
            <span class="n">file_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_path</span><span class="p">,</span><span class="n">_path</span><span class="p">)</span> <span class="k">for</span> <span class="n">_path</span> <span class="ow">in</span> <span class="n">file_list</span><span class="p">]</span>
            
            <span class="c1"># image list sort</span>
            <span class="n">file_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sort_image_list</span><span class="p">(</span><span class="n">file_list</span><span class="p">,</span> <span class="n">image_mode</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">file_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s1">&#39;There is no *.fits file in </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                     <span class="n">dir_path</span><span class="p">))</span>
            
            <span class="n">first_file</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">file_nb</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">check</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print_msg</span><span class="p">(</span><span class="s1">&#39;Reading and checking </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dir_path</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print_msg</span><span class="p">(</span><span class="s1">&#39;Reading </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dir_path</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">file_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;.fits&quot;</span>
                    <span class="ow">and</span> <span class="s1">&#39;_bias.fits&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">filename</span><span class="p">):</span>
                    <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_path</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
                        
                        <span class="k">if</span> <span class="n">first_file</span><span class="p">:</span>
                            <span class="n">fits_hdul</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_fits</span><span class="p">(</span>
                                <span class="n">file_path</span><span class="p">,</span> <span class="n">return_hdu_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                            <span class="n">hdu_data_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_hdu_data_index</span><span class="p">(</span>
                                <span class="n">fits_hdul</span><span class="p">)</span>
                                                     
                            <span class="n">fits_hdu</span> <span class="o">=</span> <span class="n">fits_hdul</span><span class="p">[</span><span class="n">hdu_data_index</span><span class="p">]</span>
                            <span class="n">dimx</span> <span class="o">=</span> <span class="n">fits_hdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">]</span>
                            <span class="n">dimy</span> <span class="o">=</span> <span class="n">fits_hdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">]</span>
                            <span class="n">first_file</span> <span class="o">=</span> <span class="kc">False</span>

                        <span class="k">elif</span> <span class="n">check</span><span class="p">:</span>
                            <span class="n">fits_hdu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_fits</span><span class="p">(</span>
                                <span class="n">file_path</span><span class="p">,</span> <span class="n">return_hdu_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="n">hdu_data_index</span><span class="p">]</span>
                            
                            <span class="n">dims</span> <span class="o">=</span> <span class="n">fits_hdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS&#39;</span><span class="p">]</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
                                <span class="n">dims</span> <span class="o">==</span> <span class="mi">2</span>
                                <span class="ow">or</span> <span class="n">fits_hdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">dimx</span>
                                <span class="ow">or</span> <span class="n">fits_hdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">dimy</span><span class="p">):</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s2">&quot;All FITS files in the directory </span><span class="si">%s</span><span class="s2"> do not have the same shape. Please remove bad files.&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">dir_path</span><span class="p">))</span>
                            
                        <span class="n">list_file_str</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">file_path</span><span class="p">))</span>
                        <span class="n">file_nb</span> <span class="o">+=</span> <span class="mi">1</span>
                            
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; does not exists !&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">file_nb</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print_msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> Images found&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_nb</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">list_file_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span><span class="n">list_file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">list_file</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">iline</span> <span class="ow">in</span> <span class="n">list_file_str</span><span class="p">:</span>
                            <span class="n">list_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">iline</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">list_file_path</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">list_file_str</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s1">&#39;No FITS file in the folder: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">dir_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dir_path</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; does not exists !&quot;</span><span class="p">)</span>
        

    <span class="k">def</span> <span class="nf">_get_hdu_data_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hdul</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the index of the first header data unit (HDU) containing data.</span>

<span class="sd">        :param hdul: A pyfits.HDU instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">utils</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">get_hdu_data_index</span><span class="p">(</span><span class="n">hdul</span><span class="p">)</span>
        
<div class="viewcode-block" id="Tools.write_fits"><a class="viewcode-back" href="../../orb.html#orb.core.Tools.write_fits">[docs]</a>    <span class="k">def</span> <span class="nf">write_fits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fits_path</span><span class="p">,</span> <span class="n">fits_data</span><span class="p">,</span> <span class="n">fits_header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">silent</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">record_stats</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        
        <span class="sd">&quot;&quot;&quot;Write data in FITS format. If the file doesn&#39;t exist create</span>
<span class="sd">        it with its directories.</span>

<span class="sd">        If the file already exists add a number to its name before the</span>
<span class="sd">        extension (unless &#39;overwrite&#39; option is set to True).</span>

<span class="sd">        :param fits_path: Path to the file, can be either</span>
<span class="sd">          relative or absolut.</span>
<span class="sd">     </span>
<span class="sd">        :param fits_data: Data to be written in the file.</span>

<span class="sd">        :param fits_header: (Optional) Optional keywords to update or</span>
<span class="sd">          create. It can be a pyfits.Header() instance or a list of</span>
<span class="sd">          tuples [(KEYWORD_1, VALUE_1, COMMENT_1), (KEYWORD_2,</span>
<span class="sd">          VALUE_2, COMMENT_2), ...]. Standard keywords like SIMPLE,</span>
<span class="sd">          BITPIX, NAXIS, EXTEND does not have to be passed.</span>
<span class="sd">     </span>
<span class="sd">        :param silent: (Optional) If True turn this function won&#39;t</span>
<span class="sd">          display any message (default False)</span>

<span class="sd">        :param overwrite: (Optional) If True overwrite the output file</span>
<span class="sd">          if it exists (default False).</span>

<span class="sd">        :param mask: (Optional) It not None must be an array with the</span>
<span class="sd">          same size as the given data but filled with ones and</span>
<span class="sd">          zeros. Bad values (NaN or Inf) are converted to 1 and the</span>
<span class="sd">          array is converted to 8 bit unsigned integers (uint8). This</span>
<span class="sd">          array will be written to the disk with the same path</span>
<span class="sd">          terminated by &#39;_mask&#39;. The header of the mask FITS file will</span>
<span class="sd">          be the same as the original data (default None).</span>

<span class="sd">        :param replace: (Optional) If True and if the file already</span>
<span class="sd">          exist, new data replace old data in the existing file. NaN</span>
<span class="sd">          values do not replace old values. Other values replace old</span>
<span class="sd">          values. New array MUST have the same size as the existing</span>
<span class="sd">          array. Note that if replace is True, overwrite is</span>
<span class="sd">          automatically set to True.</span>

<span class="sd">        :param record_stats: (Optional) If True, record mean and</span>
<span class="sd">          median of data. Useful if they often have to be computed</span>
<span class="sd">          (default False).</span>
<span class="sd">        </span>
<span class="sd">        .. note:: float64 data is converted to float32 data to avoid</span>
<span class="sd">          too big files with unnecessary precision</span>

<span class="sd">        .. note:: Please refer to</span>
<span class="sd">          http://www.stsci.edu/institute/software_hardware/pyfits/ for</span>
<span class="sd">          more information on PyFITS module and</span>
<span class="sd">          http://fits.gsfc.nasa.gov/ for more information on FITS</span>
<span class="sd">          files.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">utils</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">write_fits</span><span class="p">(</span>
            <span class="n">fits_path</span><span class="p">,</span> <span class="n">fits_data</span><span class="p">,</span> <span class="n">fits_header</span><span class="o">=</span><span class="n">fits_header</span><span class="p">,</span>
            <span class="n">silent</span><span class="o">=</span><span class="n">silent</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
            <span class="n">replace</span><span class="o">=</span><span class="n">replace</span><span class="p">,</span> <span class="n">record_stats</span><span class="o">=</span><span class="n">record_stats</span><span class="p">,</span>
            <span class="n">mask_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_mask_path</span><span class="p">(</span><span class="n">fits_path</span><span class="p">))</span></div>
        
                
            

<div class="viewcode-block" id="Tools.read_fits"><a class="viewcode-back" href="../../orb.html#orb.core.Tools.read_fits">[docs]</a>    <span class="k">def</span> <span class="nf">read_fits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fits_path</span><span class="p">,</span> <span class="n">no_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nan_filter</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                  <span class="n">return_header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_hdu_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                  <span class="n">return_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">delete_after</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                  <span class="n">data_index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">image_mode</span><span class="o">=</span><span class="s1">&#39;classic&#39;</span><span class="p">,</span> <span class="n">chip_index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">binning</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fix_header</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">memmap</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read a FITS data file and returns its data.</span>
<span class="sd">    </span>
<span class="sd">        :param fits_path: Path to the file, can be either</span>
<span class="sd">          relative or absolut.</span>
<span class="sd">        </span>
<span class="sd">        :param no_error: (Optional) If True this function will only</span>
<span class="sd">          display a warning message if the file does not exist (so it</span>
<span class="sd">          does not raise an exception) (default False)</span>
<span class="sd">        </span>
<span class="sd">        :param nan_filter: (Optional) If True replace NaN by zeros</span>
<span class="sd">          (default False)</span>

<span class="sd">        :param return_header: (Optional) If True return a tuple (data,</span>
<span class="sd">           header) (default False).</span>

<span class="sd">        :param return_hdu_only: (Optional) If True return FITS header</span>
<span class="sd">          data unit only. No data will be returned (default False).</span>

<span class="sd">        :param return_mask: (Optional) If True return only the mask</span>
<span class="sd">          corresponding to the data file (default False).</span>

<span class="sd">        :param silent: (Optional) If True no message is displayed</span>
<span class="sd">          except if an error is raised (default False).</span>

<span class="sd">        :param delete_after: (Optional) If True delete file after</span>
<span class="sd">          reading (default False).</span>

<span class="sd">        :param data_index: (Optional) Index of data in the header data</span>
<span class="sd">          unit (Default 0).</span>

<span class="sd">        :param image_mode: (Optional) Can be &#39;sitelle&#39;, &#39;spiomm&#39; or</span>
<span class="sd">          &#39;classic&#39;. In &#39;sitelle&#39; mode, the parameter</span>
<span class="sd">          chip_index must also be set to 0 or 1. In this mode only</span>
<span class="sd">          one of both SITELLE quadrants is returned. In &#39;classic&#39; mode</span>
<span class="sd">          the whole frame is returned (default &#39;classic&#39;).</span>

<span class="sd">        :param chip_index: (Optional) Index of the chip of the</span>
<span class="sd">          SITELLE image. Used only if image_mode is set to &#39;sitelle&#39;</span>
<span class="sd">          In this case, must be 1 or 2. Else must be None (default</span>
<span class="sd">          None).</span>

<span class="sd">        :param binning: (Optional) If not None, returned data is</span>
<span class="sd">          binned by this amount (must be an integer &gt;= 1)</span>

<span class="sd">        :param fix_header: (Optional) If True, fits header is</span>
<span class="sd">          fixed to avoid errors due to header inconsistencies</span>
<span class="sd">          (e.g. WCS errors) (default True).</span>

<span class="sd">        :param memmap: (Optional) If True, use the memory mapping</span>
<span class="sd">          option of pyfits. This is useful to avoid loading a full cube</span>
<span class="sd">          in memory when opening a large data cube (default False).</span>

<span class="sd">        :param dtype: (Optional) Data is converted to</span>
<span class="sd">          the given dtype (e.g. np.float32, default float).</span>
<span class="sd">        </span>
<span class="sd">        .. note:: Please refer to</span>
<span class="sd">          http://www.stsci.edu/institute/software_hardware/pyfits/ for</span>
<span class="sd">          more information on PyFITS module. And</span>
<span class="sd">          http://fits.gsfc.nasa.gov/ for more information on FITS</span>
<span class="sd">          files.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">utils</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_fits</span><span class="p">(</span>
            <span class="n">fits_path</span><span class="p">,</span> <span class="n">no_error</span><span class="o">=</span><span class="n">no_error</span><span class="p">,</span> <span class="n">nan_filter</span><span class="o">=</span><span class="n">nan_filter</span><span class="p">,</span> 
            <span class="n">return_header</span><span class="o">=</span><span class="n">return_header</span><span class="p">,</span> <span class="n">return_hdu_only</span><span class="o">=</span><span class="n">return_hdu_only</span><span class="p">,</span>
            <span class="n">return_mask</span><span class="o">=</span><span class="n">return_mask</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="n">silent</span><span class="p">,</span> <span class="n">delete_after</span><span class="o">=</span><span class="n">delete_after</span><span class="p">,</span>
            <span class="n">data_index</span><span class="o">=</span><span class="n">data_index</span><span class="p">,</span> <span class="n">image_mode</span><span class="o">=</span><span class="n">image_mode</span><span class="p">,</span> <span class="n">chip_index</span><span class="o">=</span><span class="n">chip_index</span><span class="p">,</span>
            <span class="n">binning</span><span class="o">=</span><span class="n">binning</span><span class="p">,</span> <span class="n">fix_header</span><span class="o">=</span><span class="n">fix_header</span><span class="p">,</span> <span class="n">memmap</span><span class="o">=</span><span class="n">memmap</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
            <span class="n">mask_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_mask_path</span><span class="p">(</span><span class="n">fits_path</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="nf">_bin_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">binning</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return mean binned image. </span>

<span class="sd">        :param image: 2d array to bin.</span>

<span class="sd">        :param binning: binning (must be an integer &gt;= 1).</span>

<span class="sd">        ..note:: Only the complete sets of rows or columns are binned</span>
<span class="sd">          so that depending on the bin size and the image size the</span>
<span class="sd">          last columns or rows can be ignored. This ensures that the</span>
<span class="sd">          binning surface is the same for every pixel in the binned</span>
<span class="sd">          array.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">utils</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">bin_image</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">binning</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_get_sitelle_slice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slice_str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Strip a string containing SITELLE like slice coordinates.</span>

<span class="sd">        :param slice_str: Slice string.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">utils</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">get_sitelle_slice</span><span class="p">(</span><span class="n">slice_str</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_read_sitelle_chip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hdu</span><span class="p">,</span> <span class="n">chip_index</span><span class="p">,</span> <span class="n">substract_bias</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return chip data of a SITELLE FITS image.</span>

<span class="sd">        :param hdu: pyfits.HDU Instance of the SITELLE image</span>
<span class="sd">        </span>
<span class="sd">        :param chip_index: Index of the chip to read. Must be 1 or 2.</span>

<span class="sd">        :param substract_bias: If True bias is automatically</span>
<span class="sd">          substracted by using the overscan area (default True).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">utils</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_sitelle_chip</span><span class="p">(</span><span class="n">hdu</span><span class="p">,</span> <span class="n">chip_index</span><span class="p">,</span>
                                          <span class="n">substract_bias</span><span class="o">=</span><span class="n">substract_bias</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_read_spiomm_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hdu</span><span class="p">,</span> <span class="n">image_path</span><span class="p">,</span> <span class="n">substract_bias</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return data of an SpIOMM FITS image.</span>

<span class="sd">        :param hdu: pyfits.HDU Instance of the SpIOMM image</span>

<span class="sd">        :param image_path: Image path</span>
<span class="sd">        </span>
<span class="sd">        :param substract_bias: If True bias is automatically</span>
<span class="sd">          substracted by using the associated bias frame as an</span>
<span class="sd">          overscan frame. Mean bias level is thus computed along the y</span>
<span class="sd">          axis of the bias frame (default True).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">utils</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_spiomm_data</span><span class="p">(</span><span class="n">hdu</span><span class="p">,</span> <span class="n">image_path</span><span class="p">,</span>
                                         <span class="n">substract_bias</span><span class="o">=</span><span class="n">substract_bias</span><span class="p">)</span>
        

<div class="viewcode-block" id="Tools.open_file"><a class="viewcode-back" href="../../orb.html#orb.core.Tools.open_file">[docs]</a>    <span class="k">def</span> <span class="nf">open_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Open a file in write mode (by default) and return a file</span>
<span class="sd">        object.</span>
<span class="sd">        </span>
<span class="sd">        Create the file if it doesn&#39;t exist (only in write mode).</span>

<span class="sd">        :param fits_name: Path to the file, can be either</span>
<span class="sd">          relative or absolute.</span>

<span class="sd">        :param mode: (Optional) Can be &#39;w&#39; for write mode, &#39;r&#39; for</span>
<span class="sd">          read mode and &#39;a&#39; for append mode.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;w&#39;</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="s1">&#39;rU&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s2">&quot;mode option must be &#39;w&#39;, &#39;r&#39;, &#39;rU&#39; or &#39;a&#39;&quot;</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;w&#39;</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">]:</span>
            <span class="c1"># create folder if it does not exist</span>
            <span class="n">dirname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dirname</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dirname</span><span class="p">):</span> 
                    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dirname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;r&#39;</span><span class="p">:</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;rU&#39;</span> <span class="c1"># read in universal mode by</span>
                                    <span class="c1"># default to handle Windows files.</span>

        <span class="k">return</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span></div>
    

<div class="viewcode-block" id="Tools.sort_image_list"><a class="viewcode-back" href="../../orb.html#orb.core.Tools.sort_image_list">[docs]</a>    <span class="k">def</span> <span class="nf">sort_image_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_list</span><span class="p">,</span> <span class="n">image_mode</span><span class="p">,</span> <span class="n">cube</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sort a list of fits files.</span>

<span class="sd">        :param file_list: A list of file names</span>

<span class="sd">        :param image_mode: Image mode, can be &#39;sitelle&#39; or &#39;spiomm&#39;.</span>

<span class="sd">        :param cube: If True, image list is considered as a cube</span>
<span class="sd">          list. Headers are used to get the right order based on step</span>
<span class="sd">          number instead of file path (default True).</span>
<span class="sd">        &quot;&quot;&quot;</span>
    
        <span class="n">file_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">path</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">file_list</span> <span class="k">if</span>
                     <span class="p">((</span><span class="s1">&#39;.fits&#39;</span> <span class="ow">in</span> <span class="n">path</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;.hdf5&#39;</span> <span class="ow">in</span> <span class="n">path</span><span class="p">))]</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">image_mode</span> <span class="o">==</span> <span class="s1">&#39;spiomm&#39;</span><span class="p">:</span>
            <span class="n">file_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">path</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">file_list</span>
                         <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;_bias.fits&#39;</span> <span class="ow">in</span> <span class="n">path</span><span class="p">]</span>

        <span class="c1"># get all numbers</span>
        <span class="n">file_seq</span> <span class="o">=</span> <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;[0-9]+&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">file_list</span> <span class="k">if</span>
                    <span class="p">((</span><span class="s1">&#39;.fits&#39;</span> <span class="ow">in</span> <span class="n">path</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;.hdf5&#39;</span> <span class="ow">in</span> <span class="n">path</span><span class="p">))]</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">file_keys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">file_seq</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s1">&#39;Malformed sequence of files: </span><span class="si">{}</span><span class="s1">:</span><span class="se">\n</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">e</span><span class="p">,</span> <span class="n">file_seq</span><span class="p">))</span>
                             
            
        <span class="c1"># get changing column</span>
        <span class="n">test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">file_keys</span> <span class="o">==</span> <span class="n">file_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">test</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_warning</span><span class="p">(</span><span class="s1">&#39;Images list cannot be safely sorted. Two images at least have the same index&#39;</span><span class="p">)</span>
            <span class="n">column_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">column_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>

        <span class="c1"># get changing step (if possible)</span>
        <span class="n">steplist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">cube</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">file_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;.fits&#39;</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">hdr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_fits</span><span class="p">(</span>
                            <span class="n">path</span><span class="p">,</span> <span class="n">return_hdu_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
                        <span class="k">if</span> <span class="s1">&#39;SITSTEP&#39;</span> <span class="ow">in</span> <span class="n">hdr</span><span class="p">:</span>
                            <span class="n">steplist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;SITSTEP&#39;</span><span class="p">]))</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span> <span class="k">pass</span>
                
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">steplist</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_list</span><span class="p">):</span>
            <span class="n">_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">file_list</span><span class="p">)):</span>
                <span class="n">_list</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;path&#39;</span><span class="p">:</span><span class="n">file_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;step&#39;</span><span class="p">:</span><span class="n">steplist</span><span class="p">[</span><span class="n">i</span><span class="p">]})</span>
            <span class="n">_list</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;step&#39;</span><span class="p">])</span>
            <span class="n">file_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">_path</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">_path</span> <span class="ow">in</span> <span class="n">_list</span><span class="p">]</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">column_index</span><span class="p">):</span>
            <span class="n">file_list</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;[0-9]+&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)[</span>
                <span class="n">column_index</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s1">&#39;Image list cannot be sorted.&#39;</span><span class="p">)</span>
            
        <span class="k">return</span> <span class="n">file_list</span></div>

<div class="viewcode-block" id="Tools.save_sip"><a class="viewcode-back" href="../../orb.html#orb.core.Tools.save_sip">[docs]</a>    <span class="k">def</span> <span class="nf">save_sip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fits_path</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save SIP parameters from a header to a blanck FITS file.</span>

<span class="sd">        :param fits_path: Path to the FITS file</span>
<span class="sd">        :param hdr: header from which SIP parameters must be read</span>
<span class="sd">        :param overwrite: (Optional) Overwrite the FITS file.</span>
<span class="sd">        &quot;&quot;&quot;</span>    
        <span class="n">clean_hdr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clean_sip</span><span class="p">(</span><span class="n">hdr</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">data</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_fits</span><span class="p">(</span>
            <span class="n">fits_path</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">fits_header</span><span class="o">=</span><span class="n">clean_hdr</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span></div>

<div class="viewcode-block" id="Tools.load_sip"><a class="viewcode-back" href="../../orb.html#orb.core.Tools.load_sip">[docs]</a>    <span class="k">def</span> <span class="nf">load_sip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fits_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a astropy.wcs.WCS object from a FITS file containing</span>
<span class="sd">        SIP parameters.</span>
<span class="sd">    </span>
<span class="sd">        :param fits_path: Path to the FITS file    </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_fits</span><span class="p">(</span><span class="n">fits_path</span><span class="p">,</span> <span class="n">return_hdu_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
        <span class="k">return</span> <span class="n">pywcs</span><span class="o">.</span><span class="n">WCS</span><span class="p">(</span><span class="n">hdr</span><span class="p">)</span></div>


<div class="viewcode-block" id="Tools.open_hdf5"><a class="viewcode-back" href="../../orb.html#orb.core.Tools.open_hdf5">[docs]</a>    <span class="k">def</span> <span class="nf">open_hdf5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a :py:class:`h5py.File` instance with some</span>
<span class="sd">        informations.</span>

<span class="sd">        :param file_path: Path to the hdf5 file.</span>
<span class="sd">        </span>
<span class="sd">        :param mode: Opening mode. Can be &#39;r&#39;, &#39;r+&#39;, &#39;w&#39;, &#39;w-&#39;, &#39;x&#39;,</span>
<span class="sd">          &#39;a&#39;.</span>

<span class="sd">        .. note:: Please refer to http://www.h5py.org/.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;w-&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">]:</span>
            <span class="c1"># create folder if it does not exist</span>
            <span class="n">dirname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dirname</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dirname</span><span class="p">):</span> 
                    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dirname</span><span class="p">)</span>
                    
        <span class="n">f</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;w-&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;r+&#39;</span><span class="p">]:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;program&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Generated by ORB version </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">__version__</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;author&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Thomas Martin (thomas.martin.1@ulaval.ca)&#39;</span>
            <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
            
        <span class="k">return</span> <span class="n">f</span></div>

<div class="viewcode-block" id="Tools.write_hdf5"><a class="viewcode-back" href="../../orb.html#orb.core.Tools.write_hdf5">[docs]</a>    <span class="k">def</span> <span class="nf">write_hdf5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">silent</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">max_hdu_check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                   <span class="n">compress</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;    </span>
<span class="sd">        Write data in HDF5 format.</span>

<span class="sd">        A header can be added to the data. This method is useful to</span>
<span class="sd">        handle an HDF5 data file like a FITS file. It implements most</span>
<span class="sd">        of the functionality of the method</span>
<span class="sd">        :py:meth:`core.Tools.write_fits`.</span>

<span class="sd">        .. note:: The output HDF5 file can contain mutiple data header</span>
<span class="sd">          units (HDU). Each HDU is in a specific group named &#39;hdu*&#39;, *</span>
<span class="sd">          being the index of the HDU. The first HDU is named</span>
<span class="sd">          HDU0. Each HDU contains one data group (HDU*/data) which</span>
<span class="sd">          contains a numpy.ndarray and one header group</span>
<span class="sd">          (HDU*/header). Each subgroup of a header group is a keyword</span>
<span class="sd">          and its associated value, comment and type.</span>

<span class="sd">        :param file_path: Path to the HDF5 file to create</span>

<span class="sd">        :param data: A numpy array (numpy.ndarray instance) of numeric</span>
<span class="sd">          values. If a list of arrays is given, each array will be</span>
<span class="sd">          placed in a specific HDU. The header keyword must also be</span>
<span class="sd">          set to a list of headers of the same length.</span>

<span class="sd">        :param header: (Optional) Optional keywords to update or</span>
<span class="sd">          create. It can be a pyfits.Header() instance or a list of</span>
<span class="sd">          tuples [(KEYWORD_1, VALUE_1, COMMENT_1), (KEYWORD_2,</span>
<span class="sd">          VALUE_2, COMMENT_2), ...]. Standard keywords like SIMPLE,</span>
<span class="sd">          BITPIX, NAXIS, EXTEND does not have to be passed (default</span>
<span class="sd">          None). It can also be a list of headers if a list of arrays</span>
<span class="sd">          has been passed to the option &#39;data&#39;.    </span>

<span class="sd">        :param max_hdu_check: (Optional): When True, if the input data</span>
<span class="sd">          is a list (interpreted as a list of data unit), check if</span>
<span class="sd">          it&#39;s length is not too long to make sure that the input list</span>
<span class="sd">          is not a single data array that has not been converted to a</span>
<span class="sd">          numpy.ndarray format. If the number of HDU to create is</span>
<span class="sd">          indeed very long this can be set to False (default True).</span>
<span class="sd">        </span>
<span class="sd">        :param silent: (Optional) If True turn this function won&#39;t</span>
<span class="sd">          display any message (default False)</span>

<span class="sd">        :param overwrite: (Optional) If True overwrite the output file</span>
<span class="sd">          if it exists (default False).</span>

<span class="sd">        :param compress: (Optional) If True data is compressed using</span>
<span class="sd">          the SZIP library (see</span>
<span class="sd">          https://www.hdfgroup.org/doc_resource/SZIP/). SZIP library</span>
<span class="sd">          must be installed (default False).</span>
<span class="sd">    </span>

<span class="sd">        .. note:: Please refer to http://www.h5py.org/.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">MAX_HDUS</span> <span class="o">=</span> <span class="mi">3</span>

        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        
        <span class="c1"># change extension if nescessary</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_path</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;.hdf5&#39;</span><span class="p">:</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_path</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.hdf5&#39;</span>
    
        <span class="c1"># Check if data is a list of arrays.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">max_hdu_check</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">MAX_HDUS</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s1">&#39;Data list length is &gt; </span><span class="si">{}</span><span class="s1">. As a list is interpreted has a list of data unit make sure to pass a numpy.ndarray instance instead of a list. &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">MAX_HDUS</span><span class="p">))</span>

        <span class="c1"># Check header format</span>
        <span class="k">if</span> <span class="n">header</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">Header</span><span class="p">):</span>
                <span class="n">header</span> <span class="o">=</span> <span class="p">[</span><span class="n">header</span><span class="p">]</span>
                
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                
                <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">)</span>
                    <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">tuple</span><span class="p">)):</span>
                    
                    <span class="n">header_seems_ok</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">)</span>
                        <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="nb">tuple</span><span class="p">)):</span>
                        <span class="c1"># we have a list of headers</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
                            <span class="n">header_seems_ok</span> <span class="o">=</span> <span class="kc">True</span>
                            
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="c1"># we only have one header</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">header</span> <span class="o">=</span> <span class="p">[</span><span class="n">header</span><span class="p">]</span>
                            <span class="n">header_seems_ok</span> <span class="o">=</span> <span class="kc">True</span>
                            
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">header_seems_ok</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s1">&#39;Badly formated header&#39;</span><span class="p">)</span>
                            
                <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">Header</span><span class="p">):</span>
                    
                    <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s1">&#39;Header must be a pyfits.Header instance or a list&#39;</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s1">&#39;Header must be a pyfits.Header instance or a list&#39;</span><span class="p">)</span>
            

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s1">&#39;The number of headers must be the same as the number of data units.&#39;</span><span class="p">)</span>
            

        <span class="c1"># change path if file exists and must not be overwritten</span>
        <span class="n">new_file_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">overwrite</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">new_file_path</span><span class="p">):</span>
            <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">new_file_path</span><span class="p">):</span>
                <span class="n">new_file_path</span> <span class="o">=</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_path</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> 
                                 <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">+</span> 
                                 <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_path</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
                

        <span class="c1"># open file</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_hdf5</span><span class="p">(</span><span class="n">new_file_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        
            <span class="c1">## add data + header</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>

                <span class="n">idata</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                
                <span class="c1"># Check if data has a valid format.</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">idata</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">idata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">idata</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s1">&#39;Data to write must be convertible to a numpy array of numeric values: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>


                <span class="c1"># convert data to float32</span>
                <span class="k">if</span> <span class="n">idata</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">:</span>
                    <span class="n">idata</span> <span class="o">=</span> <span class="n">idata</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

                <span class="c1"># hdu name</span>
                <span class="n">hdu_group_name</span> <span class="o">=</span> <span class="s1">&#39;hdu</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">compress</span><span class="p">:</span>
                    <span class="n">data_group</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span>
                        <span class="n">hdu_group_name</span> <span class="o">+</span> <span class="s1">&#39;/data&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">idata</span><span class="p">,</span>
                        <span class="n">compression</span><span class="o">=</span><span class="s1">&#39;lzf&#39;</span><span class="p">,</span> <span class="n">compression_opts</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
                        <span class="c1">#compression=&#39;szip&#39;, compression_opts=(&#39;nn&#39;, 32))</span>
                        <span class="c1">#compression=&#39;gzip&#39;, compression_opts=9)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">data_group</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span>
                        <span class="n">hdu_group_name</span> <span class="o">+</span> <span class="s1">&#39;/data&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">idata</span><span class="p">)</span>
                
                <span class="c1"># add header</span>
                <span class="k">if</span> <span class="n">header</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">iheader</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">iheader</span><span class="p">,</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">Header</span><span class="p">):</span>
                        <span class="n">iheader</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">Header</span><span class="p">(</span><span class="n">iheader</span><span class="p">)</span>

                    <span class="n">f</span><span class="p">[</span><span class="n">hdu_group_name</span> <span class="o">+</span> <span class="s1">&#39;/header&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header_fits2hdf5</span><span class="p">(</span>
                        <span class="n">iheader</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_print_msg</span><span class="p">(</span><span class="s1">&#39;Data written as </span><span class="si">{}</span><span class="s1"> in </span><span class="si">{:.2f}</span><span class="s1"> s&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">new_file_path</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">))</span>
        
        <span class="k">return</span> <span class="n">new_file_path</span></div>

    <span class="k">def</span> <span class="nf">_header_fits2hdf5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fits_header</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;convert a pyfits.Header() instance to a header for an hdf5 file</span>

<span class="sd">        :param fits_header: Header of the FITS file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hdf5_header</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        
        <span class="k">for</span> <span class="n">ikey</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fits_header</span><span class="p">)):</span>
            <span class="n">_tstr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">fits_header</span><span class="p">[</span><span class="n">ikey</span><span class="p">]))</span>
            <span class="n">ival</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">(</span><span class="n">fits_header</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="n">ikey</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="n">fits_header</span><span class="p">[</span><span class="n">ikey</span><span class="p">]),</span>
                 <span class="n">fits_header</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="n">ikey</span><span class="p">],</span> <span class="n">_tstr</span><span class="p">))</span>
            
            <span class="n">hdf5_header</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ival</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">hdf5_header</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_header_hdf52fits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hdf5_header</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;convert an hdf5 header to a pyfits.Header() instance.</span>

<span class="sd">        :param hdf5_header: Header of the HDF5 file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">cast</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">t_str</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">_t</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">unicode</span><span class="p">,</span>
                       <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">long</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float128</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">t_str</span> <span class="o">==</span> <span class="nb">repr</span><span class="p">(</span><span class="n">_t</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">_t</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Bad type string </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t_str</span><span class="p">))</span>
                    
        <span class="n">fits_header</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">Header</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">hdf5_header</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">ival</span> <span class="o">=</span> <span class="n">hdf5_header</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span>
            <span class="k">if</span> <span class="n">ival</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;comment&#39;</span><span class="p">:</span>
                <span class="n">fits_header</span><span class="p">[</span><span class="n">ival</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="n">ival</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ival</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">ival</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fits_header</span><span class="p">[</span><span class="s1">&#39;comment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ival</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">fits_header</span>
        
<div class="viewcode-block" id="Tools.read_hdf5"><a class="viewcode-back" href="../../orb.html#orb.core.Tools.read_hdf5">[docs]</a>    <span class="k">def</span> <span class="nf">read_hdf5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">return_header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">):</span>
        
        <span class="sd">&quot;&quot;&quot;Read an HDF5 data file created with</span>
<span class="sd">        :py:meth:`core.Tools.write_hdf5`.</span>
<span class="sd">        </span>
<span class="sd">        :param file_path: Path to the file, can be either</span>
<span class="sd">          relative or absolute.        </span>

<span class="sd">        :param return_header: (Optional) If True return a tuple (data,</span>
<span class="sd">           header) (default False).</span>
<span class="sd">    </span>
<span class="sd">        :param dtype: (Optional) Data is converted to the given type</span>
<span class="sd">          (e.g. np.float32, default float).</span>
<span class="sd">        </span>
<span class="sd">        .. note:: Please refer to http://www.h5py.org/.&quot;&quot;&quot;</span>
        
        
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_hdf5</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="n">header</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">hdu_name</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="n">hdu_name</span> <span class="o">+</span> <span class="s1">&#39;/data&#39;</span><span class="p">][:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">return_header</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">hdu_name</span> <span class="o">+</span> <span class="s1">&#39;/header&#39;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                        <span class="c1"># extract header</span>
                        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_header_hdf52fits</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="n">hdu_name</span> <span class="o">+</span> <span class="s1">&#39;/header&#39;</span><span class="p">][:]))</span>
                    <span class="k">else</span><span class="p">:</span> <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">return_header</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">header</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">return_header</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">header</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">data</span></div>
            
    <span class="k">def</span> <span class="nf">_get_hdf5_data_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame_index</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return path to the data of a given frame in an HDF5 cube.</span>

<span class="sd">        :param frame_index: Index of the frame</span>
<span class="sd">        </span>
<span class="sd">        :param mask: (Optional) If True, path to the masked frame is</span>
<span class="sd">          returned (default False).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">mask</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_hdf5_frame_path</span><span class="p">(</span><span class="n">frame_index</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/mask&#39;</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_hdf5_frame_path</span><span class="p">(</span><span class="n">frame_index</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/data&#39;</span>

    <span class="k">def</span> <span class="nf">_get_hdf5_quad_data_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quad_index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return path to the data of a given quad in an HDF5 cube.</span>

<span class="sd">        :param quad_index: Index of the quadrant</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_hdf5_quad_path</span><span class="p">(</span><span class="n">quad_index</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/data&#39;</span>
        

    <span class="k">def</span> <span class="nf">_get_hdf5_header_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame_index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return path to the header of a given frame in an HDF5 cube.</span>

<span class="sd">        :param frame_index: Index of the frame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_hdf5_frame_path</span><span class="p">(</span><span class="n">frame_index</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/header&#39;</span>

    <span class="k">def</span> <span class="nf">_get_hdf5_quad_header_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quad_index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return path to the header of a given quadrant in an HDF5 cube.</span>

<span class="sd">        :param frame_index: Index of the quadrant</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_hdf5_quad_path</span><span class="p">(</span><span class="n">quad_index</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/header&#39;</span>

    <span class="k">def</span> <span class="nf">_get_hdf5_frame_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame_index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return path to a given frame in an HDF5 cube.</span>

<span class="sd">        :param frame_index: Index of the frame.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;frame</span><span class="si">{:05d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">frame_index</span><span class="p">)</span>

    
    <span class="k">def</span> <span class="nf">_get_hdf5_quad_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quad_index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return path to a given quadrant in an HDF5 cube.</span>

<span class="sd">        :param quad_index: Index of the quad.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;quad</span><span class="si">{:03d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">quad_index</span><span class="p">)</span>
        
            
    <span class="k">def</span> <span class="nf">_get_quadrant_dims</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quad_number</span><span class="p">,</span> <span class="n">dimx</span><span class="p">,</span> <span class="n">dimy</span><span class="p">,</span> <span class="n">div_nb</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the indices of a quadrant along x and y axes.</span>

<span class="sd">        :param quad_number: Quadrant number</span>

<span class="sd">        :param dimx: X axis dimension.</span>
<span class="sd">          </span>
<span class="sd">        :param dimy: Y axis dimension.</span>
<span class="sd">        </span>
<span class="sd">        :param div_nb: Number of divisions along x and y axes. (e.g. if</span>
<span class="sd">          div_nb = 3, the number of quadrant is 9 ; if div_nb = 4, the</span>
<span class="sd">          number of quadrant is 16)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">quad_nb</span> <span class="o">=</span> <span class="n">div_nb</span><span class="o">**</span><span class="mi">2</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">quad_number</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">quad_number</span> <span class="o">&gt;</span> <span class="n">quad_nb</span> <span class="o">-</span> <span class="mi">1</span><span class="n">L</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s2">&quot;quad_number out of bounds [0,&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">quad_nb</span><span class="o">-</span> <span class="mi">1</span><span class="n">L</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;]&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">index_x</span> <span class="o">=</span> <span class="n">quad_number</span> <span class="o">%</span> <span class="n">div_nb</span>
        <span class="n">index_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">quad_number</span> <span class="o">-</span> <span class="n">index_x</span><span class="p">)</span> <span class="o">/</span> <span class="n">div_nb</span>

        <span class="n">x_min</span> <span class="o">=</span> <span class="n">long</span><span class="p">(</span><span class="n">index_x</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">dimx</span> <span class="o">/</span> <span class="n">div_nb</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">index_x</span> <span class="o">!=</span> <span class="n">div_nb</span> <span class="o">-</span> <span class="mi">1</span><span class="n">L</span><span class="p">):</span>            
            <span class="n">x_max</span> <span class="o">=</span> <span class="n">long</span><span class="p">((</span><span class="n">index_x</span>  <span class="o">+</span> <span class="mi">1</span><span class="n">L</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">dimx</span> <span class="o">/</span> <span class="n">div_nb</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x_max</span> <span class="o">=</span> <span class="n">dimx</span>

        <span class="n">y_min</span> <span class="o">=</span> <span class="n">long</span><span class="p">(</span><span class="n">index_y</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">dimy</span> <span class="o">/</span> <span class="n">div_nb</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">index_y</span> <span class="o">!=</span> <span class="n">div_nb</span> <span class="o">-</span> <span class="mi">1</span><span class="n">L</span><span class="p">):</span>            
            <span class="n">y_max</span> <span class="o">=</span> <span class="n">long</span><span class="p">((</span><span class="n">index_y</span>  <span class="o">+</span> <span class="mi">1</span><span class="n">L</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">dimy</span> <span class="o">/</span> <span class="n">div_nb</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">y_max</span> <span class="o">=</span> <span class="n">dimy</span>

        <span class="k">return</span> <span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span></div>

            
<span class="c1">##################################################</span>
<span class="c1">#### CLASS Cube ##################################</span>
<span class="c1">##################################################</span>
<div class="viewcode-block" id="Cube"><a class="viewcode-back" href="../../orb.html#orb.core.Cube">[docs]</a><span class="k">class</span> <span class="nc">Cube</span><span class="p">(</span><span class="n">Tools</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate and manage a **virtual frame-divided cube**.</span>

<span class="sd">    .. note:: A **frame-divided cube** is a set of frames grouped</span>
<span class="sd">      together by a list.  It avoids storing a data cube in one large</span>
<span class="sd">      data file and loading an entire cube to process it.</span>

<span class="sd">    This class has been designed to handle large data cubes. Its data</span>
<span class="sd">    can be accessed virtually as if it was loaded in memory.</span>

<span class="sd">    .. code-block:: python</span>
<span class="sd">      :linenos:</span>

<span class="sd">      cube = Cube(&#39;liste&#39;) # A simple list is enough to initialize a Cube instance</span>
<span class="sd">      quadrant = Cube[25:50, 25:50, :] # Here you just load a small quadrant</span>
<span class="sd">      spectrum = Cube[84,58,:] # load spectrum at pixel [84,58]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Processing</span>
    <span class="n">ncpus</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># number of CPUs to use for parallel processing</span>
    <span class="n">DIV_NB</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># number of division of the frames in quadrants</span>
    <span class="n">QUAD_NB</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># number of quadrant = DIV_NB**2</span>
    <span class="n">BIG_DATA</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># If True some processes are parallelized</span>

    <span class="n">image_list_path</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">image_list</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">dimx</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">dimy</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">dimz</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="n">star_list</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">z_median</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">z_mean</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">z_std</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">mean_image</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">overwrite</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">_data_prefix</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_project_header</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_calibration_laser_header</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_wcs_header</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">_silent_load</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">_mask_exists</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="n">_return_mask</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># When True, __get_item__ return mask data</span>
                         <span class="c1"># instead of &#39;normal&#39; data</span>

    <span class="c1"># read directives</span>
    <span class="n">_image_mode</span> <span class="o">=</span> <span class="s1">&#39;classic&#39;</span> <span class="c1"># opening mode. can be sitelle, spiomm or classic</span>
    <span class="n">_chip_index</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># in sitelle mode, this gives the index of</span>
                       <span class="c1"># the chip to read</span>
    <span class="n">_prebinning</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># prebinning directive</span>

    
    <span class="n">_parallel_access_to_data</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># authorize parallel access to</span>
                                    <span class="c1"># data (False for HDF5)</span>

    <span class="n">is_hdf5_frames</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># frames are hdf5 frames (i.e. the cube is</span>
                          <span class="c1"># not an HDF5 cube but is made from hdf5</span>
                          <span class="c1"># frames)</span>
    <span class="n">is_hdf5_cube</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># tell if the cube is an hdf5 cube</span>
                        <span class="c1"># (i.e. created via OutHDFCube or</span>
                        <span class="c1"># OutHDFQuadCube)</span>
    <span class="n">is_complex</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># tell if cube&#39;s data is complex.</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># data type</span>
    <span class="n">is_quad_cube</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># Basic cube is not quad cube (see class</span>
                         <span class="c1"># HDFCube and OutHDFQuadCube)</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image_list_path</span><span class="p">,</span> <span class="n">image_mode</span><span class="o">=</span><span class="s1">&#39;classic&#39;</span><span class="p">,</span>
                 <span class="n">chip_index</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">binning</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">data_prefix</span><span class="o">=</span><span class="s2">&quot;./temp/data.&quot;</span><span class="p">,</span>
                 <span class="n">config_file_name</span><span class="o">=</span><span class="s2">&quot;config.orb&quot;</span><span class="p">,</span> <span class="n">project_header</span><span class="o">=</span><span class="nb">list</span><span class="p">(),</span>
                 <span class="n">wcs_header</span><span class="o">=</span><span class="nb">list</span><span class="p">(),</span> <span class="n">calibration_laser_header</span><span class="o">=</span><span class="nb">list</span><span class="p">(),</span>
                 <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">silent_init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">no_log</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">tuning_parameters</span><span class="o">=</span><span class="nb">dict</span><span class="p">(),</span> <span class="n">indexer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">no_sort</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">ncpus</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize Cube class.</span>
<span class="sd">       </span>
<span class="sd">        :param image_list_path: Path to the list of images which form</span>
<span class="sd">          the virtual cube. If image_list_path is set to &#39;&#39; then</span>
<span class="sd">          this class will not try to load any data.  Can be useful</span>
<span class="sd">          when the user don&#39;t want to use or process any data.</span>

<span class="sd">        :param image_mode: (Optional) Image mode. Can be &#39;spiomm&#39;,</span>
<span class="sd">          &#39;sitelle&#39; or &#39;classic&#39;. In &#39;sitelle&#39; mode bias, is</span>
<span class="sd">          automatically substracted and the overscan regions are not</span>
<span class="sd">          present in the data cube. The chip index option can also be</span>
<span class="sd">          used in this mode to read only one of the two chips</span>
<span class="sd">          (i.e. one of the 2 cameras). In &#39;spiomm&#39; mode, if</span>
<span class="sd">          :file:`*_bias.fits` frames are present along with the image</span>
<span class="sd">          frames, bias is substracted from the image frames, this</span>
<span class="sd">          option is used to precisely correct the bias of the camera</span>
<span class="sd">          2. In &#39;classic&#39; mode, the whole array is extracted in its</span>
<span class="sd">          raw form (default &#39;classic&#39;).</span>

<span class="sd">        :param chip_index: (Optional) Useful only in &#39;sitelle&#39; mode</span>
<span class="sd">          (see image_mode option). Gives the number of the ship to</span>
<span class="sd">          read. Must be an 1 or 2 (default 1).</span>

<span class="sd">        :param binning: (Optional) Data is pre-binned numerically by</span>
<span class="sd">          this amount. i.e. 1000x1000xN raw frames with a prebinning</span>
<span class="sd">          of 2 will give a cube of 500x500xN (default 1).</span>
<span class="sd">    </span>
<span class="sd">        :param config_file_name: (Optional) name of the config file to</span>
<span class="sd">          use. Must be located in orb/data/ (default &#39;config.orb&#39;).</span>

<span class="sd">        :param data_prefix: (Optional) Prefix used to determine the</span>
<span class="sd">          header of the name of each created file (default</span>
<span class="sd">          &#39;temp_data&#39;).</span>

<span class="sd">        :param project_header: (Optional) header section describing</span>
<span class="sd">          the observation parameters that can be added to each output</span>
<span class="sd">          files (an empty list() by default).</span>

<span class="sd">        :param wcs_header: (Optional) header section describing WCS</span>
<span class="sd">          that can be added to each created image files (an empty</span>
<span class="sd">          list() by default).</span>

<span class="sd">        :param calibration_laser_header: (Optional) header section</span>
<span class="sd">          describing the calibration laser parameters that can be</span>
<span class="sd">          added to the concerned output files e.g. calibration laser map,</span>
<span class="sd">          spectral cube (an empty list() by default).</span>

<span class="sd">        :param overwrite: (Optional) If True existing FITS files will</span>
<span class="sd">          be overwritten (default False).</span>

<span class="sd">        :param silent_init: (Optional) If True no message is displayed</span>
<span class="sd">          at initialization.</span>

<span class="sd">        :param no_log: (Optional) If True no log file is created</span>
<span class="sd">          (default False).</span>

<span class="sd">        :param tuning_parameters: (Optional) Some parameters of the</span>
<span class="sd">          methods can be tuned externally using this dictionary. The</span>
<span class="sd">          dictionary must contains the full parameter name</span>
<span class="sd">          (class.method.parameter_name) and its value. For example :</span>
<span class="sd">          {&#39;InterferogramMerger.find_alignment.BOX_SIZE&#39;: 7}. Note</span>
<span class="sd">          that only some parameters can be tuned. This possibility is</span>
<span class="sd">          implemented into the method itself with the method</span>
<span class="sd">          :py:meth:`core.Tools._get_tuning_parameter`.</span>

<span class="sd">        :param indexer: (Optional) Must be a :py:class:`core.Indexer`</span>
<span class="sd">          instance. If not None created files can be indexed by this</span>
<span class="sd">          instance.</span>

<span class="sd">        :param no_sort: (Optional) If True, no sort of the file list</span>
<span class="sd">          is done. Files list is taken as is (default False).</span>

<span class="sd">        :param ncpus: (Optional) Number of CPUs to use for parallel</span>
<span class="sd">          processing. set to None gives the maximum number available</span>
<span class="sd">          (default None).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_complex</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="nb">float</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">overwrite</span> <span class="o">=</span> <span class="n">overwrite</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_no_log</span> <span class="o">=</span> <span class="n">no_log</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_no_log</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">Logger</span><span class="p">):</span>
                <span class="n">Logger</span><span class="o">.</span><span class="n">nolog</span> <span class="o">=</span> <span class="kc">True</span>
                
        <span class="bp">self</span><span class="o">.</span><span class="n">indexer</span> <span class="o">=</span> <span class="n">indexer</span>
        
        <span class="c1"># read config file to get parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config_file_name</span><span class="o">=</span><span class="n">config_file_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">DIV_NB</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_config_parameter</span><span class="p">(</span>
            <span class="s2">&quot;DIV_NB&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BIG_DATA</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_config_parameter</span><span class="p">(</span>
            <span class="s2">&quot;BIG_DATA&quot;</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">ncpus</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ncpus</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_config_parameter</span><span class="p">(</span>
                <span class="s2">&quot;NCPUS&quot;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ncpus</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ncpus</span><span class="p">)</span>
 
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_prefix</span> <span class="o">=</span> <span class="n">data_prefix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_project_header</span> <span class="o">=</span> <span class="n">project_header</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wcs_header</span> <span class="o">=</span> <span class="n">wcs_header</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calibration_laser_header</span> <span class="o">=</span> <span class="n">calibration_laser_header</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_msg_class_hdr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_msg_class_hdr</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_path_hdr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_data_path_hdr</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tuning_parameters</span> <span class="o">=</span> <span class="n">tuning_parameters</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">QUAD_NB</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DIV_NB</span><span class="o">**</span><span class="mi">2</span><span class="n">L</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_list_path</span> <span class="o">=</span> <span class="n">image_list_path</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_image_mode</span> <span class="o">=</span> <span class="n">image_mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_chip_index</span> <span class="o">=</span> <span class="n">chip_index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prebinning</span> <span class="o">=</span> <span class="n">binning</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_parallel_access_to_data</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_list_path</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
            <span class="c1"># read image list and get cube dimensions  </span>
            <span class="n">image_list_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_list_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
            <span class="n">image_name_list</span> <span class="o">=</span> <span class="n">image_list_file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">image_name_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s1">&#39;No image path in the given image list&#39;</span><span class="p">)</span>
            <span class="n">is_first_image</span> <span class="o">=</span> <span class="kc">True</span>
            
            <span class="k">for</span> <span class="n">image_name</span> <span class="ow">in</span> <span class="n">image_name_list</span><span class="p">:</span>
                <span class="n">image_name</span> <span class="o">=</span> <span class="p">(</span><span class="n">image_name</span><span class="o">.</span><span class="n">splitlines</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>    
                
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image_mode</span> <span class="o">==</span> <span class="s1">&#39;spiomm&#39;</span> <span class="ow">and</span> <span class="s1">&#39;_bias&#39;</span> <span class="ow">in</span> <span class="n">image_name</span><span class="p">:</span>
                    <span class="n">spiomm_bias_frame</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span> <span class="n">spiomm_bias_frame</span> <span class="o">=</span> <span class="kc">False</span>
                
                <span class="k">if</span> <span class="n">is_first_image</span><span class="p">:</span>
                    <span class="c1"># check list parameter</span>
                    <span class="k">if</span> <span class="s1">&#39;#&#39;</span> <span class="ow">in</span> <span class="n">image_name</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;sitelle&#39;</span> <span class="ow">in</span> <span class="n">image_name</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_image_mode</span> <span class="o">=</span> <span class="s1">&#39;sitelle&#39;</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_chip_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">image_name</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                        <span class="k">elif</span> <span class="s1">&#39;spiomm&#39;</span> <span class="ow">in</span> <span class="n">image_name</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_image_mode</span> <span class="o">=</span> <span class="s1">&#39;spiomm&#39;</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_chip_index</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">elif</span> <span class="s1">&#39;prebinning&#39;</span> <span class="ow">in</span> <span class="n">image_name</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_prebinning</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">image_name</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                            
                    <span class="k">elif</span> <span class="ow">not</span> <span class="n">spiomm_bias_frame</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">image_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">image_name</span><span class="p">]</span>

                        <span class="c1"># detect if hdf5 format or not</span>
                        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">image_name</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;.hdf5&#39;</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">is_hdf5_frames</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">image_name</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;.fits&#39;</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">is_hdf5_frames</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s2">&quot;Unrecognized extension of file </span><span class="si">{}</span><span class="s2">. File extension must be &#39;*.fits&#39; or &#39;*.hdf5&#39; depending on its format.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">image_name</span><span class="p">))</span>

                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_hdf5_frames</span> <span class="p">:</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image_mode</span> <span class="o">!=</span> <span class="s1">&#39;classic&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_print_warning</span><span class="p">(</span><span class="s2">&quot;Image mode changed to &#39;classic&#39; because &#39;spiomm&#39; and &#39;sitelle&#39; modes are not supported in hdf5 format.&quot;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prebinning</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_print_warning</span><span class="p">(</span><span class="s2">&quot;Prebinning is not supported for images in hdf5 format&quot;</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_image_mode</span> <span class="o">=</span> <span class="s1">&#39;classic&#39;</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_prebinning</span> <span class="o">=</span> <span class="mi">1</span>
        
                        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_hdf5_frames</span><span class="p">:</span>
                            <span class="n">image_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_fits</span><span class="p">(</span>
                                <span class="n">image_name</span><span class="p">,</span>
                                <span class="n">image_mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_image_mode</span><span class="p">,</span>
                                <span class="n">chip_index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_chip_index</span><span class="p">,</span>
                                <span class="n">binning</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_prebinning</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">dimx</span> <span class="o">=</span> <span class="n">image_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">dimy</span> <span class="o">=</span> <span class="n">image_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                            
                            <span class="n">hdul</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_fits</span><span class="p">(</span>
                                <span class="n">image_name</span><span class="p">,</span> <span class="n">return_hdu_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                            
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_hdf5</span><span class="p">(</span><span class="n">image_name</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                                <span class="k">if</span> <span class="s1">&#39;hdu0/data&#39;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                                    <span class="n">shape</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;hdu0/data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
                                    
                                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">dimx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimy</span> <span class="o">=</span> <span class="n">shape</span>
                                    <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s1">&#39;Image shape must have 2 dimensions: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">shape</span><span class="p">))</span>
                                <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s1">&#39;Bad formatted hdf5 file. Use Tools.write_hdf5 to get a correct hdf5 file for ORB.&#39;</span><span class="p">)</span>
                            
                        <span class="n">is_first_image</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="c1"># check if masked frame exists</span>
                        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_mask_path</span><span class="p">(</span><span class="n">image_name</span><span class="p">)):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_mask_exists</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_mask_exists</span> <span class="o">=</span> <span class="kc">False</span>
                            
                <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_MASK_FRAME_TAIL</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">image_name</span>
                      <span class="ow">and</span> <span class="ow">not</span> <span class="n">spiomm_bias_frame</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">image_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">image_name</span><span class="p">)</span>

            <span class="n">image_list_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="c1"># image list is sorted</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">no_sort</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">image_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sort_image_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_list</span><span class="p">,</span>
                                                       <span class="bp">self</span><span class="o">.</span><span class="n">_image_mode</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">image_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_list</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dimz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_list</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            
            
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimx</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimy</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimz</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">silent_init</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_print_msg</span><span class="p">(</span><span class="s2">&quot;Data shape : (&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimx</span><span class="p">)</span> 
                                    <span class="o">+</span> <span class="s2">&quot;, &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimy</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span> 
                                    <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimz</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s2">&quot;Incorrect data shape : (&quot;</span> 
                                  <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimx</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimy</span><span class="p">)</span> 
                                  <span class="o">+</span> <span class="s2">&quot;, &quot;</span> <span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimz</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Implement the evaluation of self[key].</span>
<span class="sd">        </span>
<span class="sd">        .. note:: To make this function silent just set</span>
<span class="sd">          Cube()._silent_load to True.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># check return mask possibility</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_return_mask</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask_exists</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s2">&quot;No mask found with data, cannot return mask&quot;</span><span class="p">)</span>
        
        <span class="c1"># produce default values for slices</span>
        <span class="n">x_slice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_default_slice</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimx</span><span class="p">)</span>
        <span class="n">y_slice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_default_slice</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimy</span><span class="p">)</span>
        <span class="n">z_slice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_default_slice</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimz</span><span class="p">)</span>
        
        <span class="c1"># get first frame</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_frame_section</span><span class="p">(</span><span class="n">x_slice</span><span class="p">,</span> <span class="n">y_slice</span><span class="p">,</span> <span class="n">z_slice</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>
        
        <span class="c1"># return this frame if only one frame is wanted</span>
        <span class="k">if</span> <span class="n">z_slice</span><span class="o">.</span><span class="n">stop</span> <span class="o">==</span> <span class="n">z_slice</span><span class="o">.</span><span class="n">start</span> <span class="o">+</span> <span class="mi">1</span><span class="n">L</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parallel_access_to_data</span><span class="p">:</span>
            <span class="c1"># load other frames</span>
            <span class="n">job_server</span><span class="p">,</span> <span class="n">ncpus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_pp_server</span><span class="p">(</span><span class="n">silent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_silent_load</span><span class="p">)</span> 

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_silent_load</span><span class="p">:</span>
                <span class="n">progress</span> <span class="o">=</span> <span class="n">ProgressBar</span><span class="p">(</span><span class="n">z_slice</span><span class="o">.</span><span class="n">stop</span> <span class="o">-</span> <span class="n">z_slice</span><span class="o">.</span><span class="n">start</span> <span class="o">-</span> <span class="mi">1</span><span class="n">L</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">z_slice</span><span class="o">.</span><span class="n">start</span> <span class="o">+</span> <span class="mi">1</span><span class="n">L</span><span class="p">,</span> <span class="n">z_slice</span><span class="o">.</span><span class="n">stop</span><span class="p">,</span> <span class="n">ncpus</span><span class="p">):</span>
                <span class="c1"># No more jobs than frames to compute</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ik</span> <span class="o">+</span> <span class="n">ncpus</span> <span class="o">&gt;=</span> <span class="n">z_slice</span><span class="o">.</span><span class="n">stop</span><span class="p">):</span> 
                    <span class="n">ncpus</span> <span class="o">=</span> <span class="n">z_slice</span><span class="o">.</span><span class="n">stop</span> <span class="o">-</span> <span class="n">ik</span>

                <span class="n">added_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">x_slice</span><span class="o">.</span><span class="n">stop</span> <span class="o">-</span> <span class="n">x_slice</span><span class="o">.</span><span class="n">start</span><span class="p">,</span>
                                       <span class="n">y_slice</span><span class="o">.</span><span class="n">stop</span> <span class="o">-</span> <span class="n">y_slice</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">ncpus</span><span class="p">),</span>
                                      <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

                <span class="n">jobs</span> <span class="o">=</span> <span class="p">[(</span><span class="n">ijob</span><span class="p">,</span> <span class="n">job_server</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_get_frame_section</span><span class="p">,</span>
                    <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">x_slice</span><span class="p">,</span> <span class="n">y_slice</span><span class="p">,</span> <span class="n">ik</span><span class="o">+</span><span class="n">ijob</span><span class="p">),</span>
                    <span class="n">modules</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;numpy as np&quot;</span><span class="p">,)))</span>
                        <span class="k">for</span> <span class="n">ijob</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncpus</span><span class="p">)]</span>

                <span class="k">for</span> <span class="n">ijob</span><span class="p">,</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">:</span>
                    <span class="n">added_data</span><span class="p">[:,:,</span><span class="n">ijob</span><span class="p">]</span> <span class="o">=</span> <span class="n">job</span><span class="p">()</span>

                <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">((</span><span class="n">data</span><span class="p">,</span> <span class="n">added_data</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_silent_load</span><span class="p">:</span>
                    <span class="n">progress</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ik</span> <span class="o">-</span> <span class="n">z_slice</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="s2">&quot;Loading data&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_silent_load</span><span class="p">:</span>
                <span class="n">progress</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_close_pp_server</span><span class="p">(</span><span class="n">job_server</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_silent_load</span><span class="p">:</span>
                <span class="n">progress</span> <span class="o">=</span> <span class="n">ProgressBar</span><span class="p">(</span><span class="n">z_slice</span><span class="o">.</span><span class="n">stop</span> <span class="o">-</span> <span class="n">z_slice</span><span class="o">.</span><span class="n">start</span> <span class="o">-</span> <span class="mi">1</span><span class="n">L</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">z_slice</span><span class="o">.</span><span class="n">start</span> <span class="o">+</span> <span class="mi">1</span><span class="n">L</span><span class="p">,</span> <span class="n">z_slice</span><span class="o">.</span><span class="n">stop</span><span class="p">):</span>

                <span class="n">added_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_frame_section</span><span class="p">(</span><span class="n">x_slice</span><span class="p">,</span> <span class="n">y_slice</span><span class="p">,</span> <span class="n">ik</span><span class="p">)</span>

                <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">((</span><span class="n">data</span><span class="p">,</span> <span class="n">added_data</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_silent_load</span><span class="p">:</span>
                    <span class="n">progress</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ik</span> <span class="o">-</span> <span class="n">z_slice</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="s2">&quot;Loading data&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_silent_load</span><span class="p">:</span>
                <span class="n">progress</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
            
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_default_slice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_slice</span><span class="p">,</span> <span class="n">_max</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Utility function used by __getitem__. Return a valid slice</span>
<span class="sd">        object given an integer or slice.</span>

<span class="sd">        :param _slice: a slice object or an integer</span>
<span class="sd">        :param _max: size of the considered axis of the slice.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_slice</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">_slice</span><span class="o">.</span><span class="n">start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">_slice</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
                    <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_slice</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">long</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">_slice</span><span class="o">.</span><span class="n">start</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">_slice</span><span class="o">.</span><span class="n">start</span> <span class="o">&lt;=</span> <span class="n">_max</span><span class="p">):</span>
                        <span class="n">slice_min</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">_slice</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span>
                            <span class="s2">&quot;Index error: list index out of range&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s2">&quot;Type error: list indices of slice must be integers&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">slice_min</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">if</span> <span class="n">_slice</span><span class="o">.</span><span class="n">stop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">_slice</span><span class="o">.</span><span class="n">stop</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
                    <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_slice</span><span class="o">.</span><span class="n">stop</span><span class="p">,</span> <span class="n">long</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">_slice</span><span class="o">.</span><span class="n">stop</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># transform negative index to real index</span>
                        <span class="n">slice_stop</span> <span class="o">=</span> <span class="n">_max</span> <span class="o">+</span> <span class="n">_slice</span><span class="o">.</span><span class="n">stop</span>
                    <span class="k">else</span><span class="p">:</span>  <span class="n">slice_stop</span> <span class="o">=</span> <span class="n">_slice</span><span class="o">.</span><span class="n">stop</span>
                    <span class="k">if</span> <span class="p">((</span><span class="n">slice_stop</span> <span class="o">&lt;=</span> <span class="n">_max</span><span class="p">)</span>
                        <span class="ow">and</span> <span class="n">slice_stop</span> <span class="o">&gt;</span> <span class="n">slice_min</span><span class="p">):</span>
                        <span class="n">slice_max</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">slice_stop</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span>
                            <span class="s2">&quot;Index error: list index out of range&quot;</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s2">&quot;Type error: list indices of slice must be integers&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">slice_max</span> <span class="o">=</span> <span class="n">_max</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_slice</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_slice</span><span class="p">,</span> <span class="n">long</span><span class="p">):</span>
            <span class="n">slice_min</span> <span class="o">=</span> <span class="n">_slice</span>
            <span class="n">slice_max</span> <span class="o">=</span> <span class="n">slice_min</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s2">&quot;Type error: list indices must be integers or slices&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">slice</span><span class="p">(</span><span class="n">slice_min</span><span class="p">,</span> <span class="n">slice_max</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_frame_section</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_slice</span><span class="p">,</span> <span class="n">y_slice</span><span class="p">,</span> <span class="n">frame_index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Utility function used by __getitem__.</span>

<span class="sd">        Return a section of one frame in the cube.</span>

<span class="sd">        :param x_slice: slice object along x axis.</span>
<span class="sd">        :param y_slice: slice object along y axis.</span>
<span class="sd">        :param frame_index: Index of the frame.</span>

<span class="sd">        .. warning:: This function must only be used by</span>
<span class="sd">           __getitem__. To get a frame section please use the method</span>
<span class="sd">           :py:meth:`orb.core.get_data_frame` or</span>
<span class="sd">           :py:meth:`orb.core.get_data`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_hdf5_frames</span><span class="p">:</span>
            <span class="n">hdu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_fits</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_list</span><span class="p">[</span><span class="n">frame_index</span><span class="p">],</span>
                                 <span class="n">return_hdu_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                 <span class="n">return_mask</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_return_mask</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hdu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_hdf5</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_list</span><span class="p">[</span><span class="n">frame_index</span><span class="p">],</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">image</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">stored_file_path</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prebinning</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># already binned data is stored in a specific folder</span>
            <span class="c1"># to avoid loading more than one time the same image.</span>
            <span class="c1"># check if already binned data exists</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_hdf5_frames</span><span class="p">:</span>
                <span class="n">stored_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_data_path_hdr</span><span class="p">())[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="s1">&#39;STORED&#39;</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_list</span><span class="p">[</span><span class="n">frame_index</span><span class="p">])[</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                     <span class="o">+</span> <span class="s1">&#39;.</span><span class="si">{}</span><span class="s1">.bin</span><span class="si">{}</span><span class="s1">.fits&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_image_mode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prebinning</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s1">&#39;prebinned data is not handled for hdf5 cubes&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">stored_file_path</span><span class="p">):</span>
                <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_fits</span><span class="p">(</span><span class="n">stored_file_path</span><span class="p">)</span>


        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image_mode</span> <span class="o">==</span> <span class="s1">&#39;sitelle&#39;</span><span class="p">:</span> <span class="c1"># FITS only</span>
            <span class="k">if</span> <span class="n">image</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_sitelle_chip</span><span class="p">(</span><span class="n">hdu</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chip_index</span><span class="p">)</span>
                <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bin_image</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prebinning</span><span class="p">)</span>
            <span class="n">section</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="n">x_slice</span><span class="p">,</span> <span class="n">y_slice</span><span class="p">]</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image_mode</span> <span class="o">==</span> <span class="s1">&#39;spiomm&#39;</span><span class="p">:</span> <span class="c1"># FITS only</span>
            <span class="k">if</span> <span class="n">image</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">image</span><span class="p">,</span> <span class="n">header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_spiomm_data</span><span class="p">(</span>
                    <span class="n">hdu</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_list</span><span class="p">[</span><span class="n">frame_index</span><span class="p">])</span>
                <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bin_image</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prebinning</span><span class="p">)</span>
            <span class="n">section</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="n">x_slice</span><span class="p">,</span> <span class="n">y_slice</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prebinning</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># FITS only</span>
                <span class="k">if</span> <span class="n">image</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span>
                        <span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">transpose</span><span class="p">())</span>
                    <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bin_image</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prebinning</span><span class="p">)</span>
                <span class="n">section</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="n">x_slice</span><span class="p">,</span> <span class="n">y_slice</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">image</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># HDF5 and FITS</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_hdf5_frames</span><span class="p">:</span>
                        <span class="n">section</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span>
                            <span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">section</span><span class="p">[</span><span class="n">y_slice</span><span class="p">,</span> <span class="n">x_slice</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">())</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">section</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;hdu0/data&#39;</span><span class="p">][</span><span class="n">x_slice</span><span class="p">,</span> <span class="n">y_slice</span><span class="p">]</span>

                <span class="k">else</span><span class="p">:</span> <span class="c1"># FITS only</span>
                    <span class="n">section</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="n">y_slice</span><span class="p">,</span> <span class="n">x_slice</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">hdu</span>

         <span class="c1"># FITS only</span>
        <span class="k">if</span> <span class="n">stored_file_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_fits</span><span class="p">(</span><span class="n">stored_file_path</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_return_mask</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># always reset self._return_mask to False</span>
        <span class="k">return</span> <span class="n">section</span>

<div class="viewcode-block" id="Cube.is_same_2D_size"><a class="viewcode-back" href="../../orb.html#orb.core.Cube.is_same_2D_size">[docs]</a>    <span class="k">def</span> <span class="nf">is_same_2D_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cube_test</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if another cube has the same dimensions along x and y</span>
<span class="sd">        axes.</span>

<span class="sd">        :param cube_test: Cube to check</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="p">((</span><span class="n">cube_test</span><span class="o">.</span><span class="n">dimx</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimx</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">cube_test</span><span class="o">.</span><span class="n">dimy</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimy</span><span class="p">)):</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Cube.is_same_3D_size"><a class="viewcode-back" href="../../orb.html#orb.core.Cube.is_same_3D_size">[docs]</a>    <span class="k">def</span> <span class="nf">is_same_3D_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cube_test</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if another cube has the same dimensions.</span>

<span class="sd">        :param cube_test: Cube to check</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="p">((</span><span class="n">cube_test</span><span class="o">.</span><span class="n">dimx</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimx</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">cube_test</span><span class="o">.</span><span class="n">dimy</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimy</span><span class="p">)</span> 
            <span class="ow">and</span> <span class="p">(</span><span class="n">cube_test</span><span class="o">.</span><span class="n">dimz</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimz</span><span class="p">)):</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>    </div>

<div class="viewcode-block" id="Cube.get_data_frame"><a class="viewcode-back" href="../../orb.html#orb.core.Cube.get_data_frame">[docs]</a>    <span class="k">def</span> <span class="nf">get_data_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return one frame of the cube.</span>

<span class="sd">        :param index: Index of the frame to be returned</span>

<span class="sd">        :param silent: (Optional) if False display a progress bar</span>
<span class="sd">          during data loading (default False)</span>

<span class="sd">        :param mask: (Optional) if True return mask (default False).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">silent</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_silent_load</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">mask</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_return_mask</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[:,:,</span><span class="n">index</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_silent_load</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_return_mask</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">data</span></div>

<div class="viewcode-block" id="Cube.get_data"><a class="viewcode-back" href="../../orb.html#orb.core.Cube.get_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">,</span>
                 <span class="n">z_min</span><span class="p">,</span> <span class="n">z_max</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a part of the data cube.</span>

<span class="sd">        :param x_min: minimum index along x axis</span>
<span class="sd">        </span>
<span class="sd">        :param x_max: maximum index along x axis</span>
<span class="sd">        </span>
<span class="sd">        :param y_min: minimum index along y axis</span>
<span class="sd">        </span>
<span class="sd">        :param y_max: maximum index along y axis</span>
<span class="sd">        </span>
<span class="sd">        :param z_min: minimum index along z axis</span>
<span class="sd">        </span>
<span class="sd">        :param z_max: maximum index along z axis</span>
<span class="sd">        </span>
<span class="sd">        :param silent: (Optional) if False display a progress bar</span>
<span class="sd">          during data loading (default False)</span>

<span class="sd">        :param mask: (Optional) if True return mask (default False).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">silent</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_silent_load</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">mask</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_return_mask</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">x_min</span><span class="p">:</span><span class="n">x_max</span><span class="p">,</span> <span class="n">y_min</span><span class="p">:</span><span class="n">y_max</span><span class="p">,</span> <span class="n">z_min</span><span class="p">:</span><span class="n">z_max</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_silent_load</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_return_mask</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">data</span></div>
        
    
<div class="viewcode-block" id="Cube.get_all_data"><a class="viewcode-back" href="../../orb.html#orb.core.Cube.get_all_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the whole data cube</span>

<span class="sd">        :param mask: (Optional) if True return mask (default False).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">mask</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_return_mask</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[:,:,:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_return_mask</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">data</span></div>
    
<div class="viewcode-block" id="Cube.get_column_data"><a class="viewcode-back" href="../../orb.html#orb.core.Cube.get_column_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_column_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">icol</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return data as a slice along x axis</span>

<span class="sd">        :param icol: Column index</span>
<span class="sd">        </span>
<span class="sd">        :param silent: (Optional) if False display a progress bar</span>
<span class="sd">          during data loading (default True)</span>
<span class="sd">          </span>
<span class="sd">        :param mask: (Optional) if True return mask (default False).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">silent</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_silent_load</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">mask</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_return_mask</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">icol</span><span class="p">,</span> <span class="n">icol</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimy</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimz</span><span class="p">,</span>
                             <span class="n">silent</span><span class="o">=</span><span class="n">silent</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_silent_load</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_return_mask</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">data</span></div>

<div class="viewcode-block" id="Cube.get_frame_header"><a class="viewcode-back" href="../../orb.html#orb.core.Cube.get_frame_header">[docs]</a>    <span class="k">def</span> <span class="nf">get_frame_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the header of a frame given its index in the list.</span>

<span class="sd">        The header is returned as an instance of pyfits.Header().</span>

<span class="sd">        :param index: Index of the frame</span>

<span class="sd">        .. note:: Please refer to</span>
<span class="sd">          http://www.stsci.edu/institute/software_hardware/pyfits/ for</span>
<span class="sd">          more information on PyFITS module and</span>
<span class="sd">          http://fits.gsfc.nasa.gov/ for more information on FITS</span>
<span class="sd">          files.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_hdf5_frames</span><span class="p">:</span>
            <span class="n">hdu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_fits</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_list</span><span class="p">[</span><span class="n">index</span><span class="p">],</span>
                                 <span class="n">return_hdu_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">hdu</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="s1">&#39;silentfix&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hdu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_hdf5</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_list</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;hdu0/header&#39;</span> <span class="ow">in</span> <span class="n">hdu</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;hdu0/header&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">Header</span><span class="p">()</span></div>

    
<div class="viewcode-block" id="Cube.get_cube_header"><a class="viewcode-back" href="../../orb.html#orb.core.Cube.get_cube_header">[docs]</a>    <span class="k">def</span> <span class="nf">get_cube_header</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the header of a cube from the header of the first frame</span>
<span class="sd">        by keeping only the general keywords.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">del_key</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">header</span><span class="p">):</span>
            <span class="k">if</span> <span class="s1">&#39;*&#39;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">[:</span><span class="n">key</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">)]</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">header</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
                        <span class="n">header</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">while</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
                    <span class="n">header</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">header</span>
                
        <span class="n">cube_header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_frame_header</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">cube_header</span> <span class="o">=</span> <span class="n">del_key</span><span class="p">(</span><span class="s1">&#39;COMMENT&#39;</span><span class="p">,</span> <span class="n">cube_header</span><span class="p">)</span>
        <span class="n">cube_header</span> <span class="o">=</span> <span class="n">del_key</span><span class="p">(</span><span class="s1">&#39;EXPNUM&#39;</span><span class="p">,</span> <span class="n">cube_header</span><span class="p">)</span>
        <span class="n">cube_header</span> <span class="o">=</span> <span class="n">del_key</span><span class="p">(</span><span class="s1">&#39;BSEC*&#39;</span><span class="p">,</span> <span class="n">cube_header</span><span class="p">)</span>
        <span class="n">cube_header</span> <span class="o">=</span> <span class="n">del_key</span><span class="p">(</span><span class="s1">&#39;DSEC*&#39;</span><span class="p">,</span> <span class="n">cube_header</span><span class="p">)</span>
        <span class="n">cube_header</span> <span class="o">=</span> <span class="n">del_key</span><span class="p">(</span><span class="s1">&#39;FILENAME&#39;</span><span class="p">,</span> <span class="n">cube_header</span><span class="p">)</span>
        <span class="n">cube_header</span> <span class="o">=</span> <span class="n">del_key</span><span class="p">(</span><span class="s1">&#39;PATHNAME&#39;</span><span class="p">,</span> <span class="n">cube_header</span><span class="p">)</span>
        <span class="n">cube_header</span> <span class="o">=</span> <span class="n">del_key</span><span class="p">(</span><span class="s1">&#39;OBSID&#39;</span><span class="p">,</span> <span class="n">cube_header</span><span class="p">)</span>
        <span class="n">cube_header</span> <span class="o">=</span> <span class="n">del_key</span><span class="p">(</span><span class="s1">&#39;IMAGEID&#39;</span><span class="p">,</span> <span class="n">cube_header</span><span class="p">)</span>
        <span class="n">cube_header</span> <span class="o">=</span> <span class="n">del_key</span><span class="p">(</span><span class="s1">&#39;CHIPID&#39;</span><span class="p">,</span> <span class="n">cube_header</span><span class="p">)</span>
        <span class="n">cube_header</span> <span class="o">=</span> <span class="n">del_key</span><span class="p">(</span><span class="s1">&#39;DETSIZE&#39;</span><span class="p">,</span> <span class="n">cube_header</span><span class="p">)</span>
        <span class="n">cube_header</span> <span class="o">=</span> <span class="n">del_key</span><span class="p">(</span><span class="s1">&#39;RASTER&#39;</span><span class="p">,</span> <span class="n">cube_header</span><span class="p">)</span>
        <span class="n">cube_header</span> <span class="o">=</span> <span class="n">del_key</span><span class="p">(</span><span class="s1">&#39;AMPLIST&#39;</span><span class="p">,</span> <span class="n">cube_header</span><span class="p">)</span>
        <span class="n">cube_header</span> <span class="o">=</span> <span class="n">del_key</span><span class="p">(</span><span class="s1">&#39;CCDSIZE&#39;</span><span class="p">,</span> <span class="n">cube_header</span><span class="p">)</span>
        <span class="n">cube_header</span> <span class="o">=</span> <span class="n">del_key</span><span class="p">(</span><span class="s1">&#39;DATASEC&#39;</span><span class="p">,</span> <span class="n">cube_header</span><span class="p">)</span>
        <span class="n">cube_header</span> <span class="o">=</span> <span class="n">del_key</span><span class="p">(</span><span class="s1">&#39;BIASSEC&#39;</span><span class="p">,</span> <span class="n">cube_header</span><span class="p">)</span>
        <span class="n">cube_header</span> <span class="o">=</span> <span class="n">del_key</span><span class="p">(</span><span class="s1">&#39;CSEC1&#39;</span><span class="p">,</span> <span class="n">cube_header</span><span class="p">)</span>
        <span class="n">cube_header</span> <span class="o">=</span> <span class="n">del_key</span><span class="p">(</span><span class="s1">&#39;CSEC2&#39;</span><span class="p">,</span> <span class="n">cube_header</span><span class="p">)</span>
        <span class="n">cube_header</span> <span class="o">=</span> <span class="n">del_key</span><span class="p">(</span><span class="s1">&#39;TIME-OBS&#39;</span><span class="p">,</span> <span class="n">cube_header</span><span class="p">)</span>
        <span class="n">cube_header</span> <span class="o">=</span> <span class="n">del_key</span><span class="p">(</span><span class="s1">&#39;DATEEND&#39;</span><span class="p">,</span> <span class="n">cube_header</span><span class="p">)</span>
        <span class="n">cube_header</span> <span class="o">=</span> <span class="n">del_key</span><span class="p">(</span><span class="s1">&#39;TIMEEND&#39;</span><span class="p">,</span> <span class="n">cube_header</span><span class="p">)</span>
        <span class="n">cube_header</span> <span class="o">=</span> <span class="n">del_key</span><span class="p">(</span><span class="s1">&#39;SITNEXL&#39;</span><span class="p">,</span> <span class="n">cube_header</span><span class="p">)</span>
        <span class="n">cube_header</span> <span class="o">=</span> <span class="n">del_key</span><span class="p">(</span><span class="s1">&#39;SITPZ*&#39;</span><span class="p">,</span> <span class="n">cube_header</span><span class="p">)</span>
        <span class="n">cube_header</span> <span class="o">=</span> <span class="n">del_key</span><span class="p">(</span><span class="s1">&#39;SITSTEP&#39;</span><span class="p">,</span> <span class="n">cube_header</span><span class="p">)</span>
        <span class="n">cube_header</span> <span class="o">=</span> <span class="n">del_key</span><span class="p">(</span><span class="s1">&#39;SITFRING&#39;</span><span class="p">,</span> <span class="n">cube_header</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">cube_header</span></div>


<div class="viewcode-block" id="Cube.get_size_on_disk"><a class="viewcode-back" href="../../orb.html#orb.core.Cube.get_size_on_disk">[docs]</a>    <span class="k">def</span> <span class="nf">get_size_on_disk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the expected size of the cube if saved on disk in Mo.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimx</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimy</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimz</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">/</span> <span class="mf">1e6</span> <span class="c1"># 4 octets in float32</span></div>

<div class="viewcode-block" id="Cube.get_resized_frame"><a class="viewcode-back" href="../../orb.html#orb.core.Cube.get_resized_frame">[docs]</a>    <span class="k">def</span> <span class="nf">get_resized_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">size_x</span><span class="p">,</span> <span class="n">size_y</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a resized frame using spline interpolation.</span>

<span class="sd">        :param index: Index of the frame to resize</span>
<span class="sd">        :param size_x: New size of the cube along x axis</span>
<span class="sd">        :param size_y: New size of the cube along y axis</span>
<span class="sd">        :param degree: (Optional) Interpolation degree (Default 3)</span>
<span class="sd">        </span>
<span class="sd">        .. warning:: To use this function on images containing</span>
<span class="sd">           star-like objects a linear interpolation must be done</span>
<span class="sd">           (set degree to 1).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">resized_frame</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">size_x</span><span class="p">,</span> <span class="n">size_y</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimx</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimy</span><span class="p">)</span>
        <span class="n">x_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimx</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">size_x</span><span class="p">)</span>
        <span class="n">y_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimy</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">size_y</span><span class="p">)</span>
        <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data_frame</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="n">interp</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">RectBivariateSpline</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">kx</span><span class="o">=</span><span class="n">degree</span><span class="p">,</span> <span class="n">ky</span><span class="o">=</span><span class="n">degree</span><span class="p">)</span>
        <span class="n">resized_frame</span> <span class="o">=</span> <span class="n">interp</span><span class="p">(</span><span class="n">x_new</span><span class="p">,</span> <span class="n">y_new</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">resized_frame</span><span class="p">)</span>
        <span class="n">dimx</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dimy</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print_msg</span><span class="p">(</span><span class="s2">&quot;Data resized to shape : (&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">dimx</span><span class="p">)</span> <span class="o">+</span>  <span class="s2">&quot;, &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">dimy</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">resized_frame</span></div>

<div class="viewcode-block" id="Cube.get_resized_data"><a class="viewcode-back" href="../../orb.html#orb.core.Cube.get_resized_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_resized_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size_x</span><span class="p">,</span> <span class="n">size_y</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Resize the data cube and return it using spline</span>
<span class="sd">          interpolation.</span>
<span class="sd">          </span>
<span class="sd">        This function is used only to resize a cube of flat or dark</span>
<span class="sd">        frames. Note that resizing dark or flat frames must be</span>
<span class="sd">        avoided.</span>

<span class="sd">        :param size_x: New size of the cube along x axis</span>
<span class="sd">        :param size_y: New size of the cube along y axis</span>
<span class="sd">        </span>
<span class="sd">        .. warning:: This function must not be used to resize images</span>
<span class="sd">          containing star-like objects (a linear interpopolation must</span>
<span class="sd">          be done in this case).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">resized_cube</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">size_x</span><span class="p">,</span> <span class="n">size_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimz</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimx</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimy</span><span class="p">)</span>
        <span class="n">x_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimx</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">size_x</span><span class="p">)</span>
        <span class="n">y_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimy</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">size_y</span><span class="p">)</span>
        <span class="n">progress</span> <span class="o">=</span> <span class="n">ProgressBar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimz</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_ik</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimz</span><span class="p">):</span>
            <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data_frame</span><span class="p">(</span><span class="n">_ik</span><span class="p">)</span>
            <span class="n">interp</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">RectBivariateSpline</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
            <span class="n">resized_cube</span><span class="p">[:,:,</span><span class="n">_ik</span><span class="p">]</span> <span class="o">=</span> <span class="n">interp</span><span class="p">(</span><span class="n">x_new</span><span class="p">,</span> <span class="n">y_new</span><span class="p">)</span>
            <span class="n">progress</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_ik</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="s2">&quot;resizing cube&quot;</span><span class="p">)</span>
        <span class="n">progress</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">resized_cube</span><span class="p">)</span>
        <span class="n">dimx</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dimy</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">dimz</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print_msg</span><span class="p">(</span><span class="s2">&quot;Data resized to shape : (&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">dimx</span><span class="p">)</span> <span class="o">+</span>  <span class="s2">&quot;, &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">dimy</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">dimz</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span></div>

<div class="viewcode-block" id="Cube.get_interf_energy_map"><a class="viewcode-back" href="../../orb.html#orb.core.Cube.get_interf_energy_map">[docs]</a>    <span class="k">def</span> <span class="nf">get_interf_energy_map</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the energy map of an interferogram cube.&quot;&quot;&quot;</span>
        <span class="n">mean_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_mean_image</span><span class="p">()</span>
        <span class="n">energy_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">dimx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimy</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">progress</span> <span class="o">=</span> <span class="n">ProgressBar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimz</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_ik</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimz</span><span class="p">):</span>
            <span class="n">energy_map</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_data_frame</span><span class="p">(</span><span class="n">_ik</span><span class="p">)</span> <span class="o">-</span> <span class="n">mean_map</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span>
            <span class="n">progress</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_ik</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="s2">&quot;Creating interf energy map&quot;</span><span class="p">)</span>
        <span class="n">progress</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">energy_map</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimz</span><span class="p">)</span></div>

<div class="viewcode-block" id="Cube.get_spectrum_energy_map"><a class="viewcode-back" href="../../orb.html#orb.core.Cube.get_spectrum_energy_map">[docs]</a>    <span class="k">def</span> <span class="nf">get_spectrum_energy_map</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the energy map of a spectrum cube.</span>
<span class="sd">    </span>
<span class="sd">        .. note:: In this process NaNs are considered as zeros.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">energy_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">dimx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimy</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">progress</span> <span class="o">=</span> <span class="n">ProgressBar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimz</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_ik</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimz</span><span class="p">):</span>
            <span class="n">frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data_frame</span><span class="p">(</span><span class="n">_ik</span><span class="p">)</span>
            <span class="n">non_nans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">frame</span><span class="p">))</span>
            <span class="n">energy_map</span><span class="p">[</span><span class="n">non_nans</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">frame</span><span class="p">[</span><span class="n">non_nans</span><span class="p">])</span><span class="o">**</span><span class="mf">2.</span>
            <span class="n">progress</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_ik</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="s2">&quot;Creating spectrum energy map&quot;</span><span class="p">)</span>
        <span class="n">progress</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">energy_map</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimz</span></div>

<div class="viewcode-block" id="Cube.get_mean_image"><a class="viewcode-back" href="../../orb.html#orb.core.Cube.get_mean_image">[docs]</a>    <span class="k">def</span> <span class="nf">get_mean_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the mean image of a cube (corresponding to a deep</span>
<span class="sd">        frame for an interferogram cube or a specral cube).</span>

<span class="sd">        :param recompute: (Optional) Force to recompute mean image</span>
<span class="sd">          even if it is already present in the cube (default False).</span>
<span class="sd">        </span>
<span class="sd">        .. note:: In this process NaNs are considered as zeros.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean_image</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">recompute</span><span class="p">:</span>
            <span class="n">mean_im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">dimx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimy</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="n">progress</span> <span class="o">=</span> <span class="n">ProgressBar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimz</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">_ik</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimz</span><span class="p">):</span>
                <span class="n">frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data_frame</span><span class="p">(</span><span class="n">_ik</span><span class="p">)</span>
                <span class="n">non_nans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">frame</span><span class="p">))</span>
                <span class="n">mean_im</span><span class="p">[</span><span class="n">non_nans</span><span class="p">]</span> <span class="o">+=</span> <span class="n">frame</span><span class="p">[</span><span class="n">non_nans</span><span class="p">]</span>
                <span class="n">progress</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_ik</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="s2">&quot;Creating mean image&quot;</span><span class="p">)</span>
            <span class="n">progress</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mean_image</span> <span class="o">=</span> <span class="n">mean_im</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimz</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean_image</span></div>

<div class="viewcode-block" id="Cube.get_median_image"><a class="viewcode-back" href="../../orb.html#orb.core.Cube.get_median_image">[docs]</a>    <span class="k">def</span> <span class="nf">get_median_image</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the median image of a cube</span>

<span class="sd">        .. note:: This is not a real median image. Frames are combined</span>
<span class="sd">          10 by 10 with a median.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">median_im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">dimx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimy</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">progress</span> <span class="o">=</span> <span class="n">ProgressBar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimz</span><span class="p">)</span>
        <span class="n">BLOCK_SIZE</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">_ik</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimz</span><span class="p">,</span> <span class="n">BLOCK_SIZE</span><span class="p">):</span>
            <span class="n">progress</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_ik</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="s2">&quot;Creating median image&quot;</span><span class="p">)</span>
            <span class="n">_ik_end</span> <span class="o">=</span> <span class="n">_ik</span><span class="o">+</span><span class="n">BLOCK_SIZE</span>
            <span class="k">if</span> <span class="n">_ik_end</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimz</span><span class="p">:</span>
                <span class="n">_ik_end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimz</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">_ik_end</span> <span class="o">&gt;</span> <span class="n">_ik</span><span class="p">:</span>
                <span class="n">frames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dimx</span><span class="p">,</span>
                                       <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimy</span><span class="p">,</span>
                                       <span class="n">_ik</span><span class="p">,</span><span class="n">_ik_end</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">median_im</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">frames</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">counts</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">progress</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">median_im</span> <span class="o">/</span> <span class="n">counts</span></div>

<div class="viewcode-block" id="Cube.get_zstd"><a class="viewcode-back" href="../../orb.html#orb.core.Cube.get_zstd">[docs]</a>    <span class="k">def</span> <span class="nf">get_zstd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nozero</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a vector containing frames std.</span>

<span class="sd">        :param nozero: If True zeros are removed from the std</span>
<span class="sd">          computation. If there&#39;s only zeros, std frame value will</span>
<span class="sd">          be a NaN (default False).</span>

<span class="sd">        :param center: If True only the center of the frame is used to</span>
<span class="sd">          compute std.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_zstat</span><span class="p">(</span><span class="n">nozero</span><span class="o">=</span><span class="n">nozero</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">,</span> <span class="n">stat</span><span class="o">=</span><span class="s1">&#39;std&#39;</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="Cube.get_zmean"><a class="viewcode-back" href="../../orb.html#orb.core.Cube.get_zmean">[docs]</a>    <span class="k">def</span> <span class="nf">get_zmean</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nozero</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a vector containing frames median.</span>

<span class="sd">        :param nozero: If True zeros are removed from the median</span>
<span class="sd">          computation. If there&#39;s only zeros, median frame value will</span>
<span class="sd">          be a NaN (default False).</span>

<span class="sd">        :param center: If True only the center of the frame is used to</span>
<span class="sd">          compute median.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_zstat</span><span class="p">(</span><span class="n">nozero</span><span class="o">=</span><span class="n">nozero</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">,</span> <span class="n">stat</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Cube.get_zmedian"><a class="viewcode-back" href="../../orb.html#orb.core.Cube.get_zmedian">[docs]</a>    <span class="k">def</span> <span class="nf">get_zmedian</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nozero</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a vector containing frames mean.</span>

<span class="sd">        :param nozero: If True zeros are removed from the mean</span>
<span class="sd">          computation. If there&#39;s only zeros, mean frame value will</span>
<span class="sd">          be a NaN (default False).</span>

<span class="sd">        :param center: If True only the center of the frame is used to</span>
<span class="sd">          compute mean.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_zstat</span><span class="p">(</span><span class="n">nozero</span><span class="o">=</span><span class="n">nozero</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">,</span> <span class="n">stat</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_get_frame_stat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ik</span><span class="p">,</span> <span class="n">nozero</span><span class="p">,</span> <span class="n">stat_key</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span>
                        <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Utilitary function for :py:meth:`orb.orb.Cube.get_zstat`</span>
<span class="sd">        which returns the stats of a frame in a box.</span>

<span class="sd">        Check if the frame stats are not already in the header of the</span>
<span class="sd">        frame.    </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">nozero</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">center</span><span class="p">:</span>
            <span class="n">frame_hdr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_frame_header</span><span class="p">(</span><span class="n">ik</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">stat_key</span> <span class="ow">in</span> <span class="n">frame_hdr</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">frame_hdr</span><span class="p">[</span><span class="n">stat_key</span><span class="p">])):</span>
                    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">frame_hdr</span><span class="p">[</span><span class="n">stat_key</span><span class="p">])</span>

        <span class="n">frame</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span>
            <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">ik</span><span class="p">,</span> <span class="n">ik</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">nozero</span><span class="p">:</span> <span class="c1"># zeros filtering</span>
            <span class="n">frame</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">frame</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="k">if</span> <span class="n">bn</span><span class="o">.</span><span class="n">allnan</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">if</span> <span class="n">stat_key</span> <span class="o">==</span> <span class="s1">&#39;MEDIAN&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">bn</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">stat_key</span> <span class="o">==</span> <span class="s1">&#39;MEAN&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">bn</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">stat_key</span> <span class="o">==</span> <span class="s1">&#39;STD&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">bn</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s1">&#39;stat_key must be set to MEDIAN, MEAN or STD&#39;</span><span class="p">)</span>
        

<div class="viewcode-block" id="Cube.get_zstat"><a class="viewcode-back" href="../../orb.html#orb.core.Cube.get_zstat">[docs]</a>    <span class="k">def</span> <span class="nf">get_zstat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nozero</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">stat</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a vector containing frames stat (mean, median or</span>
<span class="sd">        std).</span>

<span class="sd">        :param nozero: If True zeros are removed from the stat</span>
<span class="sd">          computation. If there&#39;s only zeros, stat frame value will</span>
<span class="sd">          be a NaN (default False).</span>

<span class="sd">        :param stat: Type of stat to return. Can be &#39;mean&#39;, &#39;median&#39;</span>
<span class="sd">          or &#39;std&#39;</span>

<span class="sd">        :param center: If True only the center of the frame is used to</span>
<span class="sd">          compute stat.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">BORDER_COEFF</span> <span class="o">=</span> <span class="mf">0.15</span>
        
        <span class="k">if</span> <span class="n">center</span><span class="p">:</span>
            <span class="n">xmin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimx</span> <span class="o">*</span> <span class="n">BORDER_COEFF</span><span class="p">)</span>
            <span class="n">xmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimx</span> <span class="o">-</span> <span class="n">xmin</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">ymin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimy</span> <span class="o">*</span> <span class="n">BORDER_COEFF</span><span class="p">)</span>
            <span class="n">ymax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimy</span> <span class="o">-</span> <span class="n">ymin</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xmin</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">xmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimx</span>
            <span class="n">ymin</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">ymax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimy</span>

        <span class="k">if</span> <span class="n">stat</span> <span class="o">==</span> <span class="s1">&#39;mean&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_mean</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">stat_key</span> <span class="o">=</span> <span class="s1">&#39;MEAN&#39;</span>
            <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_mean</span>
            
        <span class="k">elif</span> <span class="n">stat</span> <span class="o">==</span> <span class="s1">&#39;median&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_median</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">stat_key</span> <span class="o">=</span> <span class="s1">&#39;MEDIAN&#39;</span>
            <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_median</span>
            
        <span class="k">elif</span> <span class="n">stat</span> <span class="o">==</span> <span class="s1">&#39;std&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_std</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">stat_key</span> <span class="o">=</span> <span class="s1">&#39;STD&#39;</span>
            <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_std</span>
            
        <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span>
            <span class="s2">&quot;Bad stat option. Must be &#39;mean&#39;, &#39;median&#39; or &#39;std&#39;&quot;</span><span class="p">)</span>
        
        <span class="n">stat_vector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimz</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

        <span class="n">job_server</span><span class="p">,</span> <span class="n">ncpus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_pp_server</span><span class="p">()</span>
        <span class="n">progress</span> <span class="o">=</span> <span class="n">ProgressBar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimz</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimz</span><span class="p">,</span> <span class="n">ncpus</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">ik</span> <span class="o">+</span> <span class="n">ncpus</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimz</span><span class="p">:</span>
                <span class="n">ncpus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimz</span> <span class="o">-</span> <span class="n">ik</span>

            <span class="n">jobs</span> <span class="o">=</span> <span class="p">[(</span><span class="n">ijob</span><span class="p">,</span> <span class="n">job_server</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_get_frame_stat</span><span class="p">,</span> 
                <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">ik</span> <span class="o">+</span> <span class="n">ijob</span><span class="p">,</span> <span class="n">nozero</span><span class="p">,</span> <span class="n">stat_key</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span>
                      <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">),</span>
                <span class="n">modules</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;import numpy as np&quot;</span><span class="p">,</span>
                         <span class="s2">&quot;import bottleneck as bn&quot;</span><span class="p">)))</span>
                    <span class="k">for</span> <span class="n">ijob</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncpus</span><span class="p">)]</span>

            <span class="k">for</span> <span class="n">ijob</span><span class="p">,</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">:</span>
                <span class="n">stat_vector</span><span class="p">[</span><span class="n">ik</span><span class="o">+</span><span class="n">ijob</span><span class="p">]</span> <span class="o">=</span> <span class="n">job</span><span class="p">()</span>   

            <span class="n">progress</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ik</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="s2">&quot;Creating stat vector&quot;</span><span class="p">)</span>
        <span class="n">progress</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_close_pp_server</span><span class="p">(</span><span class="n">job_server</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">stat</span> <span class="o">==</span> <span class="s1">&#39;mean&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">z_mean</span> <span class="o">=</span> <span class="n">stat_vector</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_mean</span>
        <span class="k">if</span> <span class="n">stat</span> <span class="o">==</span> <span class="s1">&#39;median&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">z_median</span> <span class="o">=</span> <span class="n">stat_vector</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_median</span>
        <span class="k">if</span> <span class="n">stat</span> <span class="o">==</span> <span class="s1">&#39;std&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">z_std</span> <span class="o">=</span> <span class="n">stat_vector</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_std</span></div>
            
<div class="viewcode-block" id="Cube.get_quadrant_dims"><a class="viewcode-back" href="../../orb.html#orb.core.Cube.get_quadrant_dims">[docs]</a>    <span class="k">def</span> <span class="nf">get_quadrant_dims</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quad_number</span><span class="p">,</span> <span class="n">div_nb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">dimx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dimy</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the indices of a quadrant along x and y axes.</span>

<span class="sd">        :param quad_number: Quadrant number</span>

<span class="sd">        :param div_nb: (Optional) Use another number of divisions</span>
<span class="sd">          along x and y axes. (e.g. if div_nb = 3, the number of</span>
<span class="sd">          quadrant is 9 ; if div_nb = 4, the number of quadrant is 16)</span>

<span class="sd">        :param dimx: (Optional) Use another x axis dimension. Other</span>
<span class="sd">          than the axis dimension of the managed data cube</span>
<span class="sd">          </span>
<span class="sd">        :param dimy: (Optional) Use another y axis dimension. Other</span>
<span class="sd">          than the axis dimension of the managed data cube</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">div_nb</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
            <span class="n">div_nb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DIV_NB</span>
        <span class="n">quad_nb</span> <span class="o">=</span> <span class="n">div_nb</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">if</span> <span class="n">dimx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">dimx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimx</span>
        <span class="k">if</span> <span class="n">dimy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">dimy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimy</span>

        <span class="k">return</span> <span class="n">Tools</span><span class="o">.</span><span class="n">_get_quadrant_dims</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">quad_number</span><span class="p">,</span> <span class="n">dimx</span><span class="p">,</span> <span class="n">dimy</span><span class="p">,</span> <span class="n">div_nb</span><span class="p">)</span></div>

<div class="viewcode-block" id="Cube.get_calibration_laser_map"><a class="viewcode-back" href="../../orb.html#orb.core.Cube.get_calibration_laser_map">[docs]</a>    <span class="k">def</span> <span class="nf">get_calibration_laser_map</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Not implemented in Cube class but implemented in children</span>
<span class="sd">        classes.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span></div>
       
<div class="viewcode-block" id="Cube.export"><a class="viewcode-back" href="../../orb.html#orb.core.Cube.export">[docs]</a>    <span class="k">def</span> <span class="nf">export</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">export_path</span><span class="p">,</span> <span class="n">x_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">z_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
               <span class="n">force_hdf5</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">force_fits</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
               <span class="n">calibration_laser_map_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        
        <span class="sd">&quot;&quot;&quot;Export cube as one FITS/HDF5 file.</span>

<span class="sd">        :param export_path: Path of the exported FITS file</span>

<span class="sd">        :param x_range: (Optional) Tuple (x_min, x_max) (default</span>
<span class="sd">          None).</span>
<span class="sd">        </span>
<span class="sd">        :param y_range: (Optional) Tuple (y_min, y_max) (default</span>
<span class="sd">          None).</span>
<span class="sd">        </span>
<span class="sd">        :param z_range: (Optional) Tuple (z_min, z_max) (default</span>
<span class="sd">          None).</span>

<span class="sd">        :param header: (Optional) Header of the output file (default</span>
<span class="sd">          None).</span>

<span class="sd">        :param overwrite: (Optional) Overwrite output file (default</span>
<span class="sd">          False).</span>

<span class="sd">        :param force_hdf5: (Optional) If True, output is in HDF5</span>
<span class="sd">          format even if the input files are FITS files. If False it</span>
<span class="sd">          will be in the format of the input files (default False).</span>

<span class="sd">        :param force_fits: (Optional) If True, output is in FITS</span>
<span class="sd">          format. If False it will be in the format of the input files</span>
<span class="sd">          (default False).</span>

<span class="sd">        :param calibration_laser_map_path: (Optional) Path to a</span>
<span class="sd">          calibration laser map to append (default None).</span>

<span class="sd">        :param mask: (Optional) If a mask is given. Exported data is</span>
<span class="sd">          masked. A NaN in the mask flags for a masked pixel. Other</span>
<span class="sd">          values are not considered (default None).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">force_fits</span> <span class="ow">and</span> <span class="n">force_hdf5</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s1">&#39;force_fits and force_hdf5 cannot be both set to True&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">x_range</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">xmin</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">xmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimx</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">x_range</span><span class="p">)</span>
            <span class="n">xmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x_range</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="n">y_range</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ymin</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">ymax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimy</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ymin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">y_range</span><span class="p">)</span>
            <span class="n">ymax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">y_range</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">z_range</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">zmin</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">zmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimz</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">zmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">z_range</span><span class="p">)</span>
            <span class="n">zmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">z_range</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">is_hdf5_frames</span> <span class="ow">or</span> <span class="n">force_hdf5</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_hdf5_cube</span><span class="p">)</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="n">force_fits</span><span class="p">):</span> <span class="c1"># HDF5 export</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_msg</span><span class="p">(</span><span class="s1">&#39;Exporting cube to an HDF5 cube: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">export_path</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_quad_cube</span><span class="p">:</span>
                <span class="n">outcube</span> <span class="o">=</span> <span class="n">OutHDFCube</span><span class="p">(</span>
                    <span class="n">export_path</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">-</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">zmax</span> <span class="o">-</span> <span class="n">zmin</span><span class="p">),</span>
                    <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">,</span>
                    <span class="n">reset</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">outcube</span> <span class="o">=</span> <span class="n">OutHDFQuadCube</span><span class="p">(</span>
                    <span class="n">export_path</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">-</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">zmax</span> <span class="o">-</span> <span class="n">zmin</span><span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">QUAD_NB</span><span class="p">,</span>
                    <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">,</span>
                    <span class="n">reset</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">outcube</span><span class="o">.</span><span class="n">append_image_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_list</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">header</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cube_header</span><span class="p">()</span>
            <span class="n">outcube</span><span class="o">.</span><span class="n">append_header</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">calibration_laser_map_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">calibration_laser_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_calibration_laser_map</span><span class="p">()</span>
                <span class="n">calib_map_hdr</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">calibration_laser_map</span><span class="p">,</span> <span class="n">calib_map_hdr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_fits</span><span class="p">(</span>
                    <span class="n">calibration_laser_map_path</span><span class="p">,</span> <span class="n">return_header</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">calibration_laser_map</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimx</span><span class="p">):</span>
                    <span class="n">calibration_laser_map</span> <span class="o">=</span> <span class="n">orb</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">interpolate_map</span><span class="p">(</span>
                        <span class="n">calibration_laser_map</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimy</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">calibration_laser_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">outcube</span><span class="o">.</span><span class="n">append_calibration_laser_map</span><span class="p">(</span><span class="n">calibration_laser_map</span><span class="p">,</span>
                                                     <span class="n">header</span><span class="o">=</span><span class="n">calib_map_hdr</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_quad_cube</span><span class="p">:</span> <span class="c1"># frames export</span>
                <span class="n">progress</span> <span class="o">=</span> <span class="n">ProgressBar</span><span class="p">(</span><span class="n">zmax</span><span class="o">-</span><span class="n">zmin</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">iframe</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">zmin</span><span class="p">,</span> <span class="n">zmax</span><span class="p">):</span>
                    <span class="n">progress</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">iframe</span><span class="o">-</span><span class="n">zmin</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="s1">&#39;exporting frame </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iframe</span><span class="p">))</span>
                    <span class="n">idata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span>
                        <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span>
                        <span class="n">iframe</span><span class="p">,</span> <span class="n">iframe</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">idata</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">mask</span><span class="p">))]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                    
                    <span class="n">outcube</span><span class="o">.</span><span class="n">write_frame</span><span class="p">(</span>
                        <span class="n">iframe</span><span class="p">,</span>
                        <span class="n">data</span><span class="o">=</span><span class="n">idata</span><span class="p">,</span>
                        <span class="n">header</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_frame_header</span><span class="p">(</span><span class="n">iframe</span><span class="p">),</span>
                        <span class="n">force_float32</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">progress</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1"># quad export</span>
                
                <span class="n">progress</span> <span class="o">=</span> <span class="n">ProgressBar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">QUAD_NB</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">iquad</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">QUAD_NB</span><span class="p">):</span>
                    <span class="n">progress</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                        <span class="n">iquad</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="s1">&#39;exporting quad </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">iquad</span><span class="p">))</span>
                    
                    <span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_quadrant_dims</span><span class="p">(</span>
                        <span class="n">iquad</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimy</span><span class="p">,</span>
                        <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">quad_nb</span><span class="p">))))</span>
                    
                    <span class="n">data_quad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span>
                                              <span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">,</span>
                                              <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimz</span><span class="p">,</span>
                                              <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">data_quad</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">mask</span><span class="p">)),:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                    
                    <span class="c1"># write data</span>
                    <span class="n">outcube</span><span class="o">.</span><span class="n">write_quad</span><span class="p">(</span><span class="n">iquad</span><span class="p">,</span>
                                       <span class="n">data</span><span class="o">=</span><span class="n">data_quad</span><span class="p">,</span>
                                       <span class="n">force_float32</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    
                <span class="n">progress</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
                
            <span class="n">outcube</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">del</span> <span class="n">outcube</span>
                
        <span class="k">else</span><span class="p">:</span> <span class="c1"># FITS export</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_msg</span><span class="p">(</span><span class="s1">&#39;Exporting cube to a FITS cube: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">export_path</span><span class="p">))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_hdf5_cube</span><span class="p">:</span>
                
                <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">xmax</span><span class="o">-</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymax</span><span class="o">-</span><span class="n">ymin</span><span class="p">,</span> <span class="n">zmax</span><span class="o">-</span><span class="n">zmin</span><span class="p">),</span>
                                <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
                <span class="n">job_server</span><span class="p">,</span> <span class="n">ncpus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_pp_server</span><span class="p">()</span>
                <span class="n">progress</span> <span class="o">=</span> <span class="n">ProgressBar</span><span class="p">(</span><span class="n">zmax</span><span class="o">-</span><span class="n">zmin</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">iframe</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">zmax</span><span class="o">-</span><span class="n">zmin</span><span class="p">,</span> <span class="n">ncpus</span><span class="p">):</span>
                    <span class="n">progress</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                        <span class="n">iframe</span><span class="p">,</span>
                        <span class="n">info</span><span class="o">=</span><span class="s1">&#39;exporting data frame </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">iframe</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">iframe</span> <span class="o">+</span> <span class="n">ncpus</span> <span class="o">&gt;=</span> <span class="n">zmax</span> <span class="o">-</span> <span class="n">zmin</span><span class="p">:</span>
                        <span class="n">ncpus</span> <span class="o">=</span> <span class="n">zmax</span> <span class="o">-</span> <span class="n">zmin</span> <span class="o">-</span> <span class="n">iframe</span>

                    <span class="n">jobs</span> <span class="o">=</span> <span class="p">[(</span><span class="n">ijob</span><span class="p">,</span> <span class="n">job_server</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">,</span> 
                        <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">zmin</span> <span class="o">+</span> <span class="n">iframe</span> <span class="o">+</span><span class="n">ijob</span><span class="p">,</span>
                              <span class="n">zmin</span> <span class="o">+</span> <span class="n">iframe</span> <span class="o">+</span><span class="n">ijob</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>
                            <span class="k">for</span> <span class="n">ijob</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncpus</span><span class="p">)]</span>

                    <span class="k">for</span> <span class="n">ijob</span><span class="p">,</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">:</span>
                        <span class="n">data</span><span class="p">[:,:,</span><span class="n">iframe</span><span class="o">+</span><span class="n">ijob</span><span class="p">]</span> <span class="o">=</span> <span class="n">job</span><span class="p">()</span>

                <span class="n">progress</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>        
                <span class="bp">self</span><span class="o">.</span><span class="n">_close_pp_server</span><span class="p">(</span><span class="n">job_server</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">zmin</span><span class="p">,</span> <span class="n">zmax</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">mask</span><span class="p">)),:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                
            <span class="bp">self</span><span class="o">.</span><span class="n">write_fits</span><span class="p">(</span><span class="n">export_path</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">,</span>
                            <span class="n">fits_header</span><span class="o">=</span><span class="n">header</span><span class="p">)</span></div></div>


<span class="c1">##################################################</span>
<span class="c1">#### CLASS ProgressBar ###########################</span>
<span class="c1">##################################################</span>


<div class="viewcode-block" id="ProgressBar"><a class="viewcode-back" href="../../orb.html#orb.core.ProgressBar">[docs]</a><span class="k">class</span> <span class="nc">ProgressBar</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Display a simple progress bar in the terminal</span>

<span class="sd">    :param max_index: Index representing a 100% completed task.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">REFRESH_COUNT</span> <span class="o">=</span> <span class="mi">3</span><span class="n">L</span> <span class="c1"># number of steps used to calculate a remaining time</span>
    <span class="n">MAX_CARAC</span> <span class="o">=</span> <span class="mi">78</span> <span class="c1"># Maximum number of characters in a line</span>

    <span class="n">_start_time</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_max_index</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_bar_length</span> <span class="o">=</span> <span class="mf">10.</span>
    <span class="n">_max_index</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">_time_table</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">_index_table</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">_silent</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_index</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize ProgressBar class</span>

<span class="sd">        :param max_index: The index considered as 100%. If 0 print a</span>
<span class="sd">          &#39;please wait&#39; message.</span>

<span class="sd">        :param silent: (Optional) If True progress bar is not printed</span>
<span class="sd">          (default False).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_index</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">max_index</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_time_table</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">REFRESH_COUNT</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_index_table</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">REFRESH_COUNT</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_silent</span> <span class="o">=</span> <span class="n">silent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        
    <span class="k">def</span> <span class="nf">_erase_line</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Erase the progress bar&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_silent</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">Logger</span><span class="p">):</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">MAX_CARAC</span><span class="p">,</span> <span class="n">nolog</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">MAX_CARAC</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_time_str_convert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sec</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert a number of seconds in a human readable string</span>
<span class="sd">        </span>
<span class="sd">        :param sec: Number of seconds to convert</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">sec</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;</span><span class="si">{:.3f}</span><span class="s1"> s&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sec</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">sec</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;</span><span class="si">{:.2f}</span><span class="s1"> s&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sec</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">sec</span> <span class="o">&lt;</span> <span class="mf">60.</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;</span><span class="si">{:.1f}</span><span class="s1"> s&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sec</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">sec</span> <span class="o">&lt;</span> <span class="mf">3600.</span><span class="p">):</span>
            <span class="n">minutes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">sec</span><span class="o">/</span><span class="mf">60.</span><span class="p">))</span>
            <span class="n">seconds</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sec</span> <span class="o">-</span> <span class="p">(</span><span class="n">minutes</span> <span class="o">*</span> <span class="mf">60.</span><span class="p">))</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">minutes</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;m&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">seconds</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;s&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hours</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">sec</span><span class="o">/</span><span class="mf">3600.</span><span class="p">))</span>
            <span class="n">minutes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="n">sec</span> <span class="o">-</span> <span class="p">(</span><span class="n">hours</span><span class="o">*</span><span class="mf">3600.</span><span class="p">))</span><span class="o">/</span><span class="mf">60.</span><span class="p">))</span>
            <span class="n">seconds</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sec</span> <span class="o">-</span> <span class="p">(</span><span class="n">hours</span> <span class="o">*</span> <span class="mf">3600.</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">minutes</span> <span class="o">*</span> <span class="mf">60.</span><span class="p">))</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">hours</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;h&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">minutes</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;m&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">seconds</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;s&quot;</span>


<div class="viewcode-block" id="ProgressBar.update"><a class="viewcode-back" href="../../orb.html#orb.core.ProgressBar.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">remains</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nolog</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the progress bar.</span>

<span class="sd">        :param index: Index representing the progress of the</span>
<span class="sd">          process. Must be less than index_max.</span>
<span class="sd">          </span>
<span class="sd">        :param info: (Optional) Information to be displayed as</span>
<span class="sd">          comments (default &#39;&#39;).</span>
<span class="sd">          </span>
<span class="sd">        :param remains: (Optional) If True, remaining time is</span>
<span class="sd">          displayed (default True).</span>

<span class="sd">        :param nolog: (Optional) No logging of the printed text is</span>
<span class="sd">          made (default True).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_max_index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">TextColor</span><span class="o">.</span><span class="n">BLUE</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">_icount</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">REFRESH_COUNT</span> <span class="o">-</span> <span class="mi">1</span><span class="n">L</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_time_table</span><span class="p">[</span><span class="n">_icount</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time_table</span><span class="p">[</span><span class="n">_icount</span> <span class="o">+</span> <span class="mi">1</span><span class="n">L</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_index_table</span><span class="p">[</span><span class="n">_icount</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index_table</span><span class="p">[</span><span class="n">_icount</span> <span class="o">+</span> <span class="mi">1</span><span class="n">L</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_time_table</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_index_table</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">index</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_count</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">REFRESH_COUNT</span><span class="p">):</span>
                <span class="n">index_by_step</span> <span class="o">=</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_index_table</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index_table</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                 <span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">REFRESH_COUNT</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">time_to_end</span> <span class="o">=</span> <span class="p">(((</span><span class="bp">self</span><span class="o">.</span><span class="n">_time_table</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time_table</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                <span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">REFRESH_COUNT</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
                               <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_max_index</span> <span class="o">-</span> <span class="n">index</span><span class="p">)</span> <span class="o">/</span> <span class="n">index_by_step</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">time_to_end</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_index</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bar_length</span>
            <span class="n">line</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2"> [&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">pos</span><span class="p">))</span> <span class="o">+</span> 
                    <span class="s2">&quot; &quot;</span><span class="o">*</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bar_length</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">pos</span><span class="p">))</span> <span class="o">+</span> 
                    <span class="s2">&quot;] [</span><span class="si">%d%%</span><span class="s2">] [&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">pos</span><span class="o">*</span><span class="mf">100.</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">_bar_length</span><span class="p">)</span> <span class="o">+</span> 
                    <span class="nb">str</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">+</span><span class="s2">&quot;]&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">remains</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot; [remains: &quot;</span> <span class="o">+</span> 
                         <span class="bp">self</span><span class="o">.</span><span class="n">_time_str_convert</span><span class="p">(</span><span class="n">time_to_end</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;]&quot;</span><span class="p">)</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">TextColor</span><span class="o">.</span><span class="n">GREEN</span>
            <span class="n">line</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2"> [please wait] [&quot;</span> <span class="o">+</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">+</span><span class="s2">&quot;]&quot;</span><span class="p">)</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">_erase_line</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">MAX_CARAC</span><span class="p">):</span>
            <span class="n">rem_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">MAX_CARAC</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="o">-</span><span class="n">rem_len</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_silent</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">Logger</span><span class="p">):</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">nolog</span><span class="o">=</span><span class="n">nolog</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div>

<div class="viewcode-block" id="ProgressBar.end"><a class="viewcode-back" href="../../orb.html#orb.core.ProgressBar.end">[docs]</a>    <span class="k">def</span> <span class="nf">end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;End the progress bar and display the total time needed to</span>
<span class="sd">        complete the process.</span>

<span class="sd">        :param silent: If True remove the progress bar from the</span>
<span class="sd">          screen. Further diplayed text will be displayed above the</span>
<span class="sd">          progress bar.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_erase_line</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_max_index</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="s2">&quot;completed in &quot;</span> <span class="o">+</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_time_str_convert</span><span class="p">(</span>
                            <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_time</span><span class="p">),</span>
                        <span class="n">remains</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nolog</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_silent</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">Logger</span><span class="p">):</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">nolog</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_erase_line</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_max_index</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="s2">&quot;completed in &quot;</span> <span class="o">+</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_time_str_convert</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_time</span><span class="p">),</span>
                        <span class="n">remains</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_silent</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div></div>
                




<span class="c1">##################################################</span>
<span class="c1">#### CLASS Indexer ###############################</span>
<span class="c1">##################################################</span>

<div class="viewcode-block" id="Indexer"><a class="viewcode-back" href="../../orb.html#orb.core.Indexer">[docs]</a><span class="k">class</span> <span class="nc">Indexer</span><span class="p">(</span><span class="n">Tools</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Manage locations of created files.</span>

<span class="sd">    All files locations are stored in a text-like file: the index</span>
<span class="sd">    file. This file is the &#39;real&#39; counterpart of the index (which is</span>
<span class="sd">    &#39;virtual&#39; until :py:meth:`core.Indexer.update_index` is</span>
<span class="sd">    called). This method is called each time</span>
<span class="sd">    :py:meth:`core.Indexer.__setitem__` is called.</span>

<span class="sd">    This class can be accessed like a dictionary.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">file_groups</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cam1&#39;</span><span class="p">,</span> <span class="s1">&#39;cam2&#39;</span><span class="p">,</span> <span class="s1">&#39;merged&#39;</span><span class="p">]</span>
    <span class="n">file_group_indexes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">index</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">file_group</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Implement the evaluation of self[file_key]</span>

<span class="sd">        :param file_key: Key name of the file to be located</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">file_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">file_key</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_warning</span><span class="p">(</span><span class="s2">&quot;File key &#39;</span><span class="si">%s</span><span class="s2">&#39; does not exist&quot;</span><span class="o">%</span><span class="n">file_key</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
            
    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_key</span><span class="p">,</span> <span class="n">file_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Implement the evaluation of self[file_key] = file_path</span>

<span class="sd">        :param file_key: Key name of the file</span>

<span class="sd">        :param file_path: Path to the file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_group</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">file_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_group</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">file_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">file_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_index</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Implement the evaluation of str(self)&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_index_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return path of the index&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_path_hdr</span> <span class="o">+</span> <span class="s1">&#39;file_index&#39;</span>

    <span class="k">def</span> <span class="nf">_index2group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert an integer (0, 1 or 2) to a group of files</span>
<span class="sd">        (&#39;merged&#39;, &#39;cam1&#39; or &#39;cam2&#39;).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;merged&#39;</span>
        <span class="k">elif</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;cam1&#39;</span>
        <span class="k">elif</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;cam2&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span>
                <span class="s1">&#39;Group index must be in </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_group_indexes</span><span class="p">)))</span>

<div class="viewcode-block" id="Indexer.get_path"><a class="viewcode-back" href="../../orb.html#orb.core.Indexer.get_path">[docs]</a>    <span class="k">def</span> <span class="nf">get_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_key</span><span class="p">,</span> <span class="n">file_group</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">err</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the path of a file recorded in the index.</span>

<span class="sd">        Equivalent to self[file_key] if the option file_group is not used.</span>

<span class="sd">        :param file_key: Key name of the file to be located</span>

<span class="sd">        :param file_group: (Optional) Add group prefix to the key</span>
<span class="sd">          name. File group must be &#39;cam1&#39;, &#39;cam2&#39;, &#39;merged&#39; or their</span>
<span class="sd">          integer equivalent 1, 2, 0. File group can also be set to</span>
<span class="sd">          None (default None).</span>

<span class="sd">        :param err: (Optional) Print an error instead of a warning if</span>
<span class="sd">          the file is not indexed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">file_group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_groups</span><span class="p">):</span>
            <span class="n">file_key</span> <span class="o">=</span> <span class="n">file_group</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">file_key</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">file_group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_group_indexes</span><span class="p">):</span>
            <span class="n">file_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index2group</span><span class="p">(</span><span class="n">file_group</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">file_key</span>
        <span class="k">elif</span> <span class="n">file_group</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s1">&#39;Bad file group. File group can be in </span><span class="si">%s</span><span class="s1">, in </span><span class="si">%s</span><span class="s1"> or None&#39;</span><span class="o">%</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_groups</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_group_indexes</span><span class="p">)))</span>

        <span class="k">if</span> <span class="n">file_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">file_key</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">err</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s2">&quot;File key &#39;</span><span class="si">%s</span><span class="s2">&#39; does not exist&quot;</span><span class="o">%</span><span class="n">file_key</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print_warning</span><span class="p">(</span><span class="s2">&quot;File key &#39;</span><span class="si">%s</span><span class="s2">&#39; does not exist&quot;</span><span class="o">%</span><span class="n">file_key</span><span class="p">)</span></div>

<div class="viewcode-block" id="Indexer.set_file_group"><a class="viewcode-back" href="../../orb.html#orb.core.Indexer.set_file_group">[docs]</a>    <span class="k">def</span> <span class="nf">set_file_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_group</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the group of the next files to be recorded. All given</span>
<span class="sd">        file keys will be prefixed by the file group.</span>

<span class="sd">        :param file_group: File group must be &#39;cam1&#39;, &#39;cam2&#39;, &#39;merged&#39;</span>
<span class="sd">          or their integer equivalent 1, 2, 0. File group can also be</span>
<span class="sd">          set to None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">file_group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_group_indexes</span><span class="p">):</span>
            <span class="n">file_group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index2group</span><span class="p">(</span><span class="n">file_group</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="p">(</span><span class="n">file_group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_groups</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">file_group</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">file_group</span> <span class="o">=</span> <span class="n">file_group</span>
            
        <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span>
            <span class="s1">&#39;Bad file group name. Must be in </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_groups</span><span class="p">))</span></div>

<div class="viewcode-block" id="Indexer.load_index"><a class="viewcode-back" href="../../orb.html#orb.core.Indexer.load_index">[docs]</a>    <span class="k">def</span> <span class="nf">load_index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load index file and rebuild index of already located files&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_index_path</span><span class="p">()):</span>
            <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_index_path</span><span class="p">(),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">iline</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">iline</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">iline</span> <span class="o">=</span> <span class="n">iline</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">iline</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">iline</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="Indexer.update_index"><a class="viewcode-back" href="../../orb.html#orb.core.Indexer.update_index">[docs]</a>    <span class="k">def</span> <span class="nf">update_index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update index files with data in the virtual index&quot;&quot;&quot;</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_index_path</span><span class="p">(),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ikey</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">ikey</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">ikey</span><span class="p">]))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div></div>
        
        

<span class="c1">#################################################</span>
<span class="c1">#### CLASS Lines ################################</span>
<span class="c1">#################################################</span>
<div class="viewcode-block" id="Lines"><a class="viewcode-back" href="../../orb.html#orb.core.Lines">[docs]</a><span class="k">class</span> <span class="nc">Lines</span><span class="p">(</span><span class="n">Tools</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class manages emission lines names and wavelengths.</span>
<span class="sd">    </span>
<span class="sd">    Spectral lines rest wavelength::</span>
<span class="sd">    </span>
<span class="sd">      ============ ======== =======</span>
<span class="sd">        Em. Line    Vaccum    Air</span>
<span class="sd">      ============ ======== =======</span>
<span class="sd">      [OII]3726    372.709  372.603</span>
<span class="sd">      [OII]3729    372.988  372.882</span>
<span class="sd">      Hepsilon     397.119  397.007</span>
<span class="sd">      Hdelta       410.292  410.176</span>
<span class="sd">      Hgamma       434.169  434.047</span>
<span class="sd">      [OIII]4363   436.444  436.321</span>
<span class="sd">      Hbeta        486.269  486.133</span>
<span class="sd">      [OIII]4959   496.030  495.892</span>
<span class="sd">      [OIII]5007   500.824  500.684</span>
<span class="sd">      [NII]6548    654.984  654.803</span>
<span class="sd">      Halpha       656.461  656.280</span>
<span class="sd">      [NII]6583    658.523  658.341</span>
<span class="sd">      [SII]6716    671.832  671.647</span>
<span class="sd">      [SII]6731    673.271  673.085</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sky_lines_file_name</span> <span class="o">=</span> <span class="s1">&#39;sky_lines.orb&#39;</span>
    <span class="sd">&quot;&quot;&quot;Name of the sky lines data file.&quot;&quot;&quot;</span>

    <span class="n">air_sky_lines_nm</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;Air sky lines wavelength&quot;&quot;&quot;</span>


    <span class="n">vac_lines_nm</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;[OII]3726&#39;</span><span class="p">:</span><span class="mf">372.709</span><span class="p">,</span>
                    <span class="s1">&#39;[OII]3729&#39;</span><span class="p">:</span><span class="mf">372.988</span><span class="p">,</span>
                    <span class="s1">&#39;Hepsilon&#39;</span><span class="p">:</span><span class="mf">397.119</span><span class="p">,</span>
                    <span class="s1">&#39;Hdelta&#39;</span><span class="p">:</span><span class="mf">410.292</span><span class="p">,</span>
                    <span class="s1">&#39;Hgamma&#39;</span><span class="p">:</span><span class="mf">434.169</span><span class="p">,</span>
                    <span class="s1">&#39;[OIII]4363&#39;</span><span class="p">:</span><span class="mf">436.444</span><span class="p">,</span>
                    <span class="s1">&#39;Hbeta&#39;</span><span class="p">:</span><span class="mf">486.269</span><span class="p">,</span>
                    <span class="s1">&#39;[OIII]4959&#39;</span><span class="p">:</span><span class="mf">496.030</span><span class="p">,</span>
                    <span class="s1">&#39;[OIII]5007&#39;</span><span class="p">:</span><span class="mf">500.824</span><span class="p">,</span>
                    <span class="s1">&#39;[NII]6548&#39;</span><span class="p">:</span><span class="mf">654.984</span><span class="p">,</span>
                    <span class="s1">&#39;Halpha&#39;</span><span class="p">:</span><span class="mf">656.461</span><span class="p">,</span>
                    <span class="s1">&#39;[NII]6583&#39;</span><span class="p">:</span><span class="mf">658.523</span><span class="p">,</span>
                    <span class="s1">&#39;[SII]6716&#39;</span><span class="p">:</span><span class="mf">671.832</span><span class="p">,</span>
                    <span class="s1">&#39;[SII]6731&#39;</span><span class="p">:</span><span class="mf">673.271</span><span class="p">}</span>
    <span class="sd">&quot;&quot;&quot;Vacuum emission lines wavelength&quot;&quot;&quot;</span>
    
    <span class="n">air_lines_nm</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;[OII]3726&#39;</span><span class="p">:</span><span class="mf">372.603</span><span class="p">,</span>
                    <span class="s1">&#39;[OII]3729&#39;</span><span class="p">:</span><span class="mf">372.882</span><span class="p">,</span>
                    <span class="s1">&#39;[NeIII]3869&#39;</span><span class="p">:</span><span class="mf">386.875</span><span class="p">,</span>
                    <span class="s1">&#39;Hepsilon&#39;</span><span class="p">:</span><span class="mf">397.007</span><span class="p">,</span>
                    <span class="s1">&#39;Hdelta&#39;</span><span class="p">:</span><span class="mf">410.176</span><span class="p">,</span>
                    <span class="s1">&#39;Hgamma&#39;</span><span class="p">:</span><span class="mf">434.047</span><span class="p">,</span>
                    <span class="s1">&#39;[OIII]4363&#39;</span><span class="p">:</span><span class="mf">436.321</span><span class="p">,</span>
                    <span class="s1">&#39;Hbeta&#39;</span><span class="p">:</span><span class="mf">486.133</span><span class="p">,</span>
                    <span class="s1">&#39;[OIII]4959&#39;</span><span class="p">:</span><span class="mf">495.891</span><span class="p">,</span>
                    <span class="s1">&#39;[OIII]5007&#39;</span><span class="p">:</span><span class="mf">500.684</span><span class="p">,</span>
                    <span class="s1">&#39;HeI5876&#39;</span><span class="p">:</span><span class="mf">587.567</span><span class="p">,</span>
                    <span class="s1">&#39;[OI]6300&#39;</span><span class="p">:</span><span class="mf">630.030</span><span class="p">,</span>
                    <span class="s1">&#39;[SIII]6312&#39;</span><span class="p">:</span><span class="mf">631.21</span><span class="p">,</span>
                    <span class="s1">&#39;[NII]6548&#39;</span><span class="p">:</span><span class="mf">654.803</span><span class="p">,</span>
                    <span class="s1">&#39;Halpha&#39;</span><span class="p">:</span><span class="mf">656.280</span><span class="p">,</span>
                    <span class="s1">&#39;[NII]6583&#39;</span><span class="p">:</span><span class="mf">658.341</span><span class="p">,</span>
                    <span class="s1">&#39;HeI6678&#39;</span><span class="p">:</span><span class="mf">667.815</span><span class="p">,</span>
                    <span class="s1">&#39;[SII]6716&#39;</span><span class="p">:</span><span class="mf">671.647</span><span class="p">,</span>
                    <span class="s1">&#39;[SII]6731&#39;</span><span class="p">:</span><span class="mf">673.085</span><span class="p">,</span>
                    <span class="s1">&#39;HeI7065&#39;</span><span class="p">:</span><span class="mf">706.528</span><span class="p">,</span>
                    <span class="s1">&#39;[ArIII]7136&#39;</span><span class="p">:</span><span class="mf">713.578</span><span class="p">,</span>
                    <span class="s1">&#39;[OII]7120&#39;</span><span class="p">:</span><span class="mf">731.965</span><span class="p">,</span>
                    <span class="s1">&#39;[OII]7130&#39;</span><span class="p">:</span><span class="mf">733.016</span><span class="p">,</span>
                    <span class="s1">&#39;[ArIII]7751&#39;</span><span class="p">:</span><span class="mf">775.112</span><span class="p">}</span>
    <span class="sd">&quot;&quot;&quot;Air emission lines wavelength&quot;&quot;&quot;</span>

    <span class="n">vac_lines_name</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">air_lines_name</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Lines class constructor.</span>

<span class="sd">        :param kwargs: Kwargs are :meth:`core.Tools` properties.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Tools</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># create corresponding inverted dicts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">air_lines_name</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">ikey</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">air_lines_nm</span><span class="o">.</span><span class="n">iterkeys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">air_lines_name</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">air_lines_nm</span><span class="p">[</span><span class="n">ikey</span><span class="p">])]</span> <span class="o">=</span> <span class="n">ikey</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">vac_lines_name</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">ikey</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vac_lines_nm</span><span class="o">.</span><span class="n">iterkeys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vac_lines_name</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vac_lines_nm</span><span class="p">[</span><span class="n">ikey</span><span class="p">])]</span> <span class="o">=</span> <span class="n">ikey</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">_read_sky_file</span><span class="p">()</span>
        

    <span class="k">def</span> <span class="nf">_read_sky_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return sky file (sky_lines.orb) as a dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sky_lines_file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_orb_data_file_path</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sky_lines_file_name</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span><span class="n">sky_lines_file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">air_sky_lines_nm</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;#&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">air_sky_lines_nm</span><span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mf">10.</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s1">&#39;Error during parsing of &#39;</span><span class="o">%</span><span class="n">sky_lines_file_path</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<div class="viewcode-block" id="Lines.get_sky_lines"><a class="viewcode-back" href="../../orb.html#orb.core.Lines.get_sky_lines">[docs]</a>    <span class="k">def</span> <span class="nf">get_sky_lines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nm_min</span><span class="p">,</span> <span class="n">nm_max</span><span class="p">,</span> <span class="n">delta_nm</span><span class="p">,</span> <span class="n">line_nb</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                      <span class="n">get_names</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return sky lines in a range of optical wavelength.</span>

<span class="sd">        :param nm_min: min Wavelength of the lines in nm</span>
<span class="sd">        </span>
<span class="sd">        :param nm_max: max Wavelength of the lines in nm</span>

<span class="sd">        :param delta_nm: Wavelength resolution in nm as the minimum</span>
<span class="sd">          wavelength interval of the spectrum. Lines comprises in half</span>
<span class="sd">          of this interval are merged.</span>
<span class="sd">        </span>
<span class="sd">        :param line_nb: (Optional) Number of the most intense lines to</span>
<span class="sd">          retrieve. If 0 all lines are given (default 0).</span>

<span class="sd">        :param get_name: (Optional) If True return lines name also.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="n">merged_lines</span><span class="p">):</span>
            
            <span class="n">merged_lines_nm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">merged_lines</span><span class="p">])</span>
           
            
            <span class="n">merged_lines_nm</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">merged_lines_nm</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
                                      <span class="o">*</span> <span class="n">merged_lines_nm</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
                               <span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">merged_lines_nm</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]),</span>
                               <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">merged_lines_nm</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]))</span>

            <span class="n">merged_lines_name</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">merged_lines</span><span class="p">]</span>
            <span class="n">temp_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">merged_lines_name</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;MEAN&#39;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">temp_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="n">merged_lines_name</span> <span class="o">=</span> <span class="s1">&#39;MEAN[&#39;</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_list</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;]&#39;</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">merged_lines_name</span><span class="p">,</span> <span class="n">merged_lines_nm</span><span class="p">)</span>

        <span class="n">lines</span> <span class="o">=</span> <span class="p">[(</span><span class="n">line_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">air_sky_lines_nm</span><span class="p">[</span><span class="n">line_name</span><span class="p">])</span>
                 <span class="k">for</span> <span class="n">line_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">air_sky_lines_nm</span>
                 <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">air_sky_lines_nm</span><span class="p">[</span><span class="n">line_name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">nm_min</span>
                     <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">air_sky_lines_nm</span><span class="p">[</span><span class="n">line_name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">nm_max</span><span class="p">)]</span>
        
        <span class="n">lines</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    
        <span class="n">merged_lines</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">final_lines</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        
        <span class="k">for</span> <span class="n">iline</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">iline</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">iline</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">lines</span><span class="p">[</span><span class="n">iline</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                    <span class="o">&lt;</span> <span class="n">delta_nm</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">):</span>
                    <span class="n">merged_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">iline</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">merged_lines</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">merged_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">iline</span><span class="p">])</span>
                        <span class="n">final_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">merge</span><span class="p">(</span><span class="n">merged_lines</span><span class="p">))</span>
                        <span class="n">merged_lines</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">final_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">iline</span><span class="p">])</span>
                        
        <span class="c1"># correct a border effect if the last lines of the list are to</span>
        <span class="c1"># be merged</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">merged_lines</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">merged_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">iline</span><span class="p">])</span>
            <span class="n">final_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">merge</span><span class="p">(</span><span class="n">merged_lines</span><span class="p">))</span>

        <span class="n">lines</span> <span class="o">=</span> <span class="n">final_lines</span>
        
        <span class="c1"># get only the most intense lines</span>
        <span class="k">if</span> <span class="n">line_nb</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[:</span><span class="n">line_nb</span><span class="p">]</span>

        <span class="n">lines_nm</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">])[:,</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">lines_name</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">]</span>
        
        <span class="c1"># add balmer lines</span>
        <span class="n">balmer_lines</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Halpha&#39;</span><span class="p">,</span> <span class="s1">&#39;Hbeta&#39;</span><span class="p">,</span> <span class="s1">&#39;Hgamma&#39;</span><span class="p">,</span> <span class="s1">&#39;Hdelta&#39;</span><span class="p">,</span> <span class="s1">&#39;Hepsilon&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">iline</span> <span class="ow">in</span> <span class="n">balmer_lines</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">air_lines_nm</span><span class="p">[</span><span class="n">iline</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">nm_min</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">air_lines_nm</span><span class="p">[</span><span class="n">iline</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">nm_max</span><span class="p">):</span>
                <span class="n">lines_nm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">air_lines_nm</span><span class="p">[</span><span class="n">iline</span><span class="p">])</span>
                <span class="n">lines_name</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iline</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">get_names</span><span class="p">:</span>
            <span class="n">lines_nm</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">lines_nm</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="p">[(</span><span class="n">lines_name</span><span class="p">[</span><span class="n">iline</span><span class="p">],</span> <span class="n">lines_nm</span><span class="p">[</span><span class="n">iline</span><span class="p">])</span>
                     <span class="k">for</span> <span class="n">iline</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lines_nm</span><span class="p">))]</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">lines_nm</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">]</span>
            <span class="n">lines_name</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">lines_nm</span><span class="p">,</span> <span class="n">lines_name</span></div>
        

<div class="viewcode-block" id="Lines.get_line_nm"><a class="viewcode-back" href="../../orb.html#orb.core.Lines.get_line_nm">[docs]</a>    <span class="k">def</span> <span class="nf">get_line_nm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines_name</span><span class="p">,</span> <span class="n">air</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">round_ang</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the wavelength of a line or a list of lines</span>

<span class="sd">        :param lines_name: List of line names</span>

<span class="sd">        :param air: (Optional) If True, air rest wavelength are</span>
<span class="sd">          returned. If False, vacuum rest wavelength are</span>
<span class="sd">          returned (default True).</span>

<span class="sd">        :param round_ang: (Optional) If True return the rounded</span>
<span class="sd">          wavelength of the line in angstrom (default False)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lines_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">lines_name</span> <span class="o">=</span> <span class="p">[</span><span class="n">lines_name</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">air</span><span class="p">:</span>
            <span class="n">lines_nm</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">air_lines_nm</span><span class="p">[</span><span class="n">line_name</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">line_name</span> <span class="ow">in</span> <span class="n">lines_name</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lines_nm</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">vac_lines_nm</span><span class="p">[</span><span class="n">line_name</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">line_name</span> <span class="ow">in</span> <span class="n">lines_name</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines_nm</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">lines_nm</span> <span class="o">=</span> <span class="n">lines_nm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            
        <span class="k">if</span> <span class="n">round_ang</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">round_nm2ang</span><span class="p">(</span><span class="n">lines_nm</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">lines_nm</span></div>

<div class="viewcode-block" id="Lines.get_line_cm1"><a class="viewcode-back" href="../../orb.html#orb.core.Lines.get_line_cm1">[docs]</a>    <span class="k">def</span> <span class="nf">get_line_cm1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines_name</span><span class="p">,</span> <span class="n">air</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">round_ang</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the wavenumber of a line or a list of lines</span>

<span class="sd">        :param lines_name: List of line names</span>

<span class="sd">        :param air: (Optional) If True, air rest wavenumber are</span>
<span class="sd">          returned. If False, vacuum rest wavenumber are</span>
<span class="sd">          returned (default True).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">utils</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">nm2cm1</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_line_nm</span><span class="p">(</span><span class="n">lines_name</span><span class="p">,</span> <span class="n">air</span><span class="o">=</span><span class="n">air</span><span class="p">))</span></div>

<div class="viewcode-block" id="Lines.get_line_name"><a class="viewcode-back" href="../../orb.html#orb.core.Lines.get_line_name">[docs]</a>    <span class="k">def</span> <span class="nf">get_line_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">air</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the name of a line or a list of lines given their</span>
<span class="sd">        wavelength.</span>

<span class="sd">        :param lines: List of lines wavelength</span>

<span class="sd">        :param air: (Optional) If True, rest wavelength is considered</span>
<span class="sd">          to be in air. If False it is considered to be in</span>
<span class="sd">          vacuum (default True).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float128</span><span class="p">)):</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">lines</span><span class="p">]</span>

        <span class="n">names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">air</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">iline</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">iline</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">air_lines_name</span><span class="p">:</span>
                    <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">air_lines_name</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">iline</span><span class="p">)])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;None&#39;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">iline</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">iline</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vac_lines_name</span><span class="p">:</span>
                    <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vac_lines_name</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">iline</span><span class="p">)])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;None&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="k">return</span> <span class="n">names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="n">names</span></div>
    
<div class="viewcode-block" id="Lines.round_nm2ang"><a class="viewcode-back" href="../../orb.html#orb.core.Lines.round_nm2ang">[docs]</a>    <span class="k">def</span> <span class="nf">round_nm2ang</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nm</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert a wavelength in nm into a rounded value in angstrom</span>

<span class="sd">        :param nm: Line wavelength in nm</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nm</span><span class="p">)</span> <span class="o">*</span> <span class="mf">10.</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span></div></div>
    
<span class="c1">#################################################</span>
<span class="c1">#### CLASS OptionFile ###########################</span>
<span class="c1">#################################################</span>
        
<div class="viewcode-block" id="OptionFile"><a class="viewcode-back" href="../../orb.html#orb.core.OptionFile">[docs]</a><span class="k">class</span> <span class="nc">OptionFile</span><span class="p">(</span><span class="n">Tools</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Manage an option file.</span>

<span class="sd">    An option file is a file containing keywords and values and</span>
<span class="sd">    optionally some comments indicated by &#39;#&#39;, e.g.::</span>
<span class="sd">    </span>
<span class="sd">      ## ORBS configuration file </span>
<span class="sd">      # Author: Thomas Martin &lt;thomas.martin.1@ulaval.ca&gt;</span>
<span class="sd">      # File : config.orb</span>
<span class="sd">      ## Observatory</span>
<span class="sd">      OBSERVATORY_NAME OMM # Observatory name</span>
<span class="sd">      TELESCOPE_NAME OMM # Telescope name</span>
<span class="sd">      INSTRUMENT_NAME SpIOMM # Instrument name</span>
<span class="sd">      OBS_LAT 45.455000 # Observatory latitude</span>
<span class="sd">      OBS_LON -71.153000 # Observatory longitude</span>

<span class="sd">    .. note:: The special keyword **INCLUDE** can be used to give the</span>
<span class="sd">      path to another option file that must be included. Note that</span>
<span class="sd">      existing keywords will be overriden so the INCLUDE keyword is</span>
<span class="sd">      best placed at the very beginning of the option file.</span>

<span class="sd">    .. note:: Repeated keywords override themselves. Only the</span>
<span class="sd">      protected keywords (&#39;REG&#39;, &#39;TUNE&#39;) are all kept.</span>

<span class="sd">    .. note:: The first line starting with &#39;##&#39; is considered as a header</span>
<span class="sd">      of the file and can be used to give a description of the file.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">input_file_path</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">option_file</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># the option file object</span>
    <span class="n">options</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># the core list containing the parsed file</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># a core.Lines instance</span>

    <span class="c1"># special keywords that can be used mulitple times without being</span>
    <span class="c1"># overriden.</span>
    <span class="n">protected_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;REG&#39;</span><span class="p">,</span> <span class="s1">&#39;TUNE&#39;</span><span class="p">]</span> 

    <span class="n">header_line</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">option_file_path</span><span class="p">,</span> <span class="n">protected_keys</span><span class="o">=</span><span class="p">[],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize class</span>

<span class="sd">        :param option_file_path: Path to the option file</span>

<span class="sd">        :param protected_keys: (Optional) Add other protected keys to</span>
<span class="sd">          the basic ones (default []).</span>

<span class="sd">        :param kwargs: Kwargs are :meth:`core.Tools` properties.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Tools</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        
        <span class="c1"># append new protected keys</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">protected_keys</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">protected_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> 
        
        <span class="bp">self</span><span class="o">.</span><span class="n">option_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span><span class="n">option_file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_file_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">option_file_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="n">Lines</span><span class="p">(</span><span class="n">config_file_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config_file_name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">option_file</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;##&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">header_line</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">header_line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    
                <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;#&#39;</span><span class="p">:</span> <span class="c1"># check if line is commented</span>
                    <span class="k">if</span> <span class="s1">&#39;#&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)]</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">key</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                        <span class="c1"># manage INCLUDE keyword</span>
                        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;INCLUDE&#39;</span><span class="p">:</span>
                            <span class="n">included_optfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                                <span class="o">+</span> <span class="n">included_optfile</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

                        <span class="c1"># manage protected keys</span>
                        <span class="n">final_key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">final_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">protected_keys</span><span class="p">:</span>
                            <span class="n">index</span> <span class="o">=</span> <span class="mi">2</span>
                            <span class="k">while</span> <span class="n">final_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">:</span>
                                <span class="n">final_key</span> <span class="o">=</span> <span class="n">key</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
                                <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>

                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="n">final_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="n">final_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                        
        <span class="bp">self</span><span class="o">.</span><span class="n">option_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
                        
    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Implement the evaluation of self[key].&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
        
<div class="viewcode-block" id="OptionFile.iteritems"><a class="viewcode-back" href="../../orb.html#orb.core.OptionFile.iteritems">[docs]</a>    <span class="k">def</span> <span class="nf">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Implement iteritems function often used with iterable objects&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()</span></div>

<div class="viewcode-block" id="OptionFile.get"><a class="viewcode-back" href="../../orb.html#orb.core.OptionFile.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">cast</span><span class="o">=</span><span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the value associated to a keyword.</span>
<span class="sd">        </span>
<span class="sd">        :param key: keyword</span>
<span class="sd">        </span>
<span class="sd">        :param cast: (Optional) Cast function for the returned value</span>
<span class="sd">          (default str).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">param</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">param</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cast</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">param</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="OptionFile.get_regions_parameters"><a class="viewcode-back" href="../../orb.html#orb.core.OptionFile.get_regions_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">get_regions_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get regions parameters.</span>

<span class="sd">        Defined for the special keyword &#39;REG&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;REG&#39;</span><span class="p">)}</span></div>

<div class="viewcode-block" id="OptionFile.get_lines"><a class="viewcode-back" href="../../orb.html#orb.core.OptionFile.get_lines">[docs]</a>    <span class="k">def</span> <span class="nf">get_lines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nm_min</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nm_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">delta_nm</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get lines parameters.</span>

<span class="sd">        Defined for the special keyword &#39;LINES&#39;.</span>

<span class="sd">        All optional keywords are only used if the keyword SKY is</span>
<span class="sd">        used.</span>

<span class="sd">        :param nm_min: (Optional) min wavelength of the lines in nm</span>
<span class="sd">          (default None).</span>
<span class="sd">        </span>
<span class="sd">        :param nm_max: (Optional) max wavelength of the lines in nm</span>
<span class="sd">          (default None).</span>

<span class="sd">        :param delta_nm: (Optional) wavelength resolution in nm as the minimum</span>
<span class="sd">          wavelength interval of the spectrum. Lines comprises in half</span>
<span class="sd">          of this interval are merged (default None).</span>
<span class="sd">    </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lines_names</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;LINES&#39;</span><span class="p">]</span>
        <span class="n">lines_nm</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines_names</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">lines_names</span> <span class="o">=</span> <span class="n">lines_names</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">iline</span> <span class="ow">in</span> <span class="n">lines_names</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">lines_nm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">iline</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">iline</span> <span class="o">==</span> <span class="s1">&#39;SKY&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">nm_min</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">nm_max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                            <span class="ow">and</span> <span class="n">delta_nm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                            <span class="n">lines_nm</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="o">.</span><span class="n">get_sky_lines</span><span class="p">(</span>
                                <span class="n">nm_min</span><span class="p">,</span> <span class="n">nm_max</span><span class="p">,</span> <span class="n">delta_nm</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s1">&#39;Keyword SKY used but nm_min, nm_max or delta_nm parameter not set&#39;</span><span class="p">)</span>
                            
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">lines_nm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="o">.</span><span class="n">get_line_nm</span><span class="p">(</span><span class="n">iline</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="k">return</span> <span class="n">lines_nm</span></div>
            
<div class="viewcode-block" id="OptionFile.get_filter_edges"><a class="viewcode-back" href="../../orb.html#orb.core.OptionFile.get_filter_edges">[docs]</a>    <span class="k">def</span> <span class="nf">get_filter_edges</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get filter eges parameters.</span>

<span class="sd">        Defined for the special keyword &#39;FILTER_EDGES&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">filter_edges</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;FILTER_EDGES&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">filter_edges</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filter_edges</span> <span class="o">=</span> <span class="n">filter_edges</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filter_edges</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">filter_edges</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span>
                    <span class="s1">&#39;Bad filter edges definition: check option file&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="OptionFile.get_fringes"><a class="viewcode-back" href="../../orb.html#orb.core.OptionFile.get_fringes">[docs]</a>    <span class="k">def</span> <span class="nf">get_fringes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get fringes</span>

<span class="sd">        Defined for the special keyword &#39;FRINGES&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fringes</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;FRINGES&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">fringes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fringes</span> <span class="o">=</span> <span class="n">fringes</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">ifringe</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">ifringe</span> <span class="ow">in</span> <span class="n">fringes</span><span class="p">],</span>
                    <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s2">&quot;Fringes badly defined. Use no whitespace, each fringe must be separated by a &#39;:&#39;. Fringes parameters must be given in the order [frequency, amplitude] separated by a &#39;,&#39; (e.g. 150.0,0.04:167.45,0.095 gives 2 fringes of parameters [150.0, 0.04] and [167.45, 0.095]).&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="OptionFile.get_bad_frames"><a class="viewcode-back" href="../../orb.html#orb.core.OptionFile.get_bad_frames">[docs]</a>    <span class="k">def</span> <span class="nf">get_bad_frames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get bad frames.</span>

<span class="sd">        Defined for the special keyword &#39;BAD_FRAMES&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;BAD_FRAMES&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bad_frames</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;BAD_FRAMES&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
        
        <span class="n">bad_frames_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ibad</span> <span class="ow">in</span> <span class="n">bad_frames</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ibad</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="n">min_bad</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ibad</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">max_bad</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ibad</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">min_bad</span><span class="p">,</span> <span class="n">max_bad</span><span class="p">):</span>
                        <span class="n">bad_frames_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">bad_frames_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">ibad</span><span class="p">))</span>   
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bad_frames_list</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s2">&quot;Bad frames badly defined. Use no whitespace, bad frames must be comma separated. the sign &#39;:&#39; can be used to define a range of bad frames, commas and &#39;:&#39; can be mixed. Frame index must be integer.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="OptionFile.get_tuning_parameters"><a class="viewcode-back" href="../../orb.html#orb.core.OptionFile.get_tuning_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">get_tuning_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the list of tuning parameters.</span>

<span class="sd">        Defined for the special keyword &#39;TUNE&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;TUNE&#39;</span><span class="p">)}</span></div></div>
        
                   
<span class="c1">#################################################</span>
<span class="c1">#### CLASS ParamsFile ###########################</span>
<span class="c1">#################################################</span>

<div class="viewcode-block" id="ParamsFile"><a class="viewcode-back" href="../../orb.html#orb.core.ParamsFile">[docs]</a><span class="k">class</span> <span class="nc">ParamsFile</span><span class="p">(</span><span class="n">Tools</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Manage correspondance between multiple dict containing the</span>
<span class="sd">    same parameters and a file on disk.</span>

<span class="sd">    Its behaviour is similar to :py:class:`astrometry.StarsParams`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_params_list</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_keys</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_file_path</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">f</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">reset</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Init ParamsFile class.</span>

<span class="sd">        :param file_path: Path of the output file where all</span>
<span class="sd">          parameters are stored (Note that this file will</span>
<span class="sd">          automatically be overwritten if reset is set to True).</span>

<span class="sd">        :param reset: (Optional) If True the output file is</span>
<span class="sd">          overwritten. If False and if the output file already exists</span>
<span class="sd">          data in the file are read and new data is appended (default</span>
<span class="sd">          True).</span>

<span class="sd">        :param kwargs: Kwargs are :meth:`core.Tools` properties.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Tools</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_params_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">reset</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">iline</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;##&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">iline</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">iline</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;# KEYS&#39;</span> <span class="ow">in</span> <span class="n">iline</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_keys</span> <span class="o">=</span> <span class="n">iline</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">:]</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keys</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">iline</span> <span class="o">=</span> <span class="n">iline</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                        <span class="n">line_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                        <span class="k">for</span> <span class="n">ikey</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_keys</span><span class="p">)):</span>
                            <span class="n">line_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_keys</span><span class="p">[</span><span class="n">ikey</span><span class="p">]]</span> <span class="o">=</span> <span class="n">iline</span><span class="p">[</span><span class="n">ikey</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_params_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line_dict</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span>
                            <span class="s1">&#39;Wrong file format: </span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_path</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;## PARAMS FILE</span><span class="se">\n</span><span class="s2">## created by </span><span class="si">{:s}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file_path</span> <span class="o">=</span> <span class="n">file_path</span>

    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;ParamsFile destructor&quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;implement Instance[key]&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params_list</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            
<div class="viewcode-block" id="ParamsFile.append"><a class="viewcode-back" href="../../orb.html#orb.core.ParamsFile.append">[docs]</a>    <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Append a dict to the file.</span>

<span class="sd">        :param params: A dict of parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_params_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_params_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_keys</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_keys</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;# KEYS&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ikey</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keys</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ikey</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="n">keys</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">keys</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keys</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_params_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s1">&#39;parameters of the new entry are not the same as the old entries&#39;</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">ikey</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keys</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_params_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">ikey</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div>

<div class="viewcode-block" id="ParamsFile.get_data"><a class="viewcode-back" href="../../orb.html#orb.core.ParamsFile.get_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params_list</span></div></div>


<span class="c1">#################################################</span>
<span class="c1">#### CLASS HDFCube ##############################</span>
<span class="c1">#################################################</span>


<div class="viewcode-block" id="HDFCube"><a class="viewcode-back" href="../../orb.html#orb.core.HDFCube">[docs]</a><span class="k">class</span> <span class="nc">HDFCube</span><span class="p">(</span><span class="n">Cube</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; This class implements the use of an HDF5 cube.</span>

<span class="sd">    An HDF5 cube is similar to the *frame-divided cube* implemented by</span>
<span class="sd">    the class :py:class:`orb.core.Cube` but it makes use of the really</span>
<span class="sd">    fast data access provided by HDF5 files. The &quot;frame-divided&quot;</span>
<span class="sd">    concept is keeped but all the frames are grouped into one hdf5</span>
<span class="sd">    file.</span>

<span class="sd">    An HDF5 cube must have a certain architecture:</span>
<span class="sd">    </span>
<span class="sd">    * Each frame has its own group called &#39;frameIIIII&#39;, IIIII being a</span>
<span class="sd">      integer giving the position of the frame on 5 characters filled</span>
<span class="sd">      with zeros. e.g. the first frame group is called frame00000</span>

<span class="sd">    * Each frame group is divided into at least 2 datasets: **data**</span>
<span class="sd">      and *header* (e.g. the data of the first frame will be in the</span>
<span class="sd">      dataset *frame00000/data*)</span>

<span class="sd">    * A **mask** dataset can be added to each frame.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_hdf5f</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Instance of h5py.File</span>
    <span class="n">_silent_load</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">is_complex</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_prebinning</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">quad_nb</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># number of quads (set to None if HDFCube is not a</span>
                   <span class="c1"># cube split in quads but a cube split in frames)</span>
    <span class="n">is_quad_cube</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># set to True if cube is split in quad. set to</span>
                        <span class="c1"># False if split in frames.</span>
    
    <span class="sd">&quot;&quot;&quot;Set to True if data is complex&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cube_path</span><span class="p">,</span> <span class="n">project_header</span><span class="o">=</span><span class="nb">list</span><span class="p">(),</span>
                 <span class="n">wcs_header</span><span class="o">=</span><span class="nb">list</span><span class="p">(),</span> <span class="n">calibration_laser_header</span><span class="o">=</span><span class="nb">list</span><span class="p">(),</span>
                 <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">indexer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">silent_init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">binning</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize HDFCube class.</span>
<span class="sd">        </span>
<span class="sd">        :param cube_path: Path to the HDF5 cube.</span>

<span class="sd">        :param project_header: (Optional) header section describing</span>
<span class="sd">          the observation parameters that can be added to each output</span>
<span class="sd">          files (an empty list() by default).</span>

<span class="sd">        :param wcs_header: (Optional) header section describing WCS</span>
<span class="sd">          that can be added to each created image files (an empty</span>
<span class="sd">          list() by default).</span>

<span class="sd">        :param calibration_laser_header: (Optional) header section</span>
<span class="sd">          describing the calibration laser parameters that can be</span>
<span class="sd">          added to the concerned output files e.g. calibration laser map,</span>
<span class="sd">          spectral cube (an empty list() by default).</span>

<span class="sd">        :param overwrite: (Optional) If True existing FITS files will</span>
<span class="sd">          be overwritten (default False).</span>

<span class="sd">        :param indexer: (Optional) Must be a :py:class:`core.Indexer`</span>
<span class="sd">          instance. If not None created files can be indexed by this</span>
<span class="sd">          instance.</span>

<span class="sd">        :param binning: (Optional) Cube binning. If &gt; 1 data will be</span>
<span class="sd">          transparently binned so that the cube will behave as as if</span>
<span class="sd">          it was already binned (default None).</span>

<span class="sd">        :param silent_init: (Optional) If True Init is silent (default False).</span>

<span class="sd">        :param kwargs: Kwargs are :meth:`core.Tools` properties.</span>
<span class="sd">        &quot;&quot;&quot;</span>
 
        <span class="n">Tools</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">overwrite</span> <span class="o">=</span> <span class="n">overwrite</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indexer</span> <span class="o">=</span> <span class="n">indexer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_project_header</span> <span class="o">=</span> <span class="n">project_header</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wcs_header</span> <span class="o">=</span> <span class="n">wcs_header</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calibration_laser_header</span> <span class="o">=</span> <span class="n">calibration_laser_header</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">is_hdf5_cube</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_prebinning</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">binning</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">binning</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_prebinning</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">binning</span><span class="p">)</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">DIV_NB</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_config_parameter</span><span class="p">(</span>
            <span class="s2">&quot;DIV_NB&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">QUAD_NB</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DIV_NB</span><span class="o">**</span><span class="mi">2</span><span class="n">L</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BIG_DATA</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_config_parameter</span><span class="p">(</span>
            <span class="s2">&quot;BIG_DATA&quot;</span><span class="p">)))</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_parallel_access_to_data</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">cube_path</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">cube_path</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span> <span class="k">return</span>
        
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_hdf5</span><span class="p">(</span><span class="n">cube_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cube_path</span> <span class="o">=</span> <span class="n">cube_path</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dimz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_attribute</span><span class="p">(</span><span class="s1">&#39;dimz&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dimx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_attribute</span><span class="p">(</span><span class="s1">&#39;dimx&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dimy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_attribute</span><span class="p">(</span><span class="s1">&#39;dimy&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;image_list&#39;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">image_list</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;image_list&#39;</span><span class="p">][:]</span>
            
            

            <span class="c1"># check if cube is quad or frames based</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">quad_nb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_attribute</span><span class="p">(</span><span class="s1">&#39;quad_nb&#39;</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">quad_nb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">is_quad_cube</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">is_quad_cube</span> <span class="o">=</span> <span class="kc">False</span>
        
            <span class="c1"># sanity check</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_quad_cube</span><span class="p">:</span>
                <span class="n">quad_nb</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">igrp</span> <span class="k">for</span> <span class="n">igrp</span> <span class="ow">in</span> <span class="n">f</span>
                     <span class="k">if</span> <span class="s1">&#39;quad&#39;</span> <span class="o">==</span> <span class="n">igrp</span><span class="p">[:</span><span class="mi">4</span><span class="p">]])</span>
                <span class="k">if</span> <span class="n">quad_nb</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quad_nb</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s2">&quot;Corrupted HDF5 cube: &#39;quad_nb&#39; attribute ([]) does not correspond to the real number of quads (</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">quad_nb</span><span class="p">,</span> <span class="n">quad_nb</span><span class="p">))</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_hdf5_quad_path</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                    <span class="c1"># test whether data is complex</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">iscomplexobj</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_hdf5_quad_data_path</span><span class="p">(</span><span class="mi">0</span><span class="p">)]):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">is_complex</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="nb">complex</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">is_complex</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="nb">float</span>
                
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> is missing. A valid HDF5 cube must contain at least one quadrant&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_get_hdf5_quad_path</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span>
                    

            <span class="k">else</span><span class="p">:</span>
                <span class="n">frame_nb</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">igrp</span> <span class="k">for</span> <span class="n">igrp</span> <span class="ow">in</span> <span class="n">f</span>
                     <span class="k">if</span> <span class="s1">&#39;frame&#39;</span> <span class="o">==</span> <span class="n">igrp</span><span class="p">[:</span><span class="mi">5</span><span class="p">]])</span>

                <span class="k">if</span> <span class="n">frame_nb</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimz</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s2">&quot;Corrupted HDF5 cube: &#39;dimz&#39; attribute (</span><span class="si">{}</span><span class="s2">) does not correspond to the real number of frames (</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimz</span><span class="p">,</span> <span class="n">frame_nb</span><span class="p">))</span>
                
            
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_hdf5_frame_path</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>                
                    <span class="k">if</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">dimx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimy</span><span class="p">)</span>
                        <span class="o">!=</span> <span class="n">f</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_hdf5_data_path</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span><span class="o">.</span><span class="n">shape</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s1">&#39;Corrupted HDF5 cube: frame shape </span><span class="si">{}</span><span class="s1"> does not correspond to the attributes of the file </span><span class="si">{}</span><span class="s1">x</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_hdf5_data_path</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimy</span><span class="p">))</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_hdf5_data_path</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_mask_exists</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_mask_exists</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="c1"># test whether data is complex</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">iscomplexobj</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_hdf5_data_path</span><span class="p">(</span><span class="mi">0</span><span class="p">)]):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">is_complex</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="nb">complex</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">is_complex</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="nb">float</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> is missing. A valid HDF5 cube must contain at least one frame&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_get_hdf5_frame_path</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span>
                

        <span class="c1"># binning</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prebinning</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dimx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimx</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prebinning</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dimy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimy</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prebinning</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimx</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimy</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimz</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">silent_init</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print_msg</span><span class="p">(</span><span class="s2">&quot;Data shape : (&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimx</span><span class="p">)</span> 
                                <span class="o">+</span> <span class="s2">&quot;, &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimy</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span> 
                                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimz</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s2">&quot;Incorrect data shape : (&quot;</span> 
                            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimx</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimy</span><span class="p">)</span> 
                              <span class="o">+</span> <span class="s2">&quot;, &quot;</span> <span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimz</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimz</span><span class="p">)</span>

        
    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Implement the evaluation of self[key].</span>
<span class="sd">        </span>
<span class="sd">        .. note:: To make this function silent just set</span>
<span class="sd">          Cube()._silent_load to True.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">slice_in_quad</span><span class="p">(</span><span class="n">ax_slice</span><span class="p">,</span> <span class="n">ax_min</span><span class="p">,</span> <span class="n">ax_max</span><span class="p">):</span>
            <span class="n">ax_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">ax_min</span><span class="p">,</span> <span class="n">ax_max</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ax_slice</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">ax_slice</span><span class="o">.</span><span class="n">stop</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">ax_range</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="c1"># check return mask possibility</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_return_mask</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask_exists</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s2">&quot;No mask found with data, cannot return mask&quot;</span><span class="p">)</span>
        
        <span class="c1"># produce default values for slices</span>
        <span class="n">x_slice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_default_slice</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimx</span><span class="p">)</span>
        <span class="n">y_slice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_default_slice</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimy</span><span class="p">)</span>
        <span class="n">z_slice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_default_slice</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimz</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">x_slice</span><span class="o">.</span><span class="n">stop</span> <span class="o">-</span> <span class="n">x_slice</span><span class="o">.</span><span class="n">start</span><span class="p">,</span>
                         <span class="n">y_slice</span><span class="o">.</span><span class="n">stop</span> <span class="o">-</span> <span class="n">y_slice</span><span class="o">.</span><span class="n">start</span><span class="p">,</span>
                         <span class="n">z_slice</span><span class="o">.</span><span class="n">stop</span> <span class="o">-</span> <span class="n">z_slice</span><span class="o">.</span><span class="n">start</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prebinning</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x_slice</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">x_slice</span><span class="o">.</span><span class="n">start</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prebinning</span><span class="p">,</span>
                            <span class="n">x_slice</span><span class="o">.</span><span class="n">stop</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prebinning</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">y_slice</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">y_slice</span><span class="o">.</span><span class="n">start</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prebinning</span><span class="p">,</span>
                            <span class="n">y_slice</span><span class="o">.</span><span class="n">stop</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prebinning</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># frame based cube</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_quad_cube</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">z_slice</span><span class="o">.</span><span class="n">stop</span> <span class="o">-</span> <span class="n">z_slice</span><span class="o">.</span><span class="n">start</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">only_one_frame</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">only_one_frame</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_hdf5</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cube_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_silent_load</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">only_one_frame</span><span class="p">:</span>
                    <span class="n">progress</span> <span class="o">=</span> <span class="n">ProgressBar</span><span class="p">(</span><span class="n">z_slice</span><span class="o">.</span><span class="n">stop</span> <span class="o">-</span> <span class="n">z_slice</span><span class="o">.</span><span class="n">start</span> <span class="o">-</span> <span class="mi">1</span><span class="n">L</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">z_slice</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">z_slice</span><span class="o">.</span><span class="n">stop</span><span class="p">):</span>
                    <span class="n">unbin_data</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_get_hdf5_data_path</span><span class="p">(</span>
                            <span class="n">ik</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_return_mask</span><span class="p">)][</span><span class="n">x_slice</span><span class="p">,</span> <span class="n">y_slice</span><span class="p">]</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prebinning</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">x_slice</span><span class="o">.</span><span class="n">stop</span> <span class="o">-</span> <span class="n">x_slice</span><span class="o">.</span><span class="n">start</span><span class="p">,</span>
                             <span class="mi">0</span><span class="p">:</span><span class="n">y_slice</span><span class="o">.</span><span class="n">stop</span> <span class="o">-</span> <span class="n">y_slice</span><span class="o">.</span><span class="n">start</span><span class="p">,</span>
                             <span class="n">ik</span> <span class="o">-</span> <span class="n">z_slice</span><span class="o">.</span><span class="n">start</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">nanbin_image</span><span class="p">(</span>
                            <span class="n">unbin_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prebinning</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">x_slice</span><span class="o">.</span><span class="n">stop</span> <span class="o">-</span> <span class="n">x_slice</span><span class="o">.</span><span class="n">start</span><span class="p">,</span>
                             <span class="mi">0</span><span class="p">:</span><span class="n">y_slice</span><span class="o">.</span><span class="n">stop</span> <span class="o">-</span> <span class="n">y_slice</span><span class="o">.</span><span class="n">start</span><span class="p">,</span>
                             <span class="n">ik</span> <span class="o">-</span> <span class="n">z_slice</span><span class="o">.</span><span class="n">start</span><span class="p">]</span> <span class="o">=</span> <span class="n">unbin_data</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_silent_load</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">only_one_frame</span><span class="p">:</span>
                        <span class="n">progress</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ik</span> <span class="o">-</span> <span class="n">z_slice</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="s2">&quot;Loading data&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_silent_load</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">only_one_frame</span><span class="p">:</span>
                    <span class="n">progress</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>

        <span class="c1"># quad based cube</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_hdf5</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cube_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_silent_load</span><span class="p">:</span>
                    <span class="n">progress</span> <span class="o">=</span> <span class="n">ProgressBar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">quad_nb</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">iquad</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">quad_nb</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_silent_load</span><span class="p">:</span>
                        <span class="n">progress</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">iquad</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="s1">&#39;Loading data&#39;</span><span class="p">)</span>
                    <span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_quadrant_dims</span><span class="p">(</span>
                        <span class="n">iquad</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimy</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">quad_nb</span><span class="p">))))</span>
                    <span class="k">if</span> <span class="n">slice_in_quad</span><span class="p">(</span><span class="n">x_slice</span><span class="p">,</span> <span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">)</span> <span class="ow">and</span> <span class="n">slice_in_quad</span><span class="p">(</span><span class="n">y_slice</span><span class="p">,</span> <span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">):</span>
                        <span class="n">data</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_slice</span><span class="o">.</span><span class="n">start</span><span class="p">)</span> <span class="o">-</span> <span class="n">x_slice</span><span class="o">.</span><span class="n">start</span><span class="p">:</span>
                             <span class="nb">min</span><span class="p">(</span><span class="n">x_max</span><span class="p">,</span> <span class="n">x_slice</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span> <span class="o">-</span> <span class="n">x_slice</span><span class="o">.</span><span class="n">start</span><span class="p">,</span>
                             <span class="nb">max</span><span class="p">(</span><span class="n">y_min</span><span class="p">,</span> <span class="n">y_slice</span><span class="o">.</span><span class="n">start</span><span class="p">)</span> <span class="o">-</span> <span class="n">y_slice</span><span class="o">.</span><span class="n">start</span><span class="p">:</span>
                             <span class="nb">min</span><span class="p">(</span><span class="n">y_max</span><span class="p">,</span> <span class="n">y_slice</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span> <span class="o">-</span> <span class="n">y_slice</span><span class="o">.</span><span class="n">start</span><span class="p">,</span>
                             <span class="mi">0</span><span class="p">:</span><span class="n">z_slice</span><span class="o">.</span><span class="n">stop</span><span class="o">-</span><span class="n">z_slice</span><span class="o">.</span><span class="n">start</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_hdf5_quad_data_path</span><span class="p">(</span><span class="n">iquad</span><span class="p">)][</span>
                            <span class="nb">max</span><span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_slice</span><span class="o">.</span><span class="n">start</span><span class="p">)</span> <span class="o">-</span> <span class="n">x_min</span><span class="p">:</span><span class="nb">min</span><span class="p">(</span><span class="n">x_max</span><span class="p">,</span> <span class="n">x_slice</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span> <span class="o">-</span> <span class="n">x_min</span><span class="p">,</span>
                            <span class="nb">max</span><span class="p">(</span><span class="n">y_min</span><span class="p">,</span> <span class="n">y_slice</span><span class="o">.</span><span class="n">start</span><span class="p">)</span> <span class="o">-</span> <span class="n">y_min</span><span class="p">:</span><span class="nb">min</span><span class="p">(</span><span class="n">y_max</span><span class="p">,</span> <span class="n">y_slice</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span> <span class="o">-</span> <span class="n">y_min</span><span class="p">,</span>
                            <span class="n">z_slice</span><span class="o">.</span><span class="n">start</span><span class="p">:</span><span class="n">z_slice</span><span class="o">.</span><span class="n">stop</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_silent_load</span><span class="p">:</span>
                    <span class="n">progress</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
                        

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

                

    <span class="k">def</span> <span class="nf">_get_attribute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the value of an attribute of the HDF5 cube</span>

<span class="sd">        :param attr: Attribute to return</span>
<span class="sd">        </span>
<span class="sd">        :param optional: If True and if the attribute does not exist</span>
<span class="sd">          only a warning is raised. If False the HDF5 cube is</span>
<span class="sd">          considered as invalid and an exception is raised.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_hdf5</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cube_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">optional</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s1">&#39;Attribute </span><span class="si">{}</span><span class="s1"> is missing. The HDF5 cube seems badly formatted. Try to create it again with the last version of ORB.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="HDFCube.get_frame_attributes"><a class="viewcode-back" href="../../orb.html#orb.core.HDFCube.get_frame_attributes">[docs]</a>    <span class="k">def</span> <span class="nf">get_frame_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return an attribute attached to a frame.</span>

<span class="sd">        If the attribute does not exist returns None.</span>

<span class="sd">        :param index: Index of the frame.</span>

<span class="sd">        :param attr: Attribute name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_hdf5</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cube_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_hdf5_frame_path</span><span class="p">(</span><span class="n">index</span><span class="p">)]</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
                <span class="n">attrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">f</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_hdf5_frame_path</span><span class="p">(</span><span class="n">index</span><span class="p">)]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">attr</span><span class="p">]))</span>
            <span class="k">return</span> <span class="n">attrs</span></div>

<div class="viewcode-block" id="HDFCube.get_frame_attribute"><a class="viewcode-back" href="../../orb.html#orb.core.HDFCube.get_frame_attribute">[docs]</a>    <span class="k">def</span> <span class="nf">get_frame_attribute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return an attribute attached to a frame.</span>

<span class="sd">        If the attribute does not exist returns None.</span>

<span class="sd">        :param index: Index of the frame.</span>

<span class="sd">        :param attr: Attribute name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_hdf5</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cube_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_hdf5_frame_path</span><span class="p">(</span><span class="n">index</span><span class="p">)]</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">f</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_hdf5_frame_path</span><span class="p">(</span><span class="n">index</span><span class="p">)]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="HDFCube.get_frame_header"><a class="viewcode-back" href="../../orb.html#orb.core.HDFCube.get_frame_header">[docs]</a>    <span class="k">def</span> <span class="nf">get_frame_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the header of a frame given its index in the list.</span>

<span class="sd">        The header is returned as an instance of pyfits.Header().</span>

<span class="sd">        :param index: Index of the frame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_hdf5</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cube_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header_hdf52fits</span><span class="p">(</span>
                <span class="n">f</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_hdf5_header_path</span><span class="p">(</span><span class="n">index</span><span class="p">)][:])</span></div>

<div class="viewcode-block" id="HDFCube.get_cube_header"><a class="viewcode-back" href="../../orb.html#orb.core.HDFCube.get_cube_header">[docs]</a>    <span class="k">def</span> <span class="nf">get_cube_header</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the header of a the cube.</span>

<span class="sd">        The header is returned as an instance of pyfits.Header().</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_hdf5</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cube_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;header&#39;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header_hdf52fits</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">][:])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">Header</span><span class="p">()</span></div>

<div class="viewcode-block" id="HDFCube.get_calibration_laser_map"><a class="viewcode-back" href="../../orb.html#orb.core.HDFCube.get_calibration_laser_map">[docs]</a>    <span class="k">def</span> <span class="nf">get_calibration_laser_map</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return stored calibration laser map&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_hdf5</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cube_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;calib_map&#39;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;calib_map&#39;</span><span class="p">][:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print_warning</span><span class="p">(</span><span class="s1">&#39;No calibration laser map stored&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span></div>

           
<div class="viewcode-block" id="HDFCube.get_mean_image"><a class="viewcode-back" href="../../orb.html#orb.core.HDFCube.get_mean_image">[docs]</a>    <span class="k">def</span> <span class="nf">get_mean_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the deep frame of the cube.</span>

<span class="sd">        :param recompute: (Optional) Force to recompute mean image</span>
<span class="sd">          even if it is already present in the cube (default False).</span>
<span class="sd">        </span>
<span class="sd">        If a deep frame has already been computed (&#39;deep_frame&#39;</span>
<span class="sd">        dataset) return it directly.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_hdf5</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cube_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;deep_frame&#39;</span> <span class="ow">in</span> <span class="n">f</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">recompute</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;deep_frame&#39;</span><span class="p">][:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Cube</span><span class="o">.</span><span class="n">get_mean_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="n">recompute</span><span class="p">)</span></div>

<div class="viewcode-block" id="HDFCube.get_interf_energy_map"><a class="viewcode-back" href="../../orb.html#orb.core.HDFCube.get_interf_energy_map">[docs]</a>    <span class="k">def</span> <span class="nf">get_interf_energy_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the energy map of an interferogram cube.</span>
<span class="sd">    </span>
<span class="sd">        :param recompute: (Optional) Force to recompute energy map</span>
<span class="sd">          even if it is already present in the cube (default False).</span>
<span class="sd">          </span>
<span class="sd">        If an energy map has already been computed (&#39;energy_map&#39;</span>
<span class="sd">        dataset) return it directly.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_hdf5</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cube_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;energy_map&#39;</span> <span class="ow">in</span> <span class="n">f</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">recompute</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;energy_map&#39;</span><span class="p">][:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Cube</span><span class="o">.</span><span class="n">get_interf_energy_map</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="HDFCube.get_spectrum_energy_map"><a class="viewcode-back" href="../../orb.html#orb.core.HDFCube.get_spectrum_energy_map">[docs]</a>    <span class="k">def</span> <span class="nf">get_spectrum_energy_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the energy map of a spectral cube.</span>
<span class="sd">        </span>
<span class="sd">        :param recompute: (Optional) Force to recompute energy map</span>
<span class="sd">          even if it is already present in the cube (default False).</span>
<span class="sd">          </span>
<span class="sd">        If an energy map has already been computed (&#39;energy_map&#39;</span>
<span class="sd">        dataset) return it directly.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_hdf5</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cube_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;energy_map&#39;</span> <span class="ow">in</span> <span class="n">f</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">recompute</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;energy_map&#39;</span><span class="p">][:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Cube</span><span class="o">.</span><span class="n">get_spectrum_energy_map</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div></div>

        
<span class="c1">##################################################</span>
<span class="c1">#### CLASS OutHDFCube ############################</span>
<span class="c1">##################################################           </span>

<div class="viewcode-block" id="OutHDFCube"><a class="viewcode-back" href="../../orb.html#orb.core.OutHDFCube">[docs]</a><span class="k">class</span> <span class="nc">OutHDFCube</span><span class="p">(</span><span class="n">Tools</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Output HDF5 Cube class.</span>

<span class="sd">    This class must be used to output a valid HDF5 cube.</span>
<span class="sd">    </span>
<span class="sd">    .. warning:: The underlying dataset is not readonly and might be</span>
<span class="sd">      overwritten.</span>

<span class="sd">    .. note:: This class has been created because</span>
<span class="sd">      :py:class:`orb.core.HDFCube` must not be able to change its</span>
<span class="sd">      underlying dataset (the HDF5 cube is always read-only).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">export_path</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">reset</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Init OutHDFCube class.</span>

<span class="sd">        :param export_path: Path ot the output HDF5 cube to create.</span>

<span class="sd">        :param shape: Data shape. Must be a 3-Tuple (dimx, dimy, dimz)</span>

<span class="sd">        :param overwrite: (Optional) If True data will be overwritten</span>
<span class="sd">          but existing data will not be removed (default False).</span>

<span class="sd">        :param reset: (Optional) If True and if the file already</span>
<span class="sd">          exists, it is deleted (default False).</span>
<span class="sd">        </span>
<span class="sd">        :param kwargs: Kwargs are :meth:`core.Tools` properties.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Tools</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        
        <span class="c1"># change path if file exists and must not be overwritten</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">export_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">export_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">reset</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">export_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">export_path</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">overwrite</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">export_path</span><span class="p">):</span>
            <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">export_path</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">export_path</span> <span class="o">=</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">export_path</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> 
                                   <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">+</span> 
                                   <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">export_path</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">export_path</span> <span class="o">!=</span> <span class="n">export_path</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_warning</span><span class="p">(</span><span class="s1">&#39;Cube path changed to </span><span class="si">{}</span><span class="s1"> to avoid overwritting an already existing file&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">export_path</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">shape</span>
        <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s1">&#39;An HDF5 cube shape must be a tuple (dimx, dimy, dimz)&#39;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_hdf5</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">export_path</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">overwrite</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">export_path</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_hdf5</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">export_path</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span>
                    <span class="s1">&#39;IOError while opening HDF5 cube: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                
        <span class="bp">self</span><span class="o">.</span><span class="n">_print_msg</span><span class="p">(</span><span class="s1">&#39;Opening OutHDFCube </span><span class="si">{}</span><span class="s1"> (</span><span class="si">{}</span><span class="s1">,</span><span class="si">{}</span><span class="s1">,</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">export_path</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
        
        <span class="c1"># add attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;dimx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;dimy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;dimz&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">imshape</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<div class="viewcode-block" id="OutHDFCube.write_frame_attribute"><a class="viewcode-back" href="../../orb.html#orb.core.OutHDFCube.write_frame_attribute">[docs]</a>    <span class="k">def</span> <span class="nf">write_frame_attribute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write a frame attribute</span>

<span class="sd">        :param index: Index of the frame</span>

<span class="sd">        :param attr: Attribute name</span>

<span class="sd">        :param value: Value of the attribute to write</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_hdf5_frame_path</span><span class="p">(</span><span class="n">index</span><span class="p">)]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span></div>

<div class="viewcode-block" id="OutHDFCube.write_frame"><a class="viewcode-back" href="../../orb.html#orb.core.OutHDFCube.write_frame">[docs]</a>    <span class="k">def</span> <span class="nf">write_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">record_stats</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">force_float32</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">section</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">force_complex64</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">compress</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write a frame</span>

<span class="sd">        :param index: Index of the frame</span>
<span class="sd">        </span>
<span class="sd">        :param data: (Optional) Frame data (default None).</span>
<span class="sd">        </span>
<span class="sd">        :param header: (Optional) Frame header (default None).</span>
<span class="sd">        </span>
<span class="sd">        :param mask: (Optional) Frame mask (default None).</span>
<span class="sd">        </span>
<span class="sd">        :param record_stats: (Optional) If True Mean and Median of the</span>
<span class="sd">          frame are appended as attributes (data must be set) (defaut</span>
<span class="sd">          False).</span>

<span class="sd">        :param force_float32: (Optional) If True, data type is forced</span>
<span class="sd">          to numpy.float32 type (default True).</span>

<span class="sd">        :param section: (Optional) If not None, must be a 4-tuple</span>
<span class="sd">          [xmin, xmax, ymin, ymax] giving the section to write instead</span>
<span class="sd">          of the whole frame. Useful to modify only a part of the</span>
<span class="sd">          frame (deafult None).</span>

<span class="sd">        :param force_complex64: (Optional) If True, data type is</span>
<span class="sd">          forced to numpy.complex64 type (default False).</span>

<span class="sd">        :param compress: (Optional) If True, data is lossely</span>
<span class="sd">          compressed using a gzip algorithm (default False).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">_replace</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">dat</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">force_complex64</span><span class="p">:</span> <span class="n">dat</span> <span class="o">=</span> <span class="n">dat</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">complex64</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">force_float32</span><span class="p">:</span> <span class="n">dat</span> <span class="o">=</span> <span class="n">dat</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                <span class="n">dat_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_hdf5_data_path</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;mask&#39;</span><span class="p">:</span>
                <span class="n">dat_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_hdf5_data_path</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;header&#39;</span><span class="p">:</span>
                <span class="n">dat_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_hdf5_header_path</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;data&#39;</span> <span class="ow">or</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;mask&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">section</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">old_dat</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span>  <span class="n">dat_path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">:</span>
                        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="n">dat_path</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">imshape</span><span class="p">):</span>
                            <span class="n">old_dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="n">dat_path</span><span class="p">][:]</span>
                    <span class="k">if</span> <span class="n">old_dat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">frame</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imshape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dat</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
                        <span class="n">frame</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">frame</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">old_dat</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
                    <span class="n">frame</span><span class="p">[</span><span class="n">section</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">section</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">section</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="n">section</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span> <span class="o">=</span> <span class="n">dat</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">dat</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">imshape</span><span class="p">:</span>
                        <span class="n">frame</span> <span class="o">=</span> <span class="n">dat</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span>
                            <span class="s2">&quot;Bad data shape </span><span class="si">{}</span><span class="s2">. Must be </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">imshape</span><span class="p">))</span>
                <span class="n">dat</span> <span class="o">=</span> <span class="n">frame</span>
                    
            <span class="k">if</span> <span class="n">dat_path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">:</span> <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="n">dat_path</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">compress</span><span class="p">:</span>
                <span class="c1">## szip_types = (np.float32, np.float64, np.int16, np.int32, np.int64,</span>
                <span class="c1">##               np.uint8, np.uint16)</span>
            
                <span class="c1">## if dat.dtype in szip_types:</span>
                <span class="c1">##     compression = &#39;szip&#39;</span>
                <span class="c1">##     compression_opts = (&#39;nn&#39;, 32)</span>
                <span class="c1">## else:</span>
                <span class="c1">##     compression = &#39;gzip&#39;</span>
                <span class="c1">##     compression_opts = 4</span>
                <span class="n">compression</span> <span class="o">=</span> <span class="s1">&#39;lzf&#39;</span>
                <span class="n">compression_opts</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">compression</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">compression_opts</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span>
                <span class="n">dat_path</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">dat</span><span class="p">,</span>
                <span class="n">compression</span><span class="o">=</span><span class="n">compression</span><span class="p">,</span> <span class="n">compression_opts</span><span class="o">=</span><span class="n">compression_opts</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">dat</span>

        <span class="k">if</span> <span class="n">force_float32</span> <span class="ow">and</span> <span class="n">force_complex64</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s1">&#39;force_float32 and force_complex64 cannot be both set to True&#39;</span><span class="p">)</span>

            
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">header</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_warning</span><span class="p">(</span><span class="s1">&#39;Nothing to write in the frame </span><span class="si">{}</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">index</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">_replace</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">record_stats</span><span class="p">:</span>
                <span class="n">mean</span> <span class="o">=</span> <span class="n">bn</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">real</span><span class="p">)</span>
                <span class="n">median</span> <span class="o">=</span> <span class="n">bn</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">real</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_hdf5_frame_path</span><span class="p">(</span><span class="n">index</span><span class="p">)]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">mean</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_hdf5_frame_path</span><span class="p">(</span><span class="n">index</span><span class="p">)]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;median&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">mean</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mean</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">median</span> <span class="o">=</span> <span class="kc">None</span>
                
        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">bool_</span><span class="p">)</span>
            <span class="n">_replace</span><span class="p">(</span><span class="s1">&#39;mask&#39;</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>


        <span class="c1"># Creating pyfits.ImageHDU instance to format header</span>
        <span class="k">if</span> <span class="n">header</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">Header</span><span class="p">):</span>
                <span class="n">header</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">Header</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">iscomplexobj</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="ow">or</span> <span class="n">force_complex64</span><span class="p">:</span>
                <span class="n">hdu</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">ImageHDU</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">hdu</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">ImageHDU</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hdu</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">ImageHDU</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span> <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">)</span>
            
        
        <span class="k">if</span> <span class="n">hdu</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">record_stats</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">mean</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">mean</span><span class="p">):</span>
                        <span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;MEAN&#39;</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span>
                                       <span class="s1">&#39;Mean of data (NaNs filtered)&#39;</span><span class="p">,</span>
                                       <span class="n">after</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">median</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">median</span><span class="p">):</span>
                        <span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;MEDIAN&#39;</span><span class="p">,</span> <span class="n">median</span><span class="p">,</span>
                                       <span class="s1">&#39;Median of data (NaNs filtered)&#39;</span><span class="p">,</span>
                                       <span class="n">after</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
            
            <span class="n">hdu</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">option</span><span class="o">=</span><span class="sa">u</span><span class="s1">&#39;silentfix&#39;</span><span class="p">)</span>
                
            
            <span class="n">_replace</span><span class="p">(</span><span class="s1">&#39;header&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header_fits2hdf5</span><span class="p">(</span><span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">))</span></div>
            

<div class="viewcode-block" id="OutHDFCube.append_image_list"><a class="viewcode-back" href="../../orb.html#orb.core.OutHDFCube.append_image_list">[docs]</a>    <span class="k">def</span> <span class="nf">append_image_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Append an image list to the HDF5 cube.</span>

<span class="sd">        :param image_list: Image list to append.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;image_list&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;image_list&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">image_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;image_list&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">image_list</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_warning</span><span class="p">(</span><span class="s1">&#39;empty image list&#39;</span><span class="p">)</span></div>
        

<div class="viewcode-block" id="OutHDFCube.append_deep_frame"><a class="viewcode-back" href="../../orb.html#orb.core.OutHDFCube.append_deep_frame">[docs]</a>    <span class="k">def</span> <span class="nf">append_deep_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">deep_frame</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Append a deep frame to the HDF5 cube.</span>

<span class="sd">        :param deep_frame: Deep frame to append.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;deep_frame&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;deep_frame&#39;</span><span class="p">]</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;deep_frame&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">deep_frame</span></div>

<div class="viewcode-block" id="OutHDFCube.append_energy_map"><a class="viewcode-back" href="../../orb.html#orb.core.OutHDFCube.append_energy_map">[docs]</a>    <span class="k">def</span> <span class="nf">append_energy_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">energy_map</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Append an energy map to the HDF5 cube.</span>

<span class="sd">        :param energy_map: Energy map to append.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;energy_map&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;energy_map&#39;</span><span class="p">]</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;energy_map&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">energy_map</span></div>

    
<div class="viewcode-block" id="OutHDFCube.append_calibration_laser_map"><a class="viewcode-back" href="../../orb.html#orb.core.OutHDFCube.append_calibration_laser_map">[docs]</a>    <span class="k">def</span> <span class="nf">append_calibration_laser_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">calib_map</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Append a calibration laser map to the HDF5 cube.</span>

<span class="sd">        :param calib_map: Calibration laser map to append.</span>

<span class="sd">        :param header: (Optional) Header to append (default None)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;calib_map&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;calib_map&#39;</span><span class="p">]</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;calib_map&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">calib_map</span>
        <span class="k">if</span> <span class="n">header</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;calib_map_hdr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header_fits2hdf5</span><span class="p">(</span><span class="n">header</span><span class="p">)</span></div>

<div class="viewcode-block" id="OutHDFCube.append_header"><a class="viewcode-back" href="../../orb.html#orb.core.OutHDFCube.append_header">[docs]</a>    <span class="k">def</span> <span class="nf">append_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Append a header to the HDF5 cube.</span>

<span class="sd">        :param header: header to append.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;header&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">]</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header_fits2hdf5</span><span class="p">(</span><span class="n">header</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="OutHDFCube.close"><a class="viewcode-back" href="../../orb.html#orb.core.OutHDFCube.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Close the HDF5 cube. Class cannot work properly once this</span>
<span class="sd">        method is called so delete it. e.g.::</span>
<span class="sd">        </span>
<span class="sd">          outhdfcube.close()</span>
<span class="sd">          del outhdfcube</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span></div></div>




<span class="c1">##################################################</span>
<span class="c1">#### CLASS OutHDFQuadCube ########################</span>
<span class="c1">##################################################           </span>

<div class="viewcode-block" id="OutHDFQuadCube"><a class="viewcode-back" href="../../orb.html#orb.core.OutHDFQuadCube">[docs]</a><span class="k">class</span> <span class="nc">OutHDFQuadCube</span><span class="p">(</span><span class="n">OutHDFCube</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Output HDF5 Cube class saved in quadrants.</span>

<span class="sd">    This class can be used to output a valid HDF5 cube.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">export_path</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">quad_nb</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">reset</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Init OutHDFQuadCube class.</span>

<span class="sd">        :param export_path: Path ot the output HDF5 cube to create.</span>

<span class="sd">        :param shape: Data shape. Must be a 3-Tuple (dimx, dimy, dimz)</span>

<span class="sd">        :param quad_nb: Number of quadrants in the cube.</span>

<span class="sd">        :param overwrite: (Optional) If True data will be overwritten</span>
<span class="sd">          but existing data will not be removed (default False).</span>

<span class="sd">        :param reset: (Optional) If True and if the file already</span>
<span class="sd">          exists, it is deleted (default False).</span>
<span class="sd">        </span>
<span class="sd">        :param kwargs: Kwargs are :meth:`core.Tools` properties.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">OutHDFCube</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">export_path</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">,</span>
                            <span class="n">reset</span><span class="o">=</span><span class="n">reset</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;quad_nb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">quad_nb</span>

<div class="viewcode-block" id="OutHDFQuadCube.write_quad"><a class="viewcode-back" href="../../orb.html#orb.core.OutHDFQuadCube.write_quad">[docs]</a>    <span class="k">def</span> <span class="nf">write_quad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">force_float32</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                   <span class="n">force_complex64</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="n">compress</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;&quot;Write a quadrant</span>

<span class="sd">        :param index: Index of the quadrant</span>
<span class="sd">        </span>
<span class="sd">        :param data: (Optional) Frame data (default None).</span>
<span class="sd">        </span>
<span class="sd">        :param header: (Optional) Frame header (default None).</span>
<span class="sd">        </span>
<span class="sd">        :param mask: (Optional) Frame mask (default None).</span>
<span class="sd">        </span>
<span class="sd">        :param record_stats: (Optional) If True Mean and Median of the</span>
<span class="sd">          frame are appended as attributes (data must be set) (defaut</span>
<span class="sd">          False).</span>

<span class="sd">        :param force_float32: (Optional) If True, data type is forced</span>
<span class="sd">          to numpy.float32 type (default True).</span>

<span class="sd">        :param section: (Optional) If not None, must be a 4-tuple</span>
<span class="sd">          [xmin, xmax, ymin, ymax] giving the section to write instead</span>
<span class="sd">          of the whole frame. Useful to modify only a part of the</span>
<span class="sd">          frame (deafult None).</span>

<span class="sd">        :param force_complex64: (Optional) If True, data type is</span>
<span class="sd">          forced to numpy.complex64 type (default False).</span>

<span class="sd">        :param compress: (Optional) If True, data is lossely</span>
<span class="sd">          compressed using a gzip algorithm (default False).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="n">force_float32</span> <span class="ow">and</span> <span class="n">force_complex64</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s1">&#39;force_float32 and force_complex64 cannot be both set to True&#39;</span><span class="p">)</span>

            
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">header</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_warning</span><span class="p">(</span><span class="s1">&#39;Nothing to write in the frame </span><span class="si">{}</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">index</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">force_complex64</span><span class="p">:</span> <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">complex64</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">force_float32</span><span class="p">:</span> <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="n">dat_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_hdf5_quad_data_path</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">dat_path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="n">dat_path</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">compress</span><span class="p">:</span>
                
                <span class="c1">#szip_types = (np.float32, np.float64, np.int16, np.int32, np.int64,</span>
                <span class="c1">#              np.uint8, np.uint16)</span>
                <span class="c1">## if data.dtype in szip_types:</span>
                <span class="c1">##     compression = &#39;szip&#39;</span>
                <span class="c1">##     compression_opts = (&#39;nn&#39;, 32)</span>
                <span class="c1">## else:</span>
                <span class="c1">##     compression = &#39;gzip&#39;</span>
                <span class="c1">##     compression_opts = 4</span>
                <span class="n">compression</span> <span class="o">=</span> <span class="s1">&#39;lzf&#39;</span>
                <span class="n">compression_opts</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">compression</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">compression_opts</span> <span class="o">=</span> <span class="kc">None</span>
                
            <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span>
                <span class="n">dat_path</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
                <span class="n">compression</span><span class="o">=</span><span class="n">compression</span><span class="p">,</span>
                <span class="n">compression_opts</span><span class="o">=</span><span class="n">compression_opts</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">data</span></div></div>
        
        


<span class="c1">##################################################</span>
<span class="c1">#### CLASS Logger ################################</span>
<span class="c1">##################################################           </span>

<div class="viewcode-block" id="Logger"><a class="viewcode-back" href="../../orb.html#orb.core.Logger">[docs]</a><span class="k">class</span> <span class="nc">Logger</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Logger class.&quot;&quot;&quot;</span>

    <span class="n">noprint</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">nolog</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">stdout</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">stderr</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">file</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">noprint</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nolog</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Init Logger class.</span>

<span class="sd">        :param name: Name of the logfile.</span>

<span class="sd">        :param mode: (Optional) File mode (same as file mode for the classic</span>
<span class="sd">          open() function) (default &#39;a&#39;).</span>

<span class="sd">        :param noprint: (Optional) If True nothing is printed on the terminal (or</span>
<span class="sd">          more generally on the regular stdout) (default False).</span>

<span class="sd">        :param nolog: (Optional) If True nothing is logged in the</span>
<span class="sd">          logfile (default False).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">noprint</span> <span class="o">=</span> <span class="n">noprint</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nolog</span> <span class="o">=</span> <span class="n">nolog</span>
        
        
    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Class destructor.&quot;&quot;&quot;</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
<div class="viewcode-block" id="Logger.write"><a class="viewcode-back" href="../../orb.html#orb.core.Logger.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nolog</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write in the logfile and on the terminal (stdout)</span>

<span class="sd">        :param msg: Message to write.</span>

<span class="sd">        :param color: (Optional) Output will be colored. Must be a</span>
<span class="sd">          :py:class:`~orb.core.TextColor` attribute (default None).</span>

<span class="sd">        :param nolog: (Optional) If True nothing is printed in the log</span>
<span class="sd">          (default False).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">msg_color</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">color</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">msg_color</span> <span class="o">=</span> <span class="n">color</span> <span class="o">+</span> <span class="n">msg</span> <span class="o">+</span> <span class="n">TextColor</span><span class="o">.</span><span class="n">END</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">nolog</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">nolog</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">noprint</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">msg_color</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div>

<div class="viewcode-block" id="Logger.flush"><a class="viewcode-back" href="../../orb.html#orb.core.Logger.flush">[docs]</a>    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Flush stdout and logfile.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div></div>
        
<span class="c1">##################################################</span>
<span class="c1">#### CLASS Waves #################################</span>
<span class="c1">##################################################           </span>

<div class="viewcode-block" id="Waves"><a class="viewcode-back" href="../../orb.html#orb.core.Waves">[docs]</a><span class="k">class</span> <span class="nc">Waves</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Wave class that keep the best conversions possible from nm to cm1.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nm</span><span class="p">,</span> <span class="n">velocity</span><span class="o">=</span><span class="mf">0.</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param nm: Rest frame wavelength in nm. Must be a float, a</span>
<span class="sd">          string or an array of 1 dimension of floats and</span>
<span class="sd">          strings. Strings must be line names stored in Lines class.</span>
<span class="sd">        </span>
<span class="sd">        :param velocity: (Optional) Velocity in km/s (default 0.)</span>

<span class="sd">        .. note:: all parameters can be arrays of the same shape. If</span>
<span class="sd">        velocity is a float and nm is an array with a certain</span>
<span class="sd">        shape, the same velocity will be attributed to all</span>
<span class="sd">        wavelengths.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nm</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;nm must be an array of dimension 1&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nm</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">nm</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">nm</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">nm</span><span class="p">])</span>

        <span class="n">nm_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">inm</span> <span class="ow">in</span> <span class="n">nm</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inm</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">nm_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Lines</span><span class="p">()</span><span class="o">.</span><span class="n">get_line_nm</span><span class="p">(</span><span class="n">inm</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nm_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">inm</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nm_list</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">longdouble</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_velocity</span><span class="p">(</span><span class="n">velocity</span><span class="p">)</span>
        
<div class="viewcode-block" id="Waves.set_velocity"><a class="viewcode-back" href="../../orb.html#orb.core.Waves.set_velocity">[docs]</a>    <span class="k">def</span> <span class="nf">set_velocity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">velocity</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set waves velocity.</span>

<span class="sd">        :param velocity: velocity in km/s</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">velocity</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">velocity</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">velocity</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">velocity</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nm</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Velocity array shape must be the same as nm shape&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">velocity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">velocity</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">longdouble</span><span class="p">)</span></div>

<div class="viewcode-block" id="Waves.get_nm"><a class="viewcode-back" href="../../orb.html#orb.core.Waves.get_nm">[docs]</a>    <span class="k">def</span> <span class="nf">get_nm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return wavelength of waves in nm (taking velocity into account)&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nm</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">line_shift</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">velocity</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nm</span><span class="p">,</span> <span class="n">wavenumber</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="Waves.get_cm1"><a class="viewcode-back" href="../../orb.html#orb.core.Waves.get_cm1">[docs]</a>    <span class="k">def</span> <span class="nf">get_cm1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return wavenumber of waves in cm-1 (taking velocity into account)&quot;&quot;&quot;</span>
        <span class="n">cm1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cm1_rest</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">cm1</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">line_shift</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">velocity</span><span class="p">,</span> <span class="n">cm1</span><span class="p">,</span> <span class="n">wavenumber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="Waves.get_nm_rest"><a class="viewcode-back" href="../../orb.html#orb.core.Waves.get_nm_rest">[docs]</a>    <span class="k">def</span> <span class="nf">get_nm_rest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;&quot;Return restframe wavelength of waves in nm&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nm</span><span class="p">)</span></div>

<div class="viewcode-block" id="Waves.get_cm1_rest"><a class="viewcode-back" href="../../orb.html#orb.core.Waves.get_cm1_rest">[docs]</a>    <span class="k">def</span> <span class="nf">get_cm1_rest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return restframe wavelength of waves in cm-1&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">utils</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">nm2cm1</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nm</span><span class="p">)</span></div></div>




<span class="c1">#################################################</span>
<span class="c1">#### CLASS Standard #############################</span>
<span class="c1">#################################################</span>
<div class="viewcode-block" id="Standard"><a class="viewcode-back" href="../../orb.html#orb.core.Standard">[docs]</a><span class="k">class</span> <span class="nc">Standard</span><span class="p">(</span><span class="n">Tools</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Manage standard files and photometrical calibration&quot;&quot;&quot;</span>

    <span class="n">ang</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Angstrom axis of the standard file</span>
    <span class="n">flux</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Flux of the standard in erg/cm2/s/Ang</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">std_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize Standard class.</span>

<span class="sd">        :param std_name: Name of the standard.</span>

<span class="sd">        :param kwargs: Kwargs are :meth:`core.Tools` properties.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Tools</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
             
        <span class="n">std_file_path</span><span class="p">,</span> <span class="n">std_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_standard_file_path</span><span class="p">(</span><span class="n">std_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">std_type</span> <span class="o">==</span> <span class="s1">&#39;MASSEY&#39;</span> <span class="ow">or</span> <span class="n">std_type</span> <span class="o">==</span> <span class="s1">&#39;MISC&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ang</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">flux</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_massey_dat</span><span class="p">(</span><span class="n">std_file_path</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">std_type</span> <span class="o">==</span> <span class="s1">&#39;CALSPEC&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ang</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">flux</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_calspec_fits</span><span class="p">(</span><span class="n">std_file_path</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">std_type</span> <span class="o">==</span> <span class="s1">&#39;OKE&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ang</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">flux</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_oke_dat</span><span class="p">(</span><span class="n">std_file_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span>
                <span class="s2">&quot;Bad type of standard file. Must be &#39;MASSEY&#39;, &#39;CALSPEC&#39;, &#39;MISC&#39; or &#39;OKE&#39;&quot;</span><span class="p">)</span>
       

    <span class="k">def</span> <span class="nf">_get_data_prefix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">curdir</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="s1">&#39;STANDARD&#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span>
                <span class="o">+</span> <span class="s1">&#39;STD&#39;</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="Standard.get_spectrum"><a class="viewcode-back" href="../../orb.html#orb.core.Standard.get_spectrum">[docs]</a>    <span class="k">def</span> <span class="nf">get_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">wavenumber</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">corr</span><span class="o">=</span><span class="mf">1.</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return part of the standard spectrum corresponding to the</span>
<span class="sd">        observation parameters.</span>

<span class="sd">        Returned spectrum is calibrated in erg/cm^2/s/A</span>

<span class="sd">        :param order: Folding order</span>
<span class="sd">        </span>
<span class="sd">        :param step: Step size in um</span>
<span class="sd">        </span>
<span class="sd">        :param n: Number of steps</span>
<span class="sd">        </span>
<span class="sd">        :param wavenumber: (Optional) If True spectrum is returned along a</span>
<span class="sd">          wavenumber axis (default False).</span>
<span class="sd">          </span>
<span class="sd">        :param corr: (Optional) Correction coefficient related to the incident</span>
<span class="sd">          angle (default 1).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">wavenumber</span><span class="p">:</span>
            <span class="n">axis</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">create_cm1_axis</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">corr</span><span class="o">=</span><span class="n">corr</span><span class="p">)</span>
            <span class="n">old_axis</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">nm2cm1</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ang</span> <span class="o">/</span> <span class="mf">10.</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">axis</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">create_nm_axis</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">corr</span><span class="o">=</span><span class="n">corr</span><span class="p">)</span>
            <span class="n">old_axis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ang</span> <span class="o">/</span> <span class="mf">10.</span>
        
        <span class="k">return</span> <span class="n">axis</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">vector</span><span class="o">.</span><span class="n">interpolate_axis</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">old_axis</span><span class="o">=</span><span class="n">old_axis</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_read_oke_dat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read a data file from Oke J. B., Faint spectrophotometric</span>
<span class="sd">        standards, AJ, (1990) and return a tuple of arrays (wavelength,</span>
<span class="sd">        flux).</span>
<span class="sd">        </span>
<span class="sd">        Returned wavelength axis is in A. Returned flux is converted</span>
<span class="sd">        in erg/cm^2/s/A.</span>

<span class="sd">        :param file_path: Path to the Oke dat file (&#39;fXX.dat&#39;).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">std_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
        
        <span class="n">spec_ang</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">spec_flux</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">std_file</span><span class="p">:</span>
             <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
             <span class="n">spec_ang</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
             <span class="n">spec_flux</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">spec_ang</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">spec_ang</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">spec_flux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">spec_flux</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-16</span>

        <span class="k">return</span> <span class="n">spec_ang</span><span class="p">,</span> <span class="n">spec_flux</span>



    <span class="k">def</span> <span class="nf">_read_massey_dat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read a data file from Massey et al., Spectrophotometric</span>
<span class="sd">        Standards (1988) and return a tuple of arrays (wavelength,</span>
<span class="sd">        flux).</span>
<span class="sd">        </span>
<span class="sd">        Returned wavelength axis is in A. Returned flux is converted</span>
<span class="sd">        in erg/cm^2/s/A.</span>

<span class="sd">        :param file_path: Path to the Massey dat file (generally</span>
<span class="sd">          &#39;spXX.dat&#39;).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">std_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
        
        <span class="n">spec_ang</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">spec_mag</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">std_file</span><span class="p">:</span>
             <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
             <span class="n">spec_ang</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
             <span class="n">spec_mag</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">spec_ang</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">spec_ang</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">spec_mag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">spec_mag</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        
        <span class="c1"># convert mag to flux in erg/cm^2/s/A</span>
        <span class="n">spec_flux</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">photometry</span><span class="o">.</span><span class="n">ABmag2flambda</span><span class="p">(</span><span class="n">spec_mag</span><span class="p">,</span> <span class="n">spec_ang</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">spec_ang</span><span class="p">,</span> <span class="n">spec_flux</span>

    <span class="k">def</span> <span class="nf">_read_calspec_fits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read a CALSPEC fits file containing a standard spectrum and</span>
<span class="sd">          return a tuple of arrays (wavelength, flux).</span>

<span class="sd">        Returned wavelength axis is in A. Returned flux is in</span>
<span class="sd">        erg/cm^2/s/A.</span>
<span class="sd">        </span>
<span class="sd">        :param file_path: Path to the Massey dat file (generally</span>
<span class="sd">          &#39;spXX.dat&#39;).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hdu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_fits</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">return_hdu_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_print_msg</span><span class="p">(</span><span class="s1">&#39;Calspec file flux unit: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;TUNIT2&#39;</span><span class="p">])</span>
        
        <span class="c1"># wavelength is in A</span>
        <span class="n">spec_ang</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">data</span><span class="p">[</span><span class="n">ik</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))])</span>

        <span class="c1"># flux is in erg/cm2/s/A</span>
        <span class="n">spec_flux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">data</span><span class="p">[</span><span class="n">ik</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))])</span>

        <span class="k">return</span> <span class="n">spec_ang</span><span class="p">,</span> <span class="n">spec_flux</span>


<div class="viewcode-block" id="Standard.compute_star_flux_in_frame"><a class="viewcode-back" href="../../orb.html#orb.core.Standard.compute_star_flux_in_frame">[docs]</a>    <span class="k">def</span> <span class="nf">compute_star_flux_in_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">filter_name</span><span class="p">,</span>
                                   <span class="n">camera_number</span><span class="p">,</span> <span class="n">airmass</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">corr</span><span class="o">=</span><span class="mf">1.</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return flux in ADU/s in an image.</span>

<span class="sd">        :param step: Step size in nm</span>
<span class="sd">        :param order: Folding order</span>
<span class="sd">        :param filter_name: Name fo the filter</span>
<span class="sd">        :param optics_file_path: Path to the optics file</span>
<span class="sd">        :param camera_number: Number of the camera</span>
<span class="sd">        :param airmass: (Optional) Airmass (default 1)</span>
<span class="sd">        :param corr: (Optional) Correction coefficient related to the</span>
<span class="sd">           incident angle (default 1).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">STEP_NB</span> <span class="o">=</span> <span class="mi">1000</span>
        <span class="n">camera_number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">camera_number</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">camera_number</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s1">&#39;Camera number must be 1 or 2&#39;</span><span class="p">)</span>
        
        <span class="p">(</span><span class="n">filter_trans</span><span class="p">,</span>
         <span class="n">filter_min</span><span class="p">,</span> <span class="n">filter_max</span><span class="p">)</span> <span class="o">=</span> <span class="n">FilterFile</span><span class="p">(</span><span class="n">filter_name</span><span class="p">)</span><span class="o">.</span><span class="n">get_filter_function</span><span class="p">(</span>
            <span class="n">step</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">STEP_NB</span><span class="p">,</span> <span class="n">corr</span><span class="o">=</span><span class="n">corr</span><span class="p">)</span>
        
        <span class="n">nm_axis</span><span class="p">,</span> <span class="n">std_spectrum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_spectrum</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">STEP_NB</span><span class="p">,</span> <span class="n">corr</span><span class="o">=</span><span class="n">corr</span><span class="p">)</span>

        <span class="n">atm_trans</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">photometry</span><span class="o">.</span><span class="n">get_atmospheric_transmission</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_atmospheric_extinction_file_path</span><span class="p">(),</span>
            <span class="n">step</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">STEP_NB</span><span class="p">,</span> <span class="n">airmass</span><span class="o">=</span><span class="n">airmass</span><span class="p">,</span> <span class="n">corr</span><span class="o">=</span><span class="n">corr</span><span class="p">)</span>

        <span class="n">qe_cam</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">photometry</span><span class="o">.</span><span class="n">get_quantum_efficiency</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_quantum_efficiency_file_path</span><span class="p">(</span><span class="n">camera_number</span><span class="p">),</span>
            <span class="n">step</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">STEP_NB</span><span class="p">,</span> <span class="n">corr</span><span class="o">=</span><span class="n">corr</span><span class="p">)</span>

        <span class="n">mirror_trans</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">photometry</span><span class="o">.</span><span class="n">get_mirror_transmission</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_mirror_transmission_file_path</span><span class="p">(),</span>
            <span class="n">step</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">STEP_NB</span><span class="p">,</span> <span class="n">corr</span><span class="o">=</span><span class="n">corr</span><span class="p">)</span>
        
        <span class="n">optics_trans</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">photometry</span><span class="o">.</span><span class="n">get_optics_transmission</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_optics_file_path</span><span class="p">(</span><span class="n">filter_name</span><span class="p">),</span>
            <span class="n">step</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">STEP_NB</span><span class="p">,</span> <span class="n">corr</span><span class="o">=</span><span class="n">corr</span><span class="p">)</span>

        <span class="n">star_flux</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">photometry</span><span class="o">.</span><span class="n">compute_star_flux_in_frame</span><span class="p">(</span>
            <span class="n">nm_axis</span><span class="p">,</span> <span class="n">std_spectrum</span><span class="p">,</span>
            <span class="n">filter_trans</span><span class="p">,</span> <span class="n">optics_trans</span><span class="p">,</span> <span class="n">atm_trans</span><span class="p">,</span>
            <span class="n">mirror_trans</span><span class="p">,</span> <span class="n">qe_cam</span><span class="p">,</span>
            <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_config_parameter</span><span class="p">(</span><span class="s1">&#39;MIR_SURFACE&#39;</span><span class="p">)),</span>
            <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_config_parameter</span><span class="p">(</span><span class="s1">&#39;CAM</span><span class="si">{}</span><span class="s1">_GAIN&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">camera_number</span><span class="p">))))</span>
        <span class="k">return</span> <span class="n">star_flux</span></div>
        

<div class="viewcode-block" id="Standard.compute_optimal_texp"><a class="viewcode-back" href="../../orb.html#orb.core.Standard.compute_optimal_texp">[docs]</a>    <span class="k">def</span> <span class="nf">compute_optimal_texp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">seeing</span><span class="p">,</span> <span class="n">filter_name</span><span class="p">,</span>
                             <span class="n">camera_number</span><span class="p">,</span>
                             <span class="n">saturation</span><span class="o">=</span><span class="mi">30000</span><span class="p">,</span> <span class="n">airmass</span><span class="o">=</span><span class="mf">1.</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Compute the optimal exposition time given the total flux of</span>
<span class="sd">        the star in ADU/s.</span>

<span class="sd">        :param step: Step size in nm</span>
<span class="sd">        </span>
<span class="sd">        :param order: Folding order</span>
<span class="sd">        </span>
<span class="sd">        :param seeing: Star&#39;s FWHM in arcsec</span>
<span class="sd">        </span>
<span class="sd">        :param filter_name: Name of the filter</span>
<span class="sd">        </span>
<span class="sd">        :param camera_number: Number of the camera</span>
<span class="sd">        </span>
<span class="sd">        :param saturation: (Optional) Saturation value of the detector</span>
<span class="sd">          (default 30000).</span>

<span class="sd">        :param airmass: (Optional) Airmass (default 1)    </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">star_flux</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_star_flux_in_frame</span><span class="p">(</span>
            <span class="n">step</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">filter_name</span><span class="p">,</span>
            <span class="n">camera_number</span><span class="p">,</span> <span class="n">airmass</span><span class="o">=</span><span class="n">airmass</span><span class="p">)</span>
        
        <span class="n">dimx</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_config_parameter</span><span class="p">(</span>
            <span class="s1">&#39;CAM</span><span class="si">{}</span><span class="s1">_DETECTOR_SIZE_X&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">camera_number</span><span class="p">)))</span>
        <span class="n">dimy</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_config_parameter</span><span class="p">(</span>
            <span class="s1">&#39;CAM</span><span class="si">{}</span><span class="s1">_DETECTOR_SIZE_Y&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">camera_number</span><span class="p">)))</span>
        <span class="n">fov</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_config_parameter</span><span class="p">(</span>
            <span class="s1">&#39;FIELD_OF_VIEW_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">camera_number</span><span class="p">)))</span>

        <span class="n">plate_scale</span> <span class="o">=</span> <span class="n">fov</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">dimx</span><span class="p">,</span> <span class="n">dimy</span><span class="p">)</span> <span class="o">*</span> <span class="mi">60</span> <span class="c1"># arcsec</span>
        <span class="k">return</span> <span class="n">utils</span><span class="o">.</span><span class="n">photometry</span><span class="o">.</span><span class="n">compute_optimal_texp</span><span class="p">(</span>
            <span class="n">star_flux</span><span class="p">,</span> <span class="n">seeing</span><span class="p">,</span>
            <span class="n">plate_scale</span><span class="p">,</span>
            <span class="n">saturation</span><span class="o">=</span><span class="n">saturation</span><span class="p">)</span></div></div>


<span class="c1">#################################################</span>
<span class="c1">#### CLASS Header ###############################</span>
<span class="c1">#################################################</span>
<div class="viewcode-block" id="Header"><a class="viewcode-back" href="../../orb.html#orb.core.Header">[docs]</a><span class="k">class</span> <span class="nc">Header</span><span class="p">(</span><span class="n">pyfits</span><span class="o">.</span><span class="n">Header</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Extension of :py:class:`astropy.io.fits.Header`&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize Header class.</span>

<span class="sd">        :param args: args of :py:class:`astropy.io.fits.Header`</span>

<span class="sd">        :param kwargs: Kwargs of :py:class:`astropy.io.fits.Header`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pyfits</span><span class="o">.</span><span class="n">Header</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span> <span class="o">=</span> <span class="n">pywcs</span><span class="o">.</span><span class="n">WCS</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="Header.bin_wcs"><a class="viewcode-back" href="../../orb.html#orb.core.Header.bin_wcs">[docs]</a>    <span class="k">def</span> <span class="nf">bin_wcs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">binning</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Bin WCS</span>

<span class="sd">        :param binning: Binning</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">crpix</span> <span class="o">/=</span> <span class="n">binning</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">cdelt</span> <span class="o">*=</span> <span class="n">binning</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">to_header</span><span class="p">(),</span> <span class="n">update</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div></div>


<span class="c1">#################################################</span>
<span class="c1">#### CLASS FilterFile ###########################</span>
<span class="c1">#################################################</span>
<div class="viewcode-block" id="FilterFile"><a class="viewcode-back" href="../../orb.html#orb.core.FilterFile">[docs]</a><span class="k">class</span> <span class="nc">FilterFile</span><span class="p">(</span><span class="n">Tools</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Manage filter files&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filter_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize FilterFile class.</span>

<span class="sd">        :param filter_name: Name of the filter.</span>

<span class="sd">        :param kwargs: Kwargs are :meth:`core.Tools` properties.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Tools</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">basic_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_filter_file_path</span><span class="p">(</span><span class="n">filter_name</span><span class="p">)</span>

<div class="viewcode-block" id="FilterFile.read_filter_file"><a class="viewcode-back" href="../../orb.html#orb.core.FilterFile.read_filter_file">[docs]</a>    <span class="k">def</span> <span class="nf">read_filter_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Wrapper around</span>
<span class="sd">        :py:meth:`orb.utils.filters.read_filter_file`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">utils</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">read_filter_file</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">basic_path</span><span class="p">)</span></div>

<div class="viewcode-block" id="FilterFile.get_filter_function"><a class="viewcode-back" href="../../orb.html#orb.core.FilterFile.get_filter_function">[docs]</a>    <span class="k">def</span> <span class="nf">get_filter_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">step_nb</span><span class="p">,</span>
                            <span class="n">wavenumber</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">corr</span><span class="o">=</span><span class="mf">1.</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Wrapper around</span>
<span class="sd">        :py:meth:`orb.utils.filters.get_filter_function`.</span>

<span class="sd">        Parameters are the same.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">utils</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">get_filter_function</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">basic_path</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span>
            <span class="n">step_nb</span><span class="p">,</span> <span class="n">wavenumber</span><span class="o">=</span><span class="n">wavenumber</span><span class="p">,</span>
            <span class="n">corr</span><span class="o">=</span><span class="n">corr</span><span class="p">)</span></div>

<div class="viewcode-block" id="FilterFile.get_modulation_efficiency"><a class="viewcode-back" href="../../orb.html#orb.core.FilterFile.get_modulation_efficiency">[docs]</a>    <span class="k">def</span> <span class="nf">get_modulation_efficiency</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Wrapper around</span>
<span class="sd">        :py:meth:`orb.utils.filters.get_modulation_efficiency`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">utils</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">get_modulation_efficiency</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">basic_path</span><span class="p">)</span></div>

<div class="viewcode-block" id="FilterFile.get_observation_params"><a class="viewcode-back" href="../../orb.html#orb.core.FilterFile.get_observation_params">[docs]</a>    <span class="k">def</span> <span class="nf">get_observation_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Wrapper around</span>
<span class="sd">        :py:meth:`orb.utils.filters.get_observation_params`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">basic_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">utils</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">get_observation_params</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">basic_path</span><span class="p">)</span></div>

<div class="viewcode-block" id="FilterFile.get_phase_fit_order"><a class="viewcode-back" href="../../orb.html#orb.core.FilterFile.get_phase_fit_order">[docs]</a>    <span class="k">def</span> <span class="nf">get_phase_fit_order</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Wrapper around</span>
<span class="sd">        :py:meth:`orb.utils.filters.get_phase_fit_order`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">utils</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">get_phase_fit_order</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">basic_path</span><span class="p">)</span></div>

<div class="viewcode-block" id="FilterFile.get_filter_bandpass"><a class="viewcode-back" href="../../orb.html#orb.core.FilterFile.get_filter_bandpass">[docs]</a>    <span class="k">def</span> <span class="nf">get_filter_bandpass</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Wrapper around</span>
<span class="sd">        :py:meth:`orb.utils.filters.get_filter_bandpass`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">utils</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">get_filter_bandpass</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">basic_path</span><span class="p">)</span></div></div>


<span class="c1">#################################################</span>
<span class="c1">#### CLASS PhaseFile ############################</span>
<span class="c1">#################################################</span>
<div class="viewcode-block" id="PhaseFile"><a class="viewcode-back" href="../../orb.html#orb.core.PhaseFile">[docs]</a><span class="k">class</span> <span class="nc">PhaseFile</span><span class="p">(</span><span class="n">Tools</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Manage phase files&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filter_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize PhaseFile class.</span>

<span class="sd">        :param filter_name: Name of the filter.</span>

<span class="sd">        :param kwargs: Kwargs are :meth:`core.Tools` properties.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Tools</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">basic_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_phase_file_path</span><span class="p">(</span><span class="n">filter_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">improved_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basic_path</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.hdf5&#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">improved_path</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_warning</span><span class="p">(</span><span class="s1">&#39;Improved phase file </span><span class="si">{}</span><span class="s1"> does not exist !&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">improved_path</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">basic_phase</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">read_phase_file</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">basic_path</span><span class="p">,</span> <span class="n">return_spline</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">basic_phase</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_hdf5</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">improved_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">inf</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;angles&#39;</span> <span class="ow">in</span> <span class="n">inf</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">angles</span> <span class="o">=</span> <span class="n">inf</span><span class="p">[</span><span class="s1">&#39;angles&#39;</span><span class="p">][:]</span>
                <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s1">&#39;Badly formatted phase file: angles is missing&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;phases&#39;</span> <span class="ow">in</span> <span class="n">inf</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">phases</span> <span class="o">=</span> <span class="n">inf</span><span class="p">[</span><span class="s1">&#39;phases&#39;</span><span class="p">][:]</span>
                <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s1">&#39;Badly formatted phase file: phases is missing&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;phases_err_min&#39;</span> <span class="ow">in</span> <span class="n">inf</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">phases_err_min</span> <span class="o">=</span> <span class="n">inf</span><span class="p">[</span><span class="s1">&#39;phases_err_min&#39;</span><span class="p">][:]</span>
                <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s1">&#39;Badly formatted phase file: phases_err_min is missing&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;phases_err_max&#39;</span> <span class="ow">in</span> <span class="n">inf</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">phases_err_max</span> <span class="o">=</span> <span class="n">inf</span><span class="p">[</span><span class="s1">&#39;phases_err_max&#39;</span><span class="p">][:]</span>
                <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s1">&#39;Badly formatted phase file: phases_err_max is missing&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="s1">&#39;step&#39;</span> <span class="ow">in</span> <span class="n">inf</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="n">inf</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;step&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s1">&#39;Badly formatted phase file: step attribute is missing&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;order&#39;</span> <span class="ow">in</span> <span class="n">inf</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="n">inf</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s1">&#39;Badly formatted phase file: order attribute is missing&#39;</span><span class="p">)</span>

            


<div class="viewcode-block" id="PhaseFile.write_improved_phase_file"><a class="viewcode-back" href="../../orb.html#orb.core.PhaseFile.write_improved_phase_file">[docs]</a>    <span class="k">def</span> <span class="nf">write_improved_phase_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">angles</span><span class="p">,</span> <span class="n">phases</span><span class="p">,</span>
                                  <span class="n">phases_err_min</span><span class="p">,</span> <span class="n">phases_err_max</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write an improved phase file as an hdf5 archive.</span>

<span class="sd">        :param step: Step size in nm</span>

<span class="sd">        :param order: Folding order.</span>
<span class="sd">        </span>
<span class="sd">        :param angles: limit angles of each phase group.</span>
<span class="sd">        </span>
<span class="sd">        :param phases: list of phase vectors corresponding to each</span>
<span class="sd">          angle group.</span>
<span class="sd">        </span>
<span class="sd">        :param phases_err_min: list of min error vectors of each phase</span>
<span class="sd">          vector.</span>
<span class="sd">        </span>
<span class="sd">        :param phases_err_max: list of max error vectors of each phase</span>
<span class="sd">          vector.</span>

<span class="sd">        .. warning:: To avoid unwanted replacement of ORB&#39;s data files</span>
<span class="sd">          the phase file is not written in ORB folder but at the root</span>
<span class="sd">          folder. It must thus be placed in the orb/data folder to be</span>
<span class="sd">          readable with self.read_improved_phase_file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">improved_path</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_hdf5</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outf</span><span class="p">:</span>
            <span class="n">outf</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;step&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">step</span>
            <span class="n">outf</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">order</span>
            <span class="n">outf</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;angles&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">angles</span><span class="p">))</span>
            <span class="n">outf</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;phases&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">phases</span><span class="p">))</span>
            <span class="n">outf</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;phases_err_min&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">phases_err_min</span><span class="p">))</span>
            <span class="n">outf</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;phases_err_max&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">phases_err_max</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print_msg</span><span class="p">(</span><span class="s1">&#39;Improved phase file </span><span class="si">{}</span><span class="s1"> written&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span></div>
        

<div class="viewcode-block" id="PhaseFile.get_improved_phase"><a class="viewcode-back" href="../../orb.html#orb.core.PhaseFile.get_improved_phase">[docs]</a>    <span class="k">def</span> <span class="nf">get_improved_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">calib_laser_nm</span><span class="p">,</span> <span class="n">return_spline</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a scipy.interpolate.UnivariateSpline instance</span>
<span class="sd">        corresponding to the phase at a given calibration laser</span>
<span class="sd">        wavelength (i.e. a given incident angle theta).</span>

<span class="sd">        :param calib_laser_nm: Calibration laser wavelength in nm.</span>

<span class="sd">        :param return_spline: (Optional) If not True, the phase vector</span>
<span class="sd">          is returned without any spline interpolation. Useful and</span>
<span class="sd">          faster when no interpolation is needed (default True).</span>

<span class="sd">        .. note:: The returned spline is projected along an axis in</span>
<span class="sd">          cm-1</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">basic_phase</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">basic_phase</span>
        
        <span class="n">argmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanargmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angles</span> <span class="o">&gt;</span> <span class="n">calib_laser_nm</span><span class="p">)</span>
        <span class="n">calib_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">angles</span><span class="p">[</span><span class="n">argmax</span><span class="p">]</span>
        <span class="n">calib_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">angles</span><span class="p">[</span><span class="n">argmax</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">ratio</span> <span class="o">=</span> <span class="p">(</span><span class="n">calib_laser_nm</span> <span class="o">-</span> <span class="n">calib_min</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">calib_max</span> <span class="o">-</span> <span class="n">calib_min</span><span class="p">)</span>
        <span class="n">ph_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phases</span><span class="p">[</span><span class="n">argmax</span><span class="p">,:]</span>
        <span class="n">ph_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phases</span><span class="p">[</span><span class="n">argmax</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,:]</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="p">(</span><span class="n">ph_max</span> <span class="o">*</span> <span class="n">ratio</span> <span class="o">+</span> <span class="n">ph_min</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">ratio</span><span class="p">))</span>
        
        <span class="n">cm1_axis</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">create_cm1_axis</span><span class="p">(</span>
            <span class="n">phase</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">,</span>
            <span class="n">corr</span><span class="o">=</span><span class="n">calib_laser_nm</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_get_config_parameter</span><span class="p">(</span><span class="s1">&#39;CALIB_NM_LASER&#39;</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">return_spline</span><span class="p">:</span>
            <span class="n">nonans</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">UnivariateSpline</span><span class="p">(</span>
                <span class="n">cm1_axis</span><span class="p">[</span><span class="n">nonans</span><span class="p">],</span> <span class="n">phase</span><span class="p">[</span><span class="n">nonans</span><span class="p">],</span> <span class="n">k</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="n">phase</span></div></div>
            
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, Author.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.5.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.8</a>
      
    </div>

    

    
  </body>
</html>
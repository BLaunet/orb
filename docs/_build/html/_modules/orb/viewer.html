<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>orb.viewer &#8212; orb  documentation</title>
    
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for orb.viewer</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/python</span>
<span class="c1"># *-* coding: utf-8 *-*</span>
<span class="c1"># Author: Thomas Martin &lt;thomas.martin.1@ulaval.ca&gt; </span>
<span class="c1"># File: visual.py</span>

<span class="c1">## Copyright (c) 2010-2016 Thomas Martin &lt;thomas.martin.1@ulaval.ca&gt;</span>
<span class="c1">## </span>
<span class="c1">## This file is part of ORB</span>
<span class="c1">##</span>
<span class="c1">## ORB is free software: you can redistribute it and/or modify it</span>
<span class="c1">## under the terms of the GNU General Public License as published by</span>
<span class="c1">## the Free Software Foundation, either version 3 of the License, or</span>
<span class="c1">## (at your option) any later version.</span>
<span class="c1">##</span>
<span class="c1">## ORB is distributed in the hope that it will be useful, but WITHOUT</span>
<span class="c1">## ANY WARRANTY; without even the implied warranty of MERCHANTABILITY</span>
<span class="c1">## or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public</span>
<span class="c1">## License for more details.</span>
<span class="c1">##</span>
<span class="c1">## You should have received a copy of the GNU General Public License</span>
<span class="c1">## along with ORB.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>


<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="c1"># ORB IMPORTS</span>
<span class="kn">from</span> <span class="nn">core</span> <span class="k">import</span> <span class="n">Tools</span><span class="p">,</span> <span class="n">HDFCube</span><span class="p">,</span> <span class="n">Lines</span>
<span class="kn">import</span> <span class="nn">utils.spectrum</span>
<span class="kn">import</span> <span class="nn">utils.fft</span>
<span class="kn">import</span> <span class="nn">utils.stats</span>
<span class="kn">import</span> <span class="nn">fit</span>
<span class="kn">import</span> <span class="nn">orb.cutils</span>

<span class="c1"># OTHER IMPORTS</span>
<span class="kn">import</span> <span class="nn">gtk</span><span class="o">,</span> <span class="nn">gobject</span>
<span class="kn">import</span> <span class="nn">gtk.gdk</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">astropy.wcs</span> <span class="k">as</span> <span class="nn">pywcs</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">bottleneck</span> <span class="k">as</span> <span class="nn">bn</span>

<span class="c1"># MATPLOTLIB GTK BACKEND</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;GTKAgg&#39;</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">matplotlib.colorbar</span> <span class="k">import</span> <span class="n">ColorbarBase</span>
<span class="kn">from</span> <span class="nn">matplotlib.backends.backend_gtkagg</span> <span class="k">import</span> <span class="n">FigureCanvasGTKAgg</span> <span class="k">as</span> <span class="n">FigureCanvas</span>
<span class="kn">from</span> <span class="nn">matplotlib.figure</span> <span class="k">import</span> <span class="n">Figure</span>
<span class="kn">from</span> <span class="nn">matplotlib.widgets</span> <span class="k">import</span> <span class="n">SpanSelector</span><span class="p">,</span> <span class="n">RectangleSelector</span><span class="p">,</span> <span class="n">EllipseSelector</span><span class="p">,</span> <span class="n">AxesWidget</span>
<span class="kn">from</span> <span class="nn">matplotlib.patches</span> <span class="k">import</span> <span class="n">Circle</span><span class="p">,</span> <span class="n">Rectangle</span>
<span class="kn">from</span> <span class="nn">matplotlib.lines</span> <span class="k">import</span> <span class="n">Line2D</span>

<span class="kn">import</span> <span class="nn">pylab</span> <span class="k">as</span> <span class="nn">pl</span>

<span class="n">gobject</span><span class="o">.</span><span class="n">threads_init</span><span class="p">()</span>


<span class="c1">###########################################</span>
<span class="c1">### CLASS BASEVIEWER ######################</span>
<span class="c1">###########################################</span>

<div class="viewcode-block" id="BaseViewer"><a class="viewcode-back" href="../../orb.html#orb.viewer.BaseViewer">[docs]</a><span class="k">class</span> <span class="nc">BaseViewer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class implements a basic viewer for FITS/HDF5</span>
<span class="sd">    cubes created with ORB modules.&quot;&quot;&quot;</span>

    <span class="n">filepath</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">image</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">init_set</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="n">xy_start</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">xy_stop</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="n">mode</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">key_pressed</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">header</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">dimx</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">dimy</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">dimz</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">wcs</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">hdf5</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># True if the cube is an HDF5 Cube</span>
    
    <span class="n">calib_map</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">root</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">select</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">canvas</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">old_canvas_objs</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">canvas_objs</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">plot</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="n">image_region</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="n">autocut_methods</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">zaxis</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">wavenumber</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">step</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">order</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">bunit</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">axis_corr</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">spectrum_window</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="n">_plugins_postload_calls</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

    <span class="n">DRAW_COLOR_DEFAULT</span> <span class="o">=</span> <span class="s1">&#39;green&#39;</span>
    
    <span class="n">BAD_WCS_FLAG</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">WINDOW_SIZE</span> <span class="o">=</span> <span class="p">(</span><span class="mi">550</span><span class="p">,</span><span class="mi">500</span><span class="p">)</span>

    <span class="n">MAX_CUBE_SIZE</span> <span class="o">=</span> <span class="mf">4.</span> <span class="c1"># Max cube size in Go</span>
    <span class="n">MAX_CUBE_SECTION_SIZE</span> <span class="o">=</span> <span class="mf">1.</span> <span class="c1"># max section size to load in Go</span>
 
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_file_name</span><span class="o">=</span><span class="s1">&#39;config.orb&#39;</span><span class="p">,</span> <span class="n">no_log</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Init BaseViewer</span>

<span class="sd">        :param config_file_name: (Optional) Name of ORB config file</span>
<span class="sd">          (default &#39;config.orb&#39;).</span>

<span class="sd">        :param no_log: (Optional) If True no logfile will be created</span>
<span class="sd">          for ORB specific warnings, info and errors (default True).</span>

<span class="sd">        :param debug: (Optional) If True, all messages are printed on</span>
<span class="sd">          stdout (default False).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">STD_FORMAT</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> | </span><span class="si">%(levelname)1.1s</span><span class="s1"> | </span><span class="si">%(filename)s</span><span class="s1">:</span><span class="si">%(lineno)d</span><span class="s1"> (</span><span class="si">%(funcName)s</span><span class="s1">) | </span><span class="si">%(message)s</span><span class="s1">&#39;</span>
    
        
        <span class="bp">self</span><span class="o">.</span><span class="n">tools</span> <span class="o">=</span> <span class="n">Tools</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">_no_log</span> <span class="o">=</span> <span class="n">no_log</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">config_file_name</span> <span class="o">=</span> <span class="n">config_file_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_set</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spectrum_channel</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wcs_rotation</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">_get_config_parameter</span><span class="p">(</span><span class="s1">&#39;WCS_ROTATION&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fov</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">_get_config_parameter</span><span class="p">(</span><span class="s1">&#39;FIELD_OF_VIEW_1&#39;</span><span class="p">))</span>
           
           
        <span class="c1"># Define GTK GUI</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">Window</span><span class="p">(</span><span class="n">gtk</span><span class="o">.</span><span class="n">WINDOW_TOPLEVEL</span><span class="p">)</span>
        <span class="n">root</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;ORB Viewer&quot;</span><span class="p">)</span>
        <span class="n">root</span><span class="o">.</span><span class="n">set_border_width</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">root</span><span class="o">.</span><span class="n">set_size_request</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">WINDOW_SIZE</span><span class="p">)</span>
        <span class="n">root</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;delete_event&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">w</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quit_cb</span><span class="p">(</span><span class="n">w</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">root</span>
        
        <span class="c1"># define ImageCanvas</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">regions</span> <span class="o">=</span> <span class="n">Regions</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span> <span class="o">=</span> <span class="n">ImageCanvas</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">regions</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;on-select-region&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_select_region_cb</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;on-move&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_move_cb</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">autocut_methods</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">get_autocut_methods</span><span class="p">()</span>

        <span class="c1"># VIEWER_HBOX</span>
        <span class="n">viewer_hbox</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">HBox</span><span class="p">(</span><span class="n">spacing</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    
        <span class="c1"># VIEWER_VBOX</span>
        <span class="n">viewer_vbox</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">VBox</span><span class="p">(</span><span class="n">spacing</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># IMAGE FRAME</span>
        <span class="n">imageframe</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">Frame</span><span class="p">(</span><span class="s1">&#39;Image&#39;</span><span class="p">)</span>
        <span class="n">imageframebox</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">VBox</span><span class="p">()</span>

        <span class="c1"># imageoptionsbox</span>
        <span class="n">imageoptionsbox</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">HBox</span><span class="p">()</span>
        
        <span class="c1"># autocut</span>
        <span class="n">autocutbox</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">VBox</span><span class="p">()</span>
        <span class="n">wautocuts</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">combo_box_new_text</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">autocut_methods</span><span class="p">:</span>
            <span class="n">wautocuts</span><span class="o">.</span><span class="n">append_text</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">wautocuts</span><span class="o">.</span><span class="n">set_active</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">autocut_index</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="n">wautocuts</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;changed&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_autocut_method_cb</span><span class="p">)</span>
        <span class="n">wautocuts_label</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="s1">&#39;Scale&#39;</span><span class="p">)</span>
        <span class="n">autocutbox</span><span class="o">.</span><span class="n">pack_start</span><span class="p">(</span><span class="n">wautocuts_label</span><span class="p">)</span>
        <span class="n">autocutbox</span><span class="o">.</span><span class="n">pack_start</span><span class="p">(</span><span class="n">wautocuts</span><span class="p">)</span>
        <span class="n">imageoptionsbox</span><span class="o">.</span><span class="n">pack_start</span><span class="p">(</span><span class="n">autocutbox</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># colormap </span>
        <span class="n">colormapbox</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">VBox</span><span class="p">()</span>
        <span class="n">wcolormap</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">combo_box_new_text</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">get_cmaps</span><span class="p">():</span>
            <span class="n">wcolormap</span><span class="o">.</span><span class="n">append_text</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">wcolormap</span><span class="o">.</span><span class="n">set_active</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">wcolormap</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;changed&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_colormap_cb</span><span class="p">)</span>
        <span class="n">wcolormap_label</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="s1">&#39;Color Map&#39;</span><span class="p">)</span>
        <span class="n">colormapbox</span><span class="o">.</span><span class="n">pack_start</span><span class="p">(</span><span class="n">wcolormap_label</span><span class="p">)</span>
        <span class="n">colormapbox</span><span class="o">.</span><span class="n">pack_start</span><span class="p">(</span><span class="n">wcolormap</span><span class="p">)</span>
        <span class="n">imageoptionsbox</span><span class="o">.</span><span class="n">pack_start</span><span class="p">(</span><span class="n">colormapbox</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># index scale</span>
        <span class="n">indexbox</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">VBox</span><span class="p">()</span>
        <span class="n">scalebox</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">HBox</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wimage_index</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">Adjustment</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                           <span class="n">upper</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">step_incr</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                           <span class="n">page_incr</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">wimage_index</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;value-changed&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_image_index_cb</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index_label</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="s1">&#39;Image index&#39;</span><span class="p">)</span>
        <span class="n">index_scale</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">HScale</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wimage_index</span><span class="p">)</span>
        <span class="n">index_scale</span><span class="o">.</span><span class="n">set_digits</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">index_scale</span><span class="o">.</span><span class="n">set_value_pos</span><span class="p">(</span><span class="n">gtk</span><span class="o">.</span><span class="n">POS_RIGHT</span><span class="p">)</span>
        <span class="n">index_scale</span><span class="o">.</span><span class="n">set_draw_value</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">indexbox</span><span class="o">.</span><span class="n">pack_start</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index_label</span><span class="p">)</span>
        <span class="n">scalebox</span><span class="o">.</span><span class="n">pack_start</span><span class="p">(</span><span class="n">index_scale</span><span class="p">)</span>
        <span class="n">index_button</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">SpinButton</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wimage_index</span><span class="p">)</span>
        <span class="n">index_button</span><span class="o">.</span><span class="n">set_digits</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">scalebox</span><span class="o">.</span><span class="n">pack_start</span><span class="p">(</span><span class="n">index_button</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">indexbox</span><span class="o">.</span><span class="n">pack_start</span><span class="p">(</span><span class="n">scalebox</span><span class="p">)</span>
        <span class="n">imageoptionsbox</span><span class="o">.</span><span class="n">pack_start</span><span class="p">(</span><span class="n">indexbox</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># space</span>
        <span class="n">spacebox</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">HBox</span><span class="p">()</span>
        <span class="n">imageoptionsbox</span><span class="o">.</span><span class="n">pack_start</span><span class="p">(</span><span class="n">spacebox</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># save button</span>
        <span class="n">savebox</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">VBox</span><span class="p">()</span>
        <span class="n">saveimage_label</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">saveimage</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="s1">&#39;Save Image&#39;</span><span class="p">)</span>
        <span class="n">saveimage</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;clicked&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_image_cb</span><span class="p">)</span>
        <span class="n">savebox</span><span class="o">.</span><span class="n">pack_start</span><span class="p">(</span><span class="n">saveimage</span><span class="p">)</span>
        <span class="n">savebox</span><span class="o">.</span><span class="n">pack_start</span><span class="p">(</span><span class="n">saveimage_label</span><span class="p">)</span>
        <span class="n">imageoptionsbox</span><span class="o">.</span><span class="n">pack_start</span><span class="p">(</span><span class="n">savebox</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        
        <span class="n">imageframebox</span><span class="o">.</span><span class="n">pack_start</span><span class="p">(</span><span class="n">imageoptionsbox</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">imageframebox</span><span class="o">.</span><span class="n">pack_start</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">get_widget</span><span class="p">(),</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="c1"># Coordsbox</span>
        <span class="n">coordsbox</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">HBox</span><span class="p">()</span>
        <span class="n">ra_label</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="s1">&#39;RA &#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ra</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">set_width_chars</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span>
        <span class="n">dec_label</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="s1">&#39; DEC &#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dec</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">set_width_chars</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span>
        <span class="n">x_label</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="s1">&#39; X &#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">set_width_chars</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">y_label</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="s1">&#39; Y &#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">set_width_chars</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">value_label</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="s1">&#39; Value &#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">set_width_chars</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">box</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ra_label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="n">gtk</span><span class="o">.</span><span class="n">VSeparator</span><span class="p">(),</span>
                    <span class="n">dec_label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="n">gtk</span><span class="o">.</span><span class="n">VSeparator</span><span class="p">(),</span>
                    <span class="n">x_label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">gtk</span><span class="o">.</span><span class="n">VSeparator</span><span class="p">(),</span>
                    <span class="n">y_label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">gtk</span><span class="o">.</span><span class="n">VSeparator</span><span class="p">(),</span>
                    <span class="n">value_label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">):</span>
            <span class="n">coordsbox</span><span class="o">.</span><span class="n">pack_start</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">imageframebox</span><span class="o">.</span><span class="n">pack_start</span><span class="p">(</span><span class="n">coordsbox</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Statbox</span>
        <span class="n">STAT_WIDTH</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">statsbox</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">HBox</span><span class="p">()</span>
        <span class="n">mean_label</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="s1">&#39;MEAN &#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mean</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="o">.</span><span class="n">set_width_chars</span><span class="p">(</span><span class="n">STAT_WIDTH</span><span class="p">)</span>
        <span class="n">median_label</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="s1">&#39; MED &#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">median</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">median</span><span class="o">.</span><span class="n">set_width_chars</span><span class="p">(</span><span class="n">STAT_WIDTH</span><span class="p">)</span>
        <span class="n">std_label</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="s1">&#39; STD &#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">std</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">std</span><span class="o">.</span><span class="n">set_width_chars</span><span class="p">(</span><span class="n">STAT_WIDTH</span><span class="p">)</span>
        <span class="n">sum_label</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="s1">&#39; SUM &#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sum</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sum</span><span class="o">.</span><span class="n">set_width_chars</span><span class="p">(</span><span class="n">STAT_WIDTH</span><span class="p">)</span>
        <span class="n">surf_label</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="s1">&#39; SURF &#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">surf</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">surf</span><span class="o">.</span><span class="n">set_width_chars</span><span class="p">(</span><span class="n">STAT_WIDTH</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">box</span> <span class="ow">in</span> <span class="p">(</span><span class="n">mean_label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span> <span class="n">gtk</span><span class="o">.</span><span class="n">VSeparator</span><span class="p">(),</span>
                    <span class="n">median_label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">median</span><span class="p">,</span> <span class="n">gtk</span><span class="o">.</span><span class="n">VSeparator</span><span class="p">(),</span>
                    <span class="n">std_label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">std</span><span class="p">,</span> <span class="n">gtk</span><span class="o">.</span><span class="n">VSeparator</span><span class="p">(),</span>
                    <span class="n">sum_label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sum</span><span class="p">,</span> <span class="n">gtk</span><span class="o">.</span><span class="n">VSeparator</span><span class="p">(),</span>
                    <span class="n">surf_label</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">surf</span><span class="p">):</span>
            <span class="n">statsbox</span><span class="o">.</span><span class="n">pack_start</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">imageframebox</span><span class="o">.</span><span class="n">pack_start</span><span class="p">(</span><span class="n">gtk</span><span class="o">.</span><span class="n">HSeparator</span><span class="p">(),</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">imageframebox</span><span class="o">.</span><span class="n">pack_start</span><span class="p">(</span><span class="n">statsbox</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">imageframe</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">imageframebox</span><span class="p">)</span>
        
        <span class="c1"># IMAGE BOX</span>
        <span class="n">imagebox</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">VBox</span><span class="p">(</span><span class="n">spacing</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">imagebox</span><span class="o">.</span><span class="n">pack_start</span><span class="p">(</span><span class="n">imageframe</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        
        <span class="c1"># MENU</span>
        <span class="k">def</span> <span class="nf">new_submenu</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">cb</span><span class="p">):</span>
            <span class="n">_m</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">MenuItem</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="n">_m</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;activate&#39;</span><span class="p">,</span> <span class="n">cb</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">_m</span>
   
        <span class="n">file_menu</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">Menu</span><span class="p">()</span>
        <span class="n">file_mi</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">MenuItem</span><span class="p">(</span><span class="s1">&#39;File&#39;</span><span class="p">)</span>
        <span class="n">file_mi</span><span class="o">.</span><span class="n">set_submenu</span><span class="p">(</span><span class="n">file_menu</span><span class="p">)</span>
        
        <span class="n">submenus</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">submenus</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_submenu</span><span class="p">(</span><span class="s1">&#39;Open...&#39;</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_open_file_cb</span><span class="p">))</span>
        <span class="n">submenus</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_submenu</span><span class="p">(</span><span class="s1">&#39;Display header...&#39;</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_display_header_cb</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">submenu</span> <span class="ow">in</span> <span class="n">submenus</span><span class="p">:</span>
            <span class="n">file_menu</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">submenu</span><span class="p">)</span>
        
        
        <span class="n">menu_bar</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">MenuBar</span><span class="p">()</span>
        <span class="n">menu_bar</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_mi</span><span class="p">)</span>

        <span class="c1"># append region submenu</span>
        <span class="n">menu_bar</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">regions</span><span class="o">.</span><span class="n">get_menubar_item</span><span class="p">())</span>
        
        <span class="c1"># PACK VIEWER_VBOX</span>
        <span class="n">viewer_vbox</span><span class="o">.</span><span class="n">pack_start</span><span class="p">(</span><span class="n">menu_bar</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        
        <span class="n">viewer_vbox</span><span class="o">.</span><span class="n">pack_start</span><span class="p">(</span><span class="n">imagebox</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># add plugins</span>
        <span class="n">plugins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_vplugins</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">plugin</span> <span class="ow">in</span> <span class="n">plugins</span><span class="p">:</span>
            <span class="n">viewer_hbox</span><span class="o">.</span><span class="n">pack_start</span><span class="p">(</span><span class="n">plugin</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># PACK VIEWER_HBOX</span>
        <span class="n">viewer_hbox</span><span class="o">.</span><span class="n">pack_start</span><span class="p">(</span><span class="n">viewer_vbox</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># add plugins</span>
        <span class="n">plugins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_hplugins</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">plugin</span> <span class="ow">in</span> <span class="n">plugins</span><span class="p">:</span>
            <span class="n">viewer_hbox</span><span class="o">.</span><span class="n">pack_start</span><span class="p">(</span><span class="n">plugin</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># ADD to ROOT</span>
        <span class="n">root</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">viewer_hbox</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">connect_all</span><span class="p">()</span> <span class="c1"># muy important</span>
        <span class="n">root</span><span class="o">.</span><span class="n">show_all</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_print_traceback</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print a traceback&quot;&quot;&quot;</span>
        <span class="nb">print</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>


    <span class="k">def</span> <span class="nf">_get_vplugins</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A list of plugins (returned as a list of gtk.Box instance)</span>
<span class="sd">        may be defined and incerted here. It will be packed vertically</span>
<span class="sd">        at the bottom of the basic view.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">_get_hplugins</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A list of plugins (returned as a list of gtk.Box instance)</span>
<span class="sd">        may be defined and incerted here. It will be packed horizontally</span>
<span class="sd">        at the left of the basic view.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[]</span>
    

    <span class="k">def</span> <span class="nf">_reload_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reload a file and update the displayed data. The file might</span>
<span class="sd">        have a new size.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span> <span class="s1">&#39; &gt; Reloading </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">,</span> <span class="n">reload</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_change_region_properties_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">regions</span><span class="p">):</span>
        <span class="c1">#self.canvas.set_drawtype(</span>
        <span class="c1">#    regions.get_shape(), color=self.DRAW_COLOR_DEFAULT, alpha=1)</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_set_colormap_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">set_cmap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">get_cmaps</span><span class="p">()[</span><span class="n">c</span><span class="o">.</span><span class="n">get_active</span><span class="p">()])</span>
        
    <span class="k">def</span> <span class="nf">_open_file_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;open-file callback</span>

<span class="sd">        Popup a File chooser dialog to open a new file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_set</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pop_file_chooser_dialog</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">load_file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;open&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_display_header_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;display-header callback</span>

<span class="sd">        Popup a window with the printed header</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">HeaderWindow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
        <span class="n">w</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">_set_image_index_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;value-changed callback</span>

<span class="sd">        Changed the index of the displayed image</span>

<span class="sd">        :param c: Caller Instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">get_value</span><span class="p">())</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">zaxis</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">zval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zaxis</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">get_value</span><span class="p">()]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wavenumber</span><span class="p">:</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;cm-1&#39;</span>
                <span class="n">conv</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.2f}</span><span class="s1"> nm&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">cm12nm</span><span class="p">(</span><span class="n">zval</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;nm&#39;</span>
                <span class="n">conv</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.2f}</span><span class="s1"> cm-1&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">nm2cm1</span><span class="p">(</span><span class="n">zval</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">index_label</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:.2f}</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> (</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">zval</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">conv</span><span class="p">))</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">update_image</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cube</span><span class="p">[:,:,</span><span class="n">val</span><span class="p">])</span>
    
    <span class="k">def</span> <span class="nf">_save_image_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;save-image callback</span>

<span class="sd">        Pop a file chooser dialog to save the displayed Image</span>

<span class="sd">        :param c: Caller Instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pop_file_chooser_dialog</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_image</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;save&#39;</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_set_autocut_method_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;autocut-method-changed callback</span>

<span class="sd">        Changes the autocut method</span>
<span class="sd">        </span>
<span class="sd">        :param c: Caller Instance</span>

<span class="sd">        :param index: (Optional) Index</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">get_active</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">autocut_index</span> <span class="o">=</span> <span class="n">index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">set_autocut_method</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">autocut_methods</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>


    <span class="k">def</span> <span class="nf">_on_select_region_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">region</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;on select region callback</span>

<span class="sd">        :param region: Region instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">image_region</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">image</span><span class="p">[</span><span class="n">region</span><span class="o">.</span><span class="n">get_selected_pixels</span><span class="p">()]</span>
        <span class="n">x_range</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="n">x_range</span>
        <span class="n">y_range</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="n">y_range</span>
        

        <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:.3e}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_region</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">median</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:.3e}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">robust_median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_region</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">std</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:.3e}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_region</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sum</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:.3e}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_region</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">surf</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:.2e}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">image_region</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>


        <span class="c1"># plot spectrum</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimz</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrum_window</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">spectrum_window</span> <span class="o">=</span> <span class="n">ZPlotWindow</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">wavenumber</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bunit</span><span class="p">,</span>
                    <span class="n">axis_corr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">axis_corr</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">spectrum_window</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrum_window</span><span class="o">.</span><span class="n">w</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s1">&#39;visible&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">spectrum_window</span> <span class="o">=</span> <span class="n">ZPlotWindow</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">wavenumber</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bunit</span><span class="p">,</span>
                     <span class="n">axis_corr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">axis_corr</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">spectrum_window</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdf5</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cube</span><span class="o">.</span><span class="n">_silent_load</span> <span class="o">=</span> <span class="kc">True</span>

            
            <span class="n">zdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cube</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span><span class="nb">int</span><span class="p">(</span><span class="n">x_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                              <span class="nb">int</span><span class="p">(</span><span class="n">y_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span><span class="nb">int</span><span class="p">(</span><span class="n">y_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="p">:]</span>
        
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">regions</span><span class="o">.</span><span class="n">get_shape</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;circle&#39;</span><span class="p">:</span>
                <span class="n">all_vectors</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">region</span><span class="o">.</span><span class="n">get_selected_pixels</span><span class="p">()[</span><span class="mi">0</span><span class="p">])):</span>
                    <span class="n">all_vectors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">zdata</span><span class="p">[</span>
                        <span class="n">region</span><span class="o">.</span><span class="n">get_selected_pixels</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="n">ik</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">region</span><span class="o">.</span><span class="n">get_selected_pixels</span><span class="p">()[</span><span class="mi">1</span><span class="p">][</span><span class="n">ik</span><span class="p">]</span> <span class="o">-</span> <span class="n">y_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],:])</span>
                <span class="n">zdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">all_vectors</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">zdata</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">zdata</span> <span class="o">=</span> <span class="n">zdata</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">zdata</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">zdata</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">zdata</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
            
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">zdata</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">regions</span><span class="o">.</span><span class="n">get_method</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;sum&#39;</span><span class="p">:</span>
                    <span class="n">zdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">zdata</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">regions</span><span class="o">.</span><span class="n">get_method</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;mean&#39;</span><span class="p">:</span>
                    <span class="n">zdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">zdata</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">regions</span><span class="o">.</span><span class="n">get_method</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;median&#39;</span><span class="p">:</span>
                    <span class="n">zdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">zdata</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Method error&#39;</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">spectrum_window</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">zdata</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span> <span class="n">e</span>
                
        
    <span class="k">def</span> <span class="nf">_on_move_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_x</span><span class="p">,</span> <span class="n">data_y</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;mouse-motion callback</span>

<span class="sd">        Called when the mouse is moving on the image display.</span>
<span class="sd">        </span>
<span class="sd">        Display some informations on the mouse position.</span>
<span class="sd">    </span>
<span class="sd">        :param data_x: X position of the mouse on the image display.</span>

<span class="sd">        :param data_y: Y position of the mouse on the image display.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get the value under the data coordinates</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">image</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">data_x</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">),</span>
                                      <span class="nb">int</span><span class="p">(</span><span class="n">data_y</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)]</span>
            
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">data_x</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span>  <span class="n">data_y</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        
        <span class="n">fits_x</span><span class="p">,</span> <span class="n">fits_y</span> <span class="o">=</span> <span class="n">data_x</span><span class="p">,</span> <span class="n">data_y</span>

        <span class="c1"># Calculate WCS RA/DEC</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">wcs_pix2world</span><span class="p">(</span><span class="n">fits_x</span><span class="p">,</span> <span class="n">fits_y</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">ra_txt</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.0f}</span><span class="s1">:</span><span class="si">{:.0f}</span><span class="s1">:</span><span class="si">{:.1f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">astrometry</span><span class="o">.</span><span class="n">deg2ra</span><span class="p">(</span><span class="n">ra</span><span class="p">))</span>
            <span class="n">dec_txt</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.0f}</span><span class="s1">:</span><span class="si">{:.0f}</span><span class="s1">:</span><span class="si">{:.1f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">astrometry</span><span class="o">.</span><span class="n">deg2dec</span><span class="p">(</span><span class="n">dec</span><span class="p">))</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1">#print &quot;Bad coordinate conversion: %s&quot; % (str(e))</span>
            <span class="n">ra_txt</span>  <span class="o">=</span> <span class="s1">&#39;BAD WCS&#39;</span>
            <span class="n">dec_txt</span> <span class="o">=</span> <span class="s1">&#39;BAD WCS&#39;</span>

        <span class="c1"># hack: x/y inverted</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ra_txt</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dec_txt</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fits_x</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fits_y</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:.2e}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s1">&#39;NaN&#39;</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">_quit_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;quit callback.</span>

<span class="sd">        Quit viewer.</span>

<span class="sd">        :param c: Caller instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">gtk</span><span class="o">.</span><span class="n">main_quit</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_get_new_object</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return new boxes on the image display.&quot;&quot;&quot;</span>
        <span class="n">objs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">getObjects</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_canvas_objs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">old_canvas_objs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">objs</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">objs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">obj</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_canvas_objs</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">old_canvas_objs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">objs</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">obj</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">old_canvas_objs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">objs</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_add_plugins_postload_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">call</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a call to the list of postload calls</span>

<span class="sd">        :param call: Call to be added (a function pointer)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_plugins_postload_calls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">call</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_plugins_postload_call</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Call all plugins after data has been loaded&quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">icall</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plugins_postload_calls</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">icall</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;&gt; Error during plugins postload call: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print_traceback</span><span class="p">()</span>
                
            
<div class="viewcode-block" id="BaseViewer.get_widget"><a class="viewcode-back" href="../../orb.html#orb.viewer.BaseViewer.get_widget">[docs]</a>    <span class="k">def</span> <span class="nf">get_widget</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return root widget&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span></div>
        
<div class="viewcode-block" id="BaseViewer.load_file"><a class="viewcode-back" href="../../orb.html#orb.viewer.BaseViewer.load_file">[docs]</a>    <span class="k">def</span> <span class="nf">load_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">reload</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">chip_index</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load the file to display. Can be a FITS or HDF5 cube.</span>

<span class="sd">        :param filepath: Path to the file.</span>

<span class="sd">        :param reload: (Optional) Must be set to True if the file is</span>
<span class="sd">          reloaded (default False)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filepath</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;.fits&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hdf5</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">hdu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">read_fits</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">return_hdu_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;NAXIS3&#39;</span> <span class="ow">in</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">:</span>
                <span class="n">cube_size</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS3&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">/</span> <span class="mf">1e9</span>
            
                <span class="k">if</span> <span class="n">cube_size</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">MAX_CUBE_SIZE</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Cube size is too large: </span><span class="si">{}</span><span class="s1"> Go &gt; </span><span class="si">{}</span><span class="s1"> Go&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cube_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">MAX_CUBE_SIZE</span><span class="p">))</span>

            <span class="c1"># detect a sitelle file</span>
            <span class="n">image_mode</span> <span class="o">=</span> <span class="s1">&#39;classic&#39;</span>
            
            <span class="k">if</span> <span class="s1">&#39;DETECTOR&#39;</span> <span class="ow">in</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;SITELLE&#39;</span> <span class="ow">in</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;DETECTOR&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">4000</span><span class="p">:</span>
                        <span class="n">image_mode</span> <span class="o">=</span> <span class="s1">&#39;sitelle&#39;</span>
            <span class="k">if</span> <span class="s1">&#39;INSTRUME&#39;</span> <span class="ow">in</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;SITELLE&#39;</span> <span class="ow">in</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;INSTRUME&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">4000</span><span class="p">:</span>
                        <span class="n">image_mode</span> <span class="o">=</span> <span class="s1">&#39;sitelle&#39;</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">cube</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">read_fits</span><span class="p">(</span>
                <span class="n">filepath</span><span class="p">,</span>
                <span class="n">return_header</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">image_mode</span><span class="o">=</span><span class="n">image_mode</span><span class="p">,</span>
                <span class="n">chip_index</span><span class="o">=</span><span class="n">chip_index</span><span class="p">,</span>
                <span class="n">memmap</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">filepath</span> <span class="o">=</span> <span class="n">filepath</span>

        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filepath</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;.hdf5&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hdf5</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cube</span> <span class="o">=</span> <span class="n">HDFCube</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">no_log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cube</span><span class="o">.</span><span class="n">get_cube_header</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filepath</span> <span class="o">=</span> <span class="n">filepath</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;File must be a FITS of HDF5 cube&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cube</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cube</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cube</span><span class="p">[:,:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">dimx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cube</span><span class="o">.</span><span class="n">shape</span>

        
        <span class="c1"># SET WCS</span>
        
        <span class="n">wcs_header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span>               
        <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span> <span class="o">=</span> <span class="n">pywcs</span><span class="o">.</span><span class="n">WCS</span><span class="p">(</span><span class="n">wcs_header</span><span class="p">,</span> <span class="n">naxis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">wcs_pix2world</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ra</span> <span class="o">&lt;</span> <span class="mf">1e-15</span> <span class="ow">and</span> <span class="n">dec</span> <span class="o">&lt;</span> <span class="mf">1e-15</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;BAD WCS&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">BAD_WCS_FLAG</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s1">&#39;WCS Error: &#39;</span><span class="p">,</span> <span class="n">e</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">BAD_WCS_FLAG</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">reload</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wimage_index</span><span class="o">.</span><span class="n">get_value</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">val</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cube</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">image_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cube</span><span class="p">[:,:,</span><span class="n">val</span><span class="p">]</span>    
            <span class="bp">self</span><span class="o">.</span><span class="n">update_image</span><span class="p">(</span><span class="n">image_data</span><span class="p">)</span>
            

        <span class="c1"># SET ZAXIS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wimage_index</span><span class="o">.</span><span class="n">set_upper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimz</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;ORDER&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;ORDER&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="s1">&#39;SITORDER&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;SITORDER&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;STEP&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;STEP&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="s1">&#39;SITSTPSZ&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;SITSTPSZ&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;SITFRGNM&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="s1">&#39;AXISCORR&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">axis_corr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;AXISCORR&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">axis_corr</span> <span class="o">=</span> <span class="mf">1.</span>
                
            <span class="k">if</span> <span class="s1">&#39;CUNIT3&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;nm&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CUNIT3&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">wavenumber</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">elif</span> <span class="s1">&#39;cm-1&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CUNIT3&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">wavenumber</span> <span class="o">=</span> <span class="kc">True</span>
                
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">wavenumber</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wavenumber</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">zaxis</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">create_cm1_axis</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dimz</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">,</span>
                        <span class="n">corr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">axis_corr</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">zaxis</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">create_nm_axis</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dimz</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">,</span>
                        <span class="n">corr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">axis_corr</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;BUNIT&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;erg/cm^2/s/A&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="s1">&#39;BUNIT&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bunit</span> <span class="o">=</span> <span class="s1">&#39;erg/cm^2/s/A&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bunit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="s1">&#39;BUNIT&#39;</span><span class="p">]</span>
                    
        <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_plugins_postload_call</span><span class="p">()</span></div>


<div class="viewcode-block" id="BaseViewer.pop_file_chooser_dialog"><a class="viewcode-back" href="../../orb.html#orb.viewer.BaseViewer.pop_file_chooser_dialog">[docs]</a>    <span class="k">def</span> <span class="nf">pop_file_chooser_dialog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;save&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Pop a a file chooser dialog</span>

<span class="sd">        :param action: Method launched when file path has been</span>
<span class="sd">          defined.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;save&#39;</span><span class="p">:</span>
            <span class="n">act</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">FILE_CHOOSER_ACTION_SAVE</span>
            <span class="n">but</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">STOCK_SAVE</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Save image as...&#39;</span>

        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;open&#39;</span><span class="p">:</span>
            <span class="n">act</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">FILE_CHOOSER_ACTION_OPEN</span>
            <span class="n">but</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">STOCK_OPEN</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Open file&#39;</span>
            
        <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Mode must be &#39;save&#39; or &#39;load&#39;&quot;</span><span class="p">)</span>
        
        <span class="n">fc</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">FileChooserDialog</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
            <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span>
            <span class="n">buttons</span><span class="o">=</span><span class="p">(</span><span class="n">gtk</span><span class="o">.</span><span class="n">STOCK_CANCEL</span><span class="p">,</span> <span class="n">gtk</span><span class="o">.</span><span class="n">RESPONSE_CANCEL</span><span class="p">,</span>
                     <span class="n">but</span><span class="p">,</span> <span class="n">gtk</span><span class="o">.</span><span class="n">RESPONSE_OK</span><span class="p">),</span>
            <span class="n">action</span><span class="o">=</span><span class="n">act</span><span class="p">)</span>
        <span class="n">fc</span><span class="o">.</span><span class="n">set_current_folder</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">fc</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

        
        <span class="k">if</span> <span class="n">response</span> <span class="o">==</span> <span class="n">gtk</span><span class="o">.</span><span class="n">RESPONSE_OK</span><span class="p">:</span>
            <span class="n">filepath</span> <span class="o">=</span> <span class="n">fc</span><span class="o">.</span><span class="n">get_filename</span><span class="p">()</span>
            <span class="n">fc</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
            <span class="n">action</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fc</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span></div>
        
<div class="viewcode-block" id="BaseViewer.save_image"><a class="viewcode-back" href="../../orb.html#orb.viewer.BaseViewer.save_image">[docs]</a>    <span class="k">def</span> <span class="nf">save_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save an image as a FITS file</span>

<span class="sd">        :param filepath: File path.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">write_fits</span><span class="p">(</span>
            <span class="n">filepath</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">fits_header</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

 
<div class="viewcode-block" id="BaseViewer.update_image"><a class="viewcode-back" href="../../orb.html#orb.viewer.BaseViewer.update_image">[docs]</a>    <span class="k">def</span> <span class="nf">update_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">im</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update displayed image</span>

<span class="sd">        :param im: New image to display</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimx</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">im</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">dimx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimy</span><span class="p">))</span>
            <span class="n">im</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">set_image</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">set_wcs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="p">)</span>
            
        <span class="n">all_nans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">im</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_set</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;autozoom&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;autocenter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">all_nans</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;autocut&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set_autocut_method_cb</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">autocut_index</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#self.canvas.transform(False, False, True)</span>
            <span class="k">pass</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_set</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init_set</span> <span class="o">=</span> <span class="kc">False</span></div></div>

<span class="c1">###########################################</span>
<span class="c1">### CLASS AUTOCUTS ########################</span>
<span class="c1">###########################################</span>
<div class="viewcode-block" id="AutoCuts"><a class="viewcode-back" href="../../orb.html#orb.viewer.AutoCuts">[docs]</a><span class="k">class</span> <span class="nc">AutoCuts</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="n">autocut_methods</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;min-max&#39;</span><span class="p">,</span> <span class="s1">&#39;rhist&#39;</span><span class="p">,</span> <span class="s1">&#39;0.99&#39;</span><span class="p">,</span> <span class="s1">&#39;0.95&#39;</span><span class="p">,</span> <span class="s1">&#39;0.90&#39;</span><span class="p">,</span> <span class="s1">&#39;0.85&#39;</span><span class="p">,</span> <span class="s1">&#39;0.80&#39;</span><span class="p">]</span>
    <span class="n">autocut_method</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">im</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">autocut_method</span> <span class="o">=</span> <span class="s1">&#39;rhist&#39;</span>

<div class="viewcode-block" id="AutoCuts.get_autocut_methods"><a class="viewcode-back" href="../../orb.html#orb.viewer.AutoCuts.get_autocut_methods">[docs]</a>    <span class="k">def</span> <span class="nf">get_autocut_methods</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">autocut_methods</span></div>

<div class="viewcode-block" id="AutoCuts.set_autocut_method"><a class="viewcode-back" href="../../orb.html#orb.viewer.AutoCuts.set_autocut_method">[docs]</a>    <span class="k">def</span> <span class="nf">set_autocut_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">autocut_method</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">autocut_method</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">autocut_methods</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">autocut_method</span> <span class="o">=</span> <span class="n">autocut_method</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Bad autocut method (</span><span class="si">{}</span><span class="s1">): must be in </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">autocut_method</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">autocut_methods</span><span class="p">))</span></div>

<div class="viewcode-block" id="AutoCuts.random_image_reduction"><a class="viewcode-back" href="../../orb.html#orb.viewer.AutoCuts.random_image_reduction">[docs]</a>    <span class="k">def</span> <span class="nf">random_image_reduction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">im</span><span class="p">):</span>
        <span class="n">PROP</span> <span class="o">=</span> <span class="mf">0.01</span>
        <span class="n">nb</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">PROP</span><span class="p">)</span>
        <span class="n">rndx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span>
            <span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="n">nb</span><span class="p">)</span>
        <span class="n">rndy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span>
            <span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="n">nb</span><span class="p">)</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">im</span><span class="p">[</span><span class="n">rndx</span><span class="p">,</span> <span class="n">rndy</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">im</span></div>
        
        
<div class="viewcode-block" id="AutoCuts.get_vlim"><a class="viewcode-back" href="../../orb.html#orb.viewer.AutoCuts.get_vlim">[docs]</a>    <span class="k">def</span> <span class="nf">get_vlim</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">im</span><span class="p">):</span>
        <span class="n">distrib</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">random_image_reduction</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">autocut_method</span> <span class="o">==</span> <span class="s1">&#39;min-max&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">bn</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">im</span><span class="p">),</span> <span class="n">bn</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">autocut_method</span> <span class="o">==</span> <span class="s1">&#39;rhist&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rhist_cut</span><span class="p">(</span><span class="n">distrib</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">coeff</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">autocut_method</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print_error</span><span class="p">(</span><span class="s1">&#39;Bad autocut method: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="n">vmin</span> <span class="o">=</span> <span class="n">orb</span><span class="o">.</span><span class="n">cutils</span><span class="o">.</span><span class="n">part_value</span><span class="p">(</span><span class="n">distrib</span><span class="p">,</span> <span class="mf">1.</span><span class="o">-</span><span class="n">coeff</span><span class="p">)</span>
            <span class="n">vmax</span> <span class="o">=</span> <span class="n">orb</span><span class="o">.</span><span class="n">cutils</span><span class="o">.</span><span class="n">part_value</span><span class="p">(</span><span class="n">distrib</span><span class="p">,</span> <span class="n">coeff</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span></div>

    <span class="k">def</span> <span class="nf">_rhist_cut</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">distrib</span><span class="p">):</span>
        
        <span class="n">distrib</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sigmacut</span><span class="p">(</span><span class="n">distrib</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">2.5</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">bn</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">distrib</span><span class="p">),</span> <span class="n">bn</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">distrib</span><span class="p">)</span></div>
        

<span class="c1">###########################################</span>
<span class="c1">### CLASS POPUPWINDOW #####################</span>
<span class="c1">###########################################</span>
<div class="viewcode-block" id="PopupWindow"><a class="viewcode-back" href="../../orb.html#orb.viewer.PopupWindow">[docs]</a><span class="k">class</span> <span class="nc">PopupWindow</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Basic popup window frame&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Popup&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">300</span><span class="p">,</span><span class="mi">300</span><span class="p">)):</span>
        <span class="sd">&quot;&quot;&quot;Init Popup Window</span>

<span class="sd">        :param title: (Optional) Window title (default &#39;Popup&#39;).</span>

<span class="sd">        :param size: (Optional) Window size (default (300,300)).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">Window</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="o">.</span><span class="n">set_size_request</span><span class="p">(</span><span class="o">*</span><span class="n">size</span><span class="p">)</span>
        

<div class="viewcode-block" id="PopupWindow.show"><a class="viewcode-back" href="../../orb.html#orb.viewer.PopupWindow.show">[docs]</a>    <span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Show popup window&quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="o">.</span><span class="n">show_all</span><span class="p">()</span></div></div>
        

<span class="c1">###########################################</span>
<span class="c1">### CLASS HEADERWINDOW ####################</span>
<span class="c1">###########################################</span>
<div class="viewcode-block" id="HeaderWindow"><a class="viewcode-back" href="../../orb.html#orb.viewer.HeaderWindow">[docs]</a><span class="k">class</span> <span class="nc">HeaderWindow</span><span class="p">(</span><span class="n">PopupWindow</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Header window.</span>

<span class="sd">    Display and manage a pyfits.Header instance</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Init and construct header window.</span>

<span class="sd">        :param header: header to display. Must be a pyfits.Header instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">PopupWindow</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Header&#39;</span><span class="p">,</span>
                             <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">300</span><span class="p">,</span><span class="mi">500</span><span class="p">))</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span class="n">header</span>
        
        <span class="c1"># fit results</span>
        <span class="n">box</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">VBox</span><span class="p">()</span>
        <span class="n">sw</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">ScrolledWindow</span><span class="p">()</span>
        <span class="n">sw</span><span class="o">.</span><span class="n">set_policy</span><span class="p">(</span><span class="n">gtk</span><span class="o">.</span><span class="n">POLICY_AUTOMATIC</span><span class="p">,</span> <span class="n">gtk</span><span class="o">.</span><span class="n">POLICY_AUTOMATIC</span><span class="p">)</span>

        <span class="n">header_store</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">ListStore</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="n">header_tv</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">TreeView</span><span class="p">(</span><span class="n">header_store</span><span class="p">)</span>
        <span class="n">key_render</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">CellRendererText</span><span class="p">()</span>
        <span class="n">key_render</span><span class="o">.</span><span class="n">set_property</span><span class="p">(</span><span class="s1">&#39;font&#39;</span><span class="p">,</span> <span class="s1">&#39;mono&#39;</span><span class="p">)</span>
        <span class="n">key_render</span><span class="o">.</span><span class="n">set_property</span><span class="p">(</span><span class="s1">&#39;size-points&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="n">key_render</span><span class="o">.</span><span class="n">set_property</span><span class="p">(</span><span class="s1">&#39;editable&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">key_render</span><span class="o">.</span><span class="n">set_property</span><span class="p">(</span><span class="s1">&#39;weight&#39;</span><span class="p">,</span> <span class="mi">800</span><span class="p">)</span>
        
        <span class="n">value_render</span> <span class="o">=</span>  <span class="n">gtk</span><span class="o">.</span><span class="n">CellRendererText</span><span class="p">()</span>
        <span class="n">value_render</span><span class="o">.</span><span class="n">set_property</span><span class="p">(</span><span class="s1">&#39;font&#39;</span><span class="p">,</span> <span class="s1">&#39;mono&#39;</span><span class="p">)</span>
        <span class="n">value_render</span><span class="o">.</span><span class="n">set_property</span><span class="p">(</span><span class="s1">&#39;size-points&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="n">value_render</span><span class="o">.</span><span class="n">set_property</span><span class="p">(</span><span class="s1">&#39;editable&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        
        <span class="n">col_key</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">TreeViewColumn</span><span class="p">(</span><span class="s2">&quot;Key&quot;</span><span class="p">,</span> <span class="n">key_render</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">col_value</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">TreeViewColumn</span><span class="p">(</span><span class="s2">&quot;Value&quot;</span><span class="p">,</span> <span class="n">value_render</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">col_comment</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">TreeViewColumn</span><span class="p">(</span><span class="s2">&quot;Comment&quot;</span><span class="p">,</span> <span class="n">value_render</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
      
        <span class="n">header_tv</span><span class="o">.</span><span class="n">append_column</span><span class="p">(</span><span class="n">col_key</span><span class="p">)</span>
        <span class="n">header_tv</span><span class="o">.</span><span class="n">append_column</span><span class="p">(</span><span class="n">col_value</span><span class="p">)</span>
        <span class="n">header_tv</span><span class="o">.</span><span class="n">append_column</span><span class="p">(</span><span class="n">col_comment</span><span class="p">)</span>

        <span class="n">sw</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">header_tv</span><span class="p">)</span>
        <span class="n">box</span><span class="o">.</span><span class="n">pack_start</span><span class="p">(</span><span class="n">sw</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">box</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">)):</span>
            <span class="n">header_store</span><span class="o">.</span><span class="n">append</span><span class="p">([</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="n">i</span><span class="p">],</span>
                <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span></div>
            
  
<span class="c1">###########################################</span>
<span class="c1">### CLASS SPECTRUMWINDOW ##################</span>
<span class="c1">###########################################</span>
<div class="viewcode-block" id="ZPlotWindow"><a class="viewcode-back" href="../../orb.html#orb.viewer.ZPlotWindow">[docs]</a><span class="k">class</span> <span class="nc">ZPlotWindow</span><span class="p">(</span><span class="n">PopupWindow</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Implement a window for plotting zaxis data.&quot;&quot;&quot;</span>

    <span class="n">subplot</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">simple_mode</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">is_spectrum</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_display_spectrum</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">fitplugin</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_kzdata</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># keeped zdata</span>
    <span class="n">_substract</span> <span class="o">=</span> <span class="kc">False</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">wavenumber</span><span class="p">,</span> <span class="n">bunit</span><span class="p">,</span>
                 <span class="n">axis_corr</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span>
                 <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Zdata&#39;</span><span class="p">,</span> <span class="n">simple</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Init and construct spectrum window.</span>

<span class="sd">        :param step: Step size [in nm]</span>
<span class="sd">        </span>
<span class="sd">        :param order: Aliasing Order</span>
<span class="sd">        </span>
<span class="sd">        :wavenumber: True if data axis is in wavenumber, False if in</span>
<span class="sd">          wavelength, None otherwise.</span>

<span class="sd">        :param bunit: Flux unit (string)</span>

<span class="sd">        :param axis_corr: (Optional) Wave axis correction coefficient</span>
<span class="sd">          (default 1.)</span>

<span class="sd">        :param title: (Optional) Window title (default Zdata)</span>

<span class="sd">        :param simple: (Optional) If True, window display only a plot</span>
<span class="sd">          (no fit plugin) (default False).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">SIZE</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
        <span class="n">DPI</span> <span class="o">=</span> <span class="mi">75</span>
        <span class="n">PopupWindow</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
                             <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">SIZE</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">DPI</span><span class="p">,</span><span class="n">SIZE</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">DPI</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simple_mode</span> <span class="o">=</span> <span class="n">simple</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="n">step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="n">order</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axis_corr</span> <span class="o">=</span> <span class="n">axis_corr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wavenumber</span> <span class="o">=</span> <span class="n">wavenumber</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wavenumber</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_spectrum</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_display_spectrum</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wavenumber</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_spectrum</span> <span class="o">=</span> <span class="kc">True</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">bunit</span> <span class="o">=</span> <span class="n">bunit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zmin_pix</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zmax_pix</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">fig</span> <span class="o">=</span> <span class="n">Figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">SIZE</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">DPI</span><span class="p">,</span> <span class="n">tight_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">twin_plot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subplot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">twin_plot</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>


        <span class="c1"># CREATE framebox</span>
        <span class="n">framebox</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">VBox</span><span class="p">()</span>
        <span class="c1"># add figure canvas</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span> <span class="o">=</span> <span class="n">FigureCanvas</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="p">)</span>  <span class="c1"># a gtk.DrawingArea</span>
        <span class="n">framebox</span><span class="o">.</span><span class="n">pack_start</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># add buttons</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">simple_mode</span><span class="p">:</span>
            <span class="n">buttonsbar</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">HBox</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_spectrum</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">specbutton</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="s1">&#39;Show spectrum&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">specbutton</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;clicked&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_display_spectrum_cb</span><span class="p">)</span>
                <span class="n">buttonsbar</span><span class="o">.</span><span class="n">pack_start</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">specbutton</span><span class="p">)</span>

            <span class="n">keepbutton</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="s1">&#39;Keep&#39;</span><span class="p">)</span>
            <span class="n">keepbutton</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;clicked&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keep_data_cb</span><span class="p">)</span>
            <span class="n">buttonsbar</span><span class="o">.</span><span class="n">pack_start</span><span class="p">(</span><span class="n">keepbutton</span><span class="p">)</span>

            <span class="n">subbutton</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="s1">&#39;Substract&#39;</span><span class="p">)</span>
            <span class="n">subbutton</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;clicked&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_substract_data_cb</span><span class="p">)</span>
            <span class="n">buttonsbar</span><span class="o">.</span><span class="n">pack_start</span><span class="p">(</span><span class="n">subbutton</span><span class="p">)</span>

            <span class="n">clabutton</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="s1">&#39;Clear&#39;</span><span class="p">)</span>
            <span class="n">clabutton</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;clicked&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clear_data_cb</span><span class="p">)</span>
            <span class="n">buttonsbar</span><span class="o">.</span><span class="n">pack_start</span><span class="p">(</span><span class="n">clabutton</span><span class="p">)</span>

            <span class="n">uzobutton</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="s1">&#39;Unzoom&#39;</span><span class="p">)</span>
            <span class="n">uzobutton</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;clicked&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unzoom_cb</span><span class="p">)</span>
            <span class="n">buttonsbar</span><span class="o">.</span><span class="n">pack_start</span><span class="p">(</span><span class="n">uzobutton</span><span class="p">)</span>

            <span class="n">savbutton</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="s1">&#39;Save&#39;</span><span class="p">)</span>
            <span class="n">savbutton</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;clicked&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_data_cb</span><span class="p">)</span>
            <span class="n">buttonsbar</span><span class="o">.</span><span class="n">pack_start</span><span class="p">(</span><span class="n">savbutton</span><span class="p">)</span>

            <span class="n">framebox</span><span class="o">.</span><span class="n">pack_start</span><span class="p">(</span><span class="n">buttonsbar</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        

            <span class="c1"># add fit plugin</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fitplugin</span> <span class="o">=</span> <span class="n">FitPlugin</span><span class="p">(</span><span class="n">step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">,</span>
                                       <span class="n">order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">,</span>
                                       <span class="n">axis_corr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">axis_corr</span><span class="p">,</span>
                                       <span class="n">update_cb</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">,</span>
                                       <span class="n">wavenumber</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wavenumber</span><span class="p">,</span>
                                       <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">framebox</span><span class="o">.</span><span class="n">pack_start</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fitplugin</span><span class="o">.</span><span class="n">get_frame</span><span class="p">(),</span>
                                <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        
        <span class="c1"># add framebox</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">framebox</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_plot_widgets</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_start_plot_widgets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_spectrum</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_display_spectrum</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">simple_mode</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">span</span> <span class="o">=</span> <span class="n">SpanSelector</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">subplot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_span_select_cb</span><span class="p">,</span>
                        <span class="s1">&#39;horizontal&#39;</span><span class="p">,</span> <span class="n">useblit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">rectprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">))</span>
                
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">simple_mode</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">span_fit</span> <span class="o">=</span> <span class="n">SpanSelector</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">subplot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_span_fit_cb</span><span class="p">,</span>
                    <span class="s1">&#39;horizontal&#39;</span><span class="p">,</span> <span class="n">useblit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">rectprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">zoom</span> <span class="o">=</span> <span class="n">RectangleSelector</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subplot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_zoom_cb</span><span class="p">,</span>
            <span class="n">useblit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">button</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_display_spectrum_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_display_spectrum</span> <span class="o">=</span> <span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">_display_spectrum</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_display_spectrum</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">specbutton</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;Show interferogram&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">specbutton</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;Show spectrum&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">reset_axis</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_unzoom_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">reset_axis</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_save_data_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
        <span class="n">fc</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">FileChooserDialog</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Save data as...&#39;</span><span class="p">,</span>
            <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="p">,</span>
            <span class="n">buttons</span><span class="o">=</span><span class="p">(</span><span class="n">gtk</span><span class="o">.</span><span class="n">STOCK_CANCEL</span><span class="p">,</span> <span class="n">gtk</span><span class="o">.</span><span class="n">RESPONSE_CANCEL</span><span class="p">,</span>
                     <span class="n">gtk</span><span class="o">.</span><span class="n">STOCK_SAVE</span><span class="p">,</span> <span class="n">gtk</span><span class="o">.</span><span class="n">RESPONSE_OK</span><span class="p">),</span>
            <span class="n">action</span><span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">FILE_CHOOSER_ACTION_SAVE</span><span class="p">)</span>
        <span class="n">fc</span><span class="o">.</span><span class="n">set_current_folder</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>
        
        <span class="n">response</span> <span class="o">=</span> <span class="n">fc</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

        
        <span class="k">if</span> <span class="n">response</span> <span class="o">==</span> <span class="n">gtk</span><span class="o">.</span><span class="n">RESPONSE_OK</span><span class="p">:</span>
            <span class="n">filepath</span> <span class="o">=</span> <span class="n">fc</span><span class="o">.</span><span class="n">get_filename</span><span class="p">()</span>
            <span class="n">fc</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
            <span class="n">Tools</span><span class="p">()</span><span class="o">.</span><span class="n">write_fits</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zdata</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fc</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
        
        
    <span class="k">def</span> <span class="nf">_zoom_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eclick</span><span class="p">,</span> <span class="n">erelease</span><span class="p">):</span>
        <span class="n">xlim</span> <span class="o">=</span> <span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">eclick</span><span class="o">.</span><span class="n">xdata</span><span class="p">,</span> <span class="n">erelease</span><span class="o">.</span><span class="n">xdata</span><span class="p">),</span>
                <span class="nb">max</span><span class="p">(</span><span class="n">eclick</span><span class="o">.</span><span class="n">xdata</span><span class="p">,</span> <span class="n">erelease</span><span class="o">.</span><span class="n">xdata</span><span class="p">))</span>
        <span class="n">ylim</span> <span class="o">=</span> <span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">eclick</span><span class="o">.</span><span class="n">ydata</span><span class="p">,</span> <span class="n">erelease</span><span class="o">.</span><span class="n">ydata</span><span class="p">),</span>
                <span class="nb">max</span><span class="p">(</span><span class="n">eclick</span><span class="o">.</span><span class="n">ydata</span><span class="p">,</span> <span class="n">erelease</span><span class="o">.</span><span class="n">ydata</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subplot</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subplot</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>


    <span class="k">def</span> <span class="nf">_keep_data_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">zdata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_kzdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zdata</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_substract</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_substract_data_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_keep_data_cb</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_substract</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_clear_data_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_substract</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_kzdata</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
        
            
    <span class="k">def</span> <span class="nf">_span_select_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zmin</span><span class="p">,</span> <span class="n">zmax</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_spectrum</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_display_spectrum</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">zmin_pix</span> <span class="o">=</span> <span class="n">zmin</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">zmax_pix</span> <span class="o">=</span> <span class="n">zmax</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_span_fit_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zmin</span><span class="p">,</span> <span class="n">zmax</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_spectrum</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fitplugin</span><span class="o">.</span><span class="n">set_fitrange</span><span class="p">(</span><span class="n">zmin</span><span class="p">,</span> <span class="n">zmax</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">_get_zaxis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the best zaxis based on known parameters</span>

<span class="sd">        :param n: Number of samples</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_spectrum</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wavenumber</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">utils</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">create_cm1_axis</span><span class="p">(</span>
                    <span class="n">n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">,</span> <span class="n">corr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">axis_corr</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">utils</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">create_nm_axis</span><span class="p">(</span>
                    <span class="n">n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">,</span> <span class="n">corr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">axis_corr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

<div class="viewcode-block" id="ZPlotWindow.update"><a class="viewcode-back" href="../../orb.html#orb.viewer.ZPlotWindow.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zdata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">zaxis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reset_axis</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update plot</span>

<span class="sd">        :param zdata: Data to plot (Y)</span>
<span class="sd">        :param zaxis: X axis.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">zdata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">zdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">zdata</span><span class="p">)</span>
            <span class="n">xlim</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">ylim</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">zdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zdata</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">reset_axis</span><span class="p">:</span>
                <span class="n">xlim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subplot</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()</span>
                <span class="n">ylim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subplot</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">xlim</span> <span class="o">=</span> <span class="kc">None</span> <span class="p">;</span> <span class="n">ylim</span> <span class="o">=</span> <span class="kc">None</span>
            
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kzdata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kzdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_kzdata</span><span class="p">)</span>

        <span class="c1">#zdata[np.nonzero(zdata == 0.)] = np.nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subplot</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">twin_plot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">twin_plot</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">zaxis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">zaxis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_zaxis</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">zdata</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_spectrum</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wavenumber</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">subplot</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Wavenumber [cm-1]&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>  <span class="bp">self</span><span class="o">.</span><span class="n">subplot</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Wavelength [nm]&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_display_spectrum</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">subplot</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Step index&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">subplot</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Wavenumber [cm-1]&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">subplot</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Channel index&#39;</span><span class="p">)</span>
                
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bunit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wavenumber</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">subplot</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bunit</span><span class="p">)</span>

        <span class="n">zdata_phase</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="c1"># compute spectrum</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_spectrum</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_display_spectrum</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">zmin_pix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">zmax_pix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">interf</span> <span class="o">=</span> <span class="n">zdata</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zmin_pix</span><span class="p">):</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zmax_pix</span><span class="p">)]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kzdata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">kinterf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kzdata</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zmin_pix</span><span class="p">):</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zmax_pix</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">interf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">zdata</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kzdata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">kinterf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">kzdata</span><span class="p">)</span>
                    
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">zdata</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">transform_interferogram</span><span class="p">(</span>
                    <span class="n">interf</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="n">phase_correction</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">wavenumber</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">low_order_correction</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">zdata_phase</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">transform_interferogram</span><span class="p">(</span>
                    <span class="n">interf</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="n">phase_correction</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">wavenumber</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">low_order_correction</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_phase</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kzdata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">kzdata</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">transform_interferogram</span><span class="p">(</span>
                        <span class="n">kinterf</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="n">phase_correction</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">wavenumber</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">low_order_correction</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="n">zaxis</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">create_cm1_axis</span><span class="p">(</span>
                    <span class="n">interf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">zdata</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">raw_fft</span><span class="p">(</span><span class="n">interf</span><span class="p">)</span>
                <span class="n">zdata_phase</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">raw_fft</span><span class="p">(</span><span class="n">interf</span><span class="p">,</span> <span class="n">return_phase</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kzdata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">kzdata</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">raw_fft</span><span class="p">(</span><span class="n">kinterf</span><span class="p">)</span>
                <span class="n">zaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">interf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># plot data</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kzdata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_substract</span><span class="p">:</span>
                <span class="n">zdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">zdata</span><span class="p">)</span> <span class="o">-</span> <span class="n">kzdata</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">subplot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">zaxis</span><span class="p">,</span> <span class="n">kzdata</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
                
        <span class="k">if</span> <span class="n">zdata_phase</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            
            <span class="c1">#self.subplot.plot(zaxis, zdata_phase, c=&#39;green&#39;, lw=1.)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">twin_plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">zaxis</span><span class="p">,</span> <span class="n">zdata_phase</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">twin_plot</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Phase&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">twin_plot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">twin_plot</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
        
            
        <span class="bp">self</span><span class="o">.</span><span class="n">subplot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">zaxis</span><span class="p">,</span> <span class="n">zdata</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;0.&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">ylabel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subplot</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>
        

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitplugin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_spectrum</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_display_spectrum</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitplugin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fitplugin</span><span class="o">.</span><span class="n">set_spectrum</span><span class="p">(</span><span class="n">zdata</span><span class="p">)</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitplugin</span><span class="o">.</span><span class="n">get_fit_lines</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">lines</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">subplot</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">line</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;0.3&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
                <span class="n">fitted_vector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitplugin</span><span class="o">.</span><span class="n">get_fitted_vector</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">fitted_vector</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">subplot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">zaxis</span><span class="p">,</span> <span class="n">fitted_vector</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">xlim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subplot</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subplot</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_plot_widgets</span><span class="p">()</span></div></div>


<span class="c1">###########################################</span>
<span class="c1">### CLASS FITPLUGIN #######################</span>
<span class="c1">###########################################</span>
<div class="viewcode-block" id="FitPlugin"><a class="viewcode-back" href="../../orb.html#orb.viewer.FitPlugin">[docs]</a><span class="k">class</span> <span class="nc">FitPlugin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fitting plugin that can be added to the ZPlot module.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">line_models</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="s1">&#39;sinc&#39;</span><span class="p">,</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">,</span> <span class="s1">&#39;sinc2&#39;</span><span class="p">]</span>
    <span class="n">fit_lines</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">wavenumber</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">step</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">order</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">axis_corr</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">apod</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">spectrum</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">update_cb</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">fitted_vector</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">fitrange</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">parent</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">axis_corr</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">apod</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">update_cb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wavenumber</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Init FitPlugin class</span>

<span class="sd">        :param step: (Optional) Step size in nm (default None).</span>

<span class="sd">        :param order: (Optional) Folding order (default None).</span>

<span class="sd">        :param axis_corr: (Optional) Wave axis correction coefficient</span>
<span class="sd">          (default 1.)</span>

<span class="sd">        :param apod: (Optional) Apodization (default None).</span>

<span class="sd">        :param update_cb: (Optional) function to call when the visual</span>
<span class="sd">          object displaying the spectrum must be updated (e.g. ZPlot</span>
<span class="sd">          window) (default None).</span>

<span class="sd">        :param wavenumber: (Optional) If True spectrum to fit is in</span>
<span class="sd">          wavenumber (default True).</span>

<span class="sd">        :param parent: (Optional) Parent class (e.g. ZPlot Window)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fit_lines</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axis_corr</span> <span class="o">=</span> <span class="n">axis_corr</span>
        
        <span class="c1"># FIT BOX</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">Frame</span><span class="p">(</span><span class="s1">&#39;Spectrum Fit&#39;</span><span class="p">)</span>
        <span class="n">framebox</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">HBox</span><span class="p">(</span><span class="n">spacing</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">fitbox</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">VBox</span><span class="p">(</span><span class="n">spacing</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Observation Params</span>
        <span class="n">buttonbox</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">HBox</span><span class="p">()</span>

        <span class="n">stepbox</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">VBox</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wstep</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">Entry</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wstep</span><span class="o">.</span><span class="n">set_width_chars</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wstep</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;changed&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_step_cb</span><span class="p">)</span>
        <span class="n">wstep_label</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="s1">&#39;Step (nm)&#39;</span><span class="p">)</span>
        <span class="n">wstep_label</span><span class="o">.</span><span class="n">set_max_width_chars</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
        
        <span class="n">stepbox</span><span class="o">.</span><span class="n">pack_start</span><span class="p">(</span><span class="n">wstep_label</span><span class="p">)</span>
        <span class="n">stepbox</span><span class="o">.</span><span class="n">pack_start</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wstep</span><span class="p">)</span>
        
        <span class="n">orderbox</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">VBox</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worder</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">Entry</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worder</span><span class="o">.</span><span class="n">set_width_chars</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worder</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;changed&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_order_cb</span><span class="p">)</span>
        <span class="n">worder_label</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="s1">&#39;Order&#39;</span><span class="p">)</span>
        <span class="n">worder_label</span><span class="o">.</span><span class="n">set_max_width_chars</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
        <span class="n">orderbox</span><span class="o">.</span><span class="n">pack_start</span><span class="p">(</span><span class="n">worder_label</span><span class="p">)</span>
        <span class="n">orderbox</span><span class="o">.</span><span class="n">pack_start</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worder</span><span class="p">)</span>

        <span class="n">apodbox</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">VBox</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wapod</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">Entry</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wapod</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;changed&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_apod_cb</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wapod</span><span class="o">.</span><span class="n">set_width_chars</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
        <span class="n">wapod_label</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="s1">&#39;Apod&#39;</span><span class="p">)</span>
        <span class="n">wapod_label</span><span class="o">.</span><span class="n">set_max_width_chars</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
        <span class="n">apodbox</span><span class="o">.</span><span class="n">pack_start</span><span class="p">(</span><span class="n">wapod_label</span><span class="p">)</span>
        <span class="n">apodbox</span><span class="o">.</span><span class="n">pack_start</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wapod</span><span class="p">)</span>

        <span class="c1"># calibration map</span>
        <span class="n">calibbox</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">VBox</span><span class="p">()</span>
        <span class="n">caliblabel</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="s1">&#39;Calibration Map&#39;</span><span class="p">)</span>
        
        <span class="n">wcalib</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">FileChooserButton</span><span class="p">(</span><span class="s2">&quot;Choose a calibration map&quot;</span><span class="p">)</span>
        <span class="n">wcalib</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;file-set&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_calib_map_path_cb</span><span class="p">)</span>
        <span class="n">calibbox</span><span class="o">.</span><span class="n">pack_start</span><span class="p">(</span><span class="n">caliblabel</span><span class="p">)</span>
        <span class="n">calibbox</span><span class="o">.</span><span class="n">pack_start</span><span class="p">(</span><span class="n">wcalib</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">box</span> <span class="ow">in</span> <span class="p">(</span><span class="n">stepbox</span><span class="p">,</span> <span class="n">orderbox</span><span class="p">,</span> <span class="n">apodbox</span><span class="p">,</span> <span class="n">calibbox</span><span class="p">):</span>
            <span class="n">buttonbox</span><span class="o">.</span><span class="n">pack_start</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            
        <span class="n">fitbox</span><span class="o">.</span><span class="n">pack_start</span><span class="p">(</span><span class="n">buttonbox</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># define choose line box</span>
        <span class="n">linebox</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">HBox</span><span class="p">(</span><span class="n">spacing</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">wselectline</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">combo_box_new_text</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_lines_keys</span><span class="p">():</span>
            <span class="n">wselectline</span><span class="o">.</span><span class="n">append_text</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">wselectline</span><span class="o">.</span><span class="n">set_active</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">line_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_lines_keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">wselectline</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;changed&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_line_name_cb</span><span class="p">)</span>
        <span class="n">linebox</span><span class="o">.</span><span class="n">pack_start</span><span class="p">(</span><span class="n">wselectline</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="n">waddline</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="p">)</span>
        <span class="n">waddline</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;clicked&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_fit_line_cb</span><span class="p">)</span>
        <span class="n">linebox</span><span class="o">.</span><span class="n">pack_start</span><span class="p">(</span><span class="n">waddline</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">wdelline</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
        <span class="n">wdelline</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;clicked&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_del_fit_line_cb</span><span class="p">)</span>
        <span class="n">linebox</span><span class="o">.</span><span class="n">pack_start</span><span class="p">(</span><span class="n">wdelline</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">wselectlinemodel</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">combo_box_new_text</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">linemodel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_models</span><span class="p">:</span>
            <span class="n">wselectlinemodel</span><span class="o">.</span><span class="n">append_text</span><span class="p">(</span><span class="n">linemodel</span><span class="p">)</span>
        <span class="n">wselectlinemodel</span><span class="o">.</span><span class="n">set_active</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">line_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_models</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">wselectlinemodel</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;changed&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_line_model_cb</span><span class="p">)</span>
        <span class="n">linebox</span><span class="o">.</span><span class="n">pack_start</span><span class="p">(</span><span class="n">wselectlinemodel</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">fitbox</span><span class="o">.</span><span class="n">pack_start</span><span class="p">(</span><span class="n">linebox</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># define velocity / redshift box</span>
        <span class="n">velocitybox</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">HBox</span><span class="p">(</span><span class="n">spacing</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">velbox</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">VBox</span><span class="p">()</span>
        <span class="n">wvelocity_label</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="s1">&#39;Velocity [km/s]&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wvelocity</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">SpinButton</span><span class="p">(</span><span class="n">climb_rate</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">digits</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wvelocity</span><span class="o">.</span><span class="n">set_range</span><span class="p">(</span><span class="o">-</span><span class="mf">1e6</span><span class="p">,</span><span class="mf">1e6</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wvelocity</span><span class="o">.</span><span class="n">set_increments</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wvelocity</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;value-changed&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_velocity_cb</span><span class="p">)</span>
        <span class="n">velbox</span><span class="o">.</span><span class="n">pack_start</span><span class="p">(</span><span class="n">wvelocity_label</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">velbox</span><span class="o">.</span><span class="n">pack_start</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wvelocity</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">velocitybox</span><span class="o">.</span><span class="n">pack_start</span><span class="p">(</span><span class="n">velbox</span><span class="p">)</span>

        <span class="n">redbox</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">VBox</span><span class="p">()</span>
        <span class="n">wredshift_label</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="s1">&#39;Redshift&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wredshift</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="s1">&#39;Redshift&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wredshift</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">SpinButton</span><span class="p">(</span><span class="n">climb_rate</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">digits</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wredshift</span><span class="o">.</span><span class="n">set_range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1e8</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wredshift</span><span class="o">.</span><span class="n">set_increments</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wredshift</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;value-changed&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_velocity_cb</span><span class="p">)</span>
        <span class="n">redbox</span><span class="o">.</span><span class="n">pack_start</span><span class="p">(</span><span class="n">wredshift_label</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">redbox</span><span class="o">.</span><span class="n">pack_start</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wredshift</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">velocitybox</span><span class="o">.</span><span class="n">pack_start</span><span class="p">(</span><span class="n">redbox</span><span class="p">)</span>
        <span class="n">fitbox</span><span class="o">.</span><span class="n">pack_start</span><span class="p">(</span><span class="n">velocitybox</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fit_lines_velocity</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit_lines_redshift</span> <span class="o">=</span> <span class="mf">0.</span>

        <span class="c1"># fit spectrum button</span>
        <span class="n">wfit</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="s2">&quot;Fit Spectrum&quot;</span><span class="p">)</span>
        <span class="n">wfit</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;clicked&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fit_lines_in_spectrum</span><span class="p">)</span>
        <span class="n">fitbox</span><span class="o">.</span><span class="n">pack_start</span><span class="p">(</span><span class="n">wfit</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">framebox</span><span class="o">.</span><span class="n">pack_start</span><span class="p">(</span><span class="n">fitbox</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># fit results</span>
        <span class="n">sw</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">ScrolledWindow</span><span class="p">()</span>
        <span class="n">sw</span><span class="o">.</span><span class="n">set_policy</span><span class="p">(</span><span class="n">gtk</span><span class="o">.</span><span class="n">POLICY_AUTOMATIC</span><span class="p">,</span> <span class="n">gtk</span><span class="o">.</span><span class="n">POLICY_AUTOMATIC</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fit_results_store</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">ListStore</span><span class="p">(</span>
            <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="n">wfit_results</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">TreeView</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_results_store</span><span class="p">)</span>
        <span class="n">renderer</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">CellRendererText</span><span class="p">()</span>
        <span class="n">col_name</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">TreeViewColumn</span><span class="p">(</span><span class="s2">&quot;Name&quot;</span><span class="p">,</span> <span class="n">renderer</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">col_line</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">TreeViewColumn</span><span class="p">(</span><span class="s2">&quot;Line&quot;</span><span class="p">,</span> <span class="n">renderer</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">col_hei</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">TreeViewColumn</span><span class="p">(</span><span class="s2">&quot;Height&quot;</span><span class="p">,</span> <span class="n">renderer</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">col_amp</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">TreeViewColumn</span><span class="p">(</span><span class="s2">&quot;Amplitude&quot;</span><span class="p">,</span> <span class="n">renderer</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">col_vel</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">TreeViewColumn</span><span class="p">(</span><span class="s2">&quot;Velocity&quot;</span><span class="p">,</span> <span class="n">renderer</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">col_fwhm</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">TreeViewColumn</span><span class="p">(</span><span class="s2">&quot;FWHM&quot;</span><span class="p">,</span> <span class="n">renderer</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">col_snr</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">TreeViewColumn</span><span class="p">(</span><span class="s2">&quot;SNR&quot;</span><span class="p">,</span> <span class="n">renderer</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="n">wfit_results</span><span class="o">.</span><span class="n">append_column</span><span class="p">(</span><span class="n">col_name</span><span class="p">)</span>
        <span class="n">wfit_results</span><span class="o">.</span><span class="n">append_column</span><span class="p">(</span><span class="n">col_line</span><span class="p">)</span>
        <span class="n">wfit_results</span><span class="o">.</span><span class="n">append_column</span><span class="p">(</span><span class="n">col_hei</span><span class="p">)</span>
        <span class="n">wfit_results</span><span class="o">.</span><span class="n">append_column</span><span class="p">(</span><span class="n">col_amp</span><span class="p">)</span>
        <span class="n">wfit_results</span><span class="o">.</span><span class="n">append_column</span><span class="p">(</span><span class="n">col_vel</span><span class="p">)</span>
        <span class="n">wfit_results</span><span class="o">.</span><span class="n">append_column</span><span class="p">(</span><span class="n">col_fwhm</span><span class="p">)</span>
        <span class="n">wfit_results</span><span class="o">.</span><span class="n">append_column</span><span class="p">(</span><span class="n">col_snr</span><span class="p">)</span>
        
        <span class="n">sw</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">wfit_results</span><span class="p">)</span>
        <span class="n">framebox</span><span class="o">.</span><span class="n">pack_start</span><span class="p">(</span><span class="n">sw</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">frame</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">framebox</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fitframe</span> <span class="o">=</span> <span class="n">frame</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_step</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_order</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_apod</span><span class="p">(</span><span class="n">apod</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wavenumber</span> <span class="o">=</span> <span class="n">wavenumber</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_cb</span> <span class="o">=</span> <span class="n">update_cb</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fitted_vector</span> <span class="o">=</span> <span class="kc">None</span>


    <span class="k">def</span> <span class="nf">_get_calib_map_path_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Callback to set the calibration laser map.</span>

<span class="sd">        :param w: Widget.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_calib_map</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">get_filename</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">_set_calib_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set calibration laser map.</span>

<span class="sd">        :param file_path: Calibration laser map path.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calib_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">read_fits</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calib_map</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">interpolate_map</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calib_map</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimy</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">_set_step_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Callback to set the step size.</span>
<span class="sd">        </span>
<span class="sd">        :param w: Widget</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_step</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">get_text</span><span class="p">())</span>
        
    <span class="k">def</span> <span class="nf">_set_order_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Callback to set the folding order.</span>
<span class="sd">        </span>
<span class="sd">        :param w: Widget</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_order</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">get_text</span><span class="p">())</span>
        
    <span class="k">def</span> <span class="nf">_set_apod_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Callback to set the step apodization function.</span>
<span class="sd">        </span>
<span class="sd">        :param w: Widget</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">w</span><span class="o">.</span><span class="n">get_text</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_apod</span><span class="p">(</span><span class="s1">&#39;1.0&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_apod</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">get_text</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">_fit_lines_in_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fit lines in the given spectrum</span>
<span class="sd">        </span>
<span class="sd">        :param w: Widget</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_lines</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_lines</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">fit_axis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_axis</span><span class="p">()</span>
                
                <span class="c1"># remove lines that are not in the spectral range</span>
                <span class="n">spectrum_range</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_spectrum_range</span><span class="p">()</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_model</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">apod</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">:</span> <span class="n">fmodel</span> <span class="o">=</span> <span class="s1">&#39;sinc&#39;</span>
                    <span class="k">else</span><span class="p">:</span> <span class="n">fmodel</span> <span class="o">=</span> <span class="s1">&#39;gaussian&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fmodel</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line_model</span><span class="p">)</span>
                    
                <span class="c1"># guess fwhm</span>
                <span class="n">fwhm_guess</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">compute_line_fwhm</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">1.25</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">,</span>
                    <span class="n">apod_coeff</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">apod</span><span class="p">,</span>
                    <span class="n">wavenumber</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wavenumber</span><span class="p">)</span>
                
                <span class="n">fit_results</span> <span class="o">=</span>  <span class="n">fit</span><span class="o">.</span><span class="n">fit_lines_in_spectrum</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">get_fit_lines</span><span class="p">(),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">,</span>
                    <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis_corr</span><span class="p">,</span>
                    <span class="n">fwhm_guess</span><span class="o">=</span><span class="n">fwhm_guess</span><span class="p">,</span>
                    <span class="n">signal_range</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">spectrum_range</span><span class="p">),</span>
                                  <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">spectrum_range</span><span class="p">)],</span>
                    <span class="n">wavenumber</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wavenumber</span><span class="p">,</span>
                    <span class="n">fmodel</span><span class="o">=</span><span class="n">fmodel</span><span class="p">)</span>

                <span class="k">if</span> <span class="s1">&#39;lines-params-err&#39;</span> <span class="ow">in</span> <span class="n">fit_results</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fitted_vector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">fit_results</span><span class="p">[</span><span class="s1">&#39;fitted-vector&#39;</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_update_plot</span><span class="p">()</span>
                    
                    <span class="c1"># print results</span>
                    <span class="n">par</span> <span class="o">=</span> <span class="n">fit_results</span><span class="p">[</span><span class="s1">&#39;lines-params&#39;</span><span class="p">]</span>
                    <span class="n">par_err</span> <span class="o">=</span> <span class="n">fit_results</span><span class="p">[</span><span class="s1">&#39;lines-params-err&#39;</span><span class="p">]</span>
                    <span class="n">vel</span> <span class="o">=</span> <span class="n">fit_results</span><span class="p">[</span><span class="s1">&#39;velocity&#39;</span><span class="p">]</span>
                    <span class="n">vel_err</span> <span class="o">=</span> <span class="n">fit_results</span><span class="p">[</span><span class="s1">&#39;velocity-err&#39;</span><span class="p">]</span>
                    
                    <span class="bp">self</span><span class="o">.</span><span class="n">fit_results_store</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

                    <span class="k">def</span> <span class="nf">format_store</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">perr</span><span class="p">):</span>
                        <span class="n">_store</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
                        <span class="n">_store</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="n">iline</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">_store</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="n">iline</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">_store</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">iline</span><span class="p">]</span>
                        <span class="n">_store</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="n">iline</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
                        
                        <span class="n">_store</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">{:.2e}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_store</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                                 <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">_store</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>

                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wavenumber</span><span class="p">:</span>
                            <span class="n">_store</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Lines</span><span class="p">()</span><span class="o">.</span><span class="n">get_line_name</span><span class="p">(</span>
                                <span class="n">utils</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">cm12nm</span><span class="p">(</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">fit_lines</span><span class="p">[</span><span class="n">iline</span><span class="p">]))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">_store</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Lines</span><span class="p">()</span><span class="o">.</span><span class="n">get_line_name</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">fit_lines</span><span class="p">[</span><span class="n">iline</span><span class="p">])</span>

                        <span class="n">_store</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_lines</span><span class="p">[</span><span class="n">iline</span><span class="p">])</span>
                        <span class="n">_store</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.1f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">p</span><span class="p">[</span><span class="n">iline</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">perr</span><span class="p">[</span><span class="n">iline</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                        <span class="k">return</span> <span class="n">_store</span>

                        
                    <span class="k">for</span> <span class="n">iline</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_lines</span><span class="p">)):</span>
                        <span class="n">store</span> <span class="o">=</span> <span class="n">format_store</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">vel</span><span class="p">,</span> <span class="n">par_err</span><span class="p">)</span>
                        <span class="n">store_err</span> <span class="o">=</span> <span class="n">format_store</span><span class="p">(</span><span class="n">par_err</span><span class="p">,</span> <span class="n">vel_err</span><span class="p">,</span> <span class="n">par_err</span><span class="p">)</span>
                        <span class="n">store_err</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                        <span class="n">store_err</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                        <span class="n">store_err</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">fit_results_store</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">store</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">fit_results_store</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">store_err</span><span class="p">)</span>

                    
    <span class="k">def</span> <span class="nf">_get_lines_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return lines keys.&quot;&quot;&quot;</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="n">Lines</span><span class="p">()</span><span class="o">.</span><span class="n">air_lines_nm</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">keys</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Filter lines&#39;</span><span class="p">)</span>
        <span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Sky lines&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">keys</span>

    <span class="k">def</span> <span class="nf">_get_axis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return fit axis&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">wavenumber</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">utils</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">create_nm_axis</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis_corr</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">utils</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">create_cm1_axis</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis_corr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
            
    <span class="k">def</span> <span class="nf">_get_spectrum_range</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return min and max wavelength of the spectrum&quot;&quot;&quot;</span>
        <span class="n">axis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_axis</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitrange</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitrange</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitrange</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">nonans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">axis</span><span class="p">[</span><span class="n">nonans</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">axis</span><span class="p">[</span><span class="n">nonans</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        
    <span class="k">def</span> <span class="nf">_get_line_nm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return lines wavelength in nm</span>

<span class="sd">        :param line_name: Name of the lines</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_spectrum_range</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wavenumber</span><span class="p">:</span>
                <span class="n">nm_max</span><span class="p">,</span> <span class="n">nm_min</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">cm12nm</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_get_spectrum_range</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nm_min</span><span class="p">,</span> <span class="n">nm_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_spectrum_range</span><span class="p">()</span>
                
        <span class="k">if</span> <span class="n">line_name</span> <span class="o">==</span> <span class="s1">&#39;Sky lines&#39;</span><span class="p">:</span>
            <span class="n">delta_nm</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">compute_line_fwhm</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">,</span>
                <span class="n">apod_coeff</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">apod</span><span class="p">,</span> <span class="n">wavenumber</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                
            <span class="k">return</span> <span class="n">Lines</span><span class="p">()</span><span class="o">.</span><span class="n">get_sky_lines</span><span class="p">(</span><span class="n">nm_min</span><span class="p">,</span> <span class="n">nm_max</span><span class="p">,</span> <span class="n">delta_nm</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">line_name</span> <span class="o">==</span> <span class="s1">&#39;Filter lines&#39;</span><span class="p">:</span>
            <span class="n">filter_lines</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="n">all_lines</span> <span class="o">=</span> <span class="n">Lines</span><span class="p">()</span><span class="o">.</span><span class="n">air_lines_nm</span>
        
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">all_lines</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">line_nm</span> <span class="o">=</span> <span class="n">all_lines</span><span class="p">[</span><span class="n">line</span><span class="p">]</span>
                
                <span class="k">if</span> <span class="p">(</span><span class="n">line_nm</span> <span class="o">&gt;</span> <span class="n">nm_min</span>
                    <span class="ow">and</span> <span class="n">line_nm</span> <span class="o">&lt;</span> <span class="n">nm_max</span><span class="p">):</span>
                    <span class="n">filter_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line_nm</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="n">filter_lines</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Lines</span><span class="p">()</span><span class="o">.</span><span class="n">get_line_nm</span><span class="p">(</span><span class="n">line_name</span><span class="p">)</span>
 
    <span class="k">def</span> <span class="nf">_update_velocity_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Callback to update velocity parameters (velocity and redshift)</span>

<span class="sd">        :param w: Widget.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit_lines_velocity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wvelocity</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit_lines_redshift</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wredshift</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_plot</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">_add_fit_line_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a line to the list of lines to fit.</span>

<span class="sd">        Action called by the &#39;+&#39; button.</span>
<span class="sd">        </span>
<span class="sd">        :param w: Widget</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_change_fit_lines</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        
    <span class="k">def</span> <span class="nf">_del_fit_line_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete a line from the list of lines to fit.</span>

<span class="sd">        Action called by the &#39;-&#39; button.</span>
<span class="sd">        </span>
<span class="sd">        :param w: Widget</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_change_fit_lines</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">_change_fit_lines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">add</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add or delete a fit line.</span>

<span class="sd">        :param add: If True line is added, if False line is deleted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_lines</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fit_lines</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">new_lines</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">new_lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_line_nm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">new_lines</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_lines</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="n">new_lines</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">new_lines</span><span class="p">])</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wavenumber</span><span class="p">:</span>
            <span class="n">new_lines</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">nm2cm1</span><span class="p">(</span><span class="n">new_lines</span><span class="p">)</span>

        
        <span class="k">for</span> <span class="n">new_line</span> <span class="ow">in</span> <span class="n">new_lines</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">add</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">new_line</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_lines</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fit_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_line</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">new_line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_lines</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fit_lines</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">new_line</span><span class="p">)</span>
                
                
        <span class="c1"># add lines to table</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit_results_store</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fit_lines</span><span class="p">():</span>
            <span class="n">store</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wavenumber</span><span class="p">:</span>
                <span class="n">store</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Lines</span><span class="p">()</span><span class="o">.</span><span class="n">get_line_name</span><span class="p">(</span>
                    <span class="n">utils</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">cm12nm</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">store</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Lines</span><span class="p">()</span><span class="o">.</span><span class="n">get_line_name</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                        
                <span class="n">store</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fit_results_store</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">store</span><span class="p">)</span>        

        <span class="bp">self</span><span class="o">.</span><span class="n">_update_plot</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">_set_line_name_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Callback to set the line names</span>

<span class="sd">        :param w: Widget.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">line_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_lines_keys</span><span class="p">()[</span><span class="n">w</span><span class="o">.</span><span class="n">get_active</span><span class="p">()]</span>

    <span class="k">def</span> <span class="nf">_set_line_model_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Callback to set the line model</span>

<span class="sd">        :param w: Widget.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">line_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_models</span><span class="p">[</span><span class="n">w</span><span class="o">.</span><span class="n">get_active</span><span class="p">()]</span>


    <span class="k">def</span> <span class="nf">_update_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update plot in the ZPlot window if a callback function has</span>
<span class="sd">        been given.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_cb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_cb</span><span class="p">()</span>

<div class="viewcode-block" id="FitPlugin.set_step"><a class="viewcode-back" href="../../orb.html#orb.viewer.FitPlugin.set_step">[docs]</a>    <span class="k">def</span> <span class="nf">set_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set step size.</span>

<span class="sd">        :param step: Step size in nm</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">step</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wstep</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">step</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_plot</span><span class="p">()</span></div>

<div class="viewcode-block" id="FitPlugin.set_order"><a class="viewcode-back" href="../../orb.html#orb.viewer.FitPlugin.set_order">[docs]</a>    <span class="k">def</span> <span class="nf">set_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set order.</span>

<span class="sd">        :param order: Order.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">order</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">worder</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">order</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_plot</span><span class="p">()</span></div>
            
<div class="viewcode-block" id="FitPlugin.set_apod"><a class="viewcode-back" href="../../orb.html#orb.viewer.FitPlugin.set_apod">[docs]</a>    <span class="k">def</span> <span class="nf">set_apod</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">apod</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set apodization.</span>

<span class="sd">        :param apod: Apodization function.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">apod</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">apod</span> <span class="o">=</span> <span class="mf">1.0</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">wapod</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">apod</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">apod</span> <span class="o">=</span> <span class="n">apod</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">apod</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">apod</span><span class="p">)</span></div>
            
<div class="viewcode-block" id="FitPlugin.set_spectrum"><a class="viewcode-back" href="../../orb.html#orb.viewer.FitPlugin.set_spectrum">[docs]</a>    <span class="k">def</span> <span class="nf">set_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set spectrum to fit.</span>

<span class="sd">        :param spectrum: Spectrum.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">update</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">update</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="p">)):</span>
            <span class="n">update</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">spectrum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nonans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">spectrum</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">spectrum</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="p">[</span><span class="n">nonans</span><span class="p">]</span> <span class="o">!=</span> <span class="n">spectrum</span><span class="p">[</span><span class="n">nonans</span><span class="p">]):</span>
                    <span class="n">update</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">update</span> <span class="o">=</span> <span class="kc">True</span>
                
        <span class="k">if</span> <span class="n">update</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span> <span class="o">=</span> <span class="n">spectrum</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fitted_vector</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="FitPlugin.set_fitrange"><a class="viewcode-back" href="../../orb.html#orb.viewer.FitPlugin.set_fitrange">[docs]</a>    <span class="k">def</span> <span class="nf">set_fitrange</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fitmin</span><span class="p">,</span> <span class="n">fitmax</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fitrange</span> <span class="o">=</span> <span class="p">(</span><span class="n">fitmin</span><span class="p">,</span> <span class="n">fitmax</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="FitPlugin.get_frame"><a class="viewcode-back" href="../../orb.html#orb.viewer.FitPlugin.get_frame">[docs]</a>    <span class="k">def</span> <span class="nf">get_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the visual gtk.Frame object corresponding to the</span>
<span class="sd">        fitting plugin.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitframe</span></div>

<div class="viewcode-block" id="FitPlugin.get_fit_lines"><a class="viewcode-back" href="../../orb.html#orb.viewer.FitPlugin.get_fit_lines">[docs]</a>    <span class="k">def</span> <span class="nf">get_fit_lines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the selected fit lines.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_lines</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fit_lines</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_lines</span><span class="p">)</span>
                         <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">line_shift</span><span class="p">(</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">fit_lines_velocity</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_lines</span><span class="p">,</span>
                             <span class="n">wavenumber</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wavenumber</span><span class="p">)))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wavenumber</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">fit_lines</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_lines_redshift</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">fit_lines</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_lines_redshift</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="FitPlugin.get_fitted_vector"><a class="viewcode-back" href="../../orb.html#orb.viewer.FitPlugin.get_fitted_vector">[docs]</a>    <span class="k">def</span> <span class="nf">get_fitted_vector</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the fitted spectrum.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitted_vector</span></div></div>

<span class="c1">###########################################</span>
<span class="c1">### CLASS REGIONS #########################</span>
<span class="c1">###########################################</span>
<div class="viewcode-block" id="Regions"><a class="viewcode-back" href="../../orb.html#orb.viewer.Regions">[docs]</a><span class="k">class</span> <span class="nc">Regions</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Manage regions parameters and the visual objects (region menu)&quot;&quot;&quot;</span>

    <span class="n">method</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;sum&#39;</span><span class="p">,</span> <span class="s1">&#39;median&#39;</span><span class="p">]</span>
    <span class="c1">#shapes = [&#39;rectangle&#39;, &#39;circle&#39;]</span>
    <span class="n">shapes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;circle&#39;</span><span class="p">]</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">change_region_properties_cb</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">regions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">change_region_properties_cb</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Init Regions class.</span>

<span class="sd">        :param change_region_properties_cb: (Optional) method to call in the main</span>
<span class="sd">          window when region properties are changed (default None).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">new_checksubmenu</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">cb</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">first_radioitem</span><span class="p">,</span> <span class="n">menuitems</span><span class="p">):</span>
            <span class="n">_m</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">RadioMenuItem</span><span class="p">(</span><span class="n">first_radioitem</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="n">_m</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;toggled&#39;</span><span class="p">,</span> <span class="n">cb</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">first_radioitem</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">first_radioitem</span> <span class="o">=</span> <span class="n">_m</span>
                <span class="n">first_radioitem</span><span class="o">.</span><span class="n">set_active</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">menuitems</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_m</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">first_radioitem</span><span class="p">,</span> <span class="n">menuitems</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">change_region_properties_cb</span> <span class="o">=</span> <span class="n">change_region_properties_cb</span>

        <span class="n">region_menu</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">Menu</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">region_mi</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">MenuItem</span><span class="p">(</span><span class="s1">&#39;Region&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">region_mi</span><span class="o">.</span><span class="n">set_submenu</span><span class="p">(</span><span class="n">region_menu</span><span class="p">)</span>

        <span class="c1"># add method menu</span>
        <span class="n">region_method_menu</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">Menu</span><span class="p">()</span>
        <span class="n">region_method_mi</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">MenuItem</span><span class="p">(</span><span class="s1">&#39;Method&#39;</span><span class="p">)</span>
        <span class="n">region_method_mi</span><span class="o">.</span><span class="n">set_submenu</span><span class="p">(</span><span class="n">region_method_menu</span><span class="p">)</span>

        <span class="n">first_radioitem</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">menuitems</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">imethod</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">methods</span><span class="p">:</span>
            <span class="n">first_radioitem</span><span class="p">,</span> <span class="n">menuitems</span> <span class="o">=</span> <span class="n">new_checksubmenu</span><span class="p">(</span>
                <span class="n">imethod</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_method_cb</span><span class="p">,</span> <span class="n">imethod</span><span class="p">,</span> <span class="n">first_radioitem</span><span class="p">,</span>
                <span class="n">menuitems</span><span class="p">)</span>
        <span class="n">submenus</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">menuitem</span> <span class="ow">in</span> <span class="n">menuitems</span><span class="p">:</span>
            <span class="n">submenus</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">menuitem</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">submenu</span> <span class="ow">in</span> <span class="n">submenus</span><span class="p">:</span>
            <span class="n">region_method_menu</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">submenu</span><span class="p">)</span>
                    
        <span class="n">region_menu</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">region_method_mi</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;mean&#39;</span>
        <span class="n">menuitems</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_method_index</span><span class="p">(</span><span class="s1">&#39;mean&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">set_active</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># add shape menu</span>
        <span class="n">region_shape_menu</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">Menu</span><span class="p">()</span>
        <span class="n">region_shape_mi</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">MenuItem</span><span class="p">(</span><span class="s1">&#39;Shape&#39;</span><span class="p">)</span>
        <span class="n">region_shape_mi</span><span class="o">.</span><span class="n">set_submenu</span><span class="p">(</span><span class="n">region_shape_menu</span><span class="p">)</span>

        <span class="n">first_radioitem</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">menuitems</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">ishape</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">shapes</span><span class="p">:</span>
            <span class="n">first_radioitem</span><span class="p">,</span> <span class="n">menuitems</span> <span class="o">=</span> <span class="n">new_checksubmenu</span><span class="p">(</span>
                <span class="n">ishape</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_shape_cb</span><span class="p">,</span> <span class="n">ishape</span><span class="p">,</span> <span class="n">first_radioitem</span><span class="p">,</span>
                <span class="n">menuitems</span><span class="p">)</span>
        <span class="n">submenus</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">menuitem</span> <span class="ow">in</span> <span class="n">menuitems</span><span class="p">:</span>
            <span class="n">submenus</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">menuitem</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">submenu</span> <span class="ow">in</span> <span class="n">submenus</span><span class="p">:</span>
            <span class="n">region_shape_menu</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">submenu</span><span class="p">)</span>
                    
        <span class="n">region_menu</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">region_shape_mi</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="s1">&#39;circle&#39;</span>
        <span class="n">menuitems</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_shape_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)]</span><span class="o">.</span><span class="n">set_active</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">regions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">_set_method_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;callback method to select a new combining method.</span>

<span class="sd">        :param c: widget.</span>
<span class="sd">        :param method: Choosen method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">get_active</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_method</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
        
<div class="viewcode-block" id="Regions.set_method"><a class="viewcode-back" href="../../orb.html#orb.viewer.Regions.set_method">[docs]</a>    <span class="k">def</span> <span class="nf">set_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Select a new combining method.</span>

<span class="sd">        :param method: Selected method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">method</span></div>

<div class="viewcode-block" id="Regions.get_method"><a class="viewcode-back" href="../../orb.html#orb.viewer.Regions.get_method">[docs]</a>    <span class="k">def</span> <span class="nf">get_method</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the selected combining method.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span></div>
  
<div class="viewcode-block" id="Regions.get_menubar_item"><a class="viewcode-back" href="../../orb.html#orb.viewer.Regions.get_menubar_item">[docs]</a>    <span class="k">def</span> <span class="nf">get_menubar_item</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the region menubar item&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">region_mi</span></div>

<div class="viewcode-block" id="Regions.get_method_index"><a class="viewcode-back" href="../../orb.html#orb.viewer.Regions.get_method_index">[docs]</a>    <span class="k">def</span> <span class="nf">get_method_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return combining method index.</span>

<span class="sd">        :param method: method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">methods</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">methods</span><span class="p">[</span><span class="n">index</span><span class="p">]:</span>
                <span class="k">return</span> <span class="n">index</span>
        <span class="k">return</span> <span class="kc">None</span></div>

    <span class="k">def</span> <span class="nf">_set_shape_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">shape</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Callback function to select region shape.</span>

<span class="sd">        :param c: Widget.</span>
<span class="sd">        :param shape: Selected shape.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">get_active</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_shape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
        
<div class="viewcode-block" id="Regions.set_shape"><a class="viewcode-back" href="../../orb.html#orb.viewer.Regions.set_shape">[docs]</a>    <span class="k">def</span> <span class="nf">set_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shape</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Select region shape.</span>

<span class="sd">        :param shape: region shape.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">shape</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">change_region_properties_cb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">change_region_properties_cb</span><span class="p">()</span></div>

<div class="viewcode-block" id="Regions.get_shape"><a class="viewcode-back" href="../../orb.html#orb.viewer.Regions.get_shape">[docs]</a>    <span class="k">def</span> <span class="nf">get_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return selected region shape&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span></div>

<div class="viewcode-block" id="Regions.get_shape_index"><a class="viewcode-back" href="../../orb.html#orb.viewer.Regions.get_shape_index">[docs]</a>    <span class="k">def</span> <span class="nf">get_shape_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shape</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return region shape index.</span>

<span class="sd">        :param shape: region shape.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shapes</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">shape</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">shapes</span><span class="p">[</span><span class="n">index</span><span class="p">]:</span>
                <span class="k">return</span> <span class="n">index</span>
        <span class="k">return</span> <span class="kc">None</span></div>
    

<div class="viewcode-block" id="Regions.add_region"><a class="viewcode-back" href="../../orb.html#orb.viewer.Regions.add_region">[docs]</a>    <span class="k">def</span> <span class="nf">add_region</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">regions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Region</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_shape</span><span class="p">()))</span></div>

<div class="viewcode-block" id="Regions.clear_regions"><a class="viewcode-back" href="../../orb.html#orb.viewer.Regions.clear_regions">[docs]</a>    <span class="k">def</span> <span class="nf">clear_regions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">regions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span></div></div>
        
<span class="c1">###########################################</span>
<span class="c1">### CLASS REGION ##########################</span>
<span class="c1">###########################################</span>
<div class="viewcode-block" id="Region"><a class="viewcode-back" href="../../orb.html#orb.viewer.Region">[docs]</a><span class="k">class</span> <span class="nc">Region</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="n">shape</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">x_range</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">y_range</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">selected_pixels</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">xy_start</span><span class="p">,</span> <span class="n">xy_stop</span><span class="p">,</span> <span class="n">dimx</span><span class="p">,</span> <span class="n">dimy</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">shape</span>
        <span class="n">xy_start</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xy_start</span><span class="p">)</span>
        <span class="n">xy_stop</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xy_stop</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">shape</span> <span class="o">==</span> <span class="s1">&#39;circle&#39;</span><span class="p">:</span>
            <span class="n">center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">xy_start</span> <span class="o">+</span> <span class="n">xy_stop</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xy_stop</span><span class="p">)</span> <span class="o">-</span> <span class="n">center</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span><span class="p">))</span>
            <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">dimx</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">dimy</span><span class="p">]</span>
            <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">X</span> <span class="o">-</span> <span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mf">2.</span> <span class="o">+</span> <span class="p">(</span><span class="n">Y</span> <span class="o">-</span> <span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">selected_pixels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">R</span> <span class="o">&lt;=</span> <span class="n">radius</span><span class="p">)</span>
            
            <span class="n">x_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selected_pixels</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selected_pixels</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">y_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selected_pixels</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selected_pixels</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>

        <span class="k">else</span><span class="p">:</span>
            
            <span class="n">y_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">min</span><span class="p">(</span><span class="n">xy_start</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xy_stop</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                                <span class="nb">max</span><span class="p">(</span><span class="n">xy_start</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xy_stop</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
            <span class="n">x_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">min</span><span class="p">(</span><span class="n">xy_start</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">xy_stop</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                                <span class="nb">max</span><span class="p">(</span><span class="n">xy_start</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">xy_stop</span><span class="p">[</span><span class="mi">1</span><span class="p">])])</span>

            
        <span class="c1"># check range</span>
        <span class="n">x_range</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">x_range</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">x_range</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">x_range</span> <span class="o">&gt;</span> <span class="n">dimx</span><span class="p">)]</span> <span class="o">=</span> <span class="n">dimx</span>
        <span class="n">y_range</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">y_range</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">y_range</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">y_range</span> <span class="o">&gt;</span> <span class="n">dimy</span><span class="p">)]</span> <span class="o">=</span> <span class="n">dimy</span>

        <span class="k">if</span> <span class="n">x_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1.</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">x_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">dimx</span><span class="p">:</span>
                <span class="n">x_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">x_range</span> <span class="o">=</span> <span class="p">[</span><span class="n">dimx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dimx</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">y_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1.</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">y_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">dimy</span><span class="p">:</span>
                <span class="n">y_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">y_range</span> <span class="o">=</span> <span class="p">[</span><span class="n">dimy</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dimy</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">shape</span> <span class="o">==</span> <span class="s1">&#39;rectangle&#39;</span><span class="p">:</span>
            <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="n">x_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">x_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                            <span class="n">y_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">y_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">selected_pixels</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">X</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
                <span class="n">Y</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">x_range</span> <span class="o">=</span> <span class="n">x_range</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_range</span> <span class="o">=</span> <span class="n">y_range</span>

<div class="viewcode-block" id="Region.get_selected_pixels"><a class="viewcode-back" href="../../orb.html#orb.viewer.Region.get_selected_pixels">[docs]</a>    <span class="k">def</span> <span class="nf">get_selected_pixels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_pixels</span></div></div>

    



<span class="c1">###########################################</span>
<span class="c1">### CLASS IMAGECANVAS #####################</span>
<span class="c1">###########################################</span>
<div class="viewcode-block" id="ImageCanvas"><a class="viewcode-back" href="../../orb.html#orb.viewer.ImageCanvas">[docs]</a><span class="k">class</span> <span class="nc">ImageCanvas</span><span class="p">(</span><span class="n">Tools</span><span class="p">):</span>

    
    <span class="n">properties</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;autocut&#39;</span> <span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                  <span class="s1">&#39;autocenter&#39;</span> <span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                  <span class="s1">&#39;autozoom&#39;</span> <span class="p">:</span> <span class="kc">True</span><span class="p">}</span>

    <span class="n">autocuts</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># an Autocuts instance</span>
    <span class="n">_autocut_method_changed</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">cmaps</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="s1">&#39;gist_rainbow&#39;</span><span class="p">,</span> <span class="s1">&#39;jet&#39;</span><span class="p">,</span> <span class="s1">&#39;cool&#39;</span><span class="p">,</span> <span class="s1">&#39;hot&#39;</span><span class="p">,</span> <span class="s1">&#39;autumn&#39;</span><span class="p">,</span> <span class="s1">&#39;summer&#39;</span><span class="p">,</span> <span class="s1">&#39;winter&#39;</span><span class="p">]</span>
    <span class="n">cmap</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">cmap_contrast</span> <span class="o">=</span> <span class="mf">1.</span>
    <span class="n">cmap_center</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">cbar</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">regions</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># a Regions instance</span>
    <span class="n">artists</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    
    <span class="n">vlim</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span> <span class="c1"># vmin, vmax</span>
    <span class="n">image</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># a 2d numpy array</span>
    <span class="n">im</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># an AxesImage matplolib instance returned by imshow()</span>
    
    <span class="n">wcs</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">_init</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">_xystart</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="n">mode</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">_last_xlim</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_last_ylim</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_last_vlim</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_last_arr8</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_last_arr8_map</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_last_event</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">signals</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">region_selector</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">scatter_params</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">regions</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="n">Tools</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        
        <span class="n">SIZE</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
        <span class="n">DPI</span> <span class="o">=</span> <span class="mi">75</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fig</span> <span class="o">=</span> <span class="n">Figure</span><span class="p">(</span>
            <span class="n">figsize</span><span class="o">=</span><span class="n">SIZE</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">DPI</span><span class="p">,</span> <span class="n">tight_layout</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subplot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">clip_on</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imagebox</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">VBox</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span> <span class="o">=</span> <span class="n">FigureCanvas</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imagebox</span><span class="o">.</span><span class="n">pack_start</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># load regions instance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">regions</span> <span class="o">=</span> <span class="n">regions</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">regions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">regions</span><span class="o">.</span><span class="n">change_region_properties_cb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_change_region_properties_cb</span>
            <span class="c1"># selector</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_region_selector</span><span class="p">()</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">autocuts</span> <span class="o">=</span> <span class="n">AutoCuts</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_autocut_method_changed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span>
        
        <span class="c1"># events</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connect_all</span><span class="p">()</span>


<div class="viewcode-block" id="ImageCanvas.connect"><a class="viewcode-back" href="../../orb.html#orb.viewer.ImageCanvas.connect">[docs]</a>    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_name</span><span class="p">,</span> <span class="n">callback_function</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">signals</span><span class="p">[</span><span class="n">event_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">callback_function</span></div>

    <span class="k">def</span> <span class="nf">_create_region_selector</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rectprops</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span>
                         <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">region_selector</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">region_selector</span><span class="o">.</span><span class="n">to_draw</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">region_selector</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">regions</span><span class="o">.</span><span class="n">get_shape</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;circle&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">region_selector</span> <span class="o">=</span> <span class="n">EllipseSelector</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">subplot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_select_region_cb</span><span class="p">,</span>
                <span class="n">button</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">rectprops</span><span class="o">=</span><span class="n">rectprops</span><span class="p">,</span> <span class="n">interactive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">region_selector</span> <span class="o">=</span> <span class="n">RectangleSelector</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">subplot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_select_region_cb</span><span class="p">,</span>
                <span class="n">button</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">rectprops</span><span class="o">=</span><span class="n">rectprops</span><span class="p">,</span> <span class="n">interactive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">region_selector</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;square&#39;</span><span class="p">)</span>
        
            
<div class="viewcode-block" id="ImageCanvas.connect_all"><a class="viewcode-back" href="../../orb.html#orb.viewer.ImageCanvas.connect_all">[docs]</a>    <span class="k">def</span> <span class="nf">connect_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s1">&#39;scroll_event&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_zoom_cb</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s1">&#39;button_press_event&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_button_press_cb</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s1">&#39;button_release_event&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_button_release_cb</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s1">&#39;motion_notify_event&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_move_cb</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s1">&#39;key_press_event&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key_press_cb</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s1">&#39;key_release_event&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key_release_cb</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s1">&#39;figure_enter_event&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_figure_enter_cb</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grab_focus</span><span class="p">()</span></div>

<div class="viewcode-block" id="ImageCanvas.grab_focus"><a class="viewcode-back" href="../../orb.html#orb.viewer.ImageCanvas.grab_focus">[docs]</a>    <span class="k">def</span> <span class="nf">grab_focus</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">grab_focus</span><span class="p">()</span></div>


    <span class="k">def</span> <span class="nf">_figure_enter_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grab_focus</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_change_region_properties_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_region_selector</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">_key_press_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;control&#39;</span> <span class="ow">in</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="ow">or</span> <span class="s1">&#39;ctrl&#39;</span> <span class="ow">in</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;ctrl&#39;</span>
        <span class="k">elif</span> <span class="s1">&#39;alt&#39;</span> <span class="ow">in</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;alt&#39;</span>

    <span class="k">def</span> <span class="nf">_key_release_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_is_double_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="n">is_double</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_event</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">x</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_event</span><span class="o">.</span><span class="n">x</span>
                <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">y</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_event</span><span class="o">.</span><span class="n">y</span>
                <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">button</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_event</span><span class="o">.</span><span class="n">button</span><span class="p">):</span>
                <span class="n">is_double</span> <span class="o">=</span> <span class="kc">True</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_event</span> <span class="o">=</span> <span class="n">event</span>
        <span class="k">return</span> <span class="n">is_double</span>
       
    
    <span class="k">def</span> <span class="nf">_button_press_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">_button_release_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_xystart</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_xystartdata</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_on_select_region_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eclick</span><span class="p">,</span> <span class="n">erelease</span><span class="p">):</span>
        <span class="n">xy_start</span> <span class="o">=</span> <span class="p">(</span><span class="n">eclick</span><span class="o">.</span><span class="n">xdata</span><span class="p">,</span> <span class="n">eclick</span><span class="o">.</span><span class="n">ydata</span><span class="p">)</span>
        <span class="n">xy_stop</span> <span class="o">=</span> <span class="p">(</span><span class="n">erelease</span><span class="o">.</span><span class="n">xdata</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">erelease</span><span class="o">.</span><span class="n">ydata</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="n">region</span> <span class="o">=</span> <span class="n">Region</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">regions</span><span class="o">.</span><span class="n">get_shape</span><span class="p">(),</span>
                        <span class="n">xy_start</span><span class="p">,</span> <span class="n">xy_stop</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">if</span> <span class="s1">&#39;on-select-region&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">signals</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">signals</span><span class="p">[</span><span class="s1">&#39;on-select-region&#39;</span><span class="p">](</span><span class="n">region</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_on_move_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_double_event</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
            <span class="k">return</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xystart</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dragx</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xystart</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">dragy</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xystart</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">scaley</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">get_figheight</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">get_dpi</span><span class="p">()</span>
            <span class="n">scalex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">get_figwidth</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">get_dpi</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">button</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># contrast</span>
                    <span class="k">if</span> <span class="n">dragy</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cmap_contrast</span> <span class="o">*=</span> <span class="mf">1.</span> <span class="o">+</span> <span class="mf">0.2</span> <span class="o">*</span> <span class="p">(</span><span class="n">dragy</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">dragy</span><span class="p">))</span> 
                
                    <span class="c1"># center</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cmap_center</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">x</span> <span class="o">/</span> <span class="n">scalex</span>
                    
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmap_center</span> <span class="o">&gt;</span> <span class="mf">1.</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmap_center</span> <span class="o">=</span> <span class="mf">1.</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmap_center</span> <span class="o">&lt;</span> <span class="mf">0.</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmap_center</span> <span class="o">=</span> <span class="mf">0.</span>
                    
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;ctrl&#39;</span><span class="p">:</span> <span class="c1"># image dragging</span>
                    <span class="n">xlim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subplot</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">())</span>
                    <span class="n">ylim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subplot</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">())</span>
                    <span class="n">bbox</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subplot</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
                            <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">subplot</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">subplot</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
                            <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">subplot</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">xlim</span> <span class="o">-=</span> <span class="n">dragx</span> <span class="o">*</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">scalex</span>
                    <span class="n">ylim</span> <span class="o">-=</span> <span class="n">dragy</span> <span class="o">*</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">scaley</span>
                    
                    <span class="bp">self</span><span class="o">.</span><span class="n">subplot</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">subplot</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>
                    
                <span class="bp">self</span><span class="o">.</span><span class="n">redraw</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">button</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">pass</span>
                    
        <span class="bp">self</span><span class="o">.</span><span class="n">_xystart</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">y</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_xydatastart</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">xdata</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">ydata</span>
        
        <span class="k">if</span> <span class="s1">&#39;on-move&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">signals</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">signals</span><span class="p">[</span><span class="s1">&#39;on-move&#39;</span><span class="p">](</span><span class="n">event</span><span class="o">.</span><span class="n">xdata</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">ydata</span><span class="p">)</span>
       
    <span class="k">def</span> <span class="nf">_zoom_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="n">xlim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subplot</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()</span>
        <span class="n">ylim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subplot</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
        <span class="n">xsize</span> <span class="o">=</span> <span class="n">xlim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">xlim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ysize</span> <span class="o">=</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">xcenter</span> <span class="o">=</span> <span class="p">(</span><span class="n">xlim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">xlim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.</span>
        <span class="n">ycenter</span> <span class="o">=</span> <span class="p">(</span><span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.</span>
        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">button</span> <span class="o">==</span> <span class="s1">&#39;up&#39;</span><span class="p">:</span>
            <span class="n">xsize</span> <span class="o">*=</span> <span class="mf">1.1</span>
            <span class="n">ysize</span> <span class="o">*=</span> <span class="mf">1.1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xsize</span> <span class="o">*=</span> <span class="mf">0.9</span>
            <span class="n">ysize</span> <span class="o">*=</span> <span class="mf">0.9</span>
        
        <span class="n">new_xlim</span> <span class="o">=</span> <span class="p">(</span><span class="n">xcenter</span> <span class="o">-</span> <span class="n">xsize</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">xcenter</span> <span class="o">+</span> <span class="n">xsize</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
        <span class="n">new_ylim</span> <span class="o">=</span> <span class="p">(</span><span class="n">ycenter</span> <span class="o">-</span> <span class="n">ysize</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">ycenter</span> <span class="o">+</span> <span class="n">ysize</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">subplot</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">new_xlim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subplot</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">new_ylim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redraw</span><span class="p">()</span>
            

<div class="viewcode-block" id="ImageCanvas.get_widget"><a class="viewcode-back" href="../../orb.html#orb.viewer.ImageCanvas.get_widget">[docs]</a>    <span class="k">def</span> <span class="nf">get_widget</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">imagebox</span></div>

<div class="viewcode-block" id="ImageCanvas.get_autocut_methods"><a class="viewcode-back" href="../../orb.html#orb.viewer.ImageCanvas.get_autocut_methods">[docs]</a>    <span class="k">def</span> <span class="nf">get_autocut_methods</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">autocuts</span><span class="o">.</span><span class="n">get_autocut_methods</span><span class="p">()</span></div>

<div class="viewcode-block" id="ImageCanvas.set_autocut_method"><a class="viewcode-back" href="../../orb.html#orb.viewer.ImageCanvas.set_autocut_method">[docs]</a>    <span class="k">def</span> <span class="nf">set_autocut_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">autocut_method</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">autocuts</span><span class="o">.</span><span class="n">set_autocut_method</span><span class="p">(</span><span class="n">autocut_method</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_autocut_method_changed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redraw</span><span class="p">()</span></div>
            
<div class="viewcode-block" id="ImageCanvas.get_cmaps"><a class="viewcode-back" href="../../orb.html#orb.viewer.ImageCanvas.get_cmaps">[docs]</a>    <span class="k">def</span> <span class="nf">get_cmaps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmaps</span></div>

<div class="viewcode-block" id="ImageCanvas.get_cmap"><a class="viewcode-back" href="../../orb.html#orb.viewer.ImageCanvas.get_cmap">[docs]</a>    <span class="k">def</span> <span class="nf">get_cmap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmap</span></div>

<div class="viewcode-block" id="ImageCanvas.set_cmap"><a class="viewcode-back" href="../../orb.html#orb.viewer.ImageCanvas.set_cmap">[docs]</a>    <span class="k">def</span> <span class="nf">set_cmap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmap</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">cmap</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmaps</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cmap</span> <span class="o">=</span> <span class="n">cmap</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_warning</span><span class="p">(</span><span class="s1">&#39;Unknown colormap (</span><span class="si">{}</span><span class="s1">), must be in </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">cmap</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmaps</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redraw</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_get_vlim</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vlim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_autocut_method_changed</span><span class="p">:</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;autocut&#39;</span><span class="p">]:</span>
                
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">)):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">vlim_cut</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">vlim_cut</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">autocuts</span><span class="o">.</span><span class="n">get_vlim</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_autocut_method_changed</span> <span class="o">=</span> <span class="kc">False</span>

                
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vlim_cut</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vlim_cut</span>
            
            <span class="n">vl</span> <span class="o">=</span> <span class="n">vmax</span> <span class="o">-</span> <span class="n">vmin</span>
            <span class="n">vc</span> <span class="o">=</span> <span class="n">vl</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmap_center</span>
            <span class="n">vc</span> <span class="o">+=</span> <span class="n">vmin</span>
            <span class="n">vl</span> <span class="o">=</span> <span class="n">vmax</span> <span class="o">-</span> <span class="n">vmin</span>
            <span class="n">vl</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmap_contrast</span>
            <span class="n">vlim</span> <span class="o">=</span> <span class="p">[</span><span class="n">vc</span> <span class="o">-</span> <span class="n">vl</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">vc</span> <span class="o">+</span> <span class="n">vl</span><span class="o">/</span><span class="mf">2.</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vlim</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">vlim</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">vlim</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">vlim</span>
    

<div class="viewcode-block" id="ImageCanvas.set_image"><a class="viewcode-back" href="../../orb.html#orb.viewer.ImageCanvas.set_image">[docs]</a>    <span class="k">def</span> <span class="nf">set_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vlim</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span></div>

<div class="viewcode-block" id="ImageCanvas.set_wcs"><a class="viewcode-back" href="../../orb.html#orb.viewer.ImageCanvas.set_wcs">[docs]</a>    <span class="k">def</span> <span class="nf">set_wcs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wcs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span> <span class="o">=</span> <span class="n">wcs</span></div>

    <span class="k">def</span> <span class="nf">_get_arr8</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recompute_all</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        
        <span class="n">cmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cbar</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">()</span>
        <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_vlim</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_arr8_map</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_last_arr8_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">recompute_all</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_last_arr8_map</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subplot</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">())</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subplot</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">())</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">xmax</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">ymax</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">xmin</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">xmin</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">ymin</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">ymin</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">xmax</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">xmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">ymax</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="n">ymax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">is_valid</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">vmin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">vmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">vmin</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">vmax</span><span class="p">):</span>
                <span class="n">is_valid</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">is_valid</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_last_arr8_map</span><span class="p">[</span><span class="n">xmin</span><span class="p">:</span><span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">:</span><span class="n">ymax</span><span class="p">]):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_last_arr8</span> <span class="o">=</span> <span class="n">orb</span><span class="o">.</span><span class="n">cutils</span><span class="o">.</span><span class="n">im2rgba</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cbar</span><span class="p">,</span> <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">,</span>
                    <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_last_arr8_map</span><span class="p">,</span>
                    <span class="n">last_arr8</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_last_arr8</span><span class="p">,</span>
                    <span class="n">res</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">_last_arr8_map</span><span class="p">[</span><span class="n">xmin</span><span class="p">:</span><span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">:</span><span class="n">ymax</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">has_changed</span> <span class="o">=</span> <span class="kc">True</span>
            
            <span class="k">else</span><span class="p">:</span>
                <span class="n">has_changed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_last_arr8</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">4</span><span class="p">),</span>
                <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span> <span class="o">*</span> <span class="mi">255</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_last_arr8_map</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">has_changed</span> <span class="o">=</span> <span class="kc">True</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_vlim</span> <span class="o">=</span> <span class="p">(</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">)</span>
        
        <span class="c1">#arr8 = self.cbar.to_rgba(self.image_nonan.T, alpha=None, bytes=True)</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_arr8</span><span class="p">,</span> <span class="n">has_changed</span>

<div class="viewcode-block" id="ImageCanvas.draw"><a class="viewcode-back" href="../../orb.html#orb.viewer.ImageCanvas.draw">[docs]</a>    <span class="k">def</span> <span class="nf">draw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_vlim</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_cmap</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cmap</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subplot</span><span class="o">.</span><span class="n">set_frame_on</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subplot</span><span class="o">.</span><span class="n">get_xaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subplot</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

            <span class="c1"># add colorbar</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cbar</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">cax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cbar</span> <span class="o">=</span> <span class="n">ColorbarBase</span><span class="p">(</span>
                    <span class="n">cax</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cmap</span><span class="p">),</span>
                    <span class="n">spacing</span><span class="o">=</span><span class="s1">&#39;proportional&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cbar</span><span class="o">.</span><span class="n">get_clim</span><span class="p">()</span> <span class="o">!=</span> <span class="p">(</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cbar</span><span class="o">.</span><span class="n">set_clim</span><span class="p">([</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cbar</span><span class="o">.</span><span class="n">draw_all</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">im</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subplot</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_get_arr8</span><span class="p">(</span><span class="n">recompute_all</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span>
                <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cmap</span><span class="p">),</span>
                <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="o">.</span><span class="n">set_resample</span> <span class="o">=</span> <span class="kc">True</span>
        
            
        <span class="bp">self</span><span class="o">.</span><span class="n">_init</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redraw</span><span class="p">(</span><span class="n">recompute_all</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>
        
        
<div class="viewcode-block" id="ImageCanvas.redraw"><a class="viewcode-back" href="../../orb.html#orb.viewer.ImageCanvas.redraw">[docs]</a>    <span class="k">def</span> <span class="nf">redraw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recompute_all</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">vlim_changed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_vlim</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="o">.</span><span class="n">get_clim</span><span class="p">():</span>
            <span class="n">vlim_changed</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">xylim_changed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_xlim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">xylim_changed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_ylim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">xylim_changed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_xlim</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subplot</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">():</span> <span class="n">xylim_changed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_ylim</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subplot</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">():</span> <span class="n">xylim_changed</span> <span class="o">=</span> <span class="kc">True</span>
        
        <span class="n">cmap_changed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmap</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_cmap</span><span class="p">:</span>
            <span class="n">cmap_changed</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">xylim_changed</span> <span class="ow">or</span> <span class="n">vlim_changed</span> <span class="ow">or</span> <span class="n">cmap_changed</span> <span class="ow">or</span> <span class="n">recompute_all</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">vlim_changed</span> <span class="ow">or</span> <span class="n">cmap_changed</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">vlim_changed</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="o">.</span><span class="n">set_clim</span><span class="p">([</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cbar</span><span class="o">.</span><span class="n">set_clim</span><span class="p">([</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">])</span>
           
                <span class="k">if</span> <span class="n">cmap_changed</span><span class="p">:</span>
                    <span class="n">cmap</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cmap</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="o">.</span><span class="n">set_cmap</span><span class="p">(</span><span class="n">cmap</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cbar</span><span class="o">.</span><span class="n">set_cmap</span><span class="p">(</span><span class="n">cmap</span><span class="p">)</span>
                    
                <span class="bp">self</span><span class="o">.</span><span class="n">cbar</span><span class="o">.</span><span class="n">draw_all</span><span class="p">()</span>
                <span class="n">recompute_all</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="n">arr8</span><span class="p">,</span> <span class="n">has_changed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_arr8</span><span class="p">(</span>
                <span class="n">recompute_all</span><span class="o">=</span><span class="n">recompute_all</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">has_changed</span><span class="p">:</span>
                <span class="c1"># break through : replace self.im.set_data(arr8). Much</span>
                <span class="c1"># much faster when input data has no nans or infs</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="o">.</span><span class="n">_A</span> <span class="o">=</span> <span class="n">arr8</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="o">.</span><span class="n">changed</span><span class="p">()</span> <span class="c1"># very important, avoid &#39;zooming&#39; bug</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scatter_params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">subplot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">scatter_params</span><span class="p">)</span>
                
            <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_xlim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subplot</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_ylim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subplot</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_cmap</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cmap</span><span class="p">)</span></div>
        

<div class="viewcode-block" id="ImageCanvas.scatter"><a class="viewcode-back" href="../../orb.html#orb.viewer.ImageCanvas.scatter">[docs]</a>    <span class="k">def</span> <span class="nf">scatter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scatter_params</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redraw</span><span class="p">(</span><span class="n">recompute_all</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div></div>
    





<span class="c1">###########################################</span>
<span class="c1">### CLASS IMAGEWINDOW #####################</span>
<span class="c1">###########################################</span>
<div class="viewcode-block" id="ImageWindow"><a class="viewcode-back" href="../../orb.html#orb.viewer.ImageWindow">[docs]</a><span class="k">class</span> <span class="nc">ImageWindow</span><span class="p">(</span><span class="n">PopupWindow</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Implement a window for plotting zaxis data.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Init and construct spectrum window.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">SIZE</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
        <span class="n">DPI</span> <span class="o">=</span> <span class="mi">75</span>
        <span class="n">PopupWindow</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Image&#39;</span><span class="p">,</span>
                             <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">SIZE</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">DPI</span><span class="p">,</span><span class="n">SIZE</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">DPI</span><span class="p">))</span>
   
        <span class="bp">self</span><span class="o">.</span><span class="n">fig</span> <span class="o">=</span> <span class="n">Figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">SIZE</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">DPI</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subplot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>


        <span class="c1"># CREATE framebox</span>
        <span class="n">framebox</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">VBox</span><span class="p">()</span>
        <span class="c1"># add figure canvas</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span> <span class="o">=</span> <span class="n">ImageCanvas</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>  <span class="c1"># a gtk.DrawingArea</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">set_image</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
        <span class="n">framebox</span><span class="o">.</span><span class="n">pack_start</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">get_widget</span><span class="p">(),</span>
                            <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># add framebox</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">framebox</span><span class="p">)</span>


<div class="viewcode-block" id="ImageWindow.scatter"><a class="viewcode-back" href="../../orb.html#orb.viewer.ImageWindow.scatter">[docs]</a>    <span class="k">def</span> <span class="nf">scatter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, Author.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.5.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.8</a>
      
    </div>

    

    
  </body>
</html>